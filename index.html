<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="‰ªøAppÂ∞èÊâãÊú∫">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#e8f8f5">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="manifest" href="manifest.json">
    <title>‰ªøÂæÆ‰ø°ÊâãÊú∫ÁïåÈù¢ - ËßíËâ≤ËÅäÂ§©Á≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        body {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            min-height: 100dvh;
            background: linear-gradient(160deg, #e8f8f5 0%, #d5f5e3 25%, #abebc6 50%, #d5f5e3 75%, #e8f8f5 100%);
            font-family: 'PingFang SC', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            justify-content: center;
        }

        .phone {
            width: 100%;
            max-width: 450px;
            height: 100vh;
            height: -webkit-fill-available;
            height: 100dvh;
            position: relative;
            display: flex;
            flex-direction: column;
            background: transparent;
            box-shadow: 0 0 50px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .phone-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 0;
        }

        .decoration {
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
            pointer-events: none;
            z-index: 1;
        }

        .deco1 { width: 120px; height: 120px; background: radial-gradient(circle, #fff 0%, transparent 70%); top: 60px; right: 10%; }
        .deco2 { width: 80px; height: 80px; background: radial-gradient(circle, #fff 0%, transparent 70%); top: 300px; left: 5%; }
        .deco3 { width: 60px; height: 60px; background: radial-gradient(circle, #fff 0%, transparent 70%); bottom: 150px; right: 10%; }

        .stars {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
        }

        .star {
            position: absolute;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            animation: twinkle 2s ease-in-out infinite;
        }

        .star:nth-child(1) { top: 15%; left: 10%; animation-delay: 0s; }
        .star:nth-child(2) { top: 25%; right: 15%; animation-delay: 0.5s; }
        .star:nth-child(3) { top: 55%; left: 8%; animation-delay: 1s; }
        .star:nth-child(4) { top: 70%; right: 12%; animation-delay: 1.5s; }

        @keyframes twinkle {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            z-index: 2;
            scrollbar-width: none;
        }

        .content-wrapper::-webkit-scrollbar { display: none; }

        .status-bar {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            padding-top: calc(15px + env(safe-area-inset-top, 0px));
            color: #5d8a66;
            font-size: 14px;
            font-weight: 500;
        }

        .time { font-size: 16px; letter-spacing: 1px; }
        .battery { display: flex; align-items: center; gap: 4px; }
        .battery-icon {
            width: 24px; height: 11px;
            border: 1.5px solid #5d8a66;
            border-radius: 3px;
            position: relative;
            display: flex; align-items: center; padding: 1px;
        }
        .battery-icon::after {
            content: ''; position: absolute; right: -4px;
            width: 2px; height: 5px; background: #5d8a66; border-radius: 0 2px 2px 0;
        }
        .battery-level {
            width: 85%; height: 100%;
            background: linear-gradient(90deg, #81c784, #4caf50);
            border-radius: 1px;
        }
        .battery-percent { font-size: 13px; }

        .avatar-section {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .avatar-frame {
            width: 85px; height: 85px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.9);
            overflow: hidden;
            background: linear-gradient(135deg, #fff 0%, #f0fff0 100%);
            box-shadow: 0 4px 20px rgba(129, 199, 132, 0.3), 0 0 0 5px rgba(255,255,255,0.3);
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .avatar-frame:hover {
            transform: scale(1.05);
        }
        
        .avatar-frame::before {
            content: '‚úø'; position: absolute; top: -8px; right: -5px;
            font-size: 16px; color: #f8bbd9; z-index: 10;
        }

        .avatar-frame img { width: 100%; height: 100%; object-fit: cover; }

        .input-section {
            flex-shrink: 0;
            padding: 0 45px;
            margin-bottom: 10px;
        }

        .text-input {
            width: 100%; padding: 12px 16px;
            border: none; border-radius: 20px;
            background: rgba(255,255,255,0.85);
            font-size: 14px; outline: none;
            box-shadow: 0 2px 12px rgba(129, 199, 132, 0.2), inset 0 1px 3px rgba(255,255,255,0.8);
            text-align: center; color: #5d8a66;
        }
        .text-input::placeholder { color: #a5d6a7; font-size: 13px; }

        .apps-container {
            flex-shrink: 0;
            position: relative;
            width: 360px;
            height: 380px;
            margin: 10px auto 0;
        }

        .app-icon {
            position: absolute;
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .app-icon:hover { transform: scale(1.15) translateY(-3px); }
        .app-icon:active { transform: scale(0.95); }

        .icon-img {
            width: 58px; height: 58px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.75);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(129, 199, 132, 0.2), 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden; transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .app-icon:hover .icon-img {
            box-shadow: 0 8px 24px rgba(129, 199, 132, 0.35), 0 2px 8px rgba(0,0,0,0.08);
        }

        /* ÁÆÄÁ¨îÁîªSVGÂõæÊ†áÊ†∑Âºè */
        .icon-img svg {
            width: 36px;
            height: 36px;
        }

        .icon-img img {
            width: 36px;
            height: 36px;
            object-fit: contain;
        }

        .app-name {
            margin-top: 6px; font-size: 11px; color: #5d8a66;
            text-align: center; max-width: 65px; font-weight: 500; letter-spacing: 0.3px;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }

        .app-icon:nth-child(1) { left: 105px; top: 20px; }
        .app-icon:nth-child(2) { right: 105px; top: 20px; }
        .app-icon:nth-child(3) { left: 55px; top: 80px; }
        .app-icon:nth-child(4) { right: 55px; top: 80px; }
        .app-icon:nth-child(5) { left: 90px; top: 155px; }
        .app-icon:nth-child(6) { right: 90px; top: 155px; }
        .app-icon:nth-child(7) { left: 50%; transform: translateX(-50%); top: 230px; }
        .app-icon:nth-child(7):hover { transform: translateX(-50%) scale(1.15) translateY(-3px); }

        .bottom-area {
            margin-top: auto;
            flex-shrink: 0;
            width: 100%;
            padding-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .bottom-apps {
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            width: 100%;
            padding: 10px 20px;
        }

        .bottom-app {
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bottom-app:hover { transform: scale(1.15) translateY(-3px); }
        .bottom-app:active { transform: scale(0.95); }
        
        .bottom-app .icon-img {
            width: 58px; height: 58px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.75);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(129, 199, 132, 0.2), 0 1px 3px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .bottom-app:hover .icon-img {
            box-shadow: 0 8px 24px rgba(129, 199, 132, 0.35), 0 2px 8px rgba(0,0,0,0.08);
        }

        .bottom-app .app-name {
            margin-top: 6px; font-size: 11px; color: #5d8a66;
            text-align: center; font-weight: 500; letter-spacing: 0.3px;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }

        .bottom-decoration {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: rgba(129, 199, 132, 0.4);
        }
        .dot.active {
            width: 18px; border-radius: 9px;
            background: linear-gradient(90deg, #81c784, #66bb6a);
        }

        .bottom-bar {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 5px;
            background: rgba(93, 138, 102, 0.3);
            border-radius: 3px;
            z-index: 10;
        }

        /* ================= ÈÄöÁî®Ê®°ÊÄÅÊ°ÜÊ†∑Âºè ================= */
        .modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: flex-end;
            backdrop-filter: blur(3px);
        }

        .modal.full-screen {
            align-items: stretch;
        }

        .modal-content {
            background: #fff;
            width: 100%;
            height: 85%;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }

        .modal-content.full-height {
            height: 100%;
            border-radius: 0;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .modal-header h2 {
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn {
            font-size: 20px;
            color: #5d8a66;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .back-btn:hover {
            transform: translateX(-3px);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-btn {
            font-size: 22px;
            color: #5d8a66;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .header-btn:hover {
            transform: scale(1.1);
        }

        .close-btn {
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 5px;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .setting-section {
            margin-bottom: 25px;
            background: #f9fcf9;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e8f5e9;
        }

        .setting-section h3 {
            font-size: 14px;
            color: #5d8a66;
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 8px;
            background: #fff;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: #81c784;
            outline: none;
        }

        .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 8px;
            background: #fff;
            transition: border-color 0.3s;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .form-textarea:focus {
            border-color: #81c784;
            outline: none;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary {
            background: #81c784;
            color: white;
        }
        .btn-primary:hover { background: #66bb6a; }

        .btn-secondary {
            background: #e0e0e0;
            color: #555;
        }
        .btn-secondary:hover { background: #d5d5d5; }

        .btn-danger {
            background: #ef5350;
            color: white;
        }
        .btn-danger:hover { background: #e53935; }

        .form-select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
        }

        .switch-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .switch-row span {
            font-size: 13px;
            color: #555;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #81c784;
        }

        input:checked + .slider:before {
            transform: translateX(18px);
        }

        .modal-footer {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            text-align: center;
            flex-shrink: 0;
        }

        .save-all-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #81c784, #4caf50);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }
        .save-all-btn:active {
            transform: scale(0.98);
        }

        .hidden-area {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }

        .preset-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .preset-tag {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            border: 1px solid #c8e6c9;
        }
        .preset-tag:hover {
            background: #c8e6c9;
        }

        /* ================= ËßíËâ≤ÂàóË°®Ê†∑Âºè ================= */
        .character-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .character-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9fcf9;
            border-radius: 12px;
            border: 1px solid #e8f5e9;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .character-item:hover {
            background: #e8f5e9;
            transform: translateX(5px);
        }

        .character-item.long-press {
            background: #ffebee;
            border-color: #ffcdd2;
            transform: scale(0.98);
        }

        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 12px;
            border: 2px solid #81c784;
            flex-shrink: 0;
        }

        .character-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-info {
            flex: 1;
            min-width: 0;
        }

        .character-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .character-desc {
            font-size: 12px;
            color: #888;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .character-delete {
            padding: 8px;
            color: #ef5350;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .character-delete:hover {
            opacity: 1;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #aaa;
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
            text-align: center;
            line-height: 1.6;
        }

        /* ================= ‰∏ñÁïå‰π¶ÂàóË°®Ê†∑Âºè ================= */
        .worldbook-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9fcf9;
            border-radius: 12px;
            border: 1px solid #e8f5e9;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .worldbook-item:hover {
            background: #e8f5e9;
        }

        .worldbook-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #81c784, #4caf50);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
            font-size: 20px;
        }

        .worldbook-info {
            flex: 1;
        }

        .worldbook-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .worldbook-entries {
            font-size: 11px;
            color: #888;
        }

        /* ================= ËÅäÂ§©ÁïåÈù¢Ê†∑Âºè ================= */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #f5f5f5;
            position: relative;
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px;
            padding-top: calc(15px + env(safe-area-inset-top, 0px));
            background: #fff;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            z-index: 10;
        }

        .chat-header .back-btn {
            margin-right: 10px;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 10px;
        }

        .chat-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .chat-header-status {
            font-size: 12px;
            color: #888;
        }

        .chat-header-settings {
            padding: 10px;
            font-size: 20px;
            color: #5d8a66;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chat-header-settings:hover {
            transform: rotate(45deg);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            display: flex;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.ai {
            align-self: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            margin: 0 8px;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #81c784, #66bb6a);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.ai .message-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message-time {
            font-size: 10px;
            color: #aaa;
            margin-top: 4px;
            padding: 0 5px;
        }

        .message.user .message-time {
            text-align: right;
        }

        /* ËØ≠Èü≥Ê∂àÊÅØÊ†∑Âºè */
        .voice-bubble {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 18px;
            background: white;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
            min-width: 100px;
            transition: background 0.2s;
        }

        .voice-bubble:hover {
            background: #f5f5f5;
        }

        .voice-bubble.playing {
            background: #e8f5e9;
        }

        .voice-icon {
            font-size: 18px;
            animation: none;
        }

        .voice-bubble.playing .voice-icon {
            animation: voiceWave 1s infinite;
        }

        @keyframes voiceWave {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .voice-duration {
            font-size: 12px;
            color: #888;
        }

        .voice-wave {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 20px;
        }

        .voice-wave span {
            width: 3px;
            background: #81c784;
            border-radius: 2px;
            animation: wave 0.5s ease-in-out infinite;
        }

        .voice-wave span:nth-child(1) { height: 8px; animation-delay: 0s; }
        .voice-wave span:nth-child(2) { height: 14px; animation-delay: 0.1s; }
        .voice-wave span:nth-child(3) { height: 10px; animation-delay: 0.2s; }
        .voice-wave span:nth-child(4) { height: 16px; animation-delay: 0.3s; }
        .voice-wave span:nth-child(5) { height: 12px; animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.5); }
        }

        .chat-input-area {
            display: flex;
            align-items: flex-end;
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
            background: #fff;
            border-top: 1px solid #eee;
            gap: 10px;
            flex-shrink: 0;
            z-index: 10;
            transition: transform 0.3s ease;
        }

        .chat-input {
            flex: 1;
            min-height: 36px;
            max-height: 100px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 18px;
            font-size: 14px;
            resize: none;
            outline: none;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #81c784;
        }

        .chat-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .chat-btn.star-btn {
            background: linear-gradient(135deg, #ffd54f, #ffb300);
            color: white;
            font-size: 18px;
        }

        .chat-btn.star-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 179, 0, 0.4);
        }

        .chat-btn.star-btn.loading {
            animation: pulse 1s infinite;
            pointer-events: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.95); }
        }

        .chat-btn.send-btn {
            background: linear-gradient(135deg, #81c784, #4caf50);
            color: white;
            font-size: 16px;
        }

        .chat-btn.send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        /* ================= ËßíËâ≤ÁºñËæëÊ†∑Âºè ================= */
        .avatar-upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #81c784;
            margin-bottom: 10px;
            cursor: pointer;
            position: relative;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-preview:hover::after {
            content: 'üì∑';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .inline-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .inline-input .form-input {
            flex: 1;
            margin-bottom: 0;
        }

        .inline-input span {
            font-size: 13px;
            color: #555;
            white-space: nowrap;
        }

        .tokens-display {
            background: #e8f5e9;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }

        .tokens-display .label {
            font-size: 12px;
            color: #666;
        }

        .tokens-display .value {
            font-size: 20px;
            font-weight: bold;
            color: #4caf50;
        }

        /* ================= ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• ================= */
        .hidden-input {
            display: none;
        }

        /* ================= ÊªöÂä®Êù°ÁæéÂåñ ================= */
        .modal-body::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .modal-body::-webkit-scrollbar-track,
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-body::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 2px;
        }

        /* ================= ‰∏ñÁïå‰π¶Êù°ÁõÆÁºñËæë ================= */
        .entry-item {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .entry-keywords {
            font-size: 12px;
            color: #81c784;
            font-weight: 600;
        }

        .entry-content {
            font-size: 13px;
            color: #555;
            line-height: 1.5;
        }

        .entry-actions {
            display: flex;
            gap: 8px;
        }

        .entry-btn {
            padding: 4px 8px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .entry-btn.edit {
            background: #e3f2fd;
            color: #1976d2;
        }

        .entry-btn.delete {
            background: #ffebee;
            color: #d32f2f;
        }

        /* Âä†ËΩΩÊèêÁ§∫ */
        .loading-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 9999;
            display: none;
        }

        .loading-toast.show {
            display: block;
        }

        /* ÊâìÂ≠óÊåáÁ§∫Âô® */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #ccc;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* PWAÂÆâË£ÖÊèêÁ§∫ */
        .pwa-install-prompt {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 9999;
            max-width: 90%;
            text-align: center;
        }

        .pwa-install-prompt.show {
            display: block;
            animation: slideUpPrompt 0.3s ease-out;
        }

        @keyframes slideUpPrompt {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .pwa-install-prompt p {
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }

        .pwa-install-prompt .btn-row {
            justify-content: center;
        }

        /* Ê∏©Â∫¶ÊªëÂùóÊ†∑Âºè */
        .temperature-slider {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .temperature-slider input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #81c784, #ffb300, #ef5350);
            border-radius: 3px;
            outline: none;
        }

        .temperature-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid #81c784;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .temperature-value {
            min-width: 40px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #5d8a66;
        }

        /* Âà†Èô§Á°ÆËÆ§ÂºπÁ™ó */
        .delete-confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        .delete-confirm-overlay.show {
            display: flex;
        }

        .delete-confirm-box {
            background: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            max-width: 280px;
            animation: popIn 0.2s ease-out;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .delete-confirm-box h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
        }

        .delete-confirm-box p {
            font-size: 13px;
            color: #666;
            margin-bottom: 20px;
        }

        .delete-confirm-box .btn-row {
            justify-content: center;
        }

        /* ================= Â§ñËßÇËÆæÁΩÆÂõæÊ†áÁºñËæëÊ†∑Âºè ================= */
        .icon-edit-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .icon-edit-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .icon-edit-item:hover {
            transform: scale(1.05);
        }

        .icon-edit-preview {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
            border: 2px dashed #ccc;
            overflow: hidden;
            position: relative;
        }

        .icon-edit-preview:hover {
            border-color: #81c784;
        }

        .icon-edit-preview svg,
        .icon-edit-preview img {
            width: 30px;
            height: 30px;
        }

        .icon-edit-preview::after {
            content: '‚úèÔ∏è';
            position: absolute;
            bottom: -2px;
            right: -2px;
            font-size: 10px;
            background: white;
            border-radius: 50%;
            padding: 2px;
        }

        .icon-edit-name {
            font-size: 10px;
            color: #666;
            text-align: center;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bg-preview-box {
            width: 100%;
            height: 120px;
            border-radius: 12px;
            background: linear-gradient(160deg, #e8f8f5 0%, #d5f5e3 25%, #abebc6 50%, #d5f5e3 75%, #e8f8f5 100%);
            background-size: cover;
            background-position: center;
            border: 2px dashed #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .bg-preview-box:hover {
            border-color: #81c784;
        }

        .bg-preview-box span {
            background: rgba(255,255,255,0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: #5d8a66;
        }

        .main-avatar-edit {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #81c784;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            margin: 0 auto 10px;
        }

        .main-avatar-edit img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .main-avatar-edit:hover::after {
            content: 'üì∑';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* ÂõæÊ†áÁºñËæëÂºπÁ™ó */
        .icon-edit-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 300;
            width: 90%;
            max-width: 300px;
            display: none;
        }

        .icon-edit-popup.show {
            display: block;
            animation: popIn 0.2s ease-out;
        }

        .icon-edit-popup h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .icon-edit-popup .current-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            border-radius: 14px;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .icon-edit-popup .current-icon svg,
        .icon-edit-popup .current-icon img {
            width: 40px;
            height: 40px;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 250;
            display: none;
        }

        .popup-overlay.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="phone">
        <!-- Ëá™ÂÆö‰πâËÉåÊôØ -->
        <div class="phone-bg" id="phone-bg"></div>

        <!-- Ë£ÖÈ•∞ÂÖÉÁ¥† -->
        <div class="decoration deco1"></div>
        <div class="decoration deco2"></div>
        <div class="decoration deco3"></div>
        
        <div class="stars">
            <span class="star">‚ú¶</span>
            <span class="star">‚úß</span>
            <span class="star">‚ú¶</span>
            <span class="star">‚úß</span>
        </div>

        <!-- ‰∏ªÁïåÈù¢ÂÜÖÂÆπ -->
        <div class="content-wrapper" id="main-screen">
            <div class="status-bar">
                <div class="time" id="current-time">09:41</div>
                <div class="battery">
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                    <span class="battery-percent">85%</span>
                </div>
            </div>

            <div class="avatar-section">
                <div class="avatar-frame" onclick="openAppearanceSettings()">
                    <img id="main-avatar" src="https://api.dicebear.com/7.x/lorelei/png?seed=cute&backgroundColor=d1fae5" alt="Â§¥ÂÉè">
                </div>
            </div>

            <div class="input-section">
                <input type="text" class="text-input" placeholder="‚úé ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑËØù...">
            </div>

            <div class="apps-container">
                <!-- ËßíËâ≤ - ÂèØÁà±Â∞èËÑëË¢ã -->
                <div class="app-icon" id="character-icon">
                    <div class="icon-img" id="icon-character">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="45" r="28" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <circle cx="40" cy="40" r="4" fill="#5d8a66"/>
                            <circle cx="60" cy="40" r="4" fill="#5d8a66"/>
                            <path d="M40 55 Q50 65 60 55" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/>
                            <path d="M30 25 Q35 15 45 20" stroke="#5d8a66" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                            <path d="M70 25 Q65 15 55 20" stroke="#5d8a66" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                            <circle cx="38" cy="38" r="1.5" fill="white"/>
                            <circle cx="58" cy="38" r="1.5" fill="white"/>
                            <ellipse cx="32" cy="50" rx="4" ry="3" fill="#ffcdd2" opacity="0.6"/>
                            <ellipse cx="68" cy="50" rx="4" ry="3" fill="#ffcdd2" opacity="0.6"/>
                        </svg>
                    </div>
                    <span class="app-name">ËßíËâ≤</span>
                </div>

                <!-- ‰∏ñÁïå‰π¶ - ÊâìÂºÄÁöÑ‰π¶Êú¨ -->
                <div class="app-icon" id="worldbook-icon">
                    <div class="icon-img" id="icon-worldbook">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M50 25 L50 80" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M50 25 Q30 20 15 30 L15 75 Q30 68 50 75" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/>
                            <path d="M50 25 Q70 20 85 30 L85 75 Q70 68 50 75" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/>
                            <path d="M22 40 L42 38" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M22 50 L42 48" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M22 60 L38 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M58 38 L78 40" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M58 48 L78 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M62 58 L78 60" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="50" cy="20" r="5" fill="#ffeb3b" stroke="#5d8a66" stroke-width="1.5"/>
                        </svg>
                    </div>
                    <span class="app-name">‰∏ñÁïå‰π¶</span>
                </div>

                <!-- Ê∑òÂÆù - Ë¥≠Áâ©ËΩ¶ -->
                <div class="app-icon">
                    <div class="icon-img" id="icon-taobao">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 30 L30 30 L40 65 L75 65 L82 40 L35 40" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="45" cy="78" r="6" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <circle cx="68" cy="78" r="6" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <path d="M45 50 L45 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M55 48 L55 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M65 50 L65 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M25 25 Q20 20 25 15" stroke="#ffb74d" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span class="app-name">Ê∑òÂÆù</span>
                </div>

                <!-- APIËÆæÁΩÆ - Ê≠™Ê≠™Êâ≠Êâ≠ÁöÑAPIÂ≠ó -->
                <div class="app-icon" id="api-settings-icon">
                    <div class="icon-img" id="icon-api">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <text x="12" y="58" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(-8 20 50)">A</text>
                            <text x="35" y="62" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(5 45 55)">P</text>
                            <text x="58" y="55" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(-3 65 50)">I</text>
                            <path d="M75 35 Q80 30 85 35 Q90 40 85 45 Q80 50 75 45 Q70 40 75 35" stroke="#ffb74d" stroke-width="2" fill="#fff59d"/><circle cx="20" cy="30" r="4" fill="#81c784"/><circle cx="80" cy="65" r="3" fill="#81c784"/><path d="M25 70 L35 75" stroke="#5d8a66" stroke-width="1.5" stroke-linecap="round"/><path d="M30 73 L32 68" stroke="#5d8a66" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span class="app-name">APIËÆæÁΩÆ</span>
                </div>

                <!-- Â§ñËßÇËÆæÁΩÆ - Ë∞ÉËâ≤Êùø -->
                <div class="app-icon" id="appearance-icon">
                    <div class="icon-img" id="icon-appearance">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="50" cy="50" rx="35" ry="32" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <circle cx="35" cy="38" r="7" fill="#ff8a80"/>
                            <circle cx="55" cy="32" r="6" fill="#ffcc80"/>
                            <circle cx="70" cy="45" r="6" fill="#a5d6a7"/>
                            <circle cx="65" cy="62" r="5" fill="#90caf9"/>
                            <circle cx="40" cy="60" r="8" fill="white" stroke="#5d8a66" stroke-width="2"/>
                            <path d="M75 75 L90 90" stroke="#5d8a66" stroke-width="4" stroke-linecap="round"/>
                            <path d="M88 82 L92 88 L86 92" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="app-name">Â§ñËßÇËÆæÁΩÆ</span>
                </div>

                <!-- ÁúãÁúã‰Ω† - ÁúºÁùõ -->
                <div class="app-icon">
                    <div class="icon-img" id="icon-look">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="50" cy="50" rx="35" ry="22" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <circle cx="50" cy="50" r="15" stroke="#5d8a66" stroke-width="2.5" fill="none"/>
                            <circle cx="50" cy="50" r="8" fill="#5d8a66"/>
                            <circle cx="46" cy="46" r="3" fill="white"/>
                            <path d="M20 35 Q15 30 20 25" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M80 35 Q85 30 80 25" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M15 50 L20 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M80 50 L85 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span class="app-name">ÁúãÁúã‰Ω†</span>
                </div>

                <!-- ‰ªäÂ§©ÂÅö‰ªÄ‰πà - Êó•ÂéÜ -->
                <div class="app-icon">
                    <div class="icon-img" id="icon-calendar">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="18" y="25" width="64" height="55" rx="8" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <path d="M18 42 L82 42" stroke="#5d8a66" stroke-width="2"/>
                            <path d="M35 18 L35 32" stroke="#5d8a66" stroke-width="3" stroke-linecap="round"/>
                            <path d="M65 18 L65 32" stroke="#5d8a66" stroke-width="3" stroke-linecap="round"/>
                            <text x="50" y="68" font-family="Comic Sans MS, cursive" font-size="24" fill="#5d8a66" text-anchor="middle">?</text>
                            <circle cx="72" cy="28" r="5" fill="#ff8a80"/>
                        </svg>
                    </div>
                    <span class="app-name">‰ªäÂ§©ÂÅö‰ªÄ‰πà</span>
                </div>
            </div>

            <div class="bottom-area">
                <div class="bottom-apps">
                    <!-- Êü•ÊâãÊú∫ - ÊâãÊú∫ -->
                    <div class="bottom-app">
                        <div class="icon-img" id="icon-phone">
                            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="28" y="15" width="44" height="70" rx="8" stroke="#5d8a66" stroke-width="3" fill="none"/>
                                <path d="M28 25 L72 25" stroke="#5d8a66" stroke-width="2"/>
                                <path d="M28 72 L72 72" stroke="#5d8a66" stroke-width="2"/>
                                <circle cx="50" cy="80" r="4" stroke="#5d8a66" stroke-width="2" fill="none"/>
                                <path d="M42 20 L58 20" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                                <path d="M38 45 L48 55 L62 38" stroke="#81c784" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span class="app-name">Êü•ÊâãÊú∫</span>
                    </div>

                    <!-- Âõ¥ËÑñ - ÂØπËØùÊ°Ü -->
                    <div class="bottom-app">
                        <div class="icon-img" id="icon-weibo">
                            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 30 Q20 20 30 20 L70 20 Q80 20 80 30 L80 55 Q80 65 70 65 L35 65 L22 78 L25 65 L30 65 Q20 65 20 55 Z" stroke="#5d8a66" stroke-width="3" fill="none"/>
                                <circle cx="38" cy="42" r="4" fill="#5d8a66"/>
                                <circle cx="52" cy="42" r="4" fill="#5d8a66"/>
                                <circle cx="66" cy="42" r="4" fill="#5d8a66"/>
                            </svg>
                        </div>
                        <span class="app-name">Âõ¥ËÑñ</span>
                    </div>

                    <!-- BO4 - ‰øùÁïôÂéüÊ†∑Âºè -->
                    <div class="bottom-app">
                        <div class="icon-img" id="icon-bo4">
                            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <text x="50" y="62" font-family="Georgia, serif" font-size="28" fill="#990000" text-anchor="middle" font-weight="bold">BO4</text>
                                <circle cx="20" cy="25" r="4" fill="#ffb74d"/>
                                <circle cx="80" cy="75" r="3" fill="#ffb74d"/>
                            </svg>
                        </div>
                        <span class="app-name">BO4</span>
                    </div>

                    <!-- Â§ßÂâßÂú∫ - Èù¢ÂÖ∑ -->
                    <div class="bottom-app">
                        <div class="icon-img" id="icon-theater">
                            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <ellipse cx="35" cy="45" rx="22" ry="28" stroke="#5d8a66" stroke-width="2.5" fill="none"/>
                                <ellipse cx="65" cy="45" rx="22" ry="28" stroke="#5d8a66" stroke-width="2.5" fill="none"/>
                                <circle cx="28" cy="38" r="4" fill="#5d8a66"/>
                                <circle cx="42" cy="38" r="4" fill="#5d8a66"/>
                                <path d="M25 55 Q35 65 45 55" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round"/>
                                <circle cx="58" cy="38" r="4" fill="#5d8a66"/>
                                <circle cx="72" cy="38" r="4" fill="#5d8a66"/>
                                <path d="M55 55 Q65 48 75 55" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round"/>
                                <path d="M35 75 Q50 85 65 75" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <span class="app-name">Â§ßÂâßÂú∫</span>
                    </div>
                </div>

                <div class="bottom-decoration">
                    <div class="dot"></div>
                    <div class="dot active"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>
        
        <div class="bottom-bar"></div>

        <!-- Âä†ËΩΩÊèêÁ§∫ -->
        <div id="loading-toast" class="loading-toast">Â§ÑÁêÜ‰∏≠...</div>

        <!-- Âà†Èô§Á°ÆËÆ§ÂºπÁ™ó -->
        <div id="delete-confirm-overlay" class="delete-confirm-overlay">
            <div class="delete-confirm-box">
                <h3>üóëÔ∏è Âà†Èô§ËßíËâ≤</h3>
                <p id="delete-confirm-text">Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËßíËâ≤ÂêóÔºüËÅäÂ§©ËÆ∞ÂΩï‰πü‰ºö‰∏ÄÂπ∂Âà†Èô§„ÄÇ</p>
                <div class="btn-row">
                    <button class="btn btn-danger" id="confirm-delete-btn">Âà†Èô§</button>
                    <button class="btn btn-secondary" onclick="hideDeleteConfirm()">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>

        <!-- PWAÂÆâË£ÖÊèêÁ§∫ -->
        <div id="pwa-install-prompt" class="pwa-install-prompt">
            <p>üì± Â∞ÜÊ≠§Â∫îÁî®Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπïÔºåËé∑ÂæóÊõ¥Â•Ω‰ΩìÈ™åÔºÅ</p>
            <div class="btn-row">
                <button class="btn btn-primary" id="pwa-install-btn">Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπï</button>
                <button class="btn btn-secondary" onclick="dismissPWAPrompt()">Á®çÂêéÂÜçËØ¥</button>
            </div>
        </div>

        <!-- ÂõæÊ†áÁºñËæëÂºπÁ™óÈÅÆÁΩ© -->
        <div id="popup-overlay" class="popup-overlay" onclick="closeIconEditPopup()"></div>

        <!-- ÂõæÊ†áÁºñËæëÂºπÁ™ó -->
        <div id="icon-edit-popup" class="icon-edit-popup">
            <h3 id="icon-edit-title">ÁºñËæëÂõæÊ†á</h3>
            <div class="current-icon" id="icon-edit-preview"></div>
            <div class="form-group">
                <label class="form-label">ÂõæÊ†áURL</label>
                <input type="text" id="icon-url-input" class="form-input" placeholder="ËæìÂÖ•ÂõæÁâáURL">
            </div>
            <div class="btn-row" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="document.getElementById('icon-file-input').click()">Êú¨Âú∞‰∏ä‰º†</button>
                <button class="btn btn-danger" onclick="resetIconToDefault()">ÊÅ¢Â§çÈªòËÆ§</button>
            </div>
            <div class="btn-row" style="margin-top: 15px;">
                <button class="btn btn-primary" style="flex:1" onclick="saveIconEdit()">Á°ÆÂÆö</button>
                <button class="btn btn-secondary" style="flex:1" onclick="closeIconEditPopup()">ÂèñÊ∂à</button>
            </div>
        </div>

        <!-- ================= ËßíËâ≤ÂàóË°®Ê®°ÊÄÅÊ°Ü ================= -->
        <div id="character-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeModal('character-modal')">‚Üê</span>
                        <h2>ËßíËâ≤ÂàóË°®</h2>
                    </div>
                    <div class="header-right">
                        <span class="header-btn" onclick="createNewCharacter()">Ôºã</span>
                        <span class="header-btn" onclick="document.getElementById('character-import-input').click()">üì§</span>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="character-list" class="character-list">
                        <!-- ËßíËâ≤ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= ËßíËâ≤ÁºñËæë/ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="character-edit-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeCharacterEdit()">‚Üê</span>
                        <h2 id="character-edit-title">ËßíËâ≤ËÆæÁΩÆ</h2>
                    </div>
                    <div class="header-right">
                        <span class="header-btn" onclick="deleteCurrentCharacter()" style="color: #ef5350;">üóë</span>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- ËßíËâ≤Â§¥ÂÉè -->
                    <div class="avatar-upload-section">
                        <div class="avatar-preview" onclick="document.getElementById('char-avatar-input').click()">
                            <img id="char-avatar-preview" src="https://api.dicebear.com/7.x/lorelei/png?seed=default" alt="ËßíËâ≤Â§¥ÂÉè">
                        </div>
                        <span style="font-size: 12px; color: #888;">ÁÇπÂáªÊõ¥Êç¢Â§¥ÂÉè</span>
                    </div>

                    <!-- ËßíËâ≤‰ø°ÊÅØ -->
                    <div class="setting-section">
                        <h3>üë§ ËßíËâ≤‰ø°ÊÅØ</h3>
                        <div class="form-group">
                            <label class="form-label">ËßíËâ≤Â§áÊ≥®ÔºàÂèåÊñπÂèØËßÅÔºâ</label>
                            <input type="text" id="char-nickname" class="form-input" placeholder="ËßíËâ≤ÁöÑÂ§áÊ≥®ÂêçÁß∞">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ËßíËâ≤Êú¨ÂêçÔºàAIËØªÂèñÔºâ</label>
                            <input type="text" id="char-name" class="form-input" placeholder="ËßíËâ≤ÁöÑÁúüÂÆûÂêçÂ≠ó">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ËßíËâ≤‰∫∫ËÆæ</label>
                            <textarea id="char-persona" class="form-textarea" rows="5" placeholder="ÊèèËø∞ËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅËÉåÊôØ„ÄÅËØ¥ËØùÊñπÂºèÁ≠â..." oninput="updateTokensEstimate()"></textarea>
                        </div>
                    </div>

                    <!-- Áî®Êà∑‰ø°ÊÅØ -->
                    <div class="setting-section">
                        <h3>üôã Áî®Êà∑‰ø°ÊÅØ</h3>
                        <div class="avatar-upload-section">
                            <div class="avatar-preview" style="width: 60px; height: 60px;" onclick="document.getElementById('user-avatar-input').click()">
                                <img id="user-avatar-preview" src="https://api.dicebear.com/7.x/lorelei/png?seed=user" alt="Áî®Êà∑Â§¥ÂÉè">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Áî®Êà∑Â§áÊ≥®ÔºàAIÂèØËßÅÔºåAIÂèØÊîπÂÜôÔºâ</label>
                            <input type="text" id="user-nickname" class="form-input" placeholder="AIÁúãÂà∞ÁöÑ‰Ω†ÁöÑÂ§áÊ≥®">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Áî®Êà∑Êú¨ÂêçÔºàAIËØªÂèñÔºâ</label>
                            <input type="text" id="user-name" class="form-input" placeholder="‰Ω†ÁöÑÂêçÂ≠ó">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Áî®Êà∑‰∫∫ËÆæ</label>
                            <textarea id="user-persona" class="form-textarea" rows="3" placeholder="ÊèèËø∞‰Ω†Ëá™Â∑±..." oninput="updateTokensEstimate()"></textarea>
                        </div>
                    </div>

                    <!-- ÂÖ≥ËÅî‰∏ñÁïå‰π¶ -->
                    <div class="setting-section">
                        <h3>üìö ÂÖ≥ËÅî‰∏ñÁïå‰π¶</h3>
                        <div class="btn-row">
                            <select id="char-worldbook" class="form-select" onchange="updateTokensEstimate()">
                                <option value="">‰∏çÂÖ≥ËÅî‰∏ñÁïå‰π¶</option>
                            </select>
                        </div>
                    </div>

                    <!-- Token‰º∞ÁÆó -->
                    <div class="tokens-display">
                        <div class="label">È¢Ñ‰º∞‰∏ä‰∏ãÊñáÊÄªTokens</div>
                        <div class="value" id="tokens-estimate">0</div>
                    </div>

                    <!-- ËÆ∞ÂøÜËÆæÁΩÆ -->
                    <div class="setting-section">
                        <h3>üß† ËÆ∞ÂøÜËÆæÁΩÆ</h3>
                        <div class="form-group">
                            <label class="form-label">ËßíËâ≤ËÆ∞ÂøÜÔºàAIÊØèÊ¨°Âõ∫ÂÆöËØªÂèñÁöÑËÅäÂ§©ËÆ∞ÂΩïÊù°Êï∞Ôºâ</label>
                            <input type="number" id="memory-count" class="form-input" placeholder="‰æãÂ¶Ç: 200" value="50">
                        </div>
                        
                        <div class="switch-row">
                            <span>ÊòØÂê¶Ëá™Âä®ÊÄªÁªì</span>
                            <label class="switch">
                                <input type="checkbox" id="auto-summary-switch" onchange="toggleArea('summary-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="summary-settings" class="hidden-area">
                            <div class="form-group">
                                <label class="form-label">ÊØèÈöîÂ§öÂ∞ëÊù°ËÅäÂ§©ËÆ∞ÂΩïËøõË°åÊÄªÁªì</label>
                                <input type="number" id="summary-interval" class="form-input" placeholder="‰æãÂ¶Ç: 100" value="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÊÄªÁªìÊèêÁ§∫ËØç</label>
                                <textarea id="summary-prompt" class="form-textarea" rows="2">‰ª•ËßíËâ≤Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÂèôËø∞Êàë‰ª¨ËÅäÂ§©‰∏≠ÊèêÂà∞ÁöÑ‰∫ãÊÉÖÔºå100Â≠óÂÜÖ</textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÊâãÂä®ÊÄªÁªìËåÉÂõ¥</label>
                                <div class="inline-input">
                                    <input type="number" id="summary-start" class="form-input" placeholder="ÂºÄÂßã" style="width: 80px;">
                                    <span>Âà∞</span>
                                    <input type="number" id="summary-end" class="form-input" placeholder="ÁªìÊùü" style="width: 80px;">
                                    <button class="btn btn-primary" onclick="manualSummary()">ÊÄªÁªì</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Êó∂Èó¥‰∏éÂ§©Ê∞î -->
                    <div class="setting-section">
                        <h3>üåç ÁéØÂ¢ÉÊÑüÁü•</h3>
                        <div class="switch-row">
                            <span>ÊÑüÁü•ÁúüÂÆûÊó∂Èó¥</span>
                            <label class="switch">
                                <input type="checkbox" id="time-aware-switch" onchange="toggleArea('time-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="time-settings" class="hidden-area">
                            <div class="form-group">
                                <label class="form-label">Êó∂Âå∫ÈÄâÊã©</label>
                                <select id="timezone-select" class="form-select" style="width: 100%;">
                                    <option value="Asia/Shanghai">‰∏≠ÂõΩÊ†áÂáÜÊó∂Èó¥ (UTC+8)</option>
                                    <option value="Asia/Tokyo">Êó•Êú¨Ê†áÂáÜÊó∂Èó¥ (UTC+9)</option>
                                    <option value="America/New_York">ÁæéÂõΩ‰∏úÈÉ®Êó∂Èó¥ (UTC-5)</option>
                                    <option value="America/Los_Angeles">ÁæéÂõΩË•øÈÉ®Êó∂Èó¥ (UTC-8)</option>
                                    <option value="Europe/London">Ëã±ÂõΩÊó∂Èó¥ (UTC+0)</option>
                                    <option value="Europe/Paris">‰∏≠Ê¨ßÊó∂Èó¥ (UTC+1)</option>
                                </select>
                            </div>
                        </div>

                        <div class="switch-row">
                            <span>ÊÑüÁü•Â§©Ê∞î</span>
                            <label class="switch">
                                <input type="checkbox" id="weather-aware-switch" onchange="toggleArea('weather-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="weather-settings" class="hidden-area">
                            <div class="form-group">
                                <label class="form-label">ÂΩìÂâçÂ§©Ê∞î</label>
                                <input type="text" id="weather-input" class="form-input" placeholder="‰æãÂ¶Ç: Êô¥Â§©/‰∏ãÈõ®/‰∏ãÈõ™">
                            </div>
                        </div>
                    </div>

                    <!-- Á∫ø‰∏ãÊ®°Âºè -->
                    <div class="setting-section">
                        <h3>üìù Á∫ø‰∏ãÊ®°Âºè</h3>
                        <div class="switch-row">
                            <span>ÂêØÁî®Á∫ø‰∏ãÊ®°ÂºèÔºàÈïøÊñáËæìÂá∫Ôºâ</span>
                            <label class="switch">
                                <input type="checkbox" id="offline-mode-switch" onchange="toggleArea('offline-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="offline-settings" class="hidden-area">
                            <div class="form-group">
                                <label class="form-label">ÈïøÊñáÂ≠óÊï∞</label>
                                <input type="number" id="offline-length" class="form-input" placeholder="‰æãÂ¶Ç: 2000" value="1000">
                            </div>
                        </div>
                    </div>

                    <!-- Â§ñËßÇËÆæÁΩÆ -->
                    <div class="setting-section">
                        <h3>üé® Â§ñËßÇËÆæÁΩÆ</h3>
                        <div class="form-group">
                            <label class="form-label">Â≠ó‰ΩìÂ§ßÂ∞è</label>
                            <div class="inline-input">
                                <input type="range" id="font-size-range" class="range-input" min="12" max="20" value="14" style="flex:1" oninput="document.getElementById('font-size-value').textContent = this.value + 'px'">
                                <span id="font-size-value" style="width: 40px; text-align: right;">14px</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ËÅäÂ§©ËÉåÊôØÔºàURLÊàñÊú¨Âú∞‰∏ä‰º†Ôºâ</label>
                            <div class="btn-row">
                                <input type="text" id="chat-bg-url" class="form-input" placeholder="ËæìÂÖ•ÂõæÁâáURL" style="flex: 1; margin-bottom: 0;">
                                <button class="btn btn-secondary" onclick="document.getElementById('chat-bg-input').click()">Êú¨Âú∞</button>
                            </div>
                        </div>
                    </div>

                    <!-- ÂØºÂÖ•ÂØºÂá∫ -->
                    <div class="setting-section">
                        <h3>üíæ ËÅäÂ§©ËÆ∞ÂΩï</h3>
                        <div class="btn-row">
                            <button class="btn btn-primary" onclick="exportChatHistory()">ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('chat-import-input').click()">ÂØºÂÖ•ËÅäÂ§©ËÆ∞ÂΩï</button>
                        </div>
                        <div class="btn-row" style="margin-top: 10px;">
                            <button class="btn btn-danger" onclick="clearChatHistory()">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveCharacter()">‰øùÂ≠òËßíËâ≤ËÆæÁΩÆ</button>
                </div>
            </div>
        </div>

        <!-- ================= ËÅäÂ§©ÁïåÈù¢Ê®°ÊÄÅÊ°Ü ================= -->
        <div id="chat-modal" class="modal full-screen">
            <div class="modal-content full-height" style="padding: 0; background: #f5f5f5;">
                <div class="chat-container" id="chat-container">
                    <div class="chat-header">
                        <span class="back-btn" onclick="closeChat()">‚Üê</span>
                        <div class="chat-header-avatar">
                            <img id="chat-char-avatar" src="https://api.dicebear.com/7.x/lorelei/png?seed=default" alt="ËßíËâ≤">
                        </div>
                        <div class="chat-header-info">
                            <div class="chat-header-name" id="chat-char-name">ËßíËâ≤Âêç</div>
                            <div class="chat-header-status" id="chat-status">Âú®Á∫ø</div>
                        </div>
                        <span class="chat-header-settings" onclick="openCharacterSettings()">‚öôÔ∏è</span>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <!-- Ê∂àÊÅØÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                    <div class="chat-input-area" id="chat-input-area">
                        <textarea class="chat-input" id="chat-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1" oninput="autoResize(this)"></textarea>
                        <button class="chat-btn star-btn" id="ai-reply-btn" onclick="triggerAIReply()" title="ËÆ©AIÂõûÂ§ç">‚ú¶</button>
                        <button class="chat-btn send-btn" onclick="sendMessage()" title="ÂèëÈÄÅÊ∂àÊÅØ">‚û§</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= ‰∏ñÁïå‰π¶ÂàóË°®Ê®°ÊÄÅÊ°Ü ================= -->
        <div id="worldbook-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeModal('worldbook-modal')">‚Üê</span>
                        <h2>‰∏ñÁïå‰π¶</h2>
                    </div>
                    <div class="header-right">
                        <span class="header-btn" onclick="createNewWorldbook()">Ôºã</span>
                        <span class="header-btn" onclick="document.getElementById('worldbook-import-input').click()">üì§</span>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="worldbook-list">
                        <!-- ‰∏ñÁïå‰π¶ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= ‰∏ñÁïå‰π¶ÁºñËæëÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="worldbook-edit-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeWorldbookEdit()">‚Üê</span>
                        <h2 id="worldbook-edit-title">ÁºñËæë‰∏ñÁïå‰π¶</h2>
                    </div>
                    <div class="header-right">
                        <span class="header-btn" onclick="addWorldbookEntry()">Ôºã</span>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">‰∏ñÁïå‰π¶ÂêçÁß∞</label>
                        <input type="text" id="worldbook-name" class="form-input" placeholder="‰∏ñÁïå‰π¶ÂêçÁß∞">
                    </div>
                    <h3 style="font-size: 14px; color: #5d8a66; margin: 15px 0 10px;">üìñ Êù°ÁõÆÂàóË°®</h3>
                    <div id="worldbook-entries">
                        <!-- Êù°ÁõÆÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveWorldbook()">‰øùÂ≠ò‰∏ñÁïå‰π¶</button>
                </div>
            </div>
        </div>

        <!-- ================= ‰∏ñÁïå‰π¶Êù°ÁõÆÁºñËæëÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="entry-edit-modal" class="modal">
            <div class="modal-content" style="height: 60%;">
                <div class="modal-header">
                    <h2>ÁºñËæëÊù°ÁõÆ</h2>
                    <span class="close-btn" onclick="closeModal('entry-edit-modal')">√ó</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">ÂÖ≥ÈîÆËØçÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºâ</label>
                        <input type="text" id="entry-keywords" class="form-input" placeholder="‰æãÂ¶Ç: È≠îÊ≥ï,ÂííËØ≠,Ê≥ïÊúØ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÂÜÖÂÆπ</label>
                        <textarea id="entry-content" class="form-textarea" rows="6" placeholder="ÂΩìËß¶ÂèëÂÖ≥ÈîÆËØçÊó∂ÔºåAIÂ∞ÜËØªÂèñËøôÊÆµÂÜÖÂÆπ..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveEntry()">‰øùÂ≠òÊù°ÁõÆ</button>
                </div>
            </div>
        </div>

        <!-- ================= API ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="api-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>API ÈÖçÁΩÆ</h2>
                    <span class="close-btn" onclick="closeModal('api-modal')">√ó</span>
                </div>
                <div class="modal-body">
                    <div class="setting-section">
                        <h3>ü§ñ ‰∏ªAPI (ËßíËâ≤ÂØπËØù)</h3>
                        <input type="text" id="main-api-url" class="form-input" placeholder="APIÂú∞ÂùÄ (‰æãÂ¶Ç https://api.openai.com)">
                        <input type="password" id="main-api-key" class="form-input" placeholder="API ÂØÜÈí• (sk-...)">
                        <div class="btn-row">
                            <button class="btn btn-primary" onclick="fetchModels('main')">ÊãâÂèñÊ®°Âûã</button>
                            <select id="main-model-select" class="form-select">
                                <option value="">ËØ∑ÂÖàÊãâÂèñÊ®°Âûã</option>
                            </select>
                        </div>
                        
                        <!-- Ê®°ÂûãÊ∏©Â∫¶Ë∞ÉËäÇ -->
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label">üå°Ô∏è Ê®°ÂûãÊ∏©Â∫¶ (Temperature)</label>
                            <div class="temperature-slider">
                                <input type="range" id="main-temperature" min="0" max="2" step="0.1" value="0.8" oninput="document.getElementById('temp-value').textContent = this.value">
                                <span class="temperature-value" id="temp-value">0.8</span>
                            </div>
                            <div style="font-size: 11px; color: #888; margin-top: 5px;">
                                ËæÉ‰Ωé = Êõ¥Á≤æÁ°ÆÁ®≥ÂÆö | ËæÉÈ´ò = Êõ¥ÊúâÂàõÊÑèÈöèÊú∫
                            </div>
                        </div>
                        
                        <div class="btn-row" style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="savePreset()">‰øùÂ≠òÈ¢ÑËÆæ</button>
                        </div>
                        <div id="preset-list" class="preset-list"></div>
                    </div>

                    <div class="setting-section">
                        <h3>üìù ÂâØAPI (ËÅäÂ§©ÊÄªÁªì)</h3>
                        <input type="text" id="sub-api-url" class="form-input" placeholder="ÂâØAPIÂú∞ÂùÄÔºàÂèØÈÄâÔºå‰∏çÂ°´ÂàôÁî®‰∏ªAPIÔºâ">
                        <input type="password" id="sub-api-key" class="form-input" placeholder="API ÂØÜÈí•">
                        <div class="btn-row">
                            <button class="btn btn-primary" onclick="fetchModels('sub')">ÊãâÂèñÊ®°Âûã</button>
                            <select id="sub-model-select" class="form-select">
                                <option value="">ËØ∑ÂÖàÊãâÂèñÊ®°Âûã</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-section">
                        <div class="switch-row">
                            <h3 style="margin: 0;">üé® ÂºÄÂêØAIÁîüÂõæ</h3>
                            <label class="switch">
                                <input type="checkbox" id="img-gen-switch">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="setting-section">
                        <div class="switch-row">
                            <h3 style="margin: 0;">üé§ Minimax ËØ≠Èü≥</h3>
                            <label class="switch">
                                <input type="checkbox" id="voice-switch" onchange="toggleArea('voice-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="voice-settings" class="hidden-area">
                            <input type="text" id="voice-group-id" class="form-input" placeholder="Group ID">
                            <input type="password" id="voice-api-key" class="form-input" placeholder="API ÂØÜÈí•">
                            <div class="btn-row">
                                <button class="btn btn-primary" onclick="fetchMinimaxVoiceModels()">ÊãâÂèñËØ≠Èü≥Ê®°Âûã</button>
                                <select id="voice-model-select" class="form-select">
                                    <option value="">ËØ∑ÂÖàÊãâÂèñÊ®°Âûã</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-top: 8px;">
                                <label class="form-label">Voice ID (ÂèØÈÄâÔºåÁî®‰∫éÊåáÂÆöÈü≥Ëâ≤)</label>
                                <input type="text" id="voice-id-input" class="form-input" placeholder="Voice ID">
                            </div>
                            <div class="form-group" style="margin-top: 8px;">
                                <label class="form-label">ËØ≠Èü≥Ê∂àÊÅØÊ¶ÇÁéá (0-100%)</label>
                                <div class="inline-input">
                                    <input type="range" id="voice-probability" min="0" max="100" value="30" style="flex:1" oninput="document.getElementById('voice-prob-value').textContent = this.value + '%'">
                                    <span id="voice-prob-value" style="width: 50px; text-align: right;">30%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="setting-section">
                        <div class="switch-row">
                            <h3 style="margin: 0;">üí¨ AI‰∏ªÂä®ÂèëÊ∂àÊÅØ</h3>
                            <label class="switch">
                                <input type="checkbox" id="active-msg-switch" onchange="toggleArea('active-msg-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="active-msg-settings" class="hidden-area">
                            <div class="inline-input">
                                <span>ÂìçÂ∫îÊó∂Èó¥(Áßí):</span>
                                <input type="number" id="active-msg-time" class="form-input" style="width: 80px; margin: 0;" value="60">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveAPISettings()">‰øùÂ≠òAPIÈÖçÁΩÆ</button>
                </div>
            </div>
        </div>

        <!-- ================= Â§ñËßÇËÆæÁΩÆÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="appearance-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeModal('appearance-modal')">‚Üê</span>
                        <h2>Â§ñËßÇËÆæÁΩÆ</h2>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- ‰∏ªÂ±èÂπïÂ§¥ÂÉè -->
                    <div class="setting-section">
                        <h3>üñºÔ∏è ‰∏ªÂ±èÂπïÂ§¥ÂÉè</h3>
                        <div class="main-avatar-edit" onclick="document.getElementById('main-avatar-input').click()">
                            <img id="main-avatar-preview" src="https://api.dicebear.com/7.x/lorelei/png?seed=cute&backgroundColor=d1fae5" alt="‰∏ªÂ§¥ÂÉè">
                        </div>
                        <div class="form-group">
                            <input type="text" id="main-avatar-url" class="form-input" placeholder="ËæìÂÖ•Â§¥ÂÉèURL" onchange="previewMainAvatar()">
                        </div>
                        <div class="btn-row" style="justify-content: center;">
                            <button class="btn btn-secondary" onclick="document.getElementById('main-avatar-input').click()">Êú¨Âú∞‰∏ä‰º†</button>
                        </div>
                    </div>

                    <!-- ‰∏ªÂ±èÂπïËÉåÊôØ -->
                    <div class="setting-section">
                        <h3>üåÑ ‰∏ªÂ±èÂπïËÉåÊôØ</h3>
                        <div class="bg-preview-box" id="bg-preview-box" onclick="document.getElementById('main-bg-input').click()">
                            <span>ÁÇπÂáªÊõ¥Êç¢ËÉåÊôØ</span>
                        </div>
                        <div class="form-group">
                            <input type="text" id="main-bg-url" class="form-input" placeholder="ËæìÂÖ•ËÉåÊôØÂõæURL" onchange="previewMainBg()">
                        </div>
                        <div class="btn-row">
                            <button class="btn btn-secondary" onclick="document.getElementById('main-bg-input').click()">Êú¨Âú∞‰∏ä‰º†</button>
                            <button class="btn btn-danger" onclick="resetMainBg()">ÊÅ¢Â§çÈªòËÆ§</button>
                        </div>
                    </div>

                    <!-- Â∫îÁî®ÂõæÊ†á -->
                    <div class="setting-section">
                        <h3>üì± Â∫îÁî®ÂõæÊ†á (ÁÇπÂáªÁºñËæë)</h3>
                        <div class="icon-edit-grid" id="icon-edit-grid">
                            <!-- ÂõæÊ†áÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveAppearanceSettings()">‰øùÂ≠òÂ§ñËßÇËÆæÁΩÆ</button>
                </div>
            </div>
        </div>

        <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• -->
        <input type="file" id="character-import-input" class="hidden-input" accept=".json,.png" onchange="importCharacter(event)">
        <input type="file" id="worldbook-import-input" class="hidden-input" accept=".json,.txt" onchange="importWorldbook(event)">
        <input type="file" id="char-avatar-input" class="hidden-input" accept="image/*" onchange="uploadAvatar(event, 'char')">
        <input type="file" id="user-avatar-input" class="hidden-input" accept="image/*" onchange="uploadAvatar(event, 'user')">
        <input type="file" id="chat-bg-input" class="hidden-input" accept="image/*" onchange="uploadChatBg(event)">
        <input type="file" id="chat-import-input" class="hidden-input" accept=".json" onchange="importChatHistory(event)">
        <input type="file" id="main-avatar-input" class="hidden-input" accept="image/*" onchange="uploadMainAvatar(event)">
        <input type="file" id="main-bg-input" class="hidden-input" accept="image/*" onchange="uploadMainBg(event)">
        <input type="file" id="icon-file-input" class="hidden-input" accept="image/*" onchange="uploadIconImage(event)">
        
        <!-- ÈöêËóèÁöÑÈü≥È¢ëÊí≠ÊîæÂô® -->
        <audio id="voice-player" style="display:none;"></audio>
    </div>

    <script>
        // ================= ÈªòËÆ§ÂõæÊ†áSVG =================
        const defaultIcons = {
            'character': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="45" r="28" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="40" cy="40" r="4" fill="#5d8a66"/><circle cx="60" cy="40" r="4" fill="#5d8a66"/><path d="M40 55 Q50 65 60 55" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M30 25 Q35 15 45 20" stroke="#5d8a66" stroke-width="2.5" fill="none" stroke-linecap="round"/><path d="M70 25 Q65 15 55 20" stroke="#5d8a66" stroke-width="2.5" fill="none" stroke-linecap="round"/><circle cx="38" cy="38" r="1.5" fill="white"/><circle cx="58" cy="38" r="1.5" fill="white"/><ellipse cx="32" cy="50" rx="4" ry="3" fill="#ffcdd2" opacity="0.6"/><ellipse cx="68" cy="50" rx="4" ry="3" fill="#ffcdd2" opacity="0.6"/></svg>`,
            'worldbook': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M50 25 L50 80" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M50 25 Q30 20 15 30 L15 75 Q30 68 50 75" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M50 25 Q70 20 85 30 L85 75 Q70 68 50 75" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M22 40 L42 38" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M22 50 L42 48" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M22 60 L38 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M58 38 L78 40" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M58 48 L78 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M62 58 L78 60" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><circle cx="50" cy="20" r="5" fill="#ffeb3b" stroke="#5d8a66" stroke-width="1.5"/></svg>`,
            'taobao': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 30 L30 30 L40 65 L75 65 L82 40 L35 40" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/><circle cx="45" cy="78" r="6" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="68" cy="78" r="6" stroke="#5d8a66" stroke-width="3" fill="none"/><path d="M45 50 L45 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M55 48 L55 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M65 50 L65 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M25 25 Q20 20 25 15" stroke="#ffb74d" stroke-width="2" stroke-linecap="round"/></svg>`,
            'api': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><text x="12" y="58" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(-8 20 50)">A</text><text x="35" y="62" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(5 45 55)">P</text><text x="58" y="55" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(-3 65 50)">I</text><path d="M75 35 Q80 30 85 35 Q90 40 85 45 Q80 50 75 45 Q70 40 75 35" stroke="#ffb74d" stroke-width="2" fill="#fff59d"/><circle cx="20" cy="30" r="4" fill="#81c784"/><circle cx="80" cy="65" r="3" fill="#81c784"/><path d="M25 70 L35 75" stroke="#5d8a66" stroke-width="1.5" stroke-linecap="round"/><path d="M30 73 L32 68" stroke="#5d8a66" stroke-width="1.5" stroke-linecap="round"/></svg>`,
            'appearance': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="50" rx="35" ry="32" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="35" cy="38" r="7" fill="#ff8a80"/><circle cx="55" cy="32" r="6" fill="#ffcc80"/><circle cx="70" cy="45" r="6" fill="#a5d6a7"/><circle cx="65" cy="62" r="5" fill="#90caf9"/><circle cx="40" cy="60" r="8" fill="white" stroke="#5d8a66" stroke-width="2"/><path d="M75 75 L90 90" stroke="#5d8a66" stroke-width="4" stroke-linecap="round"/><path d="M88 82 L92 88 L86 92" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            'look': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="50" rx="35" ry="22" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="50" cy="50" r="15" stroke="#5d8a66" stroke-width="2.5" fill="none"/><circle cx="50" cy="50" r="8" fill="#5d8a66"/><circle cx="46" cy="46" r="3" fill="white"/><path d="M20 35 Q15 30 20 25" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M80 35 Q85 30 80 25" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M15 50 L20 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M80 50 L85 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/></svg>`,
            'calendar': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="18" y="25" width="64" height="55" rx="8" stroke="#5d8a66" stroke-width="3" fill="none"/><path d="M18 42 L82 42" stroke="#5d8a66" stroke-width="2"/><path d="M35 18 L35 32" stroke="#5d8a66" stroke-width="3" stroke-linecap="round"/><path d="M65 18 L65 32" stroke="#5d8a66" stroke-width="3" stroke-linecap="round"/><text x="50" y="68" font-family="Comic Sans MS, cursive" font-size="24" fill="#5d8a66" text-anchor="middle">?</text><circle cx="72" cy="28" r="5" fill="#ff8a80"/></svg>`,
            'phone': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="28" y="15" width="44" height="70" rx="8" stroke="#5d8a66" stroke-width="3" fill="none"/><path d="M28 25 L72 25" stroke="#5d8a66" stroke-width="2"/><path d="M28 72 L72 72" stroke="#5d8a66" stroke-width="2"/><circle cx="50" cy="80" r="4" stroke="#5d8a66" stroke-width="2" fill="none"/><path d="M42 20 L58 20" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M38 45 L48 55 L62 38" stroke="#81c784" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            'weibo': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 30 Q20 20 30 20 L70 20 Q80 20 80 30 L80 55 Q80 65 70 65 L35 65 L22 78 L25 65 L30 65 Q20 65 20 55 Z" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="38" cy="42" r="4" fill="#5d8a66"/><circle cx="52" cy="42" r="4" fill="#5d8a66"/><circle cx="66" cy="42" r="4" fill="#5d8a66"/></svg>`,
            'bo4': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><text x="50" y="62" font-family="Georgia, serif" font-size="28" fill="#990000" text-anchor="middle" font-weight="bold">BO4</text><circle cx="20" cy="25" r="4" fill="#ffb74d"/><circle cx="80" cy="75" r="3" fill="#ffb74d"/></svg>`,
            'theater': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="35" cy="45" rx="22" ry="28" stroke="#5d8a66" stroke-width="2.5" fill="none"/><ellipse cx="65" cy="45" rx="22" ry="28" stroke="#5d8a66" stroke-width="2.5" fill="none"/><circle cx="28" cy="38" r="4" fill="#5d8a66"/><circle cx="42" cy="38" r="4" fill="#5d8a66"/><path d="M25 55 Q35 65 45 55" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round"/><circle cx="58" cy="38" r="4" fill="#5d8a66"/><circle cx="72" cy="38" r="4" fill="#5d8a66"/><path d="M55 55 Q65 48 75 55" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round"/><path d="M35 75 Q50 85 65 75" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/></svg>`
        };

        const iconNames = {
            'character': 'ËßíËâ≤',
            'worldbook': '‰∏ñÁïå‰π¶',
            'taobao': 'Ê∑òÂÆù',
            'api': 'APIËÆæÁΩÆ',
            'appearance': 'Â§ñËßÇËÆæÁΩÆ',
            'look': 'ÁúãÁúã‰Ω†',
            'calendar': '‰ªäÂ§©ÂÅö‰ªÄ‰πà',
            'phone': 'Êü•ÊâãÊú∫',
            'weibo': 'Âõ¥ËÑñ',
            'bo4': 'BO4',
            'theater': 'Â§ßÂâßÂú∫'
        };

        // ================= ÂÖ®Â±ÄÊï∞ÊçÆÂ≠òÂÇ® =================
        let isCreatingNewCharacter = false;
        let tempNewCharacter = null;

        let appData = {
            characters: [],
            worldbooks: [],
            currentCharacterId: null,
            currentWorldbookId: null,
            currentEntryIndex: null,
            apiSettings: {
                main: { url: '', key: '', model: '', temperature: 0.8 },
                sub: { url: '', key: '', model: '' },
                imgGen: false,
                voice: { enabled: false, groupId: '', key: '', voiceId: '', model: '', probability: 30 },
                activeMsg: { enabled: false, time: 60 }
            },
            presets: [],
            appearance: {
                mainAvatar: '',
                mainBg: '',
                icons: {}
            }
        };

        // PWAÁõ∏ÂÖ≥
        let deferredPrompt = null;
        
        // ÈïøÊåâÂà†Èô§Áõ∏ÂÖ≥
        let longPressTimer = null;
        let longPressCharId = null;
        let isLongPress = false;

        // ÂΩìÂâçÁºñËæëÁöÑÂõæÊ†á
        let currentEditingIcon = null;

        // Âä†ËΩΩÊï∞ÊçÆ
        function loadAppData() {
            const saved = localStorage.getItem('chat_app_data');
            if (saved) {
                try {
                    appData = JSON.parse(saved);
                    // Á°Æ‰øùÂ≠óÊÆµÂ≠òÂú®
                    if (!appData.apiSettings.main.temperature) {
                        appData.apiSettings.main.temperature = 0.8;
                    }
                    if (!appData.apiSettings.voice.probability) {
                        appData.apiSettings.voice.probability = 30;
                    }
                    if (!appData.appearance) {
                        appData.appearance = { mainAvatar: '', mainBg: '', icons: {} };
                    }
                } catch (e) {
                    console.error('Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•', e);
                }
            }
            // Â∫îÁî®Â§ñËßÇËÆæÁΩÆ
            applyAppearanceSettings();
        }

        // ‰øùÂ≠òÊï∞ÊçÆ
        function saveAppData() {
            localStorage.setItem('chat_app_data', JSON.stringify(appData));
        }

        // ÊòæÁ§∫/ÈöêËóèÂä†ËΩΩÊèêÁ§∫
        function showLoading(text = 'Â§ÑÁêÜ‰∏≠...') {
            const toast = document.getElementById('loading-toast');
            toast.textContent = text;
            toast.classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading-toast').classList.remove('show');
        }

        // ================= Â§ñËßÇËÆæÁΩÆÂäüËÉΩ =================
        function applyAppearanceSettings() {
            // Â∫îÁî®‰∏ªÂ§¥ÂÉè
            if (appData.appearance.mainAvatar) {
                document.getElementById('main-avatar').src = appData.appearance.mainAvatar;
            }
            
            // Â∫îÁî®‰∏ªËÉåÊôØ
            const phoneBg = document.getElementById('phone-bg');
            if (appData.appearance.mainBg) {
                phoneBg.style.backgroundImage = `url(${appData.appearance.mainBg})`;
            } else {
                phoneBg.style.backgroundImage = '';
            }
            
            // Â∫îÁî®Ëá™ÂÆö‰πâÂõæÊ†á
            Object.keys(appData.appearance.icons || {}).forEach(iconId => {
                const iconData = appData.appearance.icons[iconId];
                if (iconData) {
                    const iconEl = document.getElementById(`icon-${iconId}`);
                    if (iconEl) {
                        iconEl.innerHTML = `<img src="${iconData}" alt="${iconId}">`;
                    }
                }
            });
        }

        function openAppearanceSettings() {
            // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆÂà∞Ë°®Âçï
            document.getElementById('main-avatar-preview').src = appData.appearance.mainAvatar || 'https://api.dicebear.com/7.x/lorelei/png?seed=cute&backgroundColor=d1fae5';
            document.getElementById('main-avatar-url').value = appData.appearance.mainAvatar || '';
            
            const bgPreview = document.getElementById('bg-preview-box');
            if (appData.appearance.mainBg) {
                bgPreview.style.backgroundImage = `url(${appData.appearance.mainBg})`;
            } else {
                bgPreview.style.backgroundImage = 'linear-gradient(160deg, #e8f8f5 0%, #d5f5e3 25%, #abebc6 50%, #d5f5e3 75%, #e8f8f5 100%)';
            }
            document.getElementById('main-bg-url').value = appData.appearance.mainBg || '';
            
            // Ê∏≤ÊüìÂõæÊ†áÁºñËæëÁΩëÊ†º
            renderIconEditGrid();
            
            openModal('appearance-modal');
        }

        function renderIconEditGrid() {
            const grid = document.getElementById('icon-edit-grid');
            grid.innerHTML = Object.keys(defaultIcons).map(iconId => {
                const customIcon = appData.appearance.icons?.[iconId];
                const iconContent = customIcon ? `<img src="${customIcon}" alt="${iconId}">` : defaultIcons[iconId];
                return `
                    <div class="icon-edit-item" onclick="openIconEditPopup('${iconId}')">
                        <div class="icon-edit-preview">${iconContent}</div>
                        <div class="icon-edit-name">${iconNames[iconId]}</div>
                    </div>
                `;
            }).join('');
        }

        function openIconEditPopup(iconId) {
            currentEditingIcon = iconId;
            document.getElementById('icon-edit-title').textContent = `ÁºñËæë ${iconNames[iconId]} ÂõæÊ†á`;
            
            const preview = document.getElementById('icon-edit-preview');
            const customIcon = appData.appearance.icons?.[iconId];
            preview.innerHTML = customIcon ? `<img src="${customIcon}" alt="${iconId}">` : defaultIcons[iconId];
            
            document.getElementById('icon-url-input').value = customIcon || '';
            
            document.getElementById('popup-overlay').classList.add('show');
            document.getElementById('icon-edit-popup').classList.add('show');
        }

        function closeIconEditPopup() {
            document.getElementById('popup-overlay').classList.remove('show');
            document.getElementById('icon-edit-popup').classList.remove('show');
            currentEditingIcon = null;
        }

        function saveIconEdit() {
            const url = document.getElementById('icon-url-input').value.trim();
            if (currentEditingIcon) {
                if (url) {
                    if (!appData.appearance.icons) appData.appearance.icons = {};
                    appData.appearance.icons[currentEditingIcon] = url;
                } else {
                    delete appData.appearance.icons?.[currentEditingIcon];
                }
                saveAppData();
                applyAppearanceSettings();
                renderIconEditGrid();
            }
            closeIconEditPopup();
        }

        function resetIconToDefault() {
            if (currentEditingIcon) {
                delete appData.appearance.icons?.[currentEditingIcon];
                document.getElementById('icon-url-input').value = '';
                document.getElementById('icon-edit-preview').innerHTML = defaultIcons[currentEditingIcon];
                
                // ÊÅ¢Â§çÈ°µÈù¢‰∏äÁöÑÂõæÊ†á
                const iconEl = document.getElementById(`icon-${currentEditingIcon}`);
                if (iconEl) {
                    iconEl.innerHTML = defaultIcons[currentEditingIcon];
                }
                
                saveAppData();
                renderIconEditGrid();
            }
        }

        function uploadIconImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 1 * 1024 * 1024) {
                alert('ÂõæÁâáÂ§™Â§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é1MBÁöÑÂõæÁâá');
                event.target.value = '';
                return;
            }
            
            fileToDataURL(file).then(dataUrl => {
                document.getElementById('icon-url-input').value = dataUrl;
                document.getElementById('icon-edit-preview').innerHTML = `<img src="${dataUrl}" alt="icon">`;
            });
            
            event.target.value = '';
        }

        function previewMainAvatar() {
            const url = document.getElementById('main-avatar-url').value.trim();
            if (url) {
                document.getElementById('main-avatar-preview').src = url;
            }
        }

        function uploadMainAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                alert('ÂõæÁâáÂ§™Â§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é2MBÁöÑÂõæÁâá');
                event.target.value = '';
                return;
            }
            
            fileToDataURL(file).then(dataUrl => {
                document.getElementById('main-avatar-preview').src = dataUrl;
                document.getElementById('main-avatar-url').value = dataUrl;
            });
            
            event.target.value = '';
        }

        function previewMainBg() {
            const url = document.getElementById('main-bg-url').value.trim();
            const preview = document.getElementById('bg-preview-box');
            if (url) {
                preview.style.backgroundImage = `url(${url})`;
            }
        }

        function uploadMainBg(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                alert('ÂõæÁâáÂ§™Â§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é5MBÁöÑÂõæÁâá');
                event.target.value = '';
                return;
            }
            
            fileToDataURL(file).then(dataUrl => {
                document.getElementById('bg-preview-box').style.backgroundImage = `url(${dataUrl})`;
                document.getElementById('main-bg-url').value = dataUrl;
            });
            
            event.target.value = '';
        }

        function resetMainBg() {
            document.getElementById('main-bg-url').value = '';
            document.getElementById('bg-preview-box').style.backgroundImage = 'linear-gradient(160deg, #e8f8f5 0%, #d5f5e3 25%, #abebc6 50%, #d5f5e3 75%, #e8f8f5 100%)';
        }

        function saveAppearanceSettings() {
            appData.appearance.mainAvatar = document.getElementById('main-avatar-url').value.trim();
            appData.appearance.mainBg = document.getElementById('main-bg-url').value.trim();
            
            saveAppData();
            applyAppearanceSettings();
            alert('Â§ñËßÇËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
            closeModal('appearance-modal');
        }

        // ================= ÁßªÂä®Á´ØÈîÆÁõòÈÄÇÈÖç (Visual Viewport API) =================
        function setupKeyboardHandling() {
            const chatMessages = document.getElementById('chat-messages');
            const chatModal = document.getElementById('chat-modal');
            const chatModalContent = chatModal ? chatModal.querySelector('.modal-content') : null;
            
            if (!chatMessages || !chatModalContent) return;
            
            if (window.visualViewport) {
                const handleResize = () => {
                    if (chatModal.style.display === 'flex') {
                        // Áõ¥Êé•ËÆæÁΩÆÂÜÖÂÆπÈ´òÂ∫¶‰∏∫ÂèØËßÜËßÜÂè£È´òÂ∫¶
                        // ËøôÊ†∑ flex Â∏ÉÂ±Ä‰ºöËá™Âä®Ë∞ÉÊï¥ÔºåËæìÂÖ•Ê°Ü‰ºöË¥¥Âú®ÈîÆÁõò‰∏äÊñπ
                        chatModalContent.style.height = window.visualViewport.height + 'px';
                        
                        // Á°Æ‰øùÊªöÂä®Âà∞Â∫ïÈÉ®
                        setTimeout(() => {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }, 50);
                    }
                };

                window.visualViewport.addEventListener('resize', handleResize);
                // Êúâ‰∫õÊµèËßàÂô®Âú®ÈîÆÁõòÂºπÂá∫Êó∂‰πü‰ºöËß¶Âèë scroll
                window.visualViewport.addEventListener('scroll', handleResize);
            }
        }

        // ================= PWAÂÆâË£ÖÂäüËÉΩ =================
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt && !localStorage.getItem('pwa_prompt_dismissed')) {
                setTimeout(() => {
                    prompt.classList.add('show');
                }, 2000);
            }
        });

        document.getElementById('pwa-install-btn')?.addEventListener('click', async () => {
            const prompt = document.getElementById('pwa-install-prompt');
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('Áî®Êà∑Â∑≤ÂÆâË£ÖPWA');
                }
                deferredPrompt = null;
            } else {
                alert('ËØ∑ÁÇπÂáªÊµèËßàÂô®ÂàÜ‰∫´ÊåâÈíÆ üì§ÔºåÁÑ∂ÂêéÈÄâÊã©"Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπï"');
            }
            prompt.classList.remove('show');
        });

        function dismissPWAPrompt() {
            document.getElementById('pwa-install-prompt').classList.remove('show');
            localStorage.setItem('pwa_prompt_dismissed', 'true');
        }

        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt) prompt.style.display = 'none';
        }

        // ================= Â∑•ÂÖ∑ÂáΩÊï∞ =================
        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('current-time').textContent = `${hours}:${minutes}`;
        }
        updateTime();
        setInterval(updateTime, 1000);

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function toggleArea(id, show) {
            const el = document.getElementById(id);
            if (el) el.style.display = show ? 'block' : 'none';
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function estimateTokens(text) {
            if (!text) return 0;
            const chineseCount = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
            const otherCount = text.length - chineseCount;
            return Math.ceil(chineseCount / 1.5 + otherCount / 4);
        }

        function updateTokensEstimate() {
            const charPersona = document.getElementById('char-persona')?.value || '';
            const userPersona = document.getElementById('user-persona')?.value || '';
            const worldbookId = document.getElementById('char-worldbook')?.value;
            
            let totalTokens = estimateTokens(charPersona) + estimateTokens(userPersona);
            
            if (worldbookId) {
                const wb = appData.worldbooks.find(w => w.id === worldbookId);
                if (wb && wb.entries) {
                    wb.entries.forEach(e => {
                        totalTokens += estimateTokens(e.content);
                    });
                }
            }
            
            const el = document.getElementById('tokens-estimate');
            if (el) el.textContent = totalTokens;
        }

        // ================= Âà†Èô§Á°ÆËÆ§ÂºπÁ™ó =================
        function showDeleteConfirm(charId, charName) {
            longPressCharId = charId;
            document.getElementById('delete-confirm-text').textContent = 
                `Á°ÆÂÆöË¶ÅÂà†Èô§"${charName || 'Êú™ÂëΩÂêçËßíËâ≤'}"ÂêóÔºüËÅäÂ§©ËÆ∞ÂΩï‰πü‰ºö‰∏ÄÂπ∂Âà†Èô§„ÄÇ`;
            document.getElementById('delete-confirm-overlay').classList.add('show');
        }

        function hideDeleteConfirm() {
            document.getElementById('delete-confirm-overlay').classList.remove('show');
            longPressCharId = null;
        }

        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if (longPressCharId) {
                appData.characters = appData.characters.filter(c => c.id !== longPressCharId);
                saveAppData();
                renderCharacterList();
                hideDeleteConfirm();
            }
        });

        // ================= ËßíËâ≤ÁÆ°ÁêÜ =================
        function renderCharacterList() {
            const container = document.getElementById('character-list');
            if (!container) return;
            
            if (appData.characters.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <div class="empty-state-text">ËøòÊ≤°ÊúâËßíËâ≤<br>ÁÇπÂáªÂè≥‰∏äËßí Ôºã ÂàõÂª∫Êàñ üì§ ÂØºÂÖ•</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appData.characters.map(char => `
                <div class="character-item" 
                     data-char-id="${char.id}"
                     data-char-name="${char.nickname || char.name || 'Êú™ÂëΩÂêçËßíËâ≤'}"
                     ontouchstart="handleCharTouchStart(event, '${char.id}', '${(char.nickname || char.name || 'Êú™ÂëΩÂêçËßíËâ≤').replace(/'/g, "\\'")}')"
                     ontouchend="handleCharTouchEnd(event)"
                     ontouchmove="handleCharTouchMove(event)"
                     onmousedown="handleCharMouseDown(event, '${char.id}', '${(char.nickname || char.name || 'Êú™ÂëΩÂêçËßíËâ≤').replace(/'/g, "\\'")}')"
                     onmouseup="handleCharMouseUp(event)"
                     onmouseleave="handleCharMouseUp(event)"
                     onclick="handleCharClick(event, '${char.id}')">
                    <div class="character-avatar">
                        <img src="${char.avatar || 'https://api.dicebear.com/7.x/lorelei/png?seed=' + char.id}" alt="${char.name}" onerror="this.src='https://api.dicebear.com/7.x/lorelei/png?seed=${char.id}'">
                    </div>
                    <div class="character-info">
                        <div class="character-name">${char.nickname || char.name || 'Êú™ÂëΩÂêçËßíËâ≤'}</div>
                        <div class="character-desc">${char.chatHistory && char.chatHistory.length > 0 ? char.chatHistory[char.chatHistory.length - 1].content.substring(0, 25) + '...' : (char.persona ? char.persona.substring(0, 25) + '...' : 'ÊöÇÊó†Ê∂àÊÅØ')}</div>
                    </div>
                </div>
            `).join('');
        }

        function handleCharTouchStart(event, charId, charName) {
            isLongPress = false;
            const item = event.currentTarget;
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                item.classList.add('long-press');
                if (navigator.vibrate) navigator.vibrate(50);
                showDeleteConfirm(charId, charName);
            }, 600);
        }

        function handleCharTouchEnd(event) {
            clearTimeout(longPressTimer);
            event.currentTarget.classList.remove('long-press');
        }

        function handleCharTouchMove(event) {
            clearTimeout(longPressTimer);
            event.currentTarget.classList.remove('long-press');
        }

        function handleCharMouseDown(event, charId, charName) {
            isLongPress = false;
            const item = event.currentTarget;
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                item.classList.add('long-press');
                showDeleteConfirm(charId, charName);
            }, 600);
        }

        function handleCharMouseUp(event) {
            clearTimeout(longPressTimer);
            event.currentTarget.classList.remove('long-press');
        }

        function handleCharClick(event, charId) {
            if (!isLongPress) {
                openChatWithCharacter(charId);
            }
            isLongPress = false;
        }

        function openChatWithCharacter(charId) {
            const char = appData.characters.find(c => c.id === charId);
            if (!char) return;
            
            appData.currentCharacterId = charId;
            saveAppData();
            
            document.getElementById('chat-char-avatar').src = char.avatar || 'https://api.dicebear.com/7.x/lorelei/png?seed=' + char.id;
            document.getElementById('chat-char-name').textContent = char.nickname || char.name || 'Êú™ÂëΩÂêçËßíËâ≤';
            
            const chatContainer = document.getElementById('chat-container');
            const chatMessages = document.getElementById('chat-messages');
            
            if (char.chatBg) {
                chatContainer.style.backgroundImage = `url(${char.chatBg})`;
                chatContainer.style.backgroundSize = 'cover';
                chatContainer.style.backgroundPosition = 'center';
            } else {
                chatContainer.style.backgroundImage = '';
                chatContainer.style.background = '#f5f5f5';
            }
            
            chatMessages.style.fontSize = (char.fontSize || 14) + 'px';
            
            renderChatMessages(char);
            closeModal('character-modal');
            openModal('chat-modal');
            
            setupKeyboardHandling();
        }

        function openCharacterSettings() {
            isCreatingNewCharacter = false;
            tempNewCharacter = null;
            
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;
            
            // ÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
            const deleteBtn = document.querySelector('#character-edit-modal .header-right .header-btn');
            if (deleteBtn) deleteBtn.style.display = 'block';
            
            loadCharacterToForm(char);
            document.getElementById('character-edit-title').textContent = (char.nickname || char.name || 'ËßíËâ≤') + ' - ËÆæÁΩÆ';
            closeModal('chat-modal');
            openModal('character-edit-modal');
        }

        function createNewCharacter() {
            isCreatingNewCharacter = true;
            const newChar = {
                id: generateId(),
                name: '',
                nickname: '',
                persona: '',
                avatar: '',
                userAvatar: '',
                userName: '',
                userNickname: '',
                userPersona: '',
                worldbookId: '',
                memoryCount: 50,
                autoSummary: false,
                summaryInterval: 100,
                summaryPrompt: '‰ª•ËßíËâ≤Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÂèôËø∞Êàë‰ª¨ËÅäÂ§©‰∏≠ÊèêÂà∞ÁöÑ‰∫ãÊÉÖÔºå100Â≠óÂÜÖ',
                timeAware: false,
                timezone: 'Asia/Shanghai',
                weatherAware: false,
                weather: '',
                offlineMode: false,
                offlineLength: 1000,
                fontSize: 14,
                chatBg: '',
                chatHistory: [],
                summaries: []
            };
            
            tempNewCharacter = newChar;
            appData.currentCharacterId = newChar.id;
            
            // ÈöêËóèÂà†Èô§ÊåâÈíÆ
            const deleteBtn = document.querySelector('#character-edit-modal .header-right .header-btn');
            if (deleteBtn) deleteBtn.style.display = 'none';
            
            loadCharacterToForm(newChar);
            document.getElementById('character-edit-title').textContent = 'ÂàõÂª∫ËßíËâ≤';
            openModal('character-edit-modal');
        }

        function loadCharacterToForm(char) {
            document.getElementById('char-avatar-preview').src = char.avatar || 'https://api.dicebear.com/7.x/lorelei/png?seed=' + char.id;
            document.getElementById('char-nickname').value = char.nickname || '';
            document.getElementById('char-name').value = char.name || '';
            document.getElementById('char-persona').value = char.persona || '';
            
            document.getElementById('user-avatar-preview').src = char.userAvatar || 'https://api.dicebear.com/7.x/lorelei/png?seed=user';
            document.getElementById('user-nickname').value = char.userNickname || '';
            document.getElementById('user-name').value = char.userName || '';
            document.getElementById('user-persona').value = char.userPersona || '';
            
            const wbSelect = document.getElementById('char-worldbook');
            wbSelect.innerHTML = '<option value="">‰∏çÂÖ≥ËÅî‰∏ñÁïå‰π¶</option>' + 
                appData.worldbooks.map(wb => `<option value="${wb.id}">${wb.name}</option>`).join('');
            wbSelect.value = char.worldbookId || '';
            
            document.getElementById('memory-count').value = char.memoryCount || 50;
            
            document.getElementById('auto-summary-switch').checked = char.autoSummary || false;
            toggleArea('summary-settings', char.autoSummary);
            document.getElementById('summary-interval').value = char.summaryInterval || 100;
            document.getElementById('summary-prompt').value = char.summaryPrompt || '‰ª•ËßíËâ≤Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÂèôËø∞Êàë‰ª¨ËÅäÂ§©‰∏≠ÊèêÂà∞ÁöÑ‰∫ãÊÉÖÔºå100Â≠óÂÜÖ';
            
            document.getElementById('time-aware-switch').checked = char.timeAware || false;
            toggleArea('time-settings', char.timeAware);
            document.getElementById('timezone-select').value = char.timezone || 'Asia/Shanghai';
            
            document.getElementById('weather-aware-switch').checked = char.weatherAware || false;
            toggleArea('weather-settings', char.weatherAware);
            document.getElementById('weather-input').value = char.weather || '';
            
            document.getElementById('offline-mode-switch').checked = char.offlineMode || false;
            toggleArea('offline-settings', char.offlineMode);
            document.getElementById('offline-length').value = char.offlineLength || 1000;
            
            document.getElementById('font-size-range').value = char.fontSize || 14;
            document.getElementById('font-size-value').textContent = (char.fontSize || 14) + 'px';
            document.getElementById('chat-bg-url').value = char.chatBg || '';
            
            updateTokensEstimate();
        }

        function saveCharacter() {
            // Ëé∑ÂèñË°®ÂçïÊï∞ÊçÆ
            const nickname = document.getElementById('char-nickname').value;
            const name = document.getElementById('char-name').value;
            const persona = document.getElementById('char-persona').value;
            
            // Â¶ÇÊûúÊòØÊñ∞Âª∫ËßíËâ≤ÔºåÊ£ÄÊü•‰∫∫ËÆæÊòØÂê¶‰∏∫Á©∫
            if (isCreatingNewCharacter) {
                if (!persona.trim()) {
                    alert('ËØ∑Â°´ÂÜôËßíËâ≤‰∫∫ËÆæÔºÅ');
                    return;
                }
                
                // Â∞Ü‰∏¥Êó∂ËßíËâ≤Ê∑ªÂä†Âà∞ÂàóË°®
                const char = tempNewCharacter;
                char.nickname = nickname;
                char.name = name;
                char.persona = persona;
                
                char.userNickname = document.getElementById('user-nickname').value;
                char.userName = document.getElementById('user-name').value;
                char.userPersona = document.getElementById('user-persona').value;
                
                char.worldbookId = document.getElementById('char-worldbook').value;
                char.memoryCount = parseInt(document.getElementById('memory-count').value) || 50;
                
                char.autoSummary = document.getElementById('auto-summary-switch').checked;
                char.summaryInterval = parseInt(document.getElementById('summary-interval').value) || 100;
                char.summaryPrompt = document.getElementById('summary-prompt').value;
                
                char.timeAware = document.getElementById('time-aware-switch').checked;
                char.timezone = document.getElementById('timezone-select').value;
                
                char.weatherAware = document.getElementById('weather-aware-switch').checked;
                char.weather = document.getElementById('weather-input').value;
                
                char.offlineMode = document.getElementById('offline-mode-switch').checked;
                char.offlineLength = parseInt(document.getElementById('offline-length').value) || 1000;
                
                char.fontSize = parseInt(document.getElementById('font-size-range').value) || 14;
                char.chatBg = document.getElementById('chat-bg-url').value;
                
                appData.characters.push(char);
                isCreatingNewCharacter = false;
                tempNewCharacter = null;
                
                saveAppData();
                alert('ËßíËâ≤ÂàõÂª∫ÊàêÂäüÔºÅ');
                closeCharacterEdit();
                return;
            }

            // ÁºñËæëÁé∞ÊúâËßíËâ≤
            const charId = appData.currentCharacterId;
            const charIndex = appData.characters.findIndex(c => c.id === charId);
            if (charIndex === -1) return;
            
            const char = appData.characters[charIndex];
            
            char.nickname = nickname;
            char.name = name;
            char.persona = persona;
            
            char.userNickname = document.getElementById('user-nickname').value;
            char.userName = document.getElementById('user-name').value;
            char.userPersona = document.getElementById('user-persona').value;
            
            char.worldbookId = document.getElementById('char-worldbook').value;
            char.memoryCount = parseInt(document.getElementById('memory-count').value) || 50;
            
            char.autoSummary = document.getElementById('auto-summary-switch').checked;
            char.summaryInterval = parseInt(document.getElementById('summary-interval').value) || 100;
            char.summaryPrompt = document.getElementById('summary-prompt').value;
            
            char.timeAware = document.getElementById('time-aware-switch').checked;
            char.timezone = document.getElementById('timezone-select').value;
            
            char.weatherAware = document.getElementById('weather-aware-switch').checked;
            char.weather = document.getElementById('weather-input').value;
            
            char.offlineMode = document.getElementById('offline-mode-switch').checked;
            char.offlineLength = parseInt(document.getElementById('offline-length').value) || 1000;
            
            char.fontSize = parseInt(document.getElementById('font-size-range').value) || 14;
            char.chatBg = document.getElementById('chat-bg-url').value;
            
            saveAppData();
            alert('ËßíËâ≤ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
        }

        function deleteCharacter(charId) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ëøô‰∏™ËßíËâ≤ÂêóÔºüËÅäÂ§©ËÆ∞ÂΩï‰πü‰ºö‰∏ÄÂπ∂Âà†Èô§„ÄÇ')) return;
            
            appData.characters = appData.characters.filter(c => c.id !== charId);
            saveAppData();
            renderCharacterList();
        }

        function deleteCurrentCharacter() {
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ëøô‰∏™ËßíËâ≤ÂêóÔºüËÅäÂ§©ËÆ∞ÂΩï‰πü‰ºö‰∏ÄÂπ∂Âà†Èô§„ÄÇ')) return;
            
            appData.characters = appData.characters.filter(c => c.id !== appData.currentCharacterId);
            appData.currentCharacterId = null;
            saveAppData();
            closeModal('character-edit-modal');
            renderCharacterList();
            openModal('character-modal');
        }

        function closeCharacterEdit() {
            closeModal('character-edit-modal');
            
            if (isCreatingNewCharacter) {
                isCreatingNewCharacter = false;
                tempNewCharacter = null;
                appData.currentCharacterId = null;
                renderCharacterList();
                openModal('character-modal');
                return;
            }

            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (char) {
                openChatWithCharacter(char.id);
            } else {
                renderCharacterList();
                openModal('character-modal');
            }
        }

        function clearChatHistory() {
            if (!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) return;
            
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (char) {
                char.chatHistory = [];
                char.summaries = [];
                saveAppData();
                alert('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
            }
        }

        // ================= ËßíËâ≤Âç°ÂØºÂÖ• =================
        async function importCharacter(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoading('Ê≠£Âú®ÂØºÂÖ•ËßíËâ≤...');
            
            try {
                if (file.name.toLowerCase().endsWith('.png')) {
                    await importPNGCharacter(file);
                } else if (file.name.toLowerCase().endsWith('.json')) {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    await processCharacterData(data, file.name);
                }
            } catch (e) {
                console.error('ÂØºÂÖ•Â§±Ë¥•', e);
                alert('ÂØºÂÖ•Â§±Ë¥•: ' + e.message);
            } finally {
                hideLoading();
            }
            
            event.target.value = '';
        }

        async function importPNGCharacter(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const uint8Array = new Uint8Array(arrayBuffer);
                        const characterData = extractPNGMetadata(uint8Array);
                        
                        if (characterData) {
                            const avatarDataUrl = await fileToDataURL(file);
                            await processCharacterData(characterData, file.name, avatarDataUrl);
                            resolve();
                        } else {
                            reject(new Error('Êó†Ê≥ï‰ªéPNG‰∏≠ÊèêÂèñËßíËâ≤Êï∞ÊçÆ'));
                        }
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = () => reject(new Error('ËØªÂèñÊñá‰ª∂Â§±Ë¥•'));
                reader.readAsArrayBuffer(file);
            });
        }

        function extractPNGMetadata(uint8Array) {
            const pngSignature = [137, 80, 78, 71, 13, 10, 26, 10];
            for (let i = 0; i < pngSignature.length; i++) {
                if (uint8Array[i] !== pngSignature[i]) {
                    throw new Error('‰∏çÊòØÊúâÊïàÁöÑPNGÊñá‰ª∂');
                }
            }
            
            let offset = 8;
            while (offset < uint8Array.length) {
                const length = (uint8Array[offset] << 24) | (uint8Array[offset + 1] << 16) | 
                              (uint8Array[offset + 2] << 8) | uint8Array[offset + 3];
                const type = String.fromCharCode(uint8Array[offset + 4], uint8Array[offset + 5], 
                                                  uint8Array[offset + 6], uint8Array[offset + 7]);
                
                if (type === 'tEXt' || type === 'iTXt') {
                    const data = uint8Array.slice(offset + 8, offset + 8 + length);
                    let nullIndex = 0;
                    for (let i = 0; i < data.length; i++) {
                        if (data[i] === 0) { nullIndex = i; break; }
                    }
                    
                    const keyword = new TextDecoder('utf-8').decode(data.slice(0, nullIndex));
                    
                    if (keyword === 'chara') {
                        let textData = type === 'iTXt' ? data.slice(nullIndex + 4) : data.slice(nullIndex + 1);
                        const base64Data = new TextDecoder('utf-8').decode(textData);
                        try {
                            const jsonStr = atob(base64Data);
                            const decoded = decodeURIComponent(escape(jsonStr));
                            return JSON.parse(decoded);
                        } catch (e) {
                            try { return JSON.parse(atob(base64Data)); } catch (e2) {}
                        }
                    }
                }
                
                if (type === 'IEND') break;
                offset += 12 + length;
            }
            return null;
        }

        async function processCharacterData(data, filename, avatarDataUrl = null) {
            const charData = data.data || data.char_data || data;
            
            const newChar = {
                id: generateId(),
                name: charData.name || charData.char_name || filename.replace(/\.(json|png)$/i, ''),
                nickname: charData.nickname || charData.display_name || '',
                persona: charData.description || charData.personality || charData.persona || '',
                avatar: avatarDataUrl || charData.avatar || '',
                userAvatar: '',
                userName: charData.user_name || '',
                userNickname: '',
                userPersona: charData.user_persona || '',
                worldbookId: '',
                memoryCount: 50,
                autoSummary: false,
                summaryInterval: 100,
                summaryPrompt: '‰ª•ËßíËâ≤Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÂèôËø∞Êàë‰ª¨ËÅäÂ§©‰∏≠ÊèêÂà∞ÁöÑ‰∫ãÊÉÖÔºå100Â≠óÂÜÖ',
                timeAware: false,
                timezone: 'Asia/Shanghai',
                weatherAware: false,
                weather: '',
                offlineMode: false,
                offlineLength: 1000,
                fontSize: 14,
                chatBg: '',
                chatHistory: [],
                summaries: [],
                firstMessage: charData.first_mes || charData.greeting || charData.char_greeting || '',
                scenario: charData.scenario || '',
                exampleDialogue: charData.mes_example || charData.example_dialogue || ''
            };
            
            if (charData.character_book || charData.world_info || charData.lorebook) {
                const wbData = charData.character_book || charData.world_info || charData.lorebook;
                const newWb = await importWorldbookData(wbData, newChar.name + ' - ‰∏ñÁïå‰π¶');
                if (newWb) newChar.worldbookId = newWb.id;
            }
            
            appData.characters.push(newChar);
            saveAppData();
            renderCharacterList();
            alert('ËßíËâ≤ÂØºÂÖ•ÊàêÂäü: ' + (newChar.nickname || newChar.name));
        }

        function fileToDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ================= Â§¥ÂÉè‰∏ä‰º† =================
        async function uploadAvatar(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                alert('ÂõæÁâáÂ§™Â§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é2MBÁöÑÂõæÁâá');
                event.target.value = '';
                return;
            }
            
            try {
                const dataUrl = await fileToDataURL(file);
                
                if (type === 'char') {
                    document.getElementById('char-avatar-preview').src = dataUrl;
                    if (isCreatingNewCharacter && tempNewCharacter) {
                        tempNewCharacter.avatar = dataUrl;
                    } else {
                        const char = appData.characters.find(c => c.id === appData.currentCharacterId);
                        if (char) {
                            char.avatar = dataUrl;
                            saveAppData();
                        }
                    }
                } else {
                    document.getElementById('user-avatar-preview').src = dataUrl;
                    if (isCreatingNewCharacter && tempNewCharacter) {
                        tempNewCharacter.userAvatar = dataUrl;
                    } else {
                        const char = appData.characters.find(c => c.id === appData.currentCharacterId);
                        if (char) {
                            char.userAvatar = dataUrl;
                            saveAppData();
                        }
                    }
                }
            } catch (e) {
                alert('‰∏ä‰º†Â§±Ë¥•');
                console.error(e);
            }
            
            event.target.value = '';
        }

        function uploadChatBg(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                alert('ÂõæÁâáÂ§™Â§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é5MBÁöÑÂõæÁâá');
                event.target.value = '';
                return;
            }
            
            fileToDataURL(file).then(dataUrl => {
                document.getElementById('chat-bg-url').value = dataUrl;
            });
            
            event.target.value = '';
        }

        // ================= ‰∏ñÁïå‰π¶ÁÆ°ÁêÜ =================
        function renderWorldbookList() {
            const container = document.getElementById('worldbook-list');
            if (!container) return;
            
            if (appData.worldbooks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <div class="empty-state-text">ËøòÊ≤°Êúâ‰∏ñÁïå‰π¶<br>ÁÇπÂáªÂè≥‰∏äËßí Ôºã ÂàõÂª∫Êàñ üì§ ÂØºÂÖ•</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appData.worldbooks.map(wb => `
                <div class="worldbook-item" onclick="openWorldbookDetail('${wb.id}')">
                    <div class="worldbook-icon">üìñ</div>
                    <div class="worldbook-info">
                        <div class="worldbook-name">${wb.name || 'Êú™ÂëΩÂêç‰∏ñÁïå‰π¶'}</div>
                        <div class="worldbook-entries">${wb.entries ? wb.entries.length : 0} ‰∏™Êù°ÁõÆ</div>
                    </div>
                    <div class="character-delete" onclick="event.stopPropagation(); deleteWorldbook('${wb.id}')">üóë</div>
                </div>
            `).join('');
        }

        function createNewWorldbook() {
            const newWb = { id: generateId(), name: 'Êñ∞‰∏ñÁïå‰π¶', entries: [] };
            appData.worldbooks.push(newWb);
            appData.currentWorldbookId = newWb.id;
            saveAppData();
            loadWorldbookToForm(newWb);
            document.getElementById('worldbook-edit-title').textContent = 'ÂàõÂª∫‰∏ñÁïå‰π¶';
            openModal('worldbook-edit-modal');
        }

        function openWorldbookDetail(wbId) {
            const wb = appData.worldbooks.find(w => w.id === wbId);
            if (!wb) return;
            appData.currentWorldbookId = wbId;
            loadWorldbookToForm(wb);
            document.getElementById('worldbook-edit-title').textContent = wb.name || 'ÁºñËæë‰∏ñÁïå‰π¶';
            openModal('worldbook-edit-modal');
        }

        function loadWorldbookToForm(wb) {
            document.getElementById('worldbook-name').value = wb.name || '';
            renderWorldbookEntries(wb.entries || []);
        }

        function renderWorldbookEntries(entries) {
            const container = document.getElementById('worldbook-entries');
            if (!container) return;
            
            if (entries.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 30px;"><div class="empty-state-text">ÊöÇÊó†Êù°ÁõÆÔºåÁÇπÂáªÂè≥‰∏äËßí Ôºã Ê∑ªÂä†</div></div>';
                return;
            }
            
            container.innerHTML = entries.map((entry, index) => `
                <div class="entry-item">
                    <div class="entry-header">
                        <div class="entry-keywords">üîë ${entry.keywords || 'Êó†ÂÖ≥ÈîÆËØç'}</div>
                        <div class="entry-actions">
                            <button class="entry-btn edit" onclick="editEntry(${index})">ÁºñËæë</button>
                            <button class="entry-btn delete" onclick="deleteEntry(${index})">Âà†Èô§</button>
                        </div>
                    </div>
                    <div class="entry-content">${entry.content ? entry.content.substring(0, 100) + (entry.content.length > 100 ? '...' : '') : 'Êó†ÂÜÖÂÆπ'}</div>
                </div>
            `).join('');
        }

        function addWorldbookEntry() {
            appData.currentEntryIndex = -1;
            document.getElementById('entry-keywords').value = '';
            document.getElementById('entry-content').value = '';
            openModal('entry-edit-modal');
        }

        function editEntry(index) {
            const wb = appData.worldbooks.find(w => w.id === appData.currentWorldbookId);
            if (!wb || !wb.entries[index]) return;
            appData.currentEntryIndex = index;
            document.getElementById('entry-keywords').value = wb.entries[index].keywords || '';
            document.getElementById('entry-content').value = wb.entries[index].content || '';
            openModal('entry-edit-modal');
        }

        function saveEntry() {
            const wb = appData.worldbooks.find(w => w.id === appData.currentWorldbookId);
            if (!wb) return;
            const entry = {
                keywords: document.getElementById('entry-keywords').value,
                content: document.getElementById('entry-content').value
            };
            if (appData.currentEntryIndex === -1) {
                wb.entries.push(entry);
            } else {
                wb.entries[appData.currentEntryIndex] = entry;
            }
            saveAppData();
            renderWorldbookEntries(wb.entries);
            closeModal('entry-edit-modal');
        }

        function deleteEntry(index) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ëøô‰∏™Êù°ÁõÆÂêóÔºü')) return;
            const wb = appData.worldbooks.find(w => w.id === appData.currentWorldbookId);
            if (!wb) return;
            wb.entries.splice(index, 1);
            saveAppData();
            renderWorldbookEntries(wb.entries);
        }

        function saveWorldbook() {
            const wb = appData.worldbooks.find(w => w.id === appData.currentWorldbookId);
            if (!wb) return;
            wb.name = document.getElementById('worldbook-name').value;
            saveAppData();
            alert('‰∏ñÁïå‰π¶Â∑≤‰øùÂ≠òÔºÅ');
            renderWorldbookList();
        }

        function deleteWorldbook(wbId) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ëøô‰∏™‰∏ñÁïå‰π¶ÂêóÔºü')) return;
            appData.worldbooks = appData.worldbooks.filter(w => w.id !== wbId);
            appData.characters.forEach(c => { if (c.worldbookId === wbId) c.worldbookId = ''; });
            saveAppData();
            renderWorldbookList();
        }

        function closeWorldbookEdit() {
            closeModal('worldbook-edit-modal');
            renderWorldbookList();
        }

        async function importWorldbook(event) {
            const file = event.target.files[0];
            if (!file) return;
            showLoading('Ê≠£Âú®ÂØºÂÖ•‰∏ñÁïå‰π¶...');
            try {
                const text = await file.text();
                let data;
                if (file.name.toLowerCase().endsWith('.json')) {
                    data = JSON.parse(text);
                } else {
                    const lines = text.split('\n').filter(l => l.trim());
                    data = { entries: lines.map(line => { const parts = line.split('|'); return { keywords: parts[0]?.trim() || '', content: parts.slice(1).join('|').trim() || parts[0]?.trim() }; }) };
                }
                await importWorldbookData(data, file.name.replace(/\.(json|txt)$/i, ''));
                renderWorldbookList();
                alert('‰∏ñÁïå‰π¶ÂØºÂÖ•ÊàêÂäüÔºÅ');
            } catch (e) { alert('ÂØºÂÖ•Â§±Ë¥•: ' + e.message); }
            finally { hideLoading(); }
            event.target.value = '';
        }

        async function importWorldbookData(data, name) {
            const entries = data.entries || data.data || [];
            const processedEntries = entries.map(e => ({ keywords: e.keys?.join?.(',') || e.keys || e.keywords || e.key || '', content: e.content || e.text || e.value || '' })).filter(e => e.keywords || e.content);
            const newWb = { id: generateId(), name: data.name || name || 'ÂØºÂÖ•ÁöÑ‰∏ñÁïå‰π¶', entries: processedEntries };
            appData.worldbooks.push(newWb);
            saveAppData();
            return newWb;
        }

        // ================= ËÅäÂ§©ÂäüËÉΩ =================
        function closeChat() {
            closeModal('chat-modal');
            renderCharacterList();
            openModal('character-modal');
        }

        function renderChatMessages(char) {
            const container = document.getElementById('chat-messages');
            if (!container) return;
            const userAvatar = char.userAvatar || 'https://api.dicebear.com/7.x/lorelei/png?seed=user';
            const charAvatar = char.avatar || 'https://api.dicebear.com/7.x/lorelei/png?seed=' + char.id;
            
            if (!char.chatHistory || char.chatHistory.length === 0) {
                if (char.firstMessage) {
                    container.innerHTML = `<div class="message ai"><div class="message-avatar"><img src="${charAvatar}" alt="AI"></div><div class="message-content"><div class="message-bubble">${char.firstMessage}</div><div class="message-time">È¶ñÊ¨°ÂØπËØù</div></div></div>`;
                } else {
                    container.innerHTML = '<div class="empty-state" style="padding: 40px;"><div class="empty-state-text">ÂºÄÂßãÂØπËØùÂêßÔºÅÁÇπÂáª ‚ú¶ ËÆ©AI‰∏ªÂä®ÂºÄÂè£</div></div>';
                }
                return;
            }
            
            container.innerHTML = char.chatHistory.map(msg => {
                if (msg.isVoice) {
                    return `<div class="message ${msg.role}"><div class="message-avatar"><img src="${msg.role === 'user' ? userAvatar : charAvatar}" alt="${msg.role}"></div><div class="message-content"><div class="voice-bubble" onclick="playVoiceMessage('${msg.voiceData || ''}', this)" data-text="${escapeAttr(msg.content)}"><span class="voice-icon">üé§</span><div class="voice-wave"><span></span><span></span><span></span><span></span><span></span></div><span class="voice-duration">${msg.voiceDuration || '3"'}</span></div><div class="message-time">${msg.time || ''}</div></div></div>`;
                } else {
                    return `<div class="message ${msg.role}"><div class="message-avatar"><img src="${msg.role === 'user' ? userAvatar : charAvatar}" alt="${msg.role}"></div><div class="message-content"><div class="message-bubble">${escapeHtml(msg.content)}</div><div class="message-time">${msg.time || ''}</div></div></div>`;
                }
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML.replace(/\n/g, '<br>'); }
        function escapeAttr(text) { return text.replace(/"/g, '"').replace(/'/g, '&#39;'); }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            if (!content) return;
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;
            if (!char.chatHistory) char.chatHistory = [];
            char.chatHistory.push({ role: 'user', content: content, time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }) });
            saveAppData();
            renderChatMessages(char);
            input.value = '';
            input.style.height = 'auto';
            if (char.autoSummary && char.chatHistory.length > 0 && char.chatHistory.length % char.summaryInterval === 0) { autoSummary(char); }
        }

        async function triggerAIReply() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;
            const apiSettings = appData.apiSettings;
            if (!apiSettings.main.url || !apiSettings.main.key || !apiSettings.main.model) { alert('ËØ∑ÂÖàÂú®‰∏ªÂ±èÂπïÈÖçÁΩÆAPIËÆæÁΩÆ'); return; }
            
            const btn = document.getElementById('ai-reply-btn');
            btn.classList.add('loading');
            document.getElementById('chat-status').textContent = 'Ê≠£Âú®ËæìÂÖ•...';
            
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.insertAdjacentHTML('beforeend', `<div class="message ai" id="typing-message"><div class="message-avatar"><img src="${char.avatar || 'https://api.dicebear.com/7.x/lorelei/png?seed=' + char.id}" alt="AI"></div><div class="typing-indicator"><span></span><span></span><span></span></div></div>`);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                const messages = buildPromptMessages(char);
                const temperature = parseFloat(apiSettings.main.temperature) || 0.8;
                const response = await callAPI(apiSettings.main, messages, char.offlineMode ? char.offlineLength : null, temperature);
                document.getElementById('typing-message')?.remove();
                
                if (response) {
                    const voiceEnabled = apiSettings.voice.enabled;
                    const voiceProbability = apiSettings.voice.probability || 30;
                    const shouldBeVoice = voiceEnabled && Math.random() * 100 < voiceProbability;
                    
                    char.chatHistory.push({ role: 'ai', content: response, time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }), isVoice: shouldBeVoice, voiceData: '', voiceDuration: shouldBeVoice ? Math.floor(response.length / 10) + '"' : '' });
                    saveAppData();
                    renderChatMessages(char);
                }
            } catch (e) { document.getElementById('typing-message')?.remove(); alert('AIÂõûÂ§çÂ§±Ë¥•: ' + e.message); }
            finally { btn.classList.remove('loading'); document.getElementById('chat-status').textContent = 'Âú®Á∫ø'; }
        }

        async function playVoiceMessage(voiceData, bubbleElement) {
            const text = bubbleElement.dataset.text;
            const player = document.getElementById('voice-player');
            if (bubbleElement.classList.contains('playing')) { player.pause(); player.currentTime = 0; bubbleElement.classList.remove('playing'); return; }
            document.querySelectorAll('.voice-bubble.playing').forEach(el => el.classList.remove('playing'));
            bubbleElement.classList.add('playing');
            if (voiceData) { player.src = voiceData; player.play(); player.onended = () => bubbleElement.classList.remove('playing'); return; }
            const voiceSettings = appData.apiSettings.voice;
            if (!voiceSettings.enabled || !voiceSettings.groupId || !voiceSettings.key) { alert('ËØ∑ÂÖàÈÖçÁΩÆMinimaxËØ≠Èü≥API'); bubbleElement.classList.remove('playing'); return; }
            showLoading('Ê≠£Âú®ÁîüÊàêËØ≠Èü≥...');
            try {
                const audioData = await generateVoice(text, voiceSettings);
                if (audioData) { player.src = audioData; player.play(); player.onended = () => bubbleElement.classList.remove('playing'); }
            } catch (e) { alert('ËØ≠Èü≥ÁîüÊàêÂ§±Ë¥•: ' + e.message); bubbleElement.classList.remove('playing'); }
            finally { hideLoading(); }
        }

        async function generateVoice(text, voiceSettings) {
            const url = `https://api.minimax.chat/v1/t2a_v2?GroupId=${voiceSettings.groupId}`;
            const body = { model: voiceSettings.model || 'speech-01-turbo', text: text.substring(0, 500), stream: false, voice_setting: { voice_id: voiceSettings.voiceId || 'female-shaonv', speed: 1.0, vol: 1.0, pitch: 0 }, audio_setting: { sample_rate: 32000, bitrate: 128000, format: 'mp3' } };
            const response = await fetch(url, { method: 'POST', headers: { 'Authorization': `Bearer ${voiceSettings.key}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if (!response.ok) throw new Error(`APIÈîôËØØ: ${response.status}`);
            const data = await response.json();
            if (data.base_resp && data.base_resp.status_code !== 0) throw new Error(data.base_resp.status_msg || 'ËØ≠Èü≥ÁîüÊàêÂ§±Ë¥•');
            if (data.data && data.data.audio) return `data:audio/mp3;base64,${data.data.audio}`;
            throw new Error('Êú™Ëé∑ÂèñÂà∞Èü≥È¢ëÊï∞ÊçÆ');
        }

        function buildPromptMessages(char) {
            const messages = [];
            let systemPrompt = '';
            if (char.name) { systemPrompt += `‰Ω†ÊòØ${char.name}„ÄÇ`; if (char.nickname && char.nickname !== char.name) systemPrompt += `Áî®Êà∑Áß∞Âëº‰Ω†‰∏∫${char.nickname}„ÄÇ`; systemPrompt += '\n\n'; }
            if (char.persona) systemPrompt += `„ÄêËßíËâ≤ËÆæÂÆö„Äë\n${char.persona}\n\n`;
            if (char.scenario) systemPrompt += `„ÄêÂú∫ÊôØ„Äë\n${char.scenario}\n\n`;
            if (char.userName || char.userPersona) { systemPrompt += `„ÄêÁî®Êà∑‰ø°ÊÅØ„Äë\n`; if (char.userName) systemPrompt += `Áî®Êà∑ÂêçÔºö${char.userName}\n`; if (char.userNickname) systemPrompt += `Áî®Êà∑Â∏åÊúõË¢´Áß∞‰∏∫Ôºö${char.userNickname}\n`; if (char.userPersona) systemPrompt += `Áî®Êà∑ËÆæÂÆöÔºö${char.userPersona}\n`; systemPrompt += '\n'; }
            if (char.worldbookId) { const wb = appData.worldbooks.find(w => w.id === char.worldbookId); if (wb && wb.entries && wb.entries.length > 0) { const recentText = (char.chatHistory || []).slice(-10).map(m => m.content).join(' ').toLowerCase(); const matchedEntries = wb.entries.filter(e => { if (!e.keywords) return false; let keywords = []; if (typeof e.keywords === 'string') { keywords = e.keywords.split(/[,Ôºå]/); } else if (Array.isArray(e.keywords)) { keywords = e.keywords; } keywords = keywords.map(k => String(k).trim().toLowerCase()); return keywords.some(k => k && recentText.includes(k)); }); const baseEntries = wb.entries.slice(0, 3); const allEntries = [...new Set([...matchedEntries, ...baseEntries])]; if (allEntries.length > 0) { systemPrompt += `„Äê‰∏ñÁïåËÉåÊôØ„Äë\n`; allEntries.forEach(e => { if (e.content) systemPrompt += `${e.content}\n`; }); systemPrompt += '\n'; } } }
            if (char.summaries && char.summaries.length > 0) { systemPrompt += `„Äê‰πãÂâçÁöÑÂØπËØùÊÄªÁªì„Äë\n`; char.summaries.slice(-3).forEach(s => systemPrompt += `- ${s}\n`); systemPrompt += '\n'; }
            if (char.timeAware) { const now = new Date().toLocaleString('zh-CN', { timeZone: char.timezone, year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: '2-digit', minute: '2-digit' }); systemPrompt += `„ÄêÂΩìÂâçÊó∂Èó¥„Äë${now}\n`; }
            if (char.weatherAware && char.weather) systemPrompt += `„ÄêÂΩìÂâçÂ§©Ê∞î„Äë${char.weather}\n`;
            if (char.offlineMode) systemPrompt += `\n„ÄêËæìÂá∫Ë¶ÅÊ±Ç„ÄëËØ∑‰ª•ÈïøÊñáÂΩ¢ÂºèËØ¶ÁªÜÂõûÂ§çÔºåÂ≠óÊï∞Á∫¶${char.offlineLength}Â≠óÔºåÂåÖÂê´‰∏∞ÂØåÁöÑÁªÜËäÇÊèèÂÜô„ÄÇ\n`;
            if (char.exampleDialogue) systemPrompt += `\n„ÄêÂØπËØùÈ£éÊ†ºÂèÇËÄÉ„Äë\n${char.exampleDialogue}\n`;
            messages.push({ role: 'system', content: systemPrompt });
            if (char.firstMessage && (!char.chatHistory || char.chatHistory.length === 0)) messages.push({ role: 'assistant', content: char.firstMessage });
            const historyLimit = char.memoryCount || 50;
            (char.chatHistory || []).slice(-historyLimit).forEach(msg => messages.push({ role: msg.role === 'user' ? 'user' : 'assistant', content: msg.content }));
            return messages;
        }

        async function callAPI(apiConfig, messages, maxTokens = null, temperature = 0.8) {
            let url = apiConfig.url.replace(/\/+$/, '');
            if (!url.includes('/chat/completions')) url += '/v1/chat/completions';
            const body = { model: apiConfig.model, messages: messages, temperature: temperature };
            if (maxTokens) body.max_tokens = Math.min(maxTokens * 2, 4000);
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiConfig.key}` }, body: JSON.stringify(body) });
            if (!response.ok) { const error = await response.text(); throw new Error(`APIÈîôËØØ ${response.status}: ${error.substring(0, 200)}`); }
            const data = await response.json();
            return data.choices?.[0]?.message?.content || '';
        }

        async function autoSummary(char) {
            const apiConfig = appData.apiSettings.sub.url ? appData.apiSettings.sub : appData.apiSettings.main;
            if (!apiConfig.url || !apiConfig.key || !apiConfig.model) return;
            await performSummary(char, Math.max(0, char.chatHistory.length - char.summaryInterval), char.chatHistory.length, apiConfig);
        }

        async function manualSummary() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char || !char.chatHistory) return;
            const start = parseInt(document.getElementById('summary-start').value) - 1;
            const end = parseInt(document.getElementById('summary-end').value);
            if (isNaN(start) || isNaN(end) || start < 0 || end > char.chatHistory.length || start >= end) { alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑËåÉÂõ¥'); return; }
            const apiConfig = appData.apiSettings.sub.url ? appData.apiSettings.sub : appData.apiSettings.main;
            if (!apiConfig.url || !apiConfig.key || !apiConfig.model) { alert('ËØ∑ÂÖàÈÖçÁΩÆAPI'); return; }
            showLoading('Ê≠£Âú®ÊÄªÁªì...');
            try { await performSummary(char, start, end, apiConfig); alert('ÊÄªÁªìÂÆåÊàêÔºÅ'); }
            catch (e) { alert('ÊÄªÁªìÂ§±Ë¥•: ' + e.message); }
            finally { hideLoading(); }
        }

        async function performSummary(char, startIdx, endIdx, apiConfig) {
            const historySlice = char.chatHistory.slice(startIdx, endIdx);
            if (historySlice.length === 0) return;
            const prompt = char.summaryPrompt || '‰ª•ËßíËâ≤Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÂèôËø∞Êàë‰ª¨ËÅäÂ§©‰∏≠ÊèêÂà∞ÁöÑ‰∫ãÊÉÖÔºå100Â≠óÂÜÖ';
            const messages = [{ role: 'system', content: `‰Ω†ÊòØ${char.name || '‰∏Ä‰∏™AIÂä©Êâã'}„ÄÇËØ∑${prompt}„ÄÇÂè™ËæìÂá∫ÊÄªÁªìÂÜÖÂÆπÔºå‰∏çË¶ÅÊúâ‰ªª‰ΩïÈ¢ùÂ§ñËØ¥Êòé„ÄÇ` }, { role: 'user', content: '‰ª•‰∏ãÊòØÈúÄË¶ÅÊÄªÁªìÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºö\n\n' + historySlice.map(m => `${m.role === 'user' ? 'Áî®Êà∑' : char.name || 'AI'}Ôºö${m.content}`).join('\n\n') }];
            const summary = await callAPI(apiConfig, messages);
            if (summary) { if (!char.summaries) char.summaries = []; char.summaries.push(`[${startIdx + 1}-${endIdx}] ${summary}`); saveAppData(); }
        }

        function exportChatHistory() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;
            const data = { characterName: char.name, characterNickname: char.nickname, exportTime: new Date().toISOString(), chatHistory: char.chatHistory || [], summaries: char.summaries || [] };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `chat_${char.nickname || char.name || 'export'}_${Date.now()}.json`; a.click();
            URL.revokeObjectURL(url);
        }

        function importChatHistory(event) {
            const file = event.target.files[0];
            if (!file) return;
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;
            file.text().then(text => {
                try {
                    const data = JSON.parse(text);
                    if (data.chatHistory) { if (confirm('ÊòØÂê¶Ë¶ÜÁõñÂΩìÂâçËÅäÂ§©ËÆ∞ÂΩïÔºü')) char.chatHistory = data.chatHistory; else char.chatHistory = [...(char.chatHistory || []), ...data.chatHistory]; }
                    if (data.summaries) char.summaries = [...(char.summaries || []), ...data.summaries];
                    saveAppData();
                    alert('ËÅäÂ§©ËÆ∞ÂΩïÂØºÂÖ•ÊàêÂäüÔºÅ');
                } catch (e) { alert('ÂØºÂÖ•Â§±Ë¥•: ' + e.message); }
            });
            event.target.value = '';
        }

        // ================= APIËÆæÁΩÆ =================
        async function fetchModels(type) {
            const urlInput = document.getElementById(type === 'main' ? 'main-api-url' : 'sub-api-url');
            const keyInput = document.getElementById(type === 'main' ? 'main-api-key' : 'sub-api-key');
            const select = document.getElementById(type === 'main' ? 'main-model-select' : 'sub-model-select');
            const url = urlInput.value.trim();
            const key = keyInput.value.trim();
            if (!url) { alert('ËØ∑Â°´ÂÜôAPIÂú∞ÂùÄ'); return; }
            select.innerHTML = '<option>Âä†ËΩΩ‰∏≠...</option>';
            try {
                let fetchUrl = url.replace(/\/+$/, '');
                if (!fetchUrl.includes('/models')) fetchUrl += '/v1/models';
                const response = await fetch(fetchUrl, { method: 'GET', headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' } });
                if (!response.ok) throw new Error(`ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
                const data = await response.json();
                select.innerHTML = '<option value="">ÈÄâÊã©Ê®°Âûã</option>';
                const models = data.data || data.models || [];
                if (Array.isArray(models) && models.length > 0) { models.forEach(model => { const id = model.id || model.name || model; const option = document.createElement('option'); option.value = id; option.textContent = id; select.appendChild(option); }); alert(`ÊàêÂäüÊãâÂèñ ${models.length} ‰∏™Ê®°Âûã`); }
                else throw new Error('Êú™ÊâæÂà∞ÂèØÁî®Ê®°Âûã');
            } catch (error) { alert('ÊãâÂèñÂ§±Ë¥•: ' + error.message); select.innerHTML = '<option value="">ËØ∑ÂÖàÊãâÂèñÊ®°Âûã</option>'; }
        }

        async function fetchMinimaxVoiceModels() {
            const groupId = document.getElementById('voice-group-id').value.trim();
            const apiKey = document.getElementById('voice-api-key').value.trim();
            const select = document.getElementById('voice-model-select');
            if (!groupId || !apiKey) { alert('ËØ∑ÂÖàÂ°´ÂÜôGroup IDÂíåAPIÂØÜÈí•'); return; }
            select.innerHTML = '<option>Âä†ËΩΩ‰∏≠...</option>';
            showLoading('Ê≠£Âú®ÊãâÂèñËØ≠Èü≥Ê®°Âûã...');
            try {
                const response = await fetch(`https://api.minimax.chat/v1/t2a/voices?GroupId=${groupId}`, { method: 'GET', headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' } });
                if (!response.ok) throw new Error(`ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
                const data = await response.json();
                select.innerHTML = '<option value="">ÈÄâÊã©ËØ≠Èü≥Ê®°Âûã</option>';
                if (data.voices && data.voices.length > 0) { data.voices.forEach(voice => { const option = document.createElement('option'); option.value = voice.voice_id || voice.id; option.textContent = voice.name || voice.voice_id; select.appendChild(option); }); alert(`ÊàêÂäüÊãâÂèñ ${data.voices.length} ‰∏™ËØ≠Èü≥Ê®°Âûã`); }
                else throw new Error('Êú™ÊâæÂà∞ÂèØÁî®ËØ≠Èü≥Ê®°Âûã');
            } catch (error) {
                select.innerHTML = '<option value="">ÈÄâÊã©ËØ≠Èü≥Ê®°Âûã</option>';
                const defaultVoices = [{ id: 'female-shaonv', name: 'Â∞ëÂ•≥Èü≥Ëâ≤' }, { id: 'female-yujie', name: 'Âæ°ÂßêÈü≥Ëâ≤' }, { id: 'female-chengshu', name: 'ÊàêÁÜüÂ•≥ÊÄß' }, { id: 'female-tianmei', name: 'ÁîúÁæéÂ•≥ÊÄß' }, { id: 'male-qn-qingse', name: 'ÈùíÊ∂©ÈùíÂπ¥' }, { id: 'male-qn-jingying', name: 'Á≤æËã±ÈùíÂπ¥' }, { id: 'male-qn-badao', name: 'Èú∏ÈÅìÈùíÂπ¥' }];
                defaultVoices.forEach(voice => { const option = document.createElement('option'); option.value = voice.id; option.textContent = voice.name; select.appendChild(option); });
                alert('Â∑≤Âä†ËΩΩÈ¢ÑËÆæËØ≠Èü≥Ê®°Âûã');
            } finally { hideLoading(); }
        }

        function savePreset() {
            const url = document.getElementById('main-api-url').value;
            const key = document.getElementById('main-api-key').value;
            const model = document.getElementById('main-model-select').value;
            const temperature = document.getElementById('main-temperature').value;
            if (!url || !model) { alert('ËØ∑Â°´ÂÜôÂú∞ÂùÄÂπ∂ÈÄâÊã©Ê®°Âûã'); return; }
            const name = prompt("ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞", "ÊàëÁöÑÈ¢ÑËÆæ");
            if (!name) return;
            appData.presets.push({ name, url, key, model, temperature });
            saveAppData();
            renderPresets();
            alert('È¢ÑËÆæÂ∑≤‰øùÂ≠ò');
        }

        function renderPresets() {
            const container = document.getElementById('preset-list');
            if (!container) return;
            container.innerHTML = appData.presets.map((preset, index) => `<div class="preset-tag" onclick="loadPreset(${index})" oncontextmenu="event.preventDefault(); deletePreset(${index})">${preset.name}</div>`).join('');
        }

        function loadPreset(index) {
            const preset = appData.presets[index];
            if (preset) {
                document.getElementById('main-api-url').value = preset.url;
                document.getElementById('main-api-key').value = preset.key;
                document.getElementById('main-temperature').value = preset.temperature || 0.8;
                document.getElementById('temp-value').textContent = preset.temperature || 0.8;
                const select = document.getElementById('main-model-select');
                let found = false;
                for (let i = 0; i < select.options.length; i++) { if (select.options[i].value === preset.model) { select.selectedIndex = i; found = true; break; } }
                if (!found && preset.model) { const option = document.createElement('option'); option.value = preset.model; option.textContent = preset.model; option.selected = true; select.appendChild(option); }
                alert('Â∑≤Âä†ËΩΩÈ¢ÑËÆæ: ' + preset.name);
            }
        }

        function deletePreset(index) {
            if (confirm('Âà†Èô§Ê≠§È¢ÑËÆæÔºü')) { appData.presets.splice(index, 1); saveAppData(); renderPresets(); }
        }

        function saveAPISettings() {
            appData.apiSettings = {
                main: { url: document.getElementById('main-api-url').value, key: document.getElementById('main-api-key').value, model: document.getElementById('main-model-select').value, temperature: parseFloat(document.getElementById('main-temperature').value) || 0.8 },
                sub: { url: document.getElementById('sub-api-url').value, key: document.getElementById('sub-api-key').value, model: document.getElementById('sub-model-select').value },
                imgGen: document.getElementById('img-gen-switch').checked,
                voice: { enabled: document.getElementById('voice-switch').checked, groupId: document.getElementById('voice-group-id').value, key: document.getElementById('voice-api-key').value, model: document.getElementById('voice-model-select').value, voiceId: document.getElementById('voice-id-input').value, probability: parseInt(document.getElementById('voice-probability').value) || 30 },
                activeMsg: { enabled: document.getElementById('active-msg-switch').checked, time: document.getElementById('active-msg-time').value }
            };
            saveAppData();
            alert('APIÈÖçÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
            closeModal('api-modal');
        }

        function loadAPISettings() {
            const settings = appData.apiSettings;
            if (settings.main) { document.getElementById('main-api-url').value = settings.main.url || ''; document.getElementById('main-api-key').value = settings.main.key || ''; document.getElementById('main-temperature').value = settings.main.temperature || 0.8; document.getElementById('temp-value').textContent = settings.main.temperature || 0.8; if (settings.main.model) document.getElementById('main-model-select').innerHTML = `<option value="${settings.main.model}" selected>${settings.main.model}</option>`; }
            if (settings.sub) { document.getElementById('sub-api-url').value = settings.sub.url || ''; document.getElementById('sub-api-key').value = settings.sub.key || ''; if (settings.sub.model) document.getElementById('sub-model-select').innerHTML = `<option value="${settings.sub.model}" selected>${settings.sub.model}</option>`; }
            document.getElementById('img-gen-switch').checked = settings.imgGen || false;
            if (settings.voice) { document.getElementById('voice-switch').checked = settings.voice.enabled || false; toggleArea('voice-settings', settings.voice.enabled); document.getElementById('voice-group-id').value = settings.voice.groupId || ''; document.getElementById('voice-api-key').value = settings.voice.key || ''; document.getElementById('voice-id-input').value = settings.voice.voiceId || ''; document.getElementById('voice-probability').value = settings.voice.probability || 30; document.getElementById('voice-prob-value').textContent = (settings.voice.probability || 30) + '%'; if (settings.voice.model) document.getElementById('voice-model-select').innerHTML = `<option value="${settings.voice.model}" selected>${settings.voice.model}</option>`; }
            if (settings.activeMsg) { document.getElementById('active-msg-switch').checked = settings.activeMsg.enabled || false; toggleArea('active-msg-settings', settings.activeMsg.enabled); document.getElementById('active-msg-time').value = settings.activeMsg.time || 60; }
            renderPresets();
        }

        // ================= ‰∫ã‰ª∂ÁªëÂÆö =================
        document.getElementById('character-icon').addEventListener('click', function() { renderCharacterList(); openModal('character-modal'); });
        document.getElementById('worldbook-icon').addEventListener('click', function() { renderWorldbookList(); openModal('worldbook-modal'); });
        document.getElementById('api-settings-icon').addEventListener('click', function() { loadAPISettings(); openModal('api-modal'); });
        document.getElementById('appearance-icon').addEventListener('click', function() { openAppearanceSettings(); });

        document.getElementById('chat-input')?.addEventListener('keydown', function(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

        document.querySelectorAll('.app-icon:not(#character-icon):not(#worldbook-icon):not(#api-settings-icon):not(#appearance-icon), .bottom-app').forEach(icon => {
            icon.addEventListener('click', function() { const iconImg = this.querySelector('.icon-img'); if (iconImg) { iconImg.style.transform = 'scale(0.9)'; setTimeout(() => { iconImg.style.transform = 'scale(1)'; }, 150); } });
        });

        document.getElementById('delete-confirm-overlay').addEventListener('click', function(e) { if (e.target === this) hideDeleteConfirm(); });

        // ÂàùÂßãÂåñ
        loadAppData();
        
        // Service Worker Ê≥®ÂÜå
        if ('serviceWorker' in navigator) {
           window.addEventListener('load', () => {
               navigator.serviceWorker.register('sw.js')
                   .then(registration => console.log('SW registered'))
                   .catch(err => console.log('SW failed', err));
           });
        }
    </script>
</body>
</html>
