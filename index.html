<<<<<<< HEAD
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="‰ªøAppÂ∞èÊâãÊú∫">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#e8f8f5">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="manifest" href="manifest.json">
    <title>‰ªøÂæÆ‰ø°ÊâãÊú∫ÁïåÈù¢ - ËßíËâ≤ËÅäÂ§©Á≥ªÁªü</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        :root {
            --custom-font: 'PingFang SC', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        body {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            min-height: 100dvh;
            background: linear-gradient(160deg, #e8f8f5 0%, #d5f5e3 25%, #abebc6 50%, #d5f5e3 75%, #e8f8f5 100%);
            font-family: var(--custom-font);
            display: flex;
            justify-content: center;
        }

        .phone {
            width: 100%;
            max-width: 450px;
            height: 100vh;
            height: -webkit-fill-available;
            height: 100dvh;
            position: relative;
            display: flex;
            flex-direction: column;
            background: transparent;
            box-shadow: 0 0 50px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .phone-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 0;
        }

        .decoration {
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
            pointer-events: none;
            z-index: 1;
        }

        .deco1 { width: 120px; height: 120px; background: radial-gradient(circle, #fff 0%, transparent 70%); top: 60px; right: 10%; }
        .deco2 { width: 80px; height: 80px; background: radial-gradient(circle, #fff 0%, transparent 70%); top: 300px; left: 5%; }
        .deco3 { width: 60px; height: 60px; background: radial-gradient(circle, #fff 0%, transparent 70%); bottom: 150px; right: 10%; }

        .stars {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
        }

        .star {
            position: absolute;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            animation: twinkle 2s ease-in-out infinite;
        }

        .star:nth-child(1) { top: 15%; left: 10%; animation-delay: 0s; }
        .star:nth-child(2) { top: 25%; right: 15%; animation-delay: 0.5s; }
        .star:nth-child(3) { top: 55%; left: 8%; animation-delay: 1s; }
        .star:nth-child(4) { top: 70%; right: 12%; animation-delay: 1.5s; }

        @keyframes twinkle {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            z-index: 2;
            scrollbar-width: none;
        }

        .content-wrapper::-webkit-scrollbar { display: none; }

        .status-bar {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            padding-top: calc(15px + env(safe-area-inset-top, 0px));
            color: #5d8a66;
            font-size: 14px;
            font-weight: 500;
        }

        .time { font-size: 16px; letter-spacing: 1px; }
        .battery { display: flex; align-items: center; gap: 4px; }
        .battery-icon {
            width: 24px; height: 11px;
            border: 1.5px solid #5d8a66;
            border-radius: 3px;
            position: relative;
            display: flex; align-items: center; padding: 1px;
        }
        .battery-icon::after {
            content: ''; position: absolute; right: -4px;
            width: 2px; height: 5px; background: #5d8a66; border-radius: 0 2px 2px 0;
        }
        .battery-level {
            width: 85%; height: 100%;
            background: linear-gradient(90deg, #81c784, #4caf50);
            border-radius: 1px;
        }
        .battery-percent { font-size: 13px; }

        .avatar-section {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .avatar-frame {
            width: 85px; height: 85px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.9);
            overflow: hidden;
            background: linear-gradient(135deg, #fff 0%, #f0fff0 100%);
            box-shadow: 0 4px 20px rgba(129, 199, 132, 0.3), 0 0 0 5px rgba(255,255,255,0.3);
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .avatar-frame:hover {
            transform: scale(1.05);
        }
        
        .avatar-frame::before {
            content: '‚úø'; position: absolute; top: -8px; right: -5px;
            font-size: 16px; color: #f8bbd9; z-index: 10;
        }

        .avatar-frame img { width: 100%; height: 100%; object-fit: cover; }

        .input-section {
            flex-shrink: 0;
            padding: 0 45px;
            margin-bottom: 10px;
        }

        .text-input {
            width: 100%; padding: 12px 16px;
            border: none; border-radius: 20px;
            background: rgba(255,255,255,0.85);
            font-size: 14px; outline: none;
            box-shadow: 0 2px 12px rgba(129, 199, 132, 0.2), inset 0 1px 3px rgba(255,255,255,0.8);
            text-align: center; color: #5d8a66;
        }
        .text-input::placeholder { color: #a5d6a7; font-size: 13px; }

        .apps-container {
            flex-shrink: 0;
            position: relative;
            width: 360px;
            height: 380px;
            margin: 10px auto 0;
        }

        .app-icon {
            position: absolute;
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .app-icon:hover { transform: scale(1.15) translateY(-3px); }
        .app-icon:active { transform: scale(0.95); }

        .icon-img {
            width: 58px; height: 58px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.75);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(129, 199, 132, 0.2), 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden; transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .app-icon:hover .icon-img {
            box-shadow: 0 8px 24px rgba(129, 199, 132, 0.35), 0 2px 8px rgba(0,0,0,0.08);
        }

        /* ÁÆÄÁ¨îÁîªSVGÂõæÊ†áÊ†∑Âºè */
        .icon-img svg {
            width: 36px;
            height: 36px;
        }

        .icon-img img {
            width: 36px;
            height: 36px;
            object-fit: contain;
        }

        .app-name {
            margin-top: 6px; font-size: 11px; color: #5d8a66;
            text-align: center; max-width: 65px; font-weight: 500; letter-spacing: 0.3px;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }

        .app-icon:nth-child(1) { left: 105px; top: 20px; }
        .app-icon:nth-child(2) { right: 105px; top: 20px; }
        .app-icon:nth-child(3) { left: 55px; top: 80px; }
        .app-icon:nth-child(4) { right: 55px; top: 80px; }
        .app-icon:nth-child(5) { left: 90px; top: 155px; }
        .app-icon:nth-child(6) { right: 90px; top: 155px; }
        .app-icon:nth-child(7) { left: 50%; transform: translateX(-50%); top: 230px; }
        .app-icon:nth-child(7):hover { transform: translateX(-50%) scale(1.15) translateY(-3px); }

        .bottom-area {
            margin-top: auto;
            flex-shrink: 0;
            width: 100%;
            padding-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .bottom-apps {
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            width: 100%;
            padding: 10px 20px;
        }

        .bottom-app {
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bottom-app:hover { transform: scale(1.15) translateY(-3px); }
        .bottom-app:active { transform: scale(0.95); }
        
        .bottom-app .icon-img {
            width: 58px; height: 58px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.75);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(129, 199, 132, 0.2), 0 1px 3px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .bottom-app:hover .icon-img {
            box-shadow: 0 8px 24px rgba(129, 199, 132, 0.35), 0 2px 8px rgba(0,0,0,0.08);
        }

        .bottom-app .app-name {
            margin-top: 6px; font-size: 11px; color: #5d8a66;
            text-align: center; font-weight: 500; letter-spacing: 0.3px;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }

        .bottom-decoration {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: rgba(129, 199, 132, 0.4);
        }
        .dot.active {
            width: 18px; border-radius: 9px;
            background: linear-gradient(90deg, #81c784, #66bb6a);
        }

        .bottom-bar {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 5px;
            background: rgba(93, 138, 102, 0.3);
            border-radius: 3px;
            z-index: 10;
        }

        /* ================= ÈÄöÁî®Ê®°ÊÄÅÊ°ÜÊ†∑Âºè ================= */
        .modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: flex-end;
            backdrop-filter: blur(3px);
        }

        .modal.full-screen {
            align-items: stretch;
        }

        .modal-content {
            background: #fff;
            width: 100%;
            height: 85%;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }

        .modal-content.full-height {
            height: 100%;
            border-radius: 0;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .modal-header h2 {
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn {
            font-size: 20px;
            color: #5d8a66;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .back-btn:hover {
            transform: translateX(-3px);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-btn {
            font-size: 22px;
            color: #5d8a66;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .header-btn:hover {
            transform: scale(1.1);
        }

        .close-btn {
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 5px;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .setting-section {
            margin-bottom: 25px;
            background: #f9fcf9;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e8f5e9;
        }

        .setting-section h3 {
            font-size: 14px;
            color: #5d8a66;
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 8px;
            background: #fff;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: #81c784;
            outline: none;
        }

        .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 8px;
            background: #fff;
            transition: border-color 0.3s;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .form-textarea:focus {
            border-color: #81c784;
            outline: none;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary {
            background: #81c784;
            color: white;
        }
        .btn-primary:hover { background: #66bb6a; }

        .btn-secondary {
            background: #e0e0e0;
            color: #555;
        }
        .btn-secondary:hover { background: #d5d5d5; }

        .btn-danger {
            background: #ef5350;
            color: white;
        }
        .btn-danger:hover { background: #e53935; }

        .form-select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
        }

        .switch-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .switch-row span {
            font-size: 13px;
            color: #555;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #81c784;
        }

        input:checked + .slider:before {
            transform: translateX(18px);
        }

        .modal-footer {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            text-align: center;
            flex-shrink: 0;
        }

        .save-all-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #81c784, #4caf50);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }
        .save-all-btn:active {
            transform: scale(0.98);
        }

        .hidden-area {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }

        .preset-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .preset-tag {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            border: 1px solid #c8e6c9;
        }
        .preset-tag:hover {
            background: #c8e6c9;
        }

        /* ================= ËßíËâ≤ÂàóË°®Ê†∑Âºè ================= */
        .character-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .character-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9fcf9;
            border-radius: 12px;
            border: 1px solid #e8f5e9;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .character-item:hover {
            background: #e8f5e9;
            transform: translateX(5px);
        }

        .character-item.long-press {
            background: #ffebee;
            border-color: #ffcdd2;
            transform: scale(0.98);
        }

        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 12px;
            border: 2px solid #81c784;
            flex-shrink: 0;
        }

        .character-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-info {
            flex: 1;
            min-width: 0;
        }

        .character-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .character-desc {
            font-size: 12px;
            color: #888;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .character-delete {
            padding: 8px;
            color: #ef5350;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .character-delete:hover {
            opacity: 1;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #aaa;
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
            text-align: center;
            line-height: 1.6;
        }

        /* ================= ‰∏ñÁïå‰π¶ÂàóË°®Ê†∑Âºè ================= */
        .worldbook-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9fcf9;
            border-radius: 12px;
            border: 1px solid #e8f5e9;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .worldbook-item:hover {
            background: #e8f5e9;
        }

        .worldbook-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #81c784, #4caf50);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
            font-size: 20px;
        }

        .worldbook-info {
            flex: 1;
        }

        .worldbook-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .worldbook-entries {
            font-size: 11px;
            color: #888;
        }

        /* ================= ËÅäÂ§©ÁïåÈù¢Ê†∑Âºè ================= */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #f5f5f5;
            position: relative;
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px;
            padding-top: calc(15px + env(safe-area-inset-top, 0px));
            background: #fff;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            z-index: 10;
        }

        .chat-header .back-btn {
            margin-right: 10px;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 10px;
        }

        .chat-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .chat-header-status {
            font-size: 12px;
            color: #888;
        }

        .chat-header-settings {
            padding: 10px;
            font-size: 20px;
            color: #5d8a66;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chat-header-settings:hover {
            transform: rotate(45deg);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            display: flex;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.ai {
            align-self: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            margin: 0 8px;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #81c784, #66bb6a);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.ai .message-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message-time {
            font-size: 10px;
            color: #aaa;
            margin-top: 4px;
            padding: 0 5px;
        }

        .message.user .message-time {
            text-align: right;
        }

        /* ËØ≠Èü≥Ê∂àÊÅØÊ†∑Âºè */
        .voice-bubble {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 18px;
            background: white;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
            min-width: 100px;
            transition: background 0.2s;
        }

        .voice-bubble:hover {
            background: #f5f5f5;
        }

        .voice-bubble.playing {
            background: #e8f5e9;
        }

        .voice-icon {
            font-size: 18px;
            animation: none;
        }

        .voice-bubble.playing .voice-icon {
            animation: voiceWave 1s infinite;
        }

        @keyframes voiceWave {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .voice-duration {
            font-size: 12px;
            color: #888;
        }

        .voice-wave {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 20px;
        }

        .voice-wave span {
            width: 3px;
            background: #81c784;
            border-radius: 2px;
            animation: wave 0.5s ease-in-out infinite;
        }

        .voice-wave span:nth-child(1) { height: 8px; animation-delay: 0s; }
        .voice-wave span:nth-child(2) { height: 14px; animation-delay: 0.1s; }
        .voice-wave span:nth-child(3) { height: 10px; animation-delay: 0.2s; }
        .voice-wave span:nth-child(4) { height: 16px; animation-delay: 0.3s; }
        .voice-wave span:nth-child(5) { height: 12px; animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.5); }
        }

        .chat-input-area {
            display: flex;
            align-items: flex-end;
            padding: 10px 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
            background: #fff;
            border-top: 1px solid #eee;
            gap: 8px;
            flex-shrink: 0;
            z-index: 10;
            transition: transform 0.3s ease;
        }

        .chat-input {
            flex: 1;
            min-height: 36px;
            max-height: 100px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 18px;
            font-size: 14px;
            resize: none;
            outline: none;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #81c784;
        }

        /* Êåâ‰ΩèËØ¥ËØùÊåâÈíÆ */
        .voice-hold-btn {
            flex: 1;
            height: 36px;
            border-radius: 18px;
            border: 1px solid #ddd;
            background: #f5f5f5;
            color: #333;
            font-size: 14px;
            font-weight: bold;
            display: none; /* ÈªòËÆ§ÈöêËóè */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .voice-hold-btn:active {
            background: #e0e0e0;
        }
        
        .voice-hold-btn.recording {
            background: #c8e6c9;
            color: #2e7d32;
            border-color: #81c784;
        }

        .chat-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            background: transparent;
            color: #666;
        }
        
        .chat-btn:hover {
            background: #f0f0f0;
        }

        .chat-btn.star-btn {
            background: linear-gradient(135deg, #ffd54f, #ffb300);
            color: white;
            font-size: 18px;
        }

        .chat-btn.star-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 179, 0, 0.4);
        }
        
        .chat-btn.regen-btn {
            color: #5d8a66;
        }
        
        .chat-btn.regen-btn:hover {
            background: #e8f5e9;
            transform: rotate(180deg);
        }

        .chat-btn.star-btn.loading {
            animation: pulse 1s infinite;
            pointer-events: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.95); }
        }

        .chat-btn.send-btn {
            background: linear-gradient(135deg, #81c784, #4caf50);
            color: white;
            font-size: 16px;
        }

        .chat-btn.send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        /* ================= ËßíËâ≤ÁºñËæëÊ†∑Âºè ================= */
        .avatar-upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #81c784;
            margin-bottom: 10px;
            cursor: pointer;
            position: relative;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-preview:hover::after {
            content: 'üì∑';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .inline-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .inline-input .form-input {
            flex: 1;
            margin-bottom: 0;
        }

        .inline-input span {
            font-size: 13px;
            color: #555;
            white-space: nowrap;
        }

        .tokens-display {
            background: #e8f5e9;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }

        .tokens-display .label {
            font-size: 12px;
            color: #666;
        }

        .tokens-display .value {
            font-size: 20px;
            font-weight: bold;
            color: #4caf50;
        }

        /* ================= ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• ================= */
        .hidden-input {
            display: none;
        }

        /* ================= ÊªöÂä®Êù°ÁæéÂåñ ================= */
        .modal-body::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .modal-body::-webkit-scrollbar-track,
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-body::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 2px;
        }

        /* ================= ‰∏ñÁïå‰π¶Êù°ÁõÆÁºñËæë ================= */
        .entry-item {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .entry-keywords {
            font-size: 12px;
            color: #81c784;
            font-weight: 600;
        }

        .entry-content {
            font-size: 13px;
            color: #555;
            line-height: 1.5;
        }

        .entry-actions {
            display: flex;
            gap: 8px;
        }

        .entry-btn {
            padding: 4px 8px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .entry-btn.edit {
            background: #e3f2fd;
            color: #1976d2;
        }

        .entry-btn.delete {
            background: #ffebee;
            color: #d32f2f;
        }

        /* Âä†ËΩΩÊèêÁ§∫ */
        .loading-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 9999;
            display: none;
        }

        .loading-toast.show {
            display: block;
        }

        /* ÊâìÂ≠óÊåáÁ§∫Âô® */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #ccc;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* PWAÂÆâË£ÖÊèêÁ§∫ */
        .pwa-install-prompt {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 9999;
            max-width: 90%;
            text-align: center;
        }

        .pwa-install-prompt.show {
            display: block;
            animation: slideUpPrompt 0.3s ease-out;
        }

        @keyframes slideUpPrompt {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .pwa-install-prompt p {
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }

        .pwa-install-prompt .btn-row {
            justify-content: center;
        }

        /* Ê∏©Â∫¶ÊªëÂùóÊ†∑Âºè */
        .temperature-slider {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .temperature-slider input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #81c784, #ffb300, #ef5350);
            border-radius: 3px;
            outline: none;
        }

        .temperature-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid #81c784;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .temperature-value {
            min-width: 40px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #5d8a66;
        }

        /* Âà†Èô§Á°ÆËÆ§ÂºπÁ™ó */
        .delete-confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        .delete-confirm-overlay.show {
            display: flex;
        }

        .delete-confirm-box {
            background: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            max-width: 280px;
            animation: popIn 0.2s ease-out;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .delete-confirm-box h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
        }

        .delete-confirm-box p {
            font-size: 13px;
            color: #666;
            margin-bottom: 20px;
        }

        .delete-confirm-box .btn-row {
            justify-content: center;
        }

        /* ================= Â§ñËßÇËÆæÁΩÆÂõæÊ†áÁºñËæëÊ†∑Âºè ================= */
        .icon-edit-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .icon-edit-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .icon-edit-item:hover {
            transform: scale(1.05);
        }

        .icon-edit-preview {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
            border: 2px dashed #ccc;
            overflow: hidden;
            position: relative;
        }

        .icon-edit-preview:hover {
            border-color: #81c784;
        }

        .icon-edit-preview svg,
        .icon-edit-preview img {
            width: 30px;
            height: 30px;
        }

        .icon-edit-preview::after {
            content: '‚úèÔ∏è';
            position: absolute;
            bottom: -2px;
            right: -2px;
            font-size: 10px;
            background: white;
            border-radius: 50%;
            padding: 2px;
        }

        .icon-edit-name {
            font-size: 10px;
            color: #666;
            text-align: center;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bg-preview-box {
            width: 100%;
            height: 120px;
            border-radius: 12px;
            background: linear-gradient(160deg, #e8f8f5 0%, #d5f5e3 25%, #abebc6 50%, #d5f5e3 75%, #e8f8f5 100%);
            background-size: cover;
            background-position: center;
            border: 2px dashed #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .bg-preview-box:hover {
            border-color: #81c784;
        }

        .bg-preview-box span {
            background: rgba(255,255,255,0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: #5d8a66;
        }

        .main-avatar-edit {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #81c784;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            margin: 0 auto 10px;
        }

        .main-avatar-edit img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .main-avatar-edit:hover::after {
            content: 'üì∑';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* ÂõæÊ†áÁºñËæëÂºπÁ™ó */
        .icon-edit-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 300;
            width: 90%;
            max-width: 300px;
            display: none;
        }

        .icon-edit-popup.show {
            display: block;
            animation: popIn 0.2s ease-out;
        }

        .icon-edit-popup h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .icon-edit-popup .current-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            border-radius: 14px;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .icon-edit-popup .current-icon svg,
        .icon-edit-popup .current-icon img {
            width: 40px;
            height: 40px;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 250;
            display: none;
        }

        .popup-overlay.show {
            display: block;
        }

        /* ================= Ë°®ÊÉÖÈù¢ÊùøÊ†∑Âºè ================= */
        .emoji-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: #fff;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 110;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ‰øÆÂ§çÔºöËßíËâ≤ÁºñËæëÊ®°ÊÄÅÊ°ÜÂ±ÇÁ∫ßÈ´ò‰∫éËÅäÂ§©Á™óÂè£ */
        #character-edit-modal {
            z-index: 120;
        }

        /* Èù¢ÊùøÈÅÆÁΩ©Â±Ç */
        .panel-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 105;
            display: none;
        }
        .panel-overlay.show {
            display: block;
        }

        /* ================= ÂäüËÉΩÈù¢ÊùøÊ†∑Âºè ================= */
        .function-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 280px;
            background: #f5f5f5;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 110;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
            padding: 30px 20px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .function-panel.show {
            transform: translateY(0);
        }

        .function-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .function-icon {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: #555;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .function-item:active .function-icon {
            transform: scale(0.95);
            background: #e8f5e9;
        }

        .function-name {
            font-size: 12px;
            color: #666;
        }

        /* Á∫¢ÂåÖÊ†∑Âºè */
        .red-packet-bubble {
            background: #fa9d3b !important;
            color: white !important;
            padding: 0 !important;
            width: 220px;
            overflow: hidden;
            cursor: pointer;
            border-radius: 8px !important;
        }

        .rp-content {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rp-icon {
            width: 36px;
            height: 36px;
            background: #fcd69f;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fa9d3b;
            font-size: 20px;
            font-weight: bold;
        }

        .rp-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .rp-desc { font-size: 15px; font-weight: 500; }
        .rp-status { font-size: 11px; opacity: 0.8; }

        .rp-footer {
            background: white;
            padding: 5px 15px;
            font-size: 10px;
            color: #999;
        }

        /* Êñá‰ª∂Ê∂àÊÅØÊ†∑Âºè */
        .file-bubble {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white !important;
            padding: 10px !important;
            border-radius: 8px !important;
            min-width: 200px;
            border: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            color: #333 !important;
        }
        .file-bubble:hover {
            background: #f9f9f9 !important;
        }
        .file-icon { font-size: 32px; }
        .file-info { flex: 1; overflow: hidden; display: flex; flex-direction: column; align-items: flex-start; }
        .file-name { font-size: 14px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; width: 100%; text-align: left; }
        .file-size { font-size: 12px; color: #999; }

        .emoji-panel.show {
            transform: translateY(0);
        }

        .emoji-header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .emoji-tabs {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .emoji-tab {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            white-space: nowrap;
        }

        .emoji-tab.active {
            background: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
        }

        .emoji-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            align-content: start;
        }

        .emoji-item {
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .emoji-item:hover {
            background: #f5f5f5;
        }

        .emoji-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* ================= Ê∂àÊÅØÈïøÊåâËèúÂçï ================= */
        .message-menu {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 5px;
            display: flex;
            gap: 10px;
            z-index: 100;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s;
        }

        .message-menu-item {
            color: white;
            font-size: 12px;
            padding: 5px 10px;
            cursor: pointer;
            white-space: nowrap;
        }

        .message-menu-item:active {
            opacity: 0.7;
        }

        /* ================= Â§öÈÄâÊ°ÜÊ†∑Âºè ================= */
        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            background: #fff;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-item:hover {
            background: #f5f5f5;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #81c784;
        }

        .checkbox-label {
            font-size: 13px;
            color: #333;
            flex: 1;
        }

        /* ÂõæÁâáÊ∂àÊÅØÊ†∑Âºè */
        .chat-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
            display: block;
        }
        
        /* ËßÜÈ¢ëÈÄöËØùÊ®°ÊÄÅÊ°Ü */
        .video-call-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, #2c3e50 0%, #000000 100%);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 60px 20px;
            color: white;
        }
        .video-call-modal.show { display: flex; }
        .vc-avatar { width: 120px; height: 120px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); margin-bottom: 20px; object-fit: cover; }
        .vc-name { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .vc-status { font-size: 16px; opacity: 0.8; }
        .vc-actions { display: flex; gap: 40px; margin-bottom: 40px; }
        .vc-btn { width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; }
        .vc-btn.hangup { background: #ff3b30; color: white; }
        .vc-btn.answer { background: #4cd964; color: white; }
        .vc-btn:active { transform: scale(0.95); }
        
        /* ÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü */
        .image-preview-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2100;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .image-preview-modal.show { display: flex; }
        .image-preview-modal img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* ÂΩïÈü≥Áä∂ÊÄÅÊåáÁ§∫Âô® */
        .recording-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 16px;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            z-index: 2000;
            width: 150px;
            height: 150px;
            justify-content: center;
        }
        
        .recording-indicator.show {
            display: flex;
        }
        
        .recording-icon {
            font-size: 40px;
            animation: pulse-record 1s infinite;
        }
        
        @keyframes pulse-record {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="phone">
        <!-- Ëá™ÂÆö‰πâËÉåÊôØ -->
        <div class="phone-bg" id="phone-bg"></div>

        <!-- Ë£ÖÈ•∞ÂÖÉÁ¥† -->
        <div class="decoration deco1"></div>
        <div class="decoration deco2"></div>
        <div class="decoration deco3"></div>
        
        <div class="stars">
            <span class="star">‚ú¶</span>
            <span class="star">‚úß</span>
            <span class="star">‚ú¶</span>
            <span class="star">‚úß</span>
        </div>

        <!-- ‰∏ªÁïåÈù¢ÂÜÖÂÆπ -->
        <div class="content-wrapper" id="main-screen">
            <div class="status-bar">
                <div class="time" id="current-time">09:41</div>
                <div class="battery">
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                    <span class="battery-percent">85%</span>
                </div>
            </div>

            <div class="avatar-section">
                <div class="avatar-frame" onclick="openAppearanceSettings()">
                    <img id="main-avatar" src="https://api.dicebear.com/7.x/lorelei/png?seed=cute&backgroundColor=d1fae5" alt="Â§¥ÂÉè">
                </div>
            </div>

            <div class="input-section">
                <input type="text" class="text-input" placeholder="‚úé ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑËØù...">
            </div>

            <div class="apps-container">
                <!-- ËßíËâ≤ - ÂèØÁà±Â∞èËÑëË¢ã -->
                <div class="app-icon" id="character-icon">
                    <div class="icon-img" id="icon-character">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="45" r="28" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <circle cx="40" cy="40" r="4" fill="#5d8a66"/>
                            <circle cx="60" cy="40" r="4" fill="#5d8a66"/>
                            <path d="M40 55 Q50 65 60 55" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/>
                            <path d="M30 25 Q35 15 45 20" stroke="#5d8a66" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                            <path d="M70 25 Q65 15 55 20" stroke="#5d8a66" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                            <circle cx="38" cy="38" r="1.5" fill="white"/>
                            <circle cx="58" cy="38" r="1.5" fill="white"/>
                            <ellipse cx="32" cy="50" rx="4" ry="3" fill="#ffcdd2" opacity="0.6"/>
                            <ellipse cx="68" cy="50" rx="4" ry="3" fill="#ffcdd2" opacity="0.6"/>
                        </svg>
                    </div>
                    <span class="app-name">ËßíËâ≤</span>
                </div>

                <!-- ‰∏ñÁïå‰π¶ - ÊâìÂºÄÁöÑ‰π¶Êú¨ -->
                <div class="app-icon" id="worldbook-icon">
                    <div class="icon-img" id="icon-worldbook">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M50 25 L50 80" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M50 25 Q30 20 15 30 L15 75 Q30 68 50 75" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/>
                            <path d="M50 25 Q70 20 85 30 L85 75 Q70 68 50 75" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/>
                            <path d="M22 40 L42 38" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M22 50 L42 48" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M22 60 L38 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M58 38 L78 40" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M58 48 L78 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M62 58 L78 60" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="50" cy="20" r="5" fill="#ffeb3b" stroke="#5d8a66" stroke-width="1.5"/>
                        </svg>
                    </div>
                    <span class="app-name">‰∏ñÁïå‰π¶</span>
                </div>

                <!-- Ê∑òÂÆù - Ë¥≠Áâ©ËΩ¶ -->
                <div class="app-icon">
                    <div class="icon-img" id="icon-taobao">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 30 L30 30 L40 65 L75 65 L82 40 L35 40" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="45" cy="78" r="6" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <circle cx="68" cy="78" r="6" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <path d="M45 50 L45 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M55 48 L55 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M65 50 L65 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M25 25 Q20 20 25 15" stroke="#ffb74d" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span class="app-name">Ê∑òÂÆù</span>
                </div>

                <!-- APIËÆæÁΩÆ - Ê≠™Ê≠™Êâ≠Êâ≠ÁöÑAPIÂ≠ó -->
                <div class="app-icon" id="api-settings-icon">
                    <div class="icon-img" id="icon-api">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <text x="12" y="58" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(-8 20 50)">A</text>
                            <text x="35" y="62" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(5 45 55)">P</text>
                            <text x="58" y="55" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(-3 65 50)">I</text>
                            <path d="M75 35 Q80 30 85 35 Q90 40 85 45 Q80 50 75 45 Q70 40 75 35" stroke="#ffb74d" stroke-width="2" fill="#fff59d"/><circle cx="20" cy="30" r="4" fill="#81c784"/><circle cx="80" cy="65" r="3" fill="#81c784"/><path d="M25 70 L35 75" stroke="#5d8a66" stroke-width="1.5" stroke-linecap="round"/><path d="M30 73 L32 68" stroke="#5d8a66" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span class="app-name">APIËÆæÁΩÆ</span>
                </div>

                <!-- Â§ñËßÇËÆæÁΩÆ - Ë∞ÉËâ≤Êùø -->
                <div class="app-icon" id="appearance-icon">
                    <div class="icon-img" id="icon-appearance">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="50" cy="50" rx="35" ry="32" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <circle cx="35" cy="38" r="7" fill="#ff8a80"/>
                            <circle cx="55" cy="32" r="6" fill="#ffcc80"/>
                            <circle cx="70" cy="45" r="6" fill="#a5d6a7"/>
                            <circle cx="65" cy="62" r="5" fill="#90caf9"/>
                            <circle cx="40" cy="60" r="8" fill="white" stroke="#5d8a66" stroke-width="2"/>
                            <path d="M75 75 L90 90" stroke="#5d8a66" stroke-width="4" stroke-linecap="round"/>
                            <path d="M88 82 L92 88 L86 92" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="app-name">Â§ñËßÇËÆæÁΩÆ</span>
                </div>

                <!-- ÁúãÁúã‰Ω† - ÁúºÁùõ -->
                <div class="app-icon">
                    <div class="icon-img" id="icon-look">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="50" cy="50" rx="35" ry="22" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <circle cx="50" cy="50" r="15" stroke="#5d8a66" stroke-width="2.5" fill="none"/>
                            <circle cx="50" cy="50" r="8" fill="#5d8a66"/>
                            <circle cx="46" cy="46" r="3" fill="white"/>
                            <path d="M20 35 Q15 30 20 25" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M80 35 Q85 30 80 25" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M15 50 L20 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M80 50 L85 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span class="app-name">ÁúãÁúã‰Ω†</span>
                </div>

                <!-- ‰ªäÂ§©ÂÅö‰ªÄ‰πà - Êó•ÂéÜ -->
                <div class="app-icon">
                    <div class="icon-img" id="icon-calendar">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="18" y="25" width="64" height="55" rx="8" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <path d="M18 42 L82 42" stroke="#5d8a66" stroke-width="2"/>
                            <path d="M35 18 L35 32" stroke="#5d8a66" stroke-width="3" stroke-linecap="round"/>
                            <path d="M65 18 L65 32" stroke="#5d8a66" stroke-width="3" stroke-linecap="round"/>
                            <text x="50" y="68" font-family="Comic Sans MS, cursive" font-size="24" fill="#5d8a66" text-anchor="middle">?</text>
                            <circle cx="72" cy="28" r="5" fill="#ff8a80"/>
                        </svg>
                    </div>
                    <span class="app-name">‰ªäÂ§©ÂÅö‰ªÄ‰πà</span>
                </div>
            </div>

            <div class="bottom-area">
                <div class="bottom-apps">
                    <!-- Êü•ÊâãÊú∫ - ÊâãÊú∫ -->
                    <div class="bottom-app">
                        <div class="icon-img" id="icon-phone">
                            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="28" y="15" width="44" height="70" rx="8" stroke="#5d8a66" stroke-width="3" fill="none"/>
                                <path d="M28 25 L72 25" stroke="#5d8a66" stroke-width="2"/>
                                <path d="M28 72 L72 72" stroke="#5d8a66" stroke-width="2"/>
                                <circle cx="50" cy="80" r="4" stroke="#5d8a66" stroke-width="2" fill="none"/>
                                <path d="M42 20 L58 20" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                                <path d="M38 45 L48 55 L62 38" stroke="#81c784" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span class="app-name">Êü•ÊâãÊú∫</span>
                    </div>

                    <!-- Âõ¥ËÑñ - ÂØπËØùÊ°Ü -->
                    <div class="bottom-app">
                        <div class="icon-img" id="icon-weibo">
                            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 30 Q20 20 30 20 L70 20 Q80 20 80 30 L80 55 Q80 65 70 65 L35 65 L22 78 L25 65 L30 65 Q20 65 20 55 Z" stroke="#5d8a66" stroke-width="3" fill="none"/>
                                <circle cx="38" cy="42" r="4" fill="#5d8a66"/>
                                <circle cx="52" cy="42" r="4" fill="#5d8a66"/>
                                <circle cx="66" cy="42" r="4" fill="#5d8a66"/>
                            </svg>
                        </div>
                        <span class="app-name">Âõ¥ËÑñ</span>
                    </div>

                    <!-- BO4 - ‰øùÁïôÂéüÊ†∑Âºè -->
                    <div class="bottom-app">
                        <div class="icon-img" id="icon-bo4">
                            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <text x="50" y="62" font-family="Georgia, serif" font-size="28" fill="#990000" text-anchor="middle" font-weight="bold">BO4</text>
                                <circle cx="20" cy="25" r="4" fill="#ffb74d"/>
                                <circle cx="80" cy="75" r="3" fill="#ffb74d"/>
                            </svg>
                        </div>
                        <span class="app-name">BO4</span>
                    </div>

                    <!-- Â§ßÂâßÂú∫ - Èù¢ÂÖ∑ -->
                    <div class="bottom-app">
                        <div class="icon-img" id="icon-theater">
                            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <ellipse cx="35" cy="45" rx="22" ry="28" stroke="#5d8a66" stroke-width="2.5" fill="none"/>
                                <ellipse cx="65" cy="45" rx="22" ry="28" stroke="#5d8a66" stroke-width="2.5" fill="none"/>
                                <circle cx="28" cy="38" r="4" fill="#5d8a66"/>
                                <circle cx="42" cy="38" r="4" fill="#5d8a66"/>
                                <path d="M25 55 Q35 65 45 55" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round"/>
                                <circle cx="58" cy="38" r="4" fill="#5d8a66"/>
                                <circle cx="72" cy="38" r="4" fill="#5d8a66"/>
                                <path d="M55 55 Q65 48 75 55" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round"/>
                                <path d="M35 75 Q50 85 65 75" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <span class="app-name">Â§ßÂâßÂú∫</span>
                    </div>
                </div>

                <div class="bottom-decoration">
                    <div class="dot"></div>
                    <div class="dot active"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>
        
        <div class="bottom-bar"></div>

        <!-- Âä†ËΩΩÊèêÁ§∫ -->
        <div id="loading-toast" class="loading-toast">Â§ÑÁêÜ‰∏≠...</div>

        <!-- Âà†Èô§Á°ÆËÆ§ÂºπÁ™ó -->
        <div id="delete-confirm-overlay" class="delete-confirm-overlay">
            <div class="delete-confirm-box">
                <h3>üóëÔ∏è Âà†Èô§ËßíËâ≤</h3>
                <p id="delete-confirm-text">Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËßíËâ≤ÂêóÔºüËÅäÂ§©ËÆ∞ÂΩï‰πü‰ºö‰∏ÄÂπ∂Âà†Èô§„ÄÇ</p>
                <div class="btn-row">
                    <button class="btn btn-danger" id="confirm-delete-btn">Âà†Èô§</button>
                    <button class="btn btn-secondary" onclick="hideDeleteConfirm()">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>

        <!-- PWAÂÆâË£ÖÊèêÁ§∫ -->
        <div id="pwa-install-prompt" class="pwa-install-prompt">
            <p>üì± Â∞ÜÊ≠§Â∫îÁî®Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπïÔºåËé∑ÂæóÊõ¥Â•Ω‰ΩìÈ™åÔºÅ</p>
            <div class="btn-row">
                <button class="btn btn-primary" id="pwa-install-btn">Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπï</button>
                <button class="btn btn-secondary" onclick="dismissPWAPrompt()">Á®çÂêéÂÜçËØ¥</button>
            </div>
        </div>

        <!-- ÂõæÊ†áÁºñËæëÂºπÁ™óÈÅÆÁΩ© -->
        <div id="popup-overlay" class="popup-overlay" onclick="closeIconEditPopup()"></div>

        <!-- ÂõæÊ†áÁºñËæëÂºπÁ™ó -->
        <div id="icon-edit-popup" class="icon-edit-popup">
            <h3 id="icon-edit-title">ÁºñËæëÂõæÊ†á</h3>
            <div class="current-icon" id="icon-edit-preview"></div>
            <div class="form-group">
                <label class="form-label">ÂõæÊ†áURL</label>
                <input type="text" id="icon-url-input" class="form-input" placeholder="ËæìÂÖ•ÂõæÁâáURL">
            </div>
            <div class="btn-row" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="document.getElementById('icon-file-input').click()">Êú¨Âú∞‰∏ä‰º†</button>
                <button class="btn btn-danger" onclick="resetIconToDefault()">ÊÅ¢Â§çÈªòËÆ§</button>
            </div>
            <div class="btn-row" style="margin-top: 15px;">
                <button class="btn btn-primary" style="flex:1" onclick="saveIconEdit()">Á°ÆÂÆö</button>
                <button class="btn btn-secondary" style="flex:1" onclick="closeIconEditPopup()">ÂèñÊ∂à</button>
            </div>
        </div>

        <!-- ================= ËßíËâ≤ÂàóË°®Ê®°ÊÄÅÊ°Ü ================= -->
        <div id="character-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeModal('character-modal')">‚Üê</span>
                        <h2>ËßíËâ≤ÂàóË°®</h2>
                    </div>
                    <div class="header-right">
                        <span class="header-btn" onclick="createNewCharacter()">Ôºã</span>
                        <span class="header-btn" onclick="document.getElementById('character-import-input').click()">üì§</span>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="character-list" class="character-list">
                        <!-- ËßíËâ≤ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= ËßíËâ≤ÁºñËæë/ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="character-edit-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeCharacterEdit()">‚Üê</span>
                        <h2 id="character-edit-title">ËßíËâ≤ËÆæÁΩÆ</h2>
                    </div>
                    <div class="header-right">
                        <span class="header-btn" onclick="deleteCurrentCharacter()" style="color: #ef5350;">üóë</span>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- ËßíËâ≤Â§¥ÂÉè -->
                    <div class="avatar-upload-section">
                        <div class="avatar-preview" onclick="document.getElementById('char-avatar-input').click()">
                            <img id="char-avatar-preview" src="https://api.dicebear.com/7.x/lorelei/png?seed=default" alt="ËßíËâ≤Â§¥ÂÉè">
                        </div>
                        <span style="font-size: 12px; color: #888;">ÁÇπÂáªÊõ¥Êç¢Â§¥ÂÉè</span>
                    </div>

                    <!-- ËßíËâ≤‰ø°ÊÅØ -->
                    <div class="setting-section">
                        <h3>üë§ ËßíËâ≤‰ø°ÊÅØ</h3>
                        <div class="form-group">
                            <label class="form-label">ËßíËâ≤Â§áÊ≥®ÔºàÂèåÊñπÂèØËßÅÔºâ</label>
                            <input type="text" id="char-nickname" class="form-input" placeholder="ËßíËâ≤ÁöÑÂ§áÊ≥®ÂêçÁß∞">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ËßíËâ≤Êú¨ÂêçÔºàAIËØªÂèñÔºâ</label>
                            <input type="text" id="char-name" class="form-input" placeholder="ËßíËâ≤ÁöÑÁúüÂÆûÂêçÂ≠ó">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ËßíËâ≤‰∫∫ËÆæ</label>
                            <textarea id="char-persona" class="form-textarea" rows="5" placeholder="ÊèèËø∞ËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅËÉåÊôØ„ÄÅËØ¥ËØùÊñπÂºèÁ≠â..." oninput="updateTokensEstimate()"></textarea>
                        </div>
                    </div>

                    <!-- Áî®Êà∑‰ø°ÊÅØ -->
                    <div class="setting-section">
                        <h3>üôã Áî®Êà∑‰ø°ÊÅØ</h3>
                        <div class="avatar-upload-section">
                            <div class="avatar-preview" style="width: 60px; height: 60px;" onclick="document.getElementById('user-avatar-input').click()">
                                <img id="user-avatar-preview" src="https://api.dicebear.com/7.x/lorelei/png?seed=user" alt="Áî®Êà∑Â§¥ÂÉè">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Áî®Êà∑Â§áÊ≥®ÔºàAIÂèØËßÅÔºåAIÂèØÊîπÂÜôÔºâ</label>
                            <input type="text" id="user-nickname" class="form-input" placeholder="AIÁúãÂà∞ÁöÑ‰Ω†ÁöÑÂ§áÊ≥®">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Áî®Êà∑Êú¨ÂêçÔºàAIËØªÂèñÔºâ</label>
                            <input type="text" id="user-name" class="form-input" placeholder="‰Ω†ÁöÑÂêçÂ≠ó">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Áî®Êà∑‰∫∫ËÆæ</label>
                            <textarea id="user-persona" class="form-textarea" rows="3" placeholder="ÊèèËø∞‰Ω†Ëá™Â∑±..." oninput="updateTokensEstimate()"></textarea>
                        </div>
                    </div>

                    <!-- ÂÖ≥ËÅî‰∏ñÁïå‰π¶ -->
                    <div class="setting-section">
                        <h3>üìö ÂÖ≥ËÅî‰∏ñÁïå‰π¶ (Â§öÈÄâ)</h3>
                        <div id="char-worldbook-list" class="checkbox-list">
                            <!-- Âä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>

                    <!-- È´òÁ∫ßËÆæÂÆö -->
                    <div class="setting-section">
                        <h3>‚öôÔ∏è È´òÁ∫ßËÆæÂÆö</h3>
                        <div class="form-group">
                            <label class="form-label">Â∫ïÂ±ÇÊèêÁ§∫ËØç (ËøΩÂä†Âà∞ System Prompt Êú´Â∞æ)</label>
                            <textarea id="char-post-history-instructions" class="form-textarea" rows="3" placeholder="‰æãÂ¶ÇÔºöËØ∑ÂßãÁªà‰øùÊåÅÈ´òÂÜ∑ËØ≠Ê∞î..."></textarea>
                        </div>
                    </div>

                    <!-- Token‰º∞ÁÆó -->
                    <div class="tokens-display">
                        <div class="label">È¢Ñ‰º∞‰∏ä‰∏ãÊñáÊÄªTokens</div>
                        <div class="value" id="tokens-estimate">0</div>
                    </div>

                    <!-- ËÆ∞ÂøÜËÆæÁΩÆ -->
                    <div class="setting-section">
                        <h3>üß† ËÆ∞ÂøÜËÆæÁΩÆ</h3>
                        <div class="form-group">
                            <label class="form-label">ËßíËâ≤ËÆ∞ÂøÜÔºàAIÊØèÊ¨°Âõ∫ÂÆöËØªÂèñÁöÑËÅäÂ§©ËÆ∞ÂΩïÊù°Êï∞Ôºâ</label>
                            <input type="number" id="memory-count" class="form-input" placeholder="‰æãÂ¶Ç: 200" value="50">
                        </div>
                        
                        <div class="switch-row">
                            <span>ÊòØÂê¶Ëá™Âä®ÊÄªÁªì</span>
                            <label class="switch">
                                <input type="checkbox" id="auto-summary-switch" onchange="toggleArea('summary-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="summary-settings" class="hidden-area">
                            <div class="form-group">
                                <label class="form-label">ÊØèÈöîÂ§öÂ∞ëÊù°ËÅäÂ§©ËÆ∞ÂΩïËøõË°åÊÄªÁªì</label>
                                <input type="number" id="summary-interval" class="form-input" placeholder="‰æãÂ¶Ç: 100" value="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÊÄªÁªìÊèêÁ§∫ËØç</label>
                                <textarea id="summary-prompt" class="form-textarea" rows="2">‰ª•ËßíËâ≤Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÂèôËø∞Êàë‰ª¨ËÅäÂ§©‰∏≠ÊèêÂà∞ÁöÑ‰∫ãÊÉÖÔºå100Â≠óÂÜÖ</textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÊâãÂä®ÊÄªÁªìËåÉÂõ¥</label>
                                <div class="inline-input">
                                    <input type="number" id="summary-start" class="form-input" placeholder="ÂºÄÂßã" style="width: 80px;">
                                    <span>Âà∞</span>
                                    <input type="number" id="summary-end" class="form-input" placeholder="ÁªìÊùü" style="width: 80px;">
                                    <button class="btn btn-primary" onclick="manualSummary()">ÊÄªÁªì</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Êó∂Èó¥‰∏éÂ§©Ê∞î -->
                    <div class="setting-section">
                        <h3>üåç ÁéØÂ¢ÉÊÑüÁü•</h3>
                        <div class="switch-row">
                            <span>ÊÑüÁü•ÁúüÂÆûÊó∂Èó¥</span>
                            <label class="switch">
                                <input type="checkbox" id="time-aware-switch" onchange="toggleArea('time-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="time-settings" class="hidden-area">
                            <div class="form-group">
                                <label class="form-label">Êó∂Âå∫ÈÄâÊã©</label>
                                <select id="timezone-select" class="form-select" style="width: 100%;">
                                    <option value="Asia/Shanghai">‰∏≠ÂõΩÊ†áÂáÜÊó∂Èó¥ (UTC+8)</option>
                                    <option value="Asia/Tokyo">Êó•Êú¨Ê†áÂáÜÊó∂Èó¥ (UTC+9)</option>
                                    <option value="America/New_York">ÁæéÂõΩ‰∏úÈÉ®Êó∂Èó¥ (UTC-5)</option>
                                    <option value="America/Los_Angeles">ÁæéÂõΩË•øÈÉ®Êó∂Èó¥ (UTC-8)</option>
                                    <option value="Europe/London">Ëã±ÂõΩÊó∂Èó¥ (UTC+0)</option>
                                    <option value="Europe/Paris">‰∏≠Ê¨ßÊó∂Èó¥ (UTC+1)</option>
                                </select>
                            </div>
                        </div>

                        <div class="switch-row">
                            <span>ÊÑüÁü•Â§©Ê∞î</span>
                            <label class="switch">
                                <input type="checkbox" id="weather-aware-switch" onchange="toggleArea('weather-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="weather-settings" class="hidden-area">
                            <div class="form-group">
                                <label class="form-label">ÂΩìÂâçÂ§©Ê∞î</label>
                                <input type="text" id="weather-input" class="form-input" placeholder="‰æãÂ¶Ç: Êô¥Â§©/‰∏ãÈõ®/‰∏ãÈõ™">
                            </div>
                        </div>
                    </div>

                    <!-- Á∫ø‰∏ãÊ®°Âºè -->
                    <div class="setting-section">
                        <h3>üìù Á∫ø‰∏ãÊ®°Âºè</h3>
                        <div class="switch-row">
                            <span>ÂêØÁî®Á∫ø‰∏ãÊ®°ÂºèÔºàÈïøÊñáËæìÂá∫Ôºâ</span>
                            <label class="switch">
                                <input type="checkbox" id="offline-mode-switch" onchange="toggleArea('offline-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="offline-settings" class="hidden-area">
                            <div class="form-group">
                                <label class="form-label">ÈïøÊñáÂ≠óÊï∞</label>
                                <input type="number" id="offline-length" class="form-input" placeholder="‰æãÂ¶Ç: 2000" value="1000">
                            </div>
                        </div>
                    </div>

                    <!-- Â§ñËßÇËÆæÁΩÆ -->
                    <div class="setting-section">
                        <h3>üé® Â§ñËßÇËÆæÁΩÆ</h3>
                        <div class="form-group">
                            <label class="form-label">Â≠ó‰ΩìÂ§ßÂ∞è</label>
                            <div class="inline-input">
                                <input type="range" id="font-size-range" class="range-input" min="12" max="20" value="14" style="flex:1" oninput="document.getElementById('font-size-value').textContent = this.value + 'px'">
                                <span id="font-size-value" style="width: 40px; text-align: right;">14px</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ËÅäÂ§©ËÉåÊôØÔºàURLÊàñÊú¨Âú∞‰∏ä‰º†Ôºâ</label>
                            <div class="btn-row">
                                <input type="text" id="chat-bg-url" class="form-input" placeholder="ËæìÂÖ•ÂõæÁâáURL" style="flex: 1; margin-bottom: 0;">
                                <button class="btn btn-secondary" onclick="document.getElementById('chat-bg-input').click()">Êú¨Âú∞</button>
                            </div>
                        </div>
                    </div>

                    <!-- ÂØºÂÖ•ÂØºÂá∫ -->
                    <div class="setting-section">
                        <h3>üíæ ËÅäÂ§©ËÆ∞ÂΩï</h3>
                        <div class="btn-row">
                            <button class="btn btn-primary" onclick="exportChatHistory()">ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('chat-import-input').click()">ÂØºÂÖ•ËÅäÂ§©ËÆ∞ÂΩï</button>
                        </div>
                        <div class="btn-row" style="margin-top: 10px;">
                            <button class="btn btn-danger" onclick="clearChatHistory()">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveCharacter()">‰øùÂ≠òËßíËâ≤ËÆæÁΩÆ</button>
                </div>
            </div>
        </div>

        <!-- ================= ËÅäÂ§©ÁïåÈù¢Ê®°ÊÄÅÊ°Ü ================= -->
        <div id="chat-modal" class="modal full-screen">
            <div class="modal-content full-height" style="padding: 0; background: #f5f5f5;">
                <div class="chat-container" id="chat-container">
                    <div class="chat-header">
                        <span class="back-btn" onclick="closeChat()">‚Üê</span>
                        <div class="chat-header-avatar">
                            <img id="chat-char-avatar" src="https://api.dicebear.com/7.x/lorelei/png?seed=default" alt="ËßíËâ≤">
                        </div>
                        <div class="chat-header-info">
                            <div class="chat-header-name" id="chat-char-name">ËßíËâ≤Âêç</div>
                            <div class="chat-header-status" id="chat-status">Âú®Á∫ø</div>
                        </div>
                        <span class="chat-header-settings" onclick="openCharacterSettings()">‚öôÔ∏è</span>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <!-- Ê∂àÊÅØÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                    <div class="chat-input-area" id="chat-input-area">
                        <!-- ËØ≠Èü≥ÂàáÊç¢ÊåâÈíÆ -->
                        <button class="chat-btn" onclick="toggleVoiceMode()" id="voice-toggle-btn" title="ÂàáÊç¢ËØ≠Èü≥/ÈîÆÁõò">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                        </button>
                        
                        <!-- ÈáçÊñ∞ÁîüÊàêÊåâÈíÆ -->
                        <button class="chat-btn regen-btn" onclick="regenerateAIResponse()" title="ÈáçÊñ∞ÁîüÊàêÂõûÂ§ç">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                        </button>

                        <!-- Âä†Âè∑ÊåâÈíÆ -->
                        <button class="chat-btn" onclick="toggleFunctionPanel()">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>

                        <!-- ÊñáÊú¨ËæìÂÖ•Ê°Ü -->
                        <textarea class="chat-input" id="chat-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1" oninput="autoResize(this)"></textarea>
                        
                        <!-- Êåâ‰ΩèËØ¥ËØùÊåâÈíÆ -->
                        <div class="voice-hold-btn" id="voice-hold-btn">Êåâ‰Ωè ËØ¥ËØù</div>

                        <button class="chat-btn star-btn" id="ai-reply-btn" onclick="triggerAIReply()" title="ËÆ©AIÂõûÂ§ç">‚ú¶</button>
                        <button class="chat-btn send-btn" onclick="sendMessage()" title="ÂèëÈÄÅÊ∂àÊÅØ">‚û§</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= ‰∏ñÁïå‰π¶ÂàóË°®Ê®°ÊÄÅÊ°Ü ================= -->
        <div id="worldbook-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeModal('worldbook-modal')">‚Üê</span>
                        <h2>‰∏ñÁïå‰π¶</h2>
                    </div>
                    <div class="header-right">
                        <span class="header-btn" onclick="createNewWorldbook()">Ôºã</span>
                        <span class="header-btn" onclick="document.getElementById('worldbook-import-input').click()">üì§</span>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="worldbook-list">
                        <!-- ‰∏ñÁïå‰π¶ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= ‰∏ñÁïå‰π¶ÁºñËæëÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="worldbook-edit-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeWorldbookEdit()">‚Üê</span>
                        <h2 id="worldbook-edit-title">ÁºñËæë‰∏ñÁïå‰π¶</h2>
                    </div>
                    <div class="header-right">
                        <span class="header-btn" onclick="addWorldbookEntry()">Ôºã</span>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">‰∏ñÁïå‰π¶ÂêçÁß∞</label>
                        <input type="text" id="worldbook-name" class="form-input" placeholder="‰∏ñÁïå‰π¶ÂêçÁß∞">
                    </div>
                    <h3 style="font-size: 14px; color: #5d8a66; margin: 15px 0 10px;">üìñ Êù°ÁõÆÂàóË°®</h3>
                    <div id="worldbook-entries">
                        <!-- Êù°ÁõÆÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveWorldbook()">‰øùÂ≠ò‰∏ñÁïå‰π¶</button>
                </div>
            </div>
        </div>

        <!-- ================= ‰∏ñÁïå‰π¶Êù°ÁõÆÁºñËæëÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="entry-edit-modal" class="modal">
            <div class="modal-content" style="height: 60%;">
                <div class="modal-header">
                    <h2>ÁºñËæëÊù°ÁõÆ</h2>
                    <span class="close-btn" onclick="closeModal('entry-edit-modal')">√ó</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">ÂÖ≥ÈîÆËØçÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºâ</label>
                        <input type="text" id="entry-keywords" class="form-input" placeholder="‰æãÂ¶Ç: È≠îÊ≥ï,ÂííËØ≠,Ê≥ïÊúØ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÂÜÖÂÆπ</label>
                        <textarea id="entry-content" class="form-textarea" rows="6" placeholder="ÂΩìËß¶ÂèëÂÖ≥ÈîÆËØçÊó∂ÔºåAIÂ∞ÜËØªÂèñËøôÊÆµÂÜÖÂÆπ..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveEntry()">‰øùÂ≠òÊù°ÁõÆ</button>
                </div>
            </div>
        </div>

        <!-- ================= API ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="api-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>API ÈÖçÁΩÆ</h2>
                    <span class="close-btn" onclick="closeModal('api-modal')">√ó</span>
                </div>
                <div class="modal-body">
                    <div class="setting-section">
                        <h3>ü§ñ ‰∏ªAPI (ËßíËâ≤ÂØπËØù)</h3>
                        <input type="text" id="main-api-url" class="form-input" placeholder="APIÂú∞ÂùÄ (‰æãÂ¶Ç https://api.openai.com)">
                        <input type="password" id="main-api-key" class="form-input" placeholder="API ÂØÜÈí• (sk-...)">
                        <div class="btn-row">
                            <button class="btn btn-primary" onclick="fetchModels('main')">ÊãâÂèñÊ®°Âûã</button>
                            <select id="main-model-select" class="form-select">
                                <option value="">ËØ∑ÂÖàÊãâÂèñÊ®°Âûã</option>
                            </select>
                        </div>
                        
                        <!-- Ê®°ÂûãÊ∏©Â∫¶Ë∞ÉËäÇ -->
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label">üå°Ô∏è Ê®°ÂûãÊ∏©Â∫¶ (Temperature)</label>
                            <div class="temperature-slider">
                                <input type="range" id="main-temperature" min="0" max="2" step="0.1" value="0.8" oninput="document.getElementById('temp-value').textContent = this.value">
                                <span class="temperature-value" id="temp-value">0.8</span>
                            </div>
                            <div style="font-size: 11px; color: #888; margin-top: 5px;">
                                ËæÉ‰Ωé = Êõ¥Á≤æÁ°ÆÁ®≥ÂÆö | ËæÉÈ´ò = Êõ¥ÊúâÂàõÊÑèÈöèÊú∫
                            </div>
                        </div>
                        
                        <div class="btn-row" style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="savePreset()">‰øùÂ≠òÈ¢ÑËÆæ</button>
                        </div>
                        <div id="preset-list" class="preset-list"></div>
                    </div>

                    <div class="setting-section">
                        <h3>üìù ÂâØAPI (ËÅäÂ§©ÊÄªÁªì)</h3>
                        <input type="text" id="sub-api-url" class="form-input" placeholder="ÂâØAPIÂú∞ÂùÄÔºàÂèØÈÄâÔºå‰∏çÂ°´ÂàôÁî®‰∏ªAPIÔºâ">
                        <input type="password" id="sub-api-key" class="form-input" placeholder="API ÂØÜÈí•">
                        <div class="btn-row">
                            <button class="btn btn-primary" onclick="fetchModels('sub')">ÊãâÂèñÊ®°Âûã</button>
                            <select id="sub-model-select" class="form-select">
                                <option value="">ËØ∑ÂÖàÊãâÂèñÊ®°Âûã</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-section">
                        <div class="switch-row">
                            <h3 style="margin: 0;">üé® ÂºÄÂêØAIÁîüÂõæ</h3>
                            <label class="switch">
                                <input type="checkbox" id="img-gen-switch">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="setting-section">
                        <div class="switch-row">
                            <h3 style="margin: 0;">üé§ Minimax ËØ≠Èü≥</h3>
                            <label class="switch">
                                <input type="checkbox" id="voice-switch" onchange="toggleArea('voice-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="voice-settings" class="hidden-area">
                            <input type="text" id="voice-group-id" class="form-input" placeholder="Group ID">
                            <input type="password" id="voice-api-key" class="form-input" placeholder="API ÂØÜÈí•">
                            <div class="btn-row">
                                <button class="btn btn-primary" onclick="fetchMinimaxVoiceModels()">ÊãâÂèñËØ≠Èü≥Ê®°Âûã</button>
                                <select id="voice-model-select" class="form-select">
                                    <option value="">ËØ∑ÂÖàÊãâÂèñÊ®°Âûã</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-top: 8px;">
                                <label class="form-label">Voice ID (ÂèØÈÄâÔºåÁî®‰∫éÊåáÂÆöÈü≥Ëâ≤)</label>
                                <input type="text" id="voice-id-input" class="form-input" placeholder="Voice ID">
                            </div>
                            <div class="form-group" style="margin-top: 8px;">
                                <label class="form-label">ËØ≠Èü≥Ê∂àÊÅØÊ¶ÇÁéá (0-100%)</label>
                                <div class="inline-input">
                                    <input type="range" id="voice-probability" min="0" max="100" value="30" style="flex:1" oninput="document.getElementById('voice-prob-value').textContent = this.value + '%'">
                                    <span id="voice-prob-value" style="width: 50px; text-align: right;">30%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="setting-section">
                        <div class="switch-row">
                            <h3 style="margin: 0;">üí¨ AI‰∏ªÂä®ÂèëÊ∂àÊÅØ</h3>
                            <label class="switch">
                                <input type="checkbox" id="active-msg-switch" onchange="toggleArea('active-msg-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="active-msg-settings" class="hidden-area">
                            <div class="inline-input">
                                <span>ÂìçÂ∫îÊó∂Èó¥(Áßí):</span>
                                <input type="number" id="active-msg-time" class="form-input" style="width: 80px; margin: 0;" value="60">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveAPISettings()">‰øùÂ≠òAPIÈÖçÁΩÆ</button>
                </div>
            </div>
        </div>

        <!-- ================= Â§ñËßÇËÆæÁΩÆÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="appearance-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeModal('appearance-modal')">‚Üê</span>
                        <h2>Â§ñËßÇËÆæÁΩÆ</h2>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- ÂÖ®Â±ÄÂ≠ó‰Ωì -->
                    <div class="setting-section">
                        <h3>Aa ÂÖ®Â±ÄÂ≠ó‰Ωì</h3>
                        <div class="form-group">
                            <label class="form-label">Â≠ó‰ΩìÂêçÁß∞ (Á≥ªÁªüÂ≠ó‰ΩìÊàñÂ∑≤ÂÆâË£ÖÂ≠ó‰Ωì)</label>
                            <input type="text" id="custom-font-input" class="form-input" placeholder="‰æãÂ¶Ç: KaiTi, SimHei, 'Courier New'" onchange="applyCustomFont(this.value)">
                        </div>
                    </div>

                    <!-- ‰∏ªÂ±èÂπïÂ§¥ÂÉè -->
                    <div class="setting-section">
                        <h3>üñºÔ∏è ‰∏ªÂ±èÂπïÂ§¥ÂÉè</h3>
                        <div class="main-avatar-edit" onclick="document.getElementById('main-avatar-input').click()">
                            <img id="main-avatar-preview" src="https://api.dicebear.com/7.x/lorelei/png?seed=cute&backgroundColor=d1fae5" alt="‰∏ªÂ§¥ÂÉè">
                        </div>
                        <div class="form-group">
                            <input type="text" id="main-avatar-url" class="form-input" placeholder="ËæìÂÖ•Â§¥ÂÉèURL" onchange="previewMainAvatar()">
                        </div>
                        <div class="btn-row" style="justify-content: center;">
                            <button class="btn btn-secondary" onclick="document.getElementById('main-avatar-input').click()">Êú¨Âú∞‰∏ä‰º†</button>
                        </div>
                    </div>

                    <!-- ‰∏ªÂ±èÂπïËÉåÊôØ -->
                    <div class="setting-section">
                        <h3>üåÑ ‰∏ªÂ±èÂπïËÉåÊôØ</h3>
                        <div class="bg-preview-box" id="bg-preview-box" onclick="document.getElementById('main-bg-input').click()">
                            <span>ÁÇπÂáªÊõ¥Êç¢ËÉåÊôØ</span>
                        </div>
                        <div class="form-group">
                            <input type="text" id="main-bg-url" class="form-input" placeholder="ËæìÂÖ•ËÉåÊôØÂõæURL" onchange="previewMainBg()">
                        </div>
                        <div class="btn-row">
                            <button class="btn btn-secondary" onclick="document.getElementById('main-bg-input').click()">Êú¨Âú∞‰∏ä‰º†</button>
                            <button class="btn btn-danger" onclick="resetMainBg()">ÊÅ¢Â§çÈªòËÆ§</button>
                        </div>
                    </div>

                    <!-- Â∫îÁî®ÂõæÊ†á -->
                    <div class="setting-section">
                        <h3>üì± Â∫îÁî®ÂõæÊ†á (ÁÇπÂáªÁºñËæë)</h3>
                        <div class="icon-edit-grid" id="icon-edit-grid">
                            <!-- ÂõæÊ†áÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveAppearanceSettings()">‰øùÂ≠òÂ§ñËßÇËÆæÁΩÆ</button>
                </div>
            </div>
        </div>

        <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• -->
        <input type="file" id="character-import-input" class="hidden-input" accept=".json,.png" onchange="importCharacter(event)">
        <input type="file" id="worldbook-import-input" class="hidden-input" accept=".json,.txt,.docx" onchange="importWorldbook(event)">
        <input type="file" id="char-avatar-input" class="hidden-input" accept="image/*" onchange="uploadAvatar(event, 'char')">
        <input type="file" id="user-avatar-input" class="hidden-input" accept="image/*" onchange="uploadAvatar(event, 'user')">
        <input type="file" id="chat-bg-input" class="hidden-input" accept="image/*" onchange="uploadChatBg(event)">
        <input type="file" id="chat-import-input" class="hidden-input" accept=".json" onchange="importChatHistory(event)">
        <input type="file" id="main-avatar-input" class="hidden-input" accept="image/*" onchange="uploadMainAvatar(event)">
        <input type="file" id="main-bg-input" class="hidden-input" accept="image/*" onchange="uploadMainBg(event)">
        <input type="file" id="icon-file-input" class="hidden-input" accept="image/*" onchange="uploadIconImage(event)">
        
        <!-- ÈöêËóèÁöÑÈü≥È¢ëÊí≠ÊîæÂô® -->
        <audio id="voice-player" style="display:none;"></audio>

        <!-- Èù¢ÊùøÈÅÆÁΩ©Â±Ç -->
        <div id="panel-overlay" class="panel-overlay" onclick="closeAllPanels()"></div>

        <!-- ÂäüËÉΩÈù¢Êùø -->
        <div id="function-panel" class="function-panel">
            <div class="function-item" onclick="openEmojiPanelFromFunc()">
                <div class="function-icon">üòä</div>
                <div class="function-name">Ë°®ÊÉÖ</div>
            </div>
            <div class="function-item" onclick="document.getElementById('image-upload-input').click()">
                <div class="function-icon">üñºÔ∏è</div>
                <div class="function-name">Áõ∏ÂÜå</div>
            </div>
            <div class="function-item" onclick="startVoiceInput()">
                <div class="function-icon">üé§</div>
                <div class="function-name">ËØ≠Èü≥</div>
            </div>
            <div class="function-item" onclick="openRedPacketModal()">
                <div class="function-icon">üßß</div>
                <div class="function-name">Á∫¢ÂåÖ</div>
            </div>
            <div class="function-item" onclick="startVideoCall()">
                <div class="function-icon">üìπ</div>
                <div class="function-name">ËßÜÈ¢ëÈÄöËØù</div>
            </div>
        </div>

        <!-- Ë°®ÊÉÖÈù¢Êùø -->
        <div id="emoji-panel" class="emoji-panel">
            <div class="emoji-header">
                <div class="header-left" style="display: flex; align-items: center; gap: 10px; overflow: hidden;">
                    <span class="back-btn" onclick="closeEmojiPanel()" style="font-size: 20px; padding: 5px 10px; cursor: pointer; color: #5d8a66;">‚Üê</span>
                    <div class="emoji-tabs" id="emoji-tabs">
                        <div class="emoji-tab active" onclick="switchEmojiTab('emoji')">Emoji</div>
                        <div class="emoji-tab" onclick="switchEmojiTab('custom')">Ë°®ÊÉÖÂåÖ</div>
                        <div class="emoji-tab" onclick="document.getElementById('emoji-import-input').click()">+ ÂØºÂÖ•</div>
                    </div>
                </div>
            </div>
            <div class="emoji-content" id="emoji-content">
                <!-- Ë°®ÊÉÖÂÜÖÂÆπÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>

        <!-- Ë°®ÊÉÖÂåÖÂØºÂÖ•ÂºπÁ™ó -->
        <div id="emoji-import-modal" class="modal">
            <div class="modal-content" style="height: auto;">
                <div class="modal-header">
                    <h2>ÂØºÂÖ•Ë°®ÊÉÖÂåÖ</h2>
                    <span class="close-btn" onclick="closeModal('emoji-import-modal')">√ó</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Ë°®ÊÉÖÂåÖÂêçÁß∞</label>
                        <input type="text" id="emoji-pack-name" class="form-input" placeholder="‰æãÂ¶Ç: ÂñµÂñµË°®ÊÉÖ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÈÄâÊã©ÂõæÁâá (ÊîØÊåÅÂ§öÈÄâ)</label>
                        <div class="btn-row">
                            <button class="btn btn-secondary" onclick="document.getElementById('emoji-files-input').click()">ÈÄâÊã©ÂõæÁâá...</button>
                            <span id="emoji-files-count" style="font-size: 12px; color: #666; align-self: center;">Êú™ÈÄâÊã©</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Êàñ‰ªéÊñáÊ°£ÂØºÂÖ• (txt/docx)</label>
                        <div class="btn-row">
                            <button class="btn btn-secondary" onclick="document.getElementById('emoji-doc-input').click()">ÈÄâÊã©ÊñáÊ°£...</button>
                            <span style="font-size: 11px; color: #999; align-self: center;">Ëá™Âä®ÊèêÂèñÈìæÊé•</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveEmojiPack()">ÂØºÂÖ•</button>
                </div>
            </div>
        </div>

        <!-- ÁªëÂÆöËßíËâ≤ÂºπÁ™ó -->
        <div id="bind-character-modal" class="modal">
            <div class="modal-content" style="height: 60%;">
                <div class="modal-header">
                    <h2>ÁªëÂÆöËßíËâ≤</h2>
                    <span class="close-btn" onclick="closeModal('bind-character-modal')">√ó</span>
                </div>
                <div class="modal-body">
                    <p style="font-size: 13px; color: #666; margin-bottom: 10px;">ÈÄâÊã©ÂèØ‰ª•‰ΩøÁî®Ê≠§Ë°®ÊÉÖÂåÖÁöÑËßíËâ≤ÔºàAIÂ∞ÜÊ†πÊçÆË°®ÊÉÖÂåÖÂêçÁß∞Ëá™Âä®ÂèëÈÄÅÔºâÔºö</p>
                    <div id="bind-char-list" class="checkbox-list">
                        <!-- Âä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveBindCharacter()">‰øùÂ≠òÁªëÂÆö</button>
                </div>
            </div>
        </div>

        <!-- Á∫¢ÂåÖÂºπÁ™ó -->
        <div id="red-packet-modal" class="modal">
            <div class="modal-content" style="height: auto;">
                <div class="modal-header">
                    <h2>ÂèëÁ∫¢ÂåÖ</h2>
                    <span class="close-btn" onclick="closeModal('red-packet-modal')">√ó</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">ÈáëÈ¢ù</label>
                        <input type="number" id="rp-amount" class="form-input" placeholder="0.00" style="font-size: 24px; font-weight: bold; text-align: center;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Â§áÊ≥®</label>
                        <input type="text" id="rp-memo" class="form-input" placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©" value="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" style="background: #fa9d3b;" onclick="sendRedPacket()">Â°ûÈí±ËøõÁ∫¢ÂåÖ</button>
                </div>
            </div>
        </div>

        <input type="file" id="emoji-import-input" class="hidden-input" accept=".json" onchange="importEmojiConfig(event)">
        <input type="file" id="emoji-files-input" class="hidden-input" accept="image/*" multiple onchange="handleEmojiFilesSelect(event)">
        <input type="file" id="emoji-doc-input" class="hidden-input" accept=".txt,.docx" onchange="handleEmojiDocSelect(event)">
        <input type="file" id="image-upload-input" class="hidden-input" accept="image/*" onchange="handleImageUpload(event)">
        <input type="file" id="file-upload-input" class="hidden-input" accept=".txt,.docx,.pdf" onchange="handleFileUpload(event)">
        
        <!-- ËßÜÈ¢ëÈÄöËØùÊ®°ÊÄÅÊ°Ü -->
        <div id="video-call-modal" class="video-call-modal">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <img id="vc-avatar" class="vc-avatar" src="" alt="Avatar">
                <div id="vc-name" class="vc-name">ËßíËâ≤Âêç</div>
                <div id="vc-status" class="vc-status">Ê≠£Âú®Á≠âÂæÖÂØπÊñπÊé•ÂèóÈÇÄËØ∑...</div>
            </div>
            <div class="vc-actions">
                <div class="vc-btn hangup" onclick="endVideoCall()">üìû</div>
            </div>
        </div>

        <!-- ÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
        <div id="image-preview-modal" class="image-preview-modal" onclick="this.classList.remove('show')">
            <img id="preview-image" src="" alt="Preview">
        </div>

        <!-- ÂΩïÈü≥ÊåáÁ§∫Âô® -->
        <div id="recording-indicator" class="recording-indicator">
            <div class="recording-icon">üéôÔ∏è</div>
            <div id="recording-text">Ê≠£Âú®ÂΩïÈü≥...</div>
        </div>
    </div>

    <script>
        // ================= ÈªòËÆ§ÂõæÊ†áSVG =================
        const defaultIcons = {
            'character': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="45" r="28" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="40" cy="40" r="4" fill="#5d8a66"/><circle cx="60" cy="40" r="4" fill="#5d8a66"/><path d="M40 55 Q50 65 60 55" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M30 25 Q35 15 45 20" stroke="#5d8a66" stroke-width="2.5" fill="none" stroke-linecap="round"/><path d="M70 25 Q65 15 55 20" stroke="#5d8a66" stroke-width="2.5" fill="none" stroke-linecap="round"/><circle cx="38" cy="38" r="1.5" fill="white"/><circle cx="58" cy="38" r="1.5" fill="white"/><ellipse cx="32" cy="50" rx="4" ry="3" fill="#ffcdd2" opacity="0.6"/><ellipse cx="68" cy="50" rx="4" ry="3" fill="#ffcdd2" opacity="0.6"/></svg>`,
            'worldbook': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M50 25 L50 80" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M50 25 Q30 20 15 30 L15 75 Q30 68 50 75" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M50 25 Q70 20 85 30 L85 75 Q70 68 50 75" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M22 40 L42 38" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M22 50 L42 48" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M22 60 L38 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M58 38 L78 40" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M58 48 L78 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M62 58 L78 60" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><circle cx="50" cy="20" r="5" fill="#ffeb3b" stroke="#5d8a66" stroke-width="1.5"/></svg>`,
            'taobao': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 30 L30 30 L40 65 L75 65 L82 40 L35 40" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/><circle cx="45" cy="78" r="6" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="68" cy="78" r="6" stroke="#5d8a66" stroke-width="3" fill="none"/><path d="M45 50 L45 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M55 48 L55 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M65 50 L65 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M25 25 Q20 20 25 15" stroke="#ffb74d" stroke-width="2" stroke-linecap="round"/></svg>`,
            'api': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><text x="12" y="58" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(-8 20 50)">A</text><text x="35" y="62" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(5 45 55)">P</text><text x="58" y="55" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(-3 65 50)">I</text><path d="M75 35 Q80 30 85 35 Q90 40 85 45 Q80 50 75 45 Q70 40 75 35" stroke="#ffb74d" stroke-width="2" fill="#fff59d"/><circle cx="20" cy="30" r="4" fill="#81c784"/><circle cx="80" cy="65" r="3" fill="#81c784"/><path d="M25 70 L35 75" stroke="#5d8a66" stroke-width="1.5" stroke-linecap="round"/><path d="M30 73 L32 68" stroke="#5d8a66" stroke-width="1.5" stroke-linecap="round"/></svg>`,
            'appearance': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="50" rx="35" ry="32" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="35" cy="38" r="7" fill="#ff8a80"/><circle cx="55" cy="32" r="6" fill="#ffcc80"/><circle cx="70" cy="45" r="6" fill="#a5d6a7"/><circle cx="65" cy="62" r="5" fill="#90caf9"/><circle cx="40" cy="60" r="8" fill="white" stroke="#5d8a66" stroke-width="2"/><path d="M75 75 L90 90" stroke="#5d8a66" stroke-width="4" stroke-linecap="round"/><path d="M88 82 L92 88 L86 92" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            'look': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="50" rx="35" ry="22" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="50" cy="50" r="15" stroke="#5d8a66" stroke-width="2.5" fill="none"/><circle cx="50" cy="50" r="8" fill="#5d8a66"/><circle cx="46" cy="46" r="3" fill="white"/><path d="M20 35 Q15 30 20 25" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M80 35 Q85 30 80 25" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M15 50 L20 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M80 50 L85 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/></svg>`,
            'calendar': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="18" y="25" width="64" height="55" rx="8" stroke="#5d8a66" stroke-width="3" fill="none"/><path d="M18 42 L82 42" stroke="#5d8a66" stroke-width="2"/><path d="M35 18 L35 32" stroke="#5d8a66" stroke-width="3" stroke-linecap="round"/><path d="M65 18 L65 32" stroke="#5d8a66" stroke-width="3" stroke-linecap="round"/><text x="50" y="68" font-family="Comic Sans MS, cursive" font-size="24" fill="#5d8a66" text-anchor="middle">?</text><circle cx="72" cy="28" r="5" fill="#ff8a80"/></svg>`,
            'phone': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="28" y="15" width="44" height="70" rx="8" stroke="#5d8a66" stroke-width="3" fill="none"/><path d="M28 25 L72 25" stroke="#5d8a66" stroke-width="2"/><path d="M28 72 L72 72" stroke="#5d8a66" stroke-width="2"/><circle cx="50" cy="80" r="4" stroke="#5d8a66" stroke-width="2" fill="none"/><path d="M42 20 L58 20" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M38 45 L48 55 L62 38" stroke="#81c784" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            'weibo': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 30 Q20 20 30 20 L70 20 Q80 20 80 30 L80 55 Q80 65 70 65 L35 65 L22 78 L25 65 L30 65 Q20 65 20 55 Z" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="38" cy="42" r="4" fill="#5d8a66"/><circle cx="52" cy="42" r="4" fill="#5d8a66"/><circle cx="66" cy="42" r="4" fill="#5d8a66"/></svg>`,
            'bo4': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><text x="50" y="62" font-family="Georgia, serif" font-size="28" fill="#990000" text-anchor="middle" font-weight="bold">BO4</text><circle cx="20" cy="25" r="4" fill="#ffb74d"/><circle cx="80" cy="75" r="3" fill="#ffb74d"/></svg>`,
            'theater': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="35" cy="45" rx="22" ry="28" stroke="#5d8a66" stroke-width="2.5" fill="none"/><ellipse cx="65" cy="45" rx="22" ry="28" stroke="#5d8a66" stroke-width="2.5" fill="none"/><circle cx="28" cy="38" r="4" fill="#5d8a66"/><circle cx="42" cy="38" r="4" fill="#5d8a66"/><path d="M25 55 Q35 65 45 55" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round"/><circle cx="58" cy="38" r="4" fill="#5d8a66"/><circle cx="72" cy="38" r="4" fill="#5d8a66"/><path d="M55 55 Q65 48 75 55" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round"/><path d="M35 75 Q50 85 65 75" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/></svg>`
        };

        const iconNames = {
            'character': 'ËßíËâ≤',
            'worldbook': '‰∏ñÁïå‰π¶',
            'taobao': 'Ê∑òÂÆù',
            'api': 'APIËÆæÁΩÆ',
            'appearance': 'Â§ñËßÇËÆæÁΩÆ',
            'look': 'ÁúãÁúã‰Ω†',
            'calendar': '‰ªäÂ§©ÂÅö‰ªÄ‰πà',
            'phone': 'Êü•ÊâãÊú∫',
            'weibo': 'Âõ¥ËÑñ',
            'bo4': 'BO4',
            'theater': 'Â§ßÂâßÂú∫'
        };

        // ================= ÂÖ®Â±ÄÊï∞ÊçÆÂ≠òÂÇ® =================
        let isCreatingNewCharacter = false;
        let tempNewCharacter = null;

        let appData = {
            characters: [],
            worldbooks: [],
            currentCharacterId: null,
            currentWorldbookId: null,
            currentEntryIndex: null,
            apiSettings: {
                main: { url: '', key: '', model: '', temperature: 0.8 },
                sub: { url: '', key: '', model: '' },
                imgGen: false,
                voice: { enabled: false, groupId: '', key: '', voiceId: '', model: '', probability: 30 },
                activeMsg: { enabled: false, time: 60 }
            },
            presets: [],
            appearance: {
                mainAvatar: '',
                mainBg: '',
                icons: {}
            },
            emojiLibrary: []
        };

        // PWAÁõ∏ÂÖ≥
        let deferredPrompt = null;
        
        // ÈïøÊåâÂà†Èô§Áõ∏ÂÖ≥
        let longPressTimer = null;
        let longPressCharId = null;
        let isLongPress = false;

        // Ê∂àÊÅØÈïøÊåâÁõ∏ÂÖ≥
        let messageLongPressTimer = null;
        let isMessageLongPress = false;

        // ÂΩìÂâçÁºñËæëÁöÑÂõæÊ†á
        let currentEditingIcon = null;

        // Âä†ËΩΩÊï∞ÊçÆ
        function loadAppData() {
            const saved = localStorage.getItem('chat_app_data');
            if (saved) {
                try {
                    appData = JSON.parse(saved);
                    // Á°Æ‰øùÂ≠óÊÆµÂ≠òÂú®
                    if (!appData.apiSettings.main.temperature) appData.apiSettings.main.temperature = 0.8;
                    if (!appData.apiSettings.voice) appData.apiSettings.voice = { enabled: false, probability: 30 };
                    if (!appData.appearance) appData.appearance = { mainAvatar: '', mainBg: '', icons: {} };
                    if (!appData.emojiLibrary) appData.emojiLibrary = [];
                    
                    // Á°Æ‰øùÂõæÊ†áÈÖçÁΩÆÂ≠òÂú®
                    if (!appData.appearance.icons) appData.appearance.icons = {};
                } catch (e) {
                    console.error('Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•', e);
                }
            }
            applyAppearance();
        }

        function saveAppData() {
            localStorage.setItem('chat_app_data', JSON.stringify(appData));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function showToast(msg) {
            const toast = document.getElementById('loading-toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function formatTime(date) {
            return new Date(date).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        // ================= Â§ñËßÇ‰∏éÂàùÂßãÂåñ =================
        function applyAppearance() {
            // Â∫îÁî®ÂÖ®Â±ÄÂ≠ó‰Ωì
            const font = localStorage.getItem('custom_font');
            if (font) {
                document.documentElement.style.setProperty('--custom-font', font);
                const input = document.getElementById('custom-font-input');
                if (input) input.value = font;
            }

            // Â∫îÁî®‰∏ªÂ±èÂπïËÉåÊôØ
            if (appData.appearance.mainBg) {
                document.getElementById('phone-bg').style.backgroundImage = `url(${appData.appearance.mainBg})`;
            }

            // Â∫îÁî®‰∏ªÂ±èÂπïÂ§¥ÂÉè
            if (appData.appearance.mainAvatar) {
                document.getElementById('main-avatar').src = appData.appearance.mainAvatar;
            }

            // Â∫îÁî®Ëá™ÂÆö‰πâÂõæÊ†á
            if (appData.appearance.icons) {
                Object.keys(appData.appearance.icons).forEach(key => {
                    const iconData = appData.appearance.icons[key];
                    const iconEl = document.getElementById(`icon-${key}`);
                    if (iconEl && iconData) {
                        if (iconData.type === 'image') {
                            iconEl.innerHTML = `<img src="${iconData.content}" style="width:100%;height:100%;object-fit:cover;border-radius:14px;">`;
                        }
                    }
                });
            }
        }

        function applyCustomFont(fontName) {
            if (!fontName) return;
            document.documentElement.style.setProperty('--custom-font', fontName);
            localStorage.setItem('custom_font', fontName);
        }

        // ================= Ê®°ÊÄÅÊ°ÜÁÆ°ÁêÜ =================
        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function toggleArea(id, show) {
            document.getElementById(id).style.display = show ? 'block' : 'none';
        }

        // ================= ËßíËâ≤ÁÆ°ÁêÜ =================
        function openCharacterList() {
            renderCharacterList();
            openModal('character-modal');
        }

        function renderCharacterList() {
            const list = document.getElementById('character-list');
            list.innerHTML = '';
            
            if (appData.characters.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <div class="empty-state-text">ËøòÊ≤°ÊúâËßíËâ≤<br>ÁÇπÂáªÂè≥‰∏äËßí + ÂàõÂª∫‰∏Ä‰∏™Âêß</div>
                    </div>
                `;
                return;
            }

            appData.characters.forEach(char => {
                const item = document.createElement('div');
                item.className = 'character-item';
                item.innerHTML = `
                    <div class="character-avatar">
                        <img src="${char.avatar || 'https://api.dicebear.com/7.x/lorelei/png?seed=' + char.id}" alt="${char.name}">
                    </div>
                    <div class="character-info">
                        <div class="character-name">${char.nickname || char.name}</div>
                        <div class="character-desc">${char.persona.substring(0, 30)}...</div>
                    </div>
                `;
                item.onclick = () => openChat(char.id);
                
                // ÈïøÊåâÂà†Èô§
                let pressTimer;
                item.addEventListener('touchstart', () => {
                    pressTimer = setTimeout(() => showDeleteConfirm(char.id), 800);
                });
                item.addEventListener('touchend', () => clearTimeout(pressTimer));
                
                list.appendChild(item);
            });
        }

        function createNewCharacter() {
            isCreatingNewCharacter = true;
            tempNewCharacter = {
                id: generateId(),
                name: '',
                nickname: '',
                persona: '',
                avatar: '',
                userSettings: { name: 'Áî®Êà∑', nickname: '‰Ω†', persona: '', avatar: '' },
                worldbooks: [],
                chatHistory: [],
                settings: { memoryCount: 50, temperature: 0.8 }
            };
            
            // Â°´ÂÖÖË°®Âçï
            document.getElementById('character-edit-title').textContent = 'ÂàõÂª∫Êñ∞ËßíËâ≤';
            document.getElementById('char-name').value = '';
            document.getElementById('char-nickname').value = '';
            document.getElementById('char-persona').value = '';
            document.getElementById('char-avatar-preview').src = 'https://api.dicebear.com/7.x/lorelei/png?seed=new';
            
            document.getElementById('user-name').value = '';
            document.getElementById('user-nickname').value = '';
            document.getElementById('user-persona').value = '';
            document.getElementById('user-avatar-preview').src = 'https://api.dicebear.com/7.x/lorelei/png?seed=user';
            
            renderWorldbookCheckboxList([]);
            
            openModal('character-edit-modal');
        }

        function openCharacterSettings() {
            if (!appData.currentCharacterId) return;
            isCreatingNewCharacter = false;
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;

            document.getElementById('character-edit-title').textContent = 'ËßíËâ≤ËÆæÁΩÆ';
            document.getElementById('char-name').value = char.name || '';
            document.getElementById('char-nickname').value = char.nickname || '';
            document.getElementById('char-persona').value = char.persona || '';
            document.getElementById('char-avatar-preview').src = char.avatar || `https://api.dicebear.com/7.x/lorelei/png?seed=${char.id}`;
            
            document.getElementById('user-name').value = char.userSettings?.name || '';
            document.getElementById('user-nickname').value = char.userSettings?.nickname || '';
            document.getElementById('user-persona').value = char.userSettings?.persona || '';
            document.getElementById('user-avatar-preview').src = char.userSettings?.avatar || `https://api.dicebear.com/7.x/lorelei/png?seed=user${char.id}`;
            
            renderWorldbookCheckboxList(char.worldbooks || []);
            
            openModal('character-edit-modal');
        }

        function saveCharacter() {
            const charData = isCreatingNewCharacter ? tempNewCharacter : appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!charData) return;

            charData.name = document.getElementById('char-name').value;
            charData.nickname = document.getElementById('char-nickname').value;
            charData.persona = document.getElementById('char-persona').value;
            charData.avatar = document.getElementById('char-avatar-preview').src;
            
            if (!charData.userSettings) charData.userSettings = {};
            charData.userSettings.name = document.getElementById('user-name').value;
            charData.userSettings.nickname = document.getElementById('user-nickname').value;
            charData.userSettings.persona = document.getElementById('user-persona').value;
            charData.userSettings.avatar = document.getElementById('user-avatar-preview').src;
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑ‰∏ñÁïå‰π¶
            const checkboxes = document.querySelectorAll('#char-worldbook-list input[type="checkbox"]');
            charData.worldbooks = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);

            if (isCreatingNewCharacter) {
                appData.characters.push(charData);
                isCreatingNewCharacter = false;
            }
            
            saveAppData();
            closeModal('character-edit-modal');
            renderCharacterList();
            
            if (appData.currentCharacterId === charData.id) {
                updateChatHeader(charData);
            }
            
            showToast('ËßíËâ≤Â∑≤‰øùÂ≠ò');
        }

        function renderWorldbookCheckboxList(selectedIds) {
            const list = document.getElementById('char-worldbook-list');
            list.innerHTML = '';
            appData.worldbooks.forEach(wb => {
                const item = document.createElement('label');
                item.className = 'checkbox-item';
                item.innerHTML = `
                    <input type="checkbox" value="${wb.id}" ${selectedIds.includes(wb.id) ? 'checked' : ''}>
                    <span class="checkbox-label">${wb.name}</span>
                `;
                list.appendChild(item);
            });
        }

        function showDeleteConfirm(charId) {
            longPressCharId = charId;
            document.getElementById('delete-confirm-overlay').classList.add('show');
        }

        function hideDeleteConfirm() {
            document.getElementById('delete-confirm-overlay').classList.remove('show');
            longPressCharId = null;
        }

        document.getElementById('confirm-delete-btn').onclick = function() {
            if (longPressCharId) {
                appData.characters = appData.characters.filter(c => c.id !== longPressCharId);
                saveAppData();
                renderCharacterList();
                hideDeleteConfirm();
                
                if (appData.currentCharacterId === longPressCharId) {
                    closeChat();
                }
            } else if (appData.currentCharacterId) {
                // ‰ªéÁºñËæëÁïåÈù¢Âà†Èô§
                appData.characters = appData.characters.filter(c => c.id !== appData.currentCharacterId);
                saveAppData();
                closeModal('character-edit-modal');
                closeChat();
                renderCharacterList();
            }
        };

        function deleteCurrentCharacter() {
            if (isCreatingNewCharacter) {
                closeModal('character-edit-modal');
                return;
            }
            showDeleteConfirm(null); // null Ë°®Á§∫Âà†Èô§ÂΩìÂâçÁºñËæëÁöÑËßíËâ≤
        }

        function closeCharacterEdit() {
            closeModal('character-edit-modal');
        }

        // ================= ËÅäÂ§©ÂäüËÉΩ =================
        function openChat(charId) {
            appData.currentCharacterId = charId;
            const char = appData.characters.find(c => c.id === charId);
            if (!char) return;

            updateChatHeader(char);
            renderMessages();
            openModal('chat-modal');
            closeModal('character-modal'); // ÂÖ≥Èó≠ÂàóË°®
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            setTimeout(scrollToBottom, 100);
        }

        function updateChatHeader(char) {
            document.getElementById('chat-char-name').textContent = char.nickname || char.name;
            document.getElementById('chat-char-avatar').src = char.avatar || `https://api.dicebear.com/7.x/lorelei/png?seed=${char.id}`;
        }

        function closeChat() {
            appData.currentCharacterId = null;
            closeModal('chat-modal');
        }

        function renderMessages() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;
            
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';
            
            char.chatHistory.forEach(msg => {
                appendMessageToDOM(msg);
            });
        }

        function appendMessageToDOM(msg) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message ${msg.role === 'user' ? 'user' : 'ai'}`;
            
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            const avatarSrc = msg.role === 'user' 
                ? (char.userSettings?.avatar || 'https://api.dicebear.com/7.x/lorelei/png?seed=user')
                : (char.avatar || `https://api.dicebear.com/7.x/lorelei/png?seed=${char.id}`);

            let contentHtml = '';
            
            // Â§ÑÁêÜÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
            if (msg.content.includes('[img]')) {
                const url = msg.content.match(/\[img\](.*?)\[\/img\]/)[1];
                contentHtml = `<img src="${url}" class="chat-image" onclick="previewImage('${url}')">`;
            } else if (msg.content.includes('[file]')) {
                // Êñá‰ª∂Ê†ºÂºè: [file]Êñá‰ª∂Âêç|Â§ßÂ∞è[/file]
                const match = msg.content.match(/\[file\](.*?)\|(.*?)\[\/file\]/);
                if (match) {
                    const fileName = match[1];
                    const fileSize = match[2];
                    contentHtml = `
                        <div class="file-bubble" style="display: flex; align-items: center; gap: 10px; background: white; padding: 10px; border-radius: 8px; min-width: 200px; border: 1px solid #eee; cursor: pointer;">
                            <div style="font-size: 32px;">üìÑ</div>
                            <div style="flex: 1; overflow: hidden;">
                                <div style="font-size: 14px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500;">${fileName}</div>
                                <div style="font-size: 12px; color: #999;">${fileSize}</div>
                            </div>
                        </div>
                    `;
                } else {
                    contentHtml = msg.content;
                }
            } else if (msg.content.includes('[redpacket]')) {
                // Á∫¢ÂåÖÊ†ºÂºè: [redpacket]ÈáëÈ¢ù|Â§áÊ≥®[/redpacket]
                const match = msg.content.match(/\[redpacket\](.*?)\|(.*?)\[\/redpacket\]/);
                if (match) {
                    contentHtml = `
                        <div class="red-packet-bubble">
                            <div class="rp-content">
                                <div class="rp-icon">üßß</div>
                                <div class="rp-text">
                                    <div class="rp-desc">${match[2]}</div>
                                    <div class="rp-status">Êü•ÁúãÁ∫¢ÂåÖ</div>
                                </div>
                            </div>
                            <div class="rp-footer">ÂæÆ‰ø°Á∫¢ÂåÖ</div>
                        </div>
                    `;
                }
            } else {
                contentHtml = msg.content.replace(/\n/g, '<br>');
            }

            div.innerHTML = `
                <div class="message-avatar">
                    <img src="${avatarSrc}">
                </div>
                <div class="message-content">
                    <div class="message-bubble">${contentHtml}</div>
                    <div class="message-time">${formatTime(msg.timestamp || Date.now())}</div>
                </div>
            `;
            
            container.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;

            const msg = {
                role: 'user',
                content: text,
                timestamp: Date.now()
            };

            char.chatHistory.push(msg);
            saveAppData();
            appendMessageToDOM(msg);
            input.value = '';
            input.style.height = 'auto';
            
            // Ëß¶ÂèëAIÂõûÂ§ç
            triggerAIReply();
        }

        function triggerAIReply() {
            const btn = document.getElementById('ai-reply-btn');
            btn.classList.add('loading');
            
            callAI().then(response => {
                btn.classList.remove('loading');
                if (response) {
                    handleAIResponse(response);
                }
            }).catch(err => {
                btn.classList.remove('loading');
                showToast('AIËØ∑Ê±ÇÂ§±Ë¥•: ' + err.message);
            });
        }

        function retryLastMessage() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char || char.chatHistory.length === 0) return;

            const lastMsg = char.chatHistory[char.chatHistory.length - 1];
            
            // Â¶ÇÊûúÊúÄÂêé‰∏ÄÊù°ÊòØ AI ÂõûÂ§çÔºåÂà†Èô§ÂÆÉÂπ∂ÈáçËØï
            if (lastMsg.role === 'assistant') {
                char.chatHistory.pop();
                saveAppData();
                renderMessages();
                triggerAIReply();
            } else if (lastMsg.role === 'user') {
                // Â¶ÇÊûúÊúÄÂêé‰∏ÄÊù°ÊòØÁî®Êà∑Ê∂àÊÅØÔºåÁõ¥Êé•Ëß¶Âèë AI ÂõûÂ§ç
                triggerAIReply();
            }
        }

        function handleAIResponse(responseText) {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            
            // Â§ÑÁêÜÂ§öÊ∂àÊÅØÂàÜÈöîÁ¨¶ |||
            const parts = responseText.split('|||').filter(p => p.trim());
            
            let delay = 0;
            parts.forEach((part, index) => {
                setTimeout(() => {
                    const msg = {
                        role: 'assistant',
                        content: part.trim(),
                        timestamp: Date.now()
                    };
                    char.chatHistory.push(msg);
                    saveAppData();
                    appendMessageToDOM(msg);
                }, delay);
                delay += 1500; // ÊØèÊù°Ê∂àÊÅØÈó¥Èöî1.5Áßí
            });
        }

        async function fetchChatCompletion(messages, settings) {
            const apiKey = settings.key;
            let apiUrl = settings.url;
            
            // URL Êô∫ËÉΩË°•ÂÖ®‰∏é‰øÆÂ§ç
            if (!apiUrl) {
                apiUrl = 'https://api.openai.com/v1/chat/completions';
            } else {
                apiUrl = apiUrl.trim();
                // Â¶ÇÊûúÊ≤°ÊúâÂçèËÆÆÂ§¥ÔºåÈªòËÆ§Ê∑ªÂä† https
                if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
                    apiUrl = 'https://' + apiUrl;
                }
                // Â¶ÇÊûú URL ÁúãËµ∑Êù•ÂÉèÂè™ÊòØÂüüÂêçÔºàÊ≤°ÊúâË∑ØÂæÑÔºâÔºåÂ∞ùËØïËøΩÂä†Ê†áÂáÜË∑ØÂæÑ
                // ÁÆÄÂçïÁöÑÂêØÂèëÂºèÔºöÂ¶ÇÊûúÊ≤°Êúâ /v1/chat/completions ‰∏îÊ≤°Êúâ /chat/completions
                try {
                    const urlObj = new URL(apiUrl);
                    if (urlObj.pathname === '/' || urlObj.pathname === '') {
                        apiUrl = apiUrl.replace(/\/$/, '') + '/v1/chat/completions';
                    }
                } catch (e) {
                    // URL Ê†ºÂºèÈîôËØØÔºå‰øùÊåÅÂéüÊ†∑ËÆ© fetch Êä•ÈîôÊàñÊèêÁ§∫
                    console.warn('URLËß£ÊûêË≠¶Âëä:', e);
                }
            }

            const model = settings.model || 'gpt-3.5-turbo';
            
            if (!apiKey) {
                throw new Error('ËØ∑ÂÖàÈÖçÁΩÆAPI Key');
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages,
                        temperature: parseFloat(settings.temperature || 0.8)
                    })
                });

                if (!response.ok) {
                    let errMsg = 'ËØ∑Ê±ÇÂ§±Ë¥•';
                    try {
                        const err = await response.json();
                        errMsg = err.error?.message || errMsg;
                    } catch (e) {
                        errMsg = `HTTP Error ${response.status}`;
                    }
                    throw new Error(errMsg);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                // ÊçïËé∑ fetch ÈîôËØØÔºàÂ¶ÇÁΩëÁªúÈîôËØØ„ÄÅÊó†Êïà URLÔºâ
                if (error.message.includes('Invalid URL') || error.message.includes('Failed to fetch')) {
                    throw new Error(`ËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•APIÂú∞ÂùÄÊòØÂê¶Ê≠£Á°Æ„ÄÇ\nÂΩìÂâçÂú∞ÂùÄ: ${apiUrl}`);
                }
                throw error;
            }
        }

        async function callAI() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            const messages = buildPromptMessages(char);
            return await fetchChatCompletion(messages, appData.apiSettings.main);
        }

        function buildPromptMessages(char) {
            // ÊûÑÂª∫ System Prompt
            let systemPrompt = `‰Ω†Ê≠£Âú®ÊâÆÊºî‰∏Ä‰∏™ËßíËâ≤„ÄÇ
ËßíËâ≤ÂêçÔºö${char.name}
ÊòµÁß∞Ôºö${char.nickname}
‰∫∫ËÆæÔºö${char.persona}

Áî®Êà∑Ôºö${char.userSettings?.name || 'Áî®Êà∑'}
Áî®Êà∑ÊòµÁß∞Ôºö${char.userSettings?.nickname || '‰Ω†'}
Áî®Êà∑‰∫∫ËÆæÔºö${char.userSettings?.persona || ''}

ÂΩìÂâçÊó∂Èó¥Ôºö${new Date().toLocaleString()}

ËØ∑‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãËßÑÂàôÔºö
1. ÂßãÁªà‰øùÊåÅËßíËâ≤ËØ≠Ê∞îÔºå‰∏çË¶ÅË∑≥Âá∫ËßíËâ≤„ÄÇ
2. ÂõûÂ§çË¶ÅÁÆÄÁü≠Ëá™ÁÑ∂ÔºåÂÉèÂæÆ‰ø°ËÅäÂ§©‰∏ÄÊ†∑„ÄÇ
3. Â¶ÇÊûúÈúÄË¶ÅÂèëÈÄÅÂ§öÊù°Ê∂àÊÅØÔºåËØ∑Âú®Ê∂àÊÅØ‰πãÈó¥‰ΩøÁî® "|||" ÂàÜÈöî„ÄÇ
4. Â¶ÇÊûúÁî®Êà∑ÂèëÈÄÅÂõæÁâáÔºåËØ∑Ê†πÊçÆÂõæÁâáÂÜÖÂÆπËøõË°åÂõûÂ∫î„ÄÇ
`;

            // ÂÖ≥ËÅî‰∏ñÁïå‰π¶
            if (char.worldbooks && char.worldbooks.length > 0) {
                const wbContent = char.worldbooks.map(wbId => {
                    const wb = appData.worldbooks.find(w => w.id === wbId);
                    if (!wb) return '';
                    // ÁÆÄÂçïÁöÑÂÖ≥ÈîÆËØçÂåπÈÖçÈÄªËæëÔºàËøôÈáåÁÆÄÂåñ‰∏∫ÂÖ®ÈÉ®Âä†ËΩΩÔºåÂÆûÈôÖÂ∫îÊåâÈúÄÔºâ
                    return wb.entries.map(e => `${e.keywords}: ${e.content}`).join('\n');
                }).join('\n');
                if (wbContent) {
                    systemPrompt += `\n‰∏ñÁïåËßÇËÆæÂÆöÔºö\n${wbContent}`;
                }
            }

            if (char.postHistoryInstructions) {
                systemPrompt += `\n${char.postHistoryInstructions}`;
            }

            const messages = [
                { role: 'system', content: systemPrompt }
            ];

            // Ê∑ªÂä†ÂéÜÂè≤ËÆ∞ÂΩï
            const historyLimit = char.settings?.memoryCount || 50;
            const recentHistory = char.chatHistory.slice(-historyLimit);
            
            recentHistory.forEach(msg => {
                let content = msg.content;
                
                // Â§ÑÁêÜÂõæÁâáÊ∂àÊÅØÊ†ºÂºèËΩ¨Êç¢
                if (content.includes('[img]')) {
                    const imgUrl = content.match(/\[img\](.*?)\[\/img\]/)[1];
                    messages.push({
                        role: msg.role,
                        content: [
                            { type: "text", text: "ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá" },
                            { type: "image_url", image_url: { url: imgUrl } }
                        ]
                    });
                } else {
                    messages.push({ role: msg.role, content: content });
                }
            });

            return messages;
        }

        // ================= ËæÖÂä©ÂäüËÉΩ =================
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                const input = document.getElementById('chat-input');
                // ÊèíÂÖ•ÂõæÁâáÊ†áÁ≠æ
                input.value += `[img]${base64}[/img]`;
                sendMessage();
            };
            reader.readAsDataURL(file);
            event.target.value = ''; // ÈáçÁΩÆ
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const input = document.getElementById('chat-input');
            
            // ÁÆÄÂçïÁöÑÊñá‰ª∂Â§ÑÁêÜÔºöÂ¶ÇÊûúÊòØÊñáÊú¨Êñá‰ª∂ÔºåËØªÂèñÂÜÖÂÆπ
            if (file.type === 'text/plain') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    input.value += e.target.result;
                    autoResize(input);
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.docx')) {
                // ‰ΩøÁî® mammoth ËØªÂèñ docx
                const reader = new FileReader();
                reader.onload = function(e) {
                    mammoth.extractRawText({arrayBuffer: e.target.result})
                        .then(function(result){
                            input.value += result.value;
                            autoResize(input);
                        })
                        .catch(function(err){
                            showToast('ÊñáÊ°£ËØªÂèñÂ§±Ë¥•');
                        });
                };
                reader.readAsArrayBuffer(file);
            } else {
                // ÂÖ∂‰ªñÊñá‰ª∂ÔºåÂèëÈÄÅÊñá‰ª∂Ê∂àÊÅØÊ†áËÆ∞
                // Ê†ºÂºè: [file]Êñá‰ª∂Âêç|Â§ßÂ∞è[/file]
                const size = (file.size / 1024).toFixed(1) + 'KB';
                input.value += `[file]${file.name}|${size}[/file]`;
                sendMessage();
            }
            
            event.target.value = '';
        }

        function previewImage(url) {
            const modal = document.getElementById('image-preview-modal');
            const img = document.getElementById('preview-image');
            img.src = url;
            modal.classList.add('show');
        }

        // ================= ËßÜÈ¢ëÈÄöËØù =================
        function startVideoCall() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;
            
            document.getElementById('vc-avatar').src = char.avatar || `https://api.dicebear.com/7.x/lorelei/png?seed=${char.id}`;
            document.getElementById('vc-name').textContent = char.nickname || char.name;
            document.getElementById('video-call-modal').classList.add('show');
            
            // Ê®°ÊãüÂØπÊñπÊé•Âê¨
            setTimeout(() => {
                document.getElementById('vc-status').textContent = 'ÈÄöËØù‰∏≠ 00:00';
                // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ËÆ°Êó∂Âô®ÈÄªËæë
            }, 3000);
        }

        function endVideoCall() {
            document.getElementById('video-call-modal').classList.remove('show');
            document.getElementById('vc-status').textContent = 'Ê≠£Âú®Á≠âÂæÖÂØπÊñπÊé•ÂèóÈÇÄËØ∑...';
        }

        // ================= Á∫¢ÂåÖÂäüËÉΩ =================
        function openRedPacketModal() {
            openModal('red-packet-modal');
            toggleFunctionPanel(); // ÂÖ≥Èó≠ÂäüËÉΩÈù¢Êùø
        }

        function sendRedPacket() {
            const amount = document.getElementById('rp-amount').value;
            const memo = document.getElementById('rp-memo').value || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©';
            
            if (!amount) {
                showToast('ËØ∑ËæìÂÖ•ÈáëÈ¢ù');
                return;
            }
            
            const input = document.getElementById('chat-input');
            input.value = `[redpacket]${amount}|${memo}[/redpacket]`;
            sendMessage();
            closeModal('red-packet-modal');
        }

        // ================= ÂäüËÉΩÈù¢Êùø =================
        function closeAllPanels() {
            document.getElementById('function-panel').classList.remove('show');
            document.getElementById('emoji-panel').classList.remove('show');
            document.getElementById('panel-overlay').classList.remove('show');
        }

        function toggleFunctionPanel() {
            const panel = document.getElementById('function-panel');
            const overlay = document.getElementById('panel-overlay');
            const isShown = panel.classList.contains('show');
            
            if (isShown) {
                panel.classList.remove('show');
                overlay.classList.remove('show');
            } else {
                panel.classList.add('show');
                overlay.classList.add('show');
                // Á°Æ‰øùË°®ÊÉÖÈù¢ÊùøÂÖ≥Èó≠
                document.getElementById('emoji-panel').classList.remove('show');
            }
        }

        function openEmojiPanelFromFunc() {
            // ÂÖ≥Èó≠ÂäüËÉΩÈù¢ÊùøÔºå‰øùÊåÅÈÅÆÁΩ©Â±ÇÊòæÁ§∫
            document.getElementById('function-panel').classList.remove('show');
            // Á°Æ‰øùÈÅÆÁΩ©Â±ÇÊòæÁ§∫
            document.getElementById('panel-overlay').classList.add('show');
            
            setTimeout(() => {
                document.getElementById('emoji-panel').classList.add('show');
            }, 100);
        }

        function toggleEmojiPanel() {
            const panel = document.getElementById('emoji-panel');
            const overlay = document.getElementById('panel-overlay');
            panel.classList.toggle('show');
            
            if (panel.classList.contains('show')) {
                overlay.classList.add('show');
                switchEmojiTab('emoji'); // ÈªòËÆ§ÊâìÂºÄ Emoji Ê†áÁ≠æ
            } else {
                overlay.classList.remove('show');
            }
        }

        function closeEmojiPanel() {
            document.getElementById('emoji-panel').classList.remove('show');
            document.getElementById('panel-overlay').classList.remove('show');
            document.getElementById('chat-input').focus(); // ËøîÂõûÁÑ¶ÁÇπÁªôËæìÂÖ•Ê°Ü
        }

        let currentEmojiTab = 'emoji';

        function switchEmojiTab(tab) {
            currentEmojiTab = tab;
            document.querySelectorAll('.emoji-tab').forEach(el => el.classList.remove('active'));
            // ÊâæÂà∞ÂØπÂ∫îÁöÑ tab ÂÖÉÁ¥†Âπ∂Ê∑ªÂä† active Á±ª
            const tabs = document.querySelectorAll('.emoji-tab');
            if (tab === 'emoji') tabs[0].classList.add('active');
            else if (tab === 'custom') tabs[1].classList.add('active');
            
            renderEmojiContent();
        }

        function renderEmojiContent() {
            const container = document.getElementById('emoji-content');
            container.innerHTML = '';

            if (currentEmojiTab === 'emoji') {
                // Â∏∏Áî® Emoji ÂàóË°®
                const emojis = ['üòÄ','üòÅ','üòÇ','ü§£','üòÉ','üòÑ','üòÖ','üòÜ','üòâ','üòä','üòã','üòé','üòç','üòò','ü•∞','üòó','üòô','üòö','üôÇ','ü§ó','ü§©','ü§î','ü§®','üòê','üòë','üò∂','üôÑ','üòè','üò£','üò•','üòÆ','ü§ê','üòØ','üò™','üò´','üò¥','üòå','üòõ','üòú','üòù','ü§§','üòí','üòì','üòî','üòï','üôÉ','ü§ë','üò≤','‚òπÔ∏è','üôÅ','üòñ','üòû','üòü','üò§','üò¢','üò≠','üò¶','üòß','üò®','üò©','ü§Ø','üò¨','üò∞','üò±','ü•µ','ü•∂','üò≥','ü§™','üòµ','üò°','üò†','ü§¨','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','üòá','ü§†','ü§°','ü•≥','ü•¥','ü•∫','ü§•','ü§´','ü§≠','üßê','ü§ì','üòà','üëø','üëπ','üë∫','üíÄ','üëª','üëΩ','ü§ñ','üí©','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ'];
                
                emojis.forEach(emoji => {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = emoji;
                    item.onclick = () => insertEmoji(emoji);
                    container.appendChild(item);
                });
            } else if (currentEmojiTab === 'custom') {
                // Ê∏≤ÊüìËá™ÂÆö‰πâË°®ÊÉÖÂåÖ
                if (appData.emojiLibrary && appData.emojiLibrary.length > 0) {
                    appData.emojiLibrary.forEach(pack => {
                        // Ê£ÄÊü•ÊòØÂê¶ÁªëÂÆö‰∫ÜÂΩìÂâçËßíËâ≤
                        // Â¶ÇÊûúÁªëÂÆö‰∫ÜËßíËâ≤ÔºåÂè™ÊúâËØ•ËßíËâ≤ËÉΩÁúãÂà∞ÔºõÊ≤°ÁªëÂÆöÂàôÊâÄÊúâËßíËâ≤ÂèØËßÅ
                        // ‰ΩÜÂú®ÁÆ°ÁêÜÊ®°Âºè‰∏ãÔºàËøôÈáåÊ≤°Êúâ‰∏ìÈó®ÁöÑÁÆ°ÁêÜÊ®°ÂºèÔºåÊâÄ‰ª•Êàë‰ª¨ÂÖÅËÆ∏ÁúãÂà∞ÊâÄÊúâÔºå‰ΩÜÂú®ÁÇπÂáªÊó∂ÊèêÁ§∫ÔºüÊàñËÄÖÂè™ÊòæÁ§∫ÂèØËßÅÁöÑÔºâ
                        // ‰∏∫‰∫ÜÊñπ‰æøÁÆ°ÁêÜÔºåÊàë‰ª¨ÊòæÁ§∫ÊâÄÊúâÂèØËßÅÁöÑ„ÄÇ
                        const isVisible = !pack.bindCharId || pack.bindCharId === appData.currentCharacterId;
                        if (!isVisible) return;

                        // ÁªÑÊ†áÈ¢òÊ†è
                        const groupHeader = document.createElement('div');
                        groupHeader.style.gridColumn = '1 / -1';
                        groupHeader.style.display = 'flex';
                        groupHeader.style.justifyContent = 'space-between';
                        groupHeader.style.alignItems = 'center';
                        groupHeader.style.padding = '5px 0';
                        groupHeader.style.marginTop = '10px';
                        groupHeader.style.borderBottom = '1px dashed #eee';
                        
                        groupHeader.innerHTML = `
                            <span style="font-size:12px;color:#666;font-weight:bold;">${pack.name}</span>
                            <span style="font-size:16px;cursor:pointer;padding:0 5px;" onclick="openBindCharacterModal('${pack.id}')" title="ËÆæÁΩÆ">‚öôÔ∏è</span>
                        `;
                        container.appendChild(groupHeader);

                        pack.emojis.forEach(url => {
                            const item = document.createElement('div');
                            item.className = 'emoji-item';
                            item.innerHTML = `<img src="${url}">`;
                            item.onclick = () => sendEmojiImage(url);
                            container.appendChild(item);
                        });
                    });
                } else {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">ÊöÇÊó†Ë°®ÊÉÖÂåÖÔºåÁÇπÂáªÂè≥‰∏äËßíÂØºÂÖ•</div>';
                }
            }
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('chat-input');
            input.value += emoji;
            // ‰∏çËá™Âä®ÂèëÈÄÅÔºå‰πü‰∏çÂÖ≥Èó≠Èù¢Êùø
        }

        function sendEmojiImage(url) {
            const input = document.getElementById('chat-input');
            // ÂèëÈÄÅÂõæÁâáÊ∂àÊÅØ
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;

            const msg = {
                role: 'user',
                content: `[img]${url}[/img]`,
                timestamp: Date.now()
            };

            char.chatHistory.push(msg);
            saveAppData();
            appendMessageToDOM(msg);
            
            // Ëß¶ÂèëAIÂõûÂ§ç
            triggerAIReply();
            
            // ÂèëÈÄÅÂêé‰∏çÂÖ≥Èó≠Èù¢ÊùøÔºåÁ¨¶ÂêàÁî®Êà∑Ë¶ÅÊ±Ç
        }

        // ================= API ËÆæÁΩÆ =================
        function openAPISettings() {
            document.getElementById('main-api-url').value = appData.apiSettings.main.url;
            document.getElementById('main-api-key').value = appData.apiSettings.main.key;
            document.getElementById('main-temperature').value = appData.apiSettings.main.temperature || 0.8;
            document.getElementById('temp-value').textContent = appData.apiSettings.main.temperature || 0.8;
            openModal('api-modal');
        }

        function saveAPISettings() {
            appData.apiSettings.main.url = document.getElementById('main-api-url').value;
            appData.apiSettings.main.key = document.getElementById('main-api-key').value;
            appData.apiSettings.main.temperature = document.getElementById('main-temperature').value;
            saveAppData();
            closeModal('api-modal');
            showToast('APIËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }

        // ================= Â§ñËßÇËÆæÁΩÆ =================
        function openAppearanceSettings() {
            document.getElementById('custom-font-input').value = localStorage.getItem('custom_font') || '';
            document.getElementById('main-avatar-url').value = appData.appearance.mainAvatar || '';
            document.getElementById('main-bg-url').value = appData.appearance.mainBg || '';
            
            renderIconEditGrid();
            openModal('appearance-modal');
        }

        function saveAppearanceSettings() {
            appData.appearance.mainAvatar = document.getElementById('main-avatar-url').value;
            appData.appearance.mainBg = document.getElementById('main-bg-url').value;
            saveAppData();
            applyAppearance();
            closeModal('appearance-modal');
            showToast('Â§ñËßÇËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }

        function renderIconEditGrid() {
            const grid = document.getElementById('icon-edit-grid');
            grid.innerHTML = '';
            
            Object.keys(iconNames).forEach(key => {
                const item = document.createElement('div');
                item.className = 'icon-edit-item';
                
                let iconContent = defaultIcons[key];
                if (appData.appearance.icons && appData.appearance.icons[key]) {
                    if (appData.appearance.icons[key].type === 'image') {
                        iconContent = `<img src="${appData.appearance.icons[key].content}">`;
                    }
                }

                item.innerHTML = `
                    <div class="icon-edit-preview">${iconContent}</div>
                    <div class="icon-edit-name">${iconNames[key]}</div>
                `;
                item.onclick = () => openIconEdit(key);
                grid.appendChild(item);
            });
        }

        function openIconEdit(key) {
            currentEditingIcon = key;
            document.getElementById('icon-edit-title').textContent = `ÁºñËæë ${iconNames[key]} ÂõæÊ†á`;
            
            const preview = document.getElementById('icon-edit-preview');
            let iconContent = defaultIcons[key];
            if (appData.appearance.icons && appData.appearance.icons[key]) {
                if (appData.appearance.icons[key].type === 'image') {
                    iconContent = `<img src="${appData.appearance.icons[key].content}">`;
                }
            }
            preview.innerHTML = iconContent;
            
            document.getElementById('popup-overlay').classList.add('show');
            document.getElementById('icon-edit-popup').classList.add('show');
        }

        function closeIconEditPopup() {
            document.getElementById('popup-overlay').classList.remove('show');
            document.getElementById('icon-edit-popup').classList.remove('show');
            currentEditingIcon = null;
        }

        function uploadIconImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('icon-url-input').value = e.target.result;
                document.getElementById('icon-edit-preview').innerHTML = `<img src="${e.target.result}">`;
            };
            reader.readAsDataURL(file);
        }

        function saveIconEdit() {
            if (!currentEditingIcon) return;
            const url = document.getElementById('icon-url-input').value;
            if (url) {
                if (!appData.appearance.icons) appData.appearance.icons = {};
                appData.appearance.icons[currentEditingIcon] = { type: 'image', content: url };
                saveAppData();
                renderIconEditGrid();
                closeIconEditPopup();
            }
        }

        function resetIconToDefault() {
            if (!currentEditingIcon) return;
            if (appData.appearance.icons && appData.appearance.icons[currentEditingIcon]) {
                delete appData.appearance.icons[currentEditingIcon];
                saveAppData();
                renderIconEditGrid();
                closeIconEditPopup();
            }
        }

        // ================= Êñ∞Â¢ûÂäüËÉΩÈÄªËæë =================
        
        // ÈáçÊñ∞ÁîüÊàêÂõûÂ§ç
        function regenerateAIResponse() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char || char.chatHistory.length === 0) return;

            const lastMsg = char.chatHistory[char.chatHistory.length - 1];
            
            // Âè™ÊúâÂΩìÊúÄÂêé‰∏ÄÊù°ÊòØAIÂõûÂ§çÔºåÊàñËÄÖÊúÄÂêé‰∏ÄÊù°ÊòØÁî®Êà∑Ê∂àÊÅØÊó∂ÊâçÊúâÊïà
            if (lastMsg.role === 'assistant') {
                // Âà†Èô§ÊúÄÂêé‰∏ÄÊù°AIÊ∂àÊÅØ
                char.chatHistory.pop();
                saveAppData();
                renderMessages();
                triggerAIReply();
            } else if (lastMsg.role === 'user') {
                // Â¶ÇÊûúÊúÄÂêéÊòØÁî®Êà∑Ê∂àÊÅØÔºåÁõ¥Êé•ÈáçËØï
                triggerAIReply();
            } else {
                showToast('Êó†Ê≥ïÈáçÊñ∞ÁîüÊàê');
            }
        }

        // ÂàáÊç¢ËØ≠Èü≥/ÈîÆÁõòÊ®°Âºè
        let isVoiceMode = false;
        function toggleVoiceMode() {
            isVoiceMode = !isVoiceMode;
            const input = document.getElementById('chat-input');
            const voiceBtn = document.getElementById('voice-hold-btn');
            const toggleBtn = document.getElementById('voice-toggle-btn');
            
            if (isVoiceMode) {
                input.style.display = 'none';
                voiceBtn.style.display = 'flex';
                // ÂàáÊç¢ÂõæÊ†á‰∏∫ÈîÆÁõò
                toggleBtn.innerHTML = '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2" ry="2"></rect><line x1="6" y1="8" x2="6" y2="8"></line><line x1="10" y1="8" x2="10" y2="8"></line><line x1="14" y1="8" x2="14" y2="8"></line><line x1="18" y1="8" x2="18" y2="8"></line><line x1="6" y1="12" x2="6" y2="12"></line><line x1="10" y1="12" x2="10" y2="12"></line><line x1="14" y1="12" x2="14" y2="12"></line><line x1="18" y1="12" x2="18" y2="12"></line><line x1="6" y1="16" x2="6" y2="16"></line><line x1="10" y1="16" x2="10" y2="16"></line><line x1="14" y1="16" x2="14" y2="16"></line></svg>';
            } else {
                input.style.display = 'block';
                voiceBtn.style.display = 'none';
                // ÂàáÊç¢ÂõæÊ†á‰∏∫ËØ≠Èü≥
                toggleBtn.innerHTML = '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>';
                input.focus();
            }
        }

        // ÂàùÂßãÂåñËØ≠Èü≥ÊåâÈíÆ‰∫ã‰ª∂
        function initVoiceButton() {
            const btn = document.getElementById('voice-hold-btn');
            const indicator = document.getElementById('recording-indicator');
            const text = document.getElementById('recording-text');
            let recognition = null;
            let isRecording = false;

            // Â∞ùËØïÂàùÂßãÂåñËØ≠Èü≥ËØÜÂà´
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onresult = function(event) {
                    const result = event.results[0][0].transcript;
                    if (result) {
                        const input = document.getElementById('chat-input');
                        input.value += result;
                        sendMessage(); // Ëá™Âä®ÂèëÈÄÅ
                    }
                };
                
                recognition.onerror = function(e) {
                    console.error('ËØ≠Èü≥ËØÜÂà´ÈîôËØØ:', e);
                    showToast('ËØ≠Èü≥ËØÜÂà´Â§±Ë¥•');
                    resetUI();
                };
                
                recognition.onend = function() {
                    if (isRecording) {
                        // Â¶ÇÊûúËøòÂú®Êåâ‰Ωè‰ΩÜËØÜÂà´ÁªìÊùü‰∫ÜÔºåÈáçÁΩÆUI
                        resetUI();
                    }
                };
            }

            function startRecord(e) {
                e.preventDefault();
                if (isRecording) return;
                isRecording = true;
                
                btn.classList.add('recording');
                btn.textContent = 'ÊùæÂºÄ ÂèëÈÄÅ';
                indicator.classList.add('show');
                text.textContent = 'Ê≠£Âú®Âê¨...';
                
                if (recognition) {
                    try {
                        recognition.start();
                    } catch(e) {
                        console.error(e);
                        resetUI();
                    }
                } else {
                    text.textContent = '‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´';
                }
            }

            function stopRecord(e) {
                e.preventDefault();
                if (!isRecording) return;
                
                // Á®çÂæÆÂª∂Ëøü‰∏ÄÁÇπÔºåÈÅøÂÖçËØØËß¶
                setTimeout(() => {
                    if (recognition) {
                        recognition.stop();
                    }
                    resetUI();
                }, 300);
            }
            
            function resetUI() {
                isRecording = false;
                btn.classList.remove('recording');
                btn.textContent = 'Êåâ‰Ωè ËØ¥ËØù';
                indicator.classList.remove('show');
            }

            // Ëß¶Êë∏‰∫ã‰ª∂
            btn.addEventListener('touchstart', startRecord);
            btn.addEventListener('touchend', stopRecord);
            // Èº†Ê†á‰∫ã‰ª∂ÔºàÁî®‰∫éÊ°åÈù¢ÊµãËØïÔºâ
            btn.addEventListener('mousedown', startRecord);
            btn.addEventListener('mouseup', stopRecord);
            btn.addEventListener('mouseleave', (e) => {
                if (isRecording) stopRecord(e);
            });
        }

        // ================= ÂàùÂßãÂåñ =================
        window.onload = function() {
            loadAppData();
            initVoiceButton();
            
            // ÁªëÂÆö‰∏ªÂ±èÂπïÂõæÊ†áÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('character-icon').onclick = openCharacterList;
            document.getElementById('worldbook-icon').onclick = () => { renderWorldbookList(); openModal('worldbook-modal'); };
            document.getElementById('api-settings-icon').onclick = openAPISettings;
            document.getElementById('appearance-icon').onclick = openAppearanceSettings;
            
            // Êõ¥Êñ∞Êó∂Èó¥
            setInterval(() => {
                document.getElementById('current-time').textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            }, 1000);

            // PWA ÂÆâË£ÖÊèêÁ§∫
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('pwa-install-prompt').classList.add('show');
            });

            document.getElementById('pwa-install-btn').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        deferredPrompt = null;
                    }
                    document.getElementById('pwa-install-prompt').classList.remove('show');
                }
            });
        };

        function dismissPWAPrompt() {
            document.getElementById('pwa-install-prompt').classList.remove('show');
        }
        
        // ================= API Áõ∏ÂÖ≥ =================
        async function fetchModels(type) {
            const urlInput = type === 'main' ? 'main-api-url' : 'sub-api-url';
            const keyInput = type === 'main' ? 'main-api-key' : 'sub-api-key';
            const selectId = type === 'main' ? 'main-model-select' : 'sub-model-select';
            
            const urlVal = document.getElementById(urlInput).value;
            if (!urlVal) {
                showToast('ËØ∑ËæìÂÖ•APIÂú∞ÂùÄ');
                return;
            }
            // ÁÆÄÂçïÁöÑÂ§ÑÁêÜÔºåÂéªÊéâÊú´Â∞æÁöÑ /chat/completions Êç¢Êàê /models
            const url = urlVal.replace(/\/chat\/completions\/?$/, '') + '/models';
            const key = document.getElementById(keyInput).value;
            const select = document.getElementById(selectId);
            
            select.innerHTML = '<option>Âä†ËΩΩ‰∏≠...</option>';
            
            try {
                const headers = {};
                if (key) headers['Authorization'] = `Bearer ${key}`;
                
                const response = await fetch(url, { headers });
                if (!response.ok) throw new Error('ËØ∑Ê±ÇÂ§±Ë¥•');
                
                const data = await response.json();
                select.innerHTML = '';
                
                const models = data.data || data; // ÂÖºÂÆπ‰∏çÂêåÊ†ºÂºè
                if (Array.isArray(models)) {
                    models.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.id;
                        option.textContent = m.id;
                        select.appendChild(option);
                    });
                    
                    // ÊÅ¢Â§ç‰πãÂâçÁöÑÈÄâÊã©
                    const savedModel = type === 'main' ? appData.apiSettings.main.model : appData.apiSettings.sub.model;
                    if (savedModel) {
                        // Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®
                        let exists = false;
                        for(let i=0; i<select.options.length; i++) {
                            if(select.options[i].value === savedModel) exists = true;
                        }
                        if(!exists) {
                            const opt = document.createElement('option');
                            opt.value = savedModel;
                            opt.textContent = savedModel;
                            select.appendChild(opt);
                        }
                        select.value = savedModel;
                    }
                    
                    // ÁªëÂÆö change ‰∫ã‰ª∂
                    select.onchange = function() {
                        if (type === 'main') appData.apiSettings.main.model = this.value;
                        else appData.apiSettings.sub.model = this.value;
                    };
                } else {
                    throw new Error('Ê†ºÂºèÊó†Ê≥ïËØÜÂà´');
                }
                showToast('Ê®°ÂûãÊãâÂèñÊàêÂäü');
            } catch (e) {
                console.error(e);
                select.innerHTML = '<option value="">ÊãâÂèñÂ§±Ë¥•</option>';
                showToast('ÊãâÂèñÂ§±Ë¥•: ' + e.message);
            }
        }

        function fetchMinimaxVoiceModels() {
            // Ê®°ÊãüÊãâÂèñÔºåÂõ†‰∏∫ Minimax API ÊØîËæÉÂ§çÊùÇÔºåËøôÈáåÂÖàÊèê‰æõÂá†‰∏™È¢ÑËÆæ
            const select = document.getElementById('voice-model-select');
            select.innerHTML = '';
            const models = [
                { id: 'speech-01', name: 'Speech-01' },
                { id: 'speech-02', name: 'Speech-02' },
                { id: 'abab5.5-chat', name: 'abab5.5-chat' }
            ];
            models.forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = m.name;
                select.appendChild(option);
            });
            showToast('ËØ≠Èü≥Ê®°ÂûãÂàóË°®Â∑≤Êõ¥Êñ∞');
        }

        function savePreset() {
            const name = prompt('ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞Ôºö');
            if (!name) return;
            
            const preset = {
                name: name,
                url: document.getElementById('main-api-url').value,
                key: document.getElementById('main-api-key').value,
                model: document.getElementById('main-model-select').value
            };
            
            appData.presets.push(preset);
            saveAppData();
            renderPresets();
            showToast('È¢ÑËÆæÂ∑≤‰øùÂ≠ò');
        }

        function renderPresets() {
            const list = document.getElementById('preset-list');
            list.innerHTML = '';
            appData.presets.forEach((p, index) => {
                const tag = document.createElement('span');
                tag.className = 'preset-tag';
                tag.textContent = p.name;
                tag.onclick = () => loadPreset(index);
                
                // ÈïøÊåâÂà†Èô§
                let timer;
                tag.addEventListener('touchstart', () => {
                    timer = setTimeout(() => {
                        if(confirm(`Âà†Èô§È¢ÑËÆæ "${p.name}"?`)) {
                            appData.presets.splice(index, 1);
                            saveAppData();
                            renderPresets();
                        }
                    }, 800);
                });
                tag.addEventListener('touchend', () => clearTimeout(timer));
                
                list.appendChild(tag);
            });
        }

        function loadPreset(index) {
            const p = appData.presets[index];
            if (!p) return;
            document.getElementById('main-api-url').value = p.url;
            document.getElementById('main-api-key').value = p.key;
            
            const select = document.getElementById('main-model-select');
            // ÁÆÄÂçïÁöÑÊ∑ªÂä†ÈÄâÈ°π
            const opt = document.createElement('option');
            opt.value = p.model;
            opt.textContent = p.model;
            select.innerHTML = ''; // Ê∏ÖÁ©∫
            select.appendChild(opt);
            select.value = p.model;
            
            appData.apiSettings.main.url = p.url;
            appData.apiSettings.main.key = p.key;
            appData.apiSettings.main.model = p.model;
            
            showToast(`Â∑≤Âä†ËΩΩÈ¢ÑËÆæ: ${p.name}`);
        }

        // ================= Êï∞ÊçÆÁÆ°ÁêÜ =================
        function importCharacter(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const charData = JSON.parse(e.target.result);
                    // ÁÆÄÂçïÁöÑÊ†ºÂºèÊ£ÄÊü•
                    if (!charData.name) throw new Error('Êó†ÊïàÁöÑËßíËâ≤Êñá‰ª∂');
                    
                    charData.id = generateId(); // ÈáçÊñ∞ÁîüÊàêIDÈÅøÂÖçÂÜ≤Á™Å
                    appData.characters.push(charData);
                    saveAppData();
                    renderCharacterList();
                    showToast('ËßíËâ≤ÂØºÂÖ•ÊàêÂäü');
                } catch (err) {
                    showToast('ÂØºÂÖ•Â§±Ë¥•: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportChatHistory() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(char.chatHistory));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `${char.name}_chat_history.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importChatHistory(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const history = JSON.parse(e.target.result);
                    if (!Array.isArray(history)) throw new Error('Êó†ÊïàÁöÑËÅäÂ§©ËÆ∞ÂΩï');
                    
                    const char = appData.characters.find(c => c.id === appData.currentCharacterId);
                    if (char) {
                        if (confirm('Ë¶ÅË¶ÜÁõñÁé∞ÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºüÁÇπÂáª"ÂèñÊ∂à"ÂàôËøΩÂä†Âà∞Êú´Â∞æ„ÄÇ')) {
                            char.chatHistory = history;
                        } else {
                            char.chatHistory = char.chatHistory.concat(history);
                        }
                        saveAppData();
                        renderMessages();
                        showToast('ËÅäÂ§©ËÆ∞ÂΩïÂØºÂÖ•ÊàêÂäü');
                    }
                } catch (err) {
                    showToast('ÂØºÂÖ•Â§±Ë¥•: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function clearChatHistory() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂΩìÂâçËßíËâ≤ÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                const char = appData.characters.find(c => c.id === appData.currentCharacterId);
                if (char) {
                    char.chatHistory = [];
                    saveAppData();
                    renderMessages();
                    showToast('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
                }
            }
        }

        // ================= Êñá‰ª∂‰∏ä‰º† =================
        function uploadAvatar(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const result = e.target.result;
                if (type === 'char') {
                    document.getElementById('char-avatar-preview').src = result;
                } else {
                    document.getElementById('user-avatar-preview').src = result;
                }
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function uploadChatBg(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('chat-bg-url').value = e.target.result;
                // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†È¢ÑËßàÈÄªËæë
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function uploadMainAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('main-avatar-url').value = e.target.result;
                previewMainAvatar();
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function uploadMainBg(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('main-bg-url').value = e.target.result;
                previewMainBg();
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function previewMainAvatar() {
            const url = document.getElementById('main-avatar-url').value;
            if (url) document.getElementById('main-avatar-preview').src = url;
        }

        function previewMainBg() {
            const url = document.getElementById('main-bg-url').value;
            if (url) {
                document.getElementById('bg-preview-box').style.backgroundImage = `url(${url})`;
                document.getElementById('bg-preview-box').innerHTML = '';
            }
        }

        function resetMainBg() {
            document.getElementById('main-bg-url').value = '';
            document.getElementById('bg-preview-box').style.backgroundImage = '';
            document.getElementById('bg-preview-box').innerHTML = '<span>ÁÇπÂáªÊõ¥Êç¢ËÉåÊôØ</span>';
        }

        // ================= ÂÖ∂‰ªñËæÖÂä© =================
        function updateTokensEstimate() {
            const persona = document.getElementById('char-persona').value || '';
            const userPersona = document.getElementById('user-persona').value || '';
            const history = document.getElementById('char-post-history-instructions').value || '';
            // Á≤óÁï•‰º∞ÁÆóÔºöÊ±âÂ≠ó2tokenÔºåËã±Êñá1tokenÔºåËøôÈáåÁÆÄÂåñ‰∏∫ÈïøÂ∫¶/2
            const total = persona.length + userPersona.length + history.length;
            document.getElementById('tokens-estimate').textContent = Math.ceil(total);
        }

        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËæìÂÖ•');
                return;
            }
            
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            showToast('ËØ∑ËØ¥ËØù...');
            
            recognition.onresult = function(event) {
                const text = event.results[0][0].transcript;
                const input = document.getElementById('chat-input');
                input.value += text;
                autoResize(input);
            };
            
            recognition.onerror = function(event) {
                showToast('ËØ≠Èü≥ËØÜÂà´ÈîôËØØ: ' + event.error);
            };
            
            recognition.start();
        }

        async function manualSummary() {
            const startInput = document.getElementById('summary-start');
            const endInput = document.getElementById('summary-end');
            const start = parseInt(startInput.value);
            const end = parseInt(endInput.value);
            
            if (isNaN(start) || isNaN(end) || start > end) {
                showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑËåÉÂõ¥');
                return;
            }

            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char || !char.chatHistory.length) {
                showToast('Ê≤°ÊúâËÅäÂ§©ËÆ∞ÂΩï');
                return;
            }

            // Á¥¢Âºï‰ªé1ÂºÄÂßã
            const history = char.chatHistory.slice(Math.max(0, start - 1), end);
            
            if (history.length === 0) {
                showToast('ËåÉÂõ¥ÂÜÖÊ≤°ÊúâÊ∂àÊÅØ');
                return;
            }

            showToast('Ê≠£Âú®ÊÄªÁªì...');
            
            const summaryPrompt = document.getElementById('summary-prompt').value || '‰ª•ËßíËâ≤Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÂèôËø∞Êàë‰ª¨ËÅäÂ§©‰∏≠ÊèêÂà∞ÁöÑ‰∫ãÊÉÖÔºå100Â≠óÂÜÖ';
            
            const contentToSummarize = history.map(msg => {
                const roleName = msg.role === 'user' ? (char.userSettings?.name || 'Áî®Êà∑') : (char.name || 'ËßíËâ≤');
                return `${roleName}: ${msg.content}`;
            }).join('\n');

            const messages = [
                { role: 'system', content: '‰Ω†ÊòØ‰∏Ä‰∏™Âä©ÊâãÔºåË¥üË¥£ÊÄªÁªìËÅäÂ§©ËÆ∞ÂΩï„ÄÇ' },
                { role: 'user', content: `ËØ∑Ê†πÊçÆ‰ª•‰∏ãËÅäÂ§©ËÆ∞ÂΩïËøõË°åÊÄªÁªì„ÄÇ\nË¶ÅÊ±ÇÔºö${summaryPrompt}\n\nËÅäÂ§©ËÆ∞ÂΩïÔºö\n${contentToSummarize}` }
            ];

            try {
                // ‰ºòÂÖà‰ΩøÁî®ÂâØAPIÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®‰∏ªAPI
                const settings = appData.apiSettings.sub.key ? appData.apiSettings.sub : appData.apiSettings.main;
                const summary = await fetchChatCompletion(messages, settings);
                
                // ÊòæÁ§∫ÁªìÊûú
                const result = prompt('ÊÄªÁªìÂÆåÊàêÔºåËØ∑Â§çÂà∂Ôºö', summary);
                if (result !== null) {
                    if (confirm('ÊòØÂê¶Â∞ÜÊ≠§ÊÄªÁªìËøΩÂä†Âà∞ËßíËâ≤‰∫∫ËÆæÊú´Â∞æÔºü')) {
                        document.getElementById('char-persona').value += '\n\n[ËÆ∞ÂøÜÊÄªÁªì]\n' + summary;
                        updateTokensEstimate();
                        showToast('Â∑≤ËøΩÂä†Âà∞‰∫∫ËÆæ');
                    }
                }
            } catch (e) {
                showToast('ÊÄªÁªìÂ§±Ë¥•: ' + e.message);
                console.error(e);
            }
        }

        // ================= ‰∏ñÁïå‰π¶ÈÄªËæë =================
        function renderWorldbookList() {
            const list = document.getElementById('worldbook-list');
            list.innerHTML = '';
            
            if (appData.worldbooks.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-text">ÊöÇÊó†‰∏ñÁïå‰π¶</div></div>';
                return;
            }

            appData.worldbooks.forEach(wb => {
                const item = document.createElement('div');
                item.className = 'worldbook-item';
                item.innerHTML = `
                    <div class="worldbook-icon">üìñ</div>
                    <div class="worldbook-info">
                        <div class="worldbook-name">${wb.name}</div>
                        <div class="worldbook-entries">${wb.entries.length} ‰∏™Êù°ÁõÆ</div>
                    </div>
                `;
                item.onclick = () => openWorldbookEdit(wb.id);
                list.appendChild(item);
            });
        }

        function createNewWorldbook() {
            const name = prompt('ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÂêçÁß∞Ôºö');
            if (!name) return;
            
            const newWb = {
                id: generateId(),
                name: name,
                entries: []
            };
            
            appData.worldbooks.push(newWb);
            saveAppData();
            renderWorldbookList();
        }

        let currentEditingWorldbookId = null;

        function openWorldbookEdit(id) {
            currentEditingWorldbookId = id;
            const wb = appData.worldbooks.find(w => w.id === id);
            if (!wb) return;
            
            document.getElementById('worldbook-edit-title').textContent = 'ÁºñËæë ' + wb.name;
            document.getElementById('worldbook-name').value = wb.name;
            renderWorldbookEntries();
            
            closeModal('worldbook-modal');
            openModal('worldbook-edit-modal');
        }
        
        function closeWorldbookEdit() {
            closeModal('worldbook-edit-modal');
            openModal('worldbook-modal');
        }

        function renderWorldbookEntries() {
            const wb = appData.worldbooks.find(w => w.id === currentEditingWorldbookId);
            if (!wb) return;
            
            const container = document.getElementById('worldbook-entries');
            container.innerHTML = '';
            
            wb.entries.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = 'entry-item';
                div.innerHTML = `
                    <div class="entry-header">
                        <div class="entry-keywords">${entry.keywords}</div>
                        <div class="entry-actions">
                            <button class="entry-btn edit" onclick="editEntry(${index})">ÁºñËæë</button>
                            <button class="entry-btn delete" onclick="deleteEntry(${index})">Âà†Èô§</button>
                        </div>
                    </div>
                    <div class="entry-content">${entry.content}</div>
                `;
                container.appendChild(div);
            });
        }

        function saveWorldbook() {
            const wb = appData.worldbooks.find(w => w.id === currentEditingWorldbookId);
            if (!wb) return;
            
            wb.name = document.getElementById('worldbook-name').value;
            saveAppData();
            showToast('‰∏ñÁïå‰π¶Â∑≤‰øùÂ≠ò');
            closeWorldbookEdit();
            renderWorldbookList();
        }

        let currentEditingEntryIndex = -1;

        function addWorldbookEntry() {
            currentEditingEntryIndex = -1;
            document.getElementById('entry-keywords').value = '';
            document.getElementById('entry-content').value = '';
            openModal('entry-edit-modal');
        }

        function editEntry(index) {
            const wb = appData.worldbooks.find(w => w.id === currentEditingWorldbookId);
            if (!wb) return;
            
            currentEditingEntryIndex = index;
            const entry = wb.entries[index];
            document.getElementById('entry-keywords').value = entry.keywords;
            document.getElementById('entry-content').value = entry.content;
            openModal('entry-edit-modal');
        }

        function deleteEntry(index) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ê≠§Êù°ÁõÆÔºü')) return;
            const wb = appData.worldbooks.find(w => w.id === currentEditingWorldbookId);
            if (wb) {
                wb.entries.splice(index, 1);
                saveAppData();
                renderWorldbookEntries();
            }
        }

        function saveEntry() {
            const wb = appData.worldbooks.find(w => w.id === currentEditingWorldbookId);
            if (!wb) return;
            
            const keywords = document.getElementById('entry-keywords').value;
            const content = document.getElementById('entry-content').value;
            
            if (!keywords || !content) {
                showToast('ËØ∑Â°´ÂÜôÂÆåÊï¥');
                return;
            }
            
            const entry = { keywords, content };
            
            if (currentEditingEntryIndex === -1) {
                wb.entries.push(entry);
            } else {
                wb.entries[currentEditingEntryIndex] = entry;
            }
            
            saveAppData();
            renderWorldbookEntries();
            closeModal('entry-edit-modal');
        }
        
        function importWorldbook(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const wbData = JSON.parse(e.target.result);
                    if (!wbData.name || !Array.isArray(wbData.entries)) throw new Error('Ê†ºÂºèÈîôËØØ');
                    
                    wbData.id = generateId();
                    appData.worldbooks.push(wbData);
                    saveAppData();
                    renderWorldbookList();
                    showToast('‰∏ñÁïå‰π¶ÂØºÂÖ•ÊàêÂäü');
                } catch (err) {
                    showToast('ÂØºÂÖ•Â§±Ë¥•: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ================= Ë°®ÊÉÖÂåÖÈÄªËæë =================
        let tempEmojiPack = { name: '', emojis: [] };

        function handleEmojiFilesSelect(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            document.getElementById('emoji-files-count').textContent = `Â∑≤ÈÄâÊã© ${files.length} Âº†ÂõæÁâá`;
            
            // ÂºÇÊ≠•ËØªÂèñÊâÄÊúâÂõæÁâá
            tempEmojiPack.emojis = [];
            let loaded = 0;
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempEmojiPack.emojis.push(e.target.result);
                    loaded++;
                    if (loaded === files.length) {
                        showToast('ÂõæÁâáËØªÂèñÂÆåÊàê');
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function handleEmojiDocSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const processText = (text) => {
                // ÊèêÂèñÊâÄÊúâ http/https ÈìæÊé•
                const urls = text.match(/https?:\/\/[^\s"']+/g);
                if (urls && urls.length > 0) {
                    // ËøáÊª§ÂõæÁâáÈìæÊé• (ÁÆÄÂçïÂà§Êñ≠)
                    const imgUrls = urls.filter(url => /\.(jpg|jpeg|png|gif|webp)$/i.test(url) || url.includes('images'));
                    
                    if (imgUrls.length > 0) {
                        tempEmojiPack.emojis = tempEmojiPack.emojis.concat(imgUrls);
                        document.getElementById('emoji-files-count').textContent = `Â∑≤ÊèêÂèñ ${tempEmojiPack.emojis.length} Âº†ÂõæÁâá`;
                        showToast(`Â∑≤ÊèêÂèñ ${imgUrls.length} ‰∏™ÈìæÊé•`);
                    } else {
                        showToast('Êú™ÊâæÂà∞ÂõæÁâáÈìæÊé•');
                    }
                } else {
                    showToast('Êú™ÊâæÂà∞ÈìæÊé•');
                }
            };

            if (file.name.endsWith('.txt')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processText(e.target.result);
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.docx')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    mammoth.extractRawText({arrayBuffer: e.target.result})
                        .then(function(result){
                            processText(result.value);
                        })
                        .catch(function(err){
                            console.error(err);
                            showToast('ÊñáÊ°£ËØªÂèñÂ§±Ë¥•');
                        });
                };
                reader.readAsArrayBuffer(file);
            } else {
                showToast('‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè');
            }
            event.target.value = '';
        }

        function saveEmojiPack() {
            const name = document.getElementById('emoji-pack-name').value;
            if (!name) {
                showToast('ËØ∑ËæìÂÖ•Ë°®ÊÉÖÂåÖÂêçÁß∞');
                return;
            }
            if (tempEmojiPack.emojis.length === 0) {
                showToast('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÂº†ÂõæÁâá');
                return;
            }
            
            const newPack = {
                id: generateId(),
                name: name,
                emojis: tempEmojiPack.emojis,
                bindCharId: null
            };
            
            appData.emojiLibrary.push(newPack);
            saveAppData();
            showToast('Ë°®ÊÉÖÂåÖÂØºÂÖ•ÊàêÂäü');
            closeModal('emoji-import-modal');
            
            // ÈáçÁΩÆ
            tempEmojiPack = { name: '', emojis: [] };
            document.getElementById('emoji-pack-name').value = '';
            document.getElementById('emoji-files-count').textContent = 'Êú™ÈÄâÊã©';
        }

        function importEmojiConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const pack = JSON.parse(e.target.result);
                    if (!pack.emojis) throw new Error('Ê†ºÂºèÈîôËØØ');
                    
                    pack.id = generateId();
                    appData.emojiLibrary.push(pack);
                    saveAppData();
                    showToast('Ë°®ÊÉÖÂåÖÈÖçÁΩÆÂØºÂÖ•ÊàêÂäü');
                } catch (err) {
                    showToast('ÂØºÂÖ•Â§±Ë¥•');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        let currentEditingPackId = null;

        function openBindCharacterModal(packId) {
            currentEditingPackId = packId;
            const pack = appData.emojiLibrary.find(p => p.id === packId);
            if (!pack) return;

            const list = document.getElementById('bind-char-list');
            list.innerHTML = '';

            // Ê∑ªÂä†"‰∏çÁªëÂÆöÔºàÊâÄÊúâËßíËâ≤ÂèØËßÅÔºâ"ÈÄâÈ°π
            const noBindItem = document.createElement('label');
            noBindItem.className = 'checkbox-item';
            noBindItem.innerHTML = `
                <input type="radio" name="bind-char" value="" ${!pack.bindCharId ? 'checked' : ''}>
                <span class="checkbox-label">‰∏çÁªëÂÆöÔºàÊâÄÊúâËßíËâ≤ÂèØËßÅÔºâ</span>
            `;
            list.appendChild(noBindItem);

            appData.characters.forEach(char => {
                const item = document.createElement('label');
                item.className = 'checkbox-item';
                item.innerHTML = `
                    <input type="radio" name="bind-char" value="${char.id}" ${pack.bindCharId === char.id ? 'checked' : ''}>
                    <span class="checkbox-label">${char.nickname || char.name}</span>
                `;
                list.appendChild(item);
            });

            // Ê∑ªÂä†Âà†Èô§ÊåâÈíÆ
            const footer = document.querySelector('#bind-character-modal .modal-footer');
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâÂà†Èô§ÊåâÈíÆÔºåÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†
            let delBtn = document.getElementById('delete-pack-btn');
            if (!delBtn) {
                delBtn = document.createElement('button');
                delBtn.id = 'delete-pack-btn';
                delBtn.className = 'btn btn-danger';
                delBtn.style.width = '100%';
                delBtn.style.marginTop = '10px';
                delBtn.textContent = 'Âà†Èô§Ê≠§Ë°®ÊÉÖÂåÖ';
                delBtn.onclick = deleteEmojiPack;
                footer.appendChild(delBtn);
            }

            openModal('bind-character-modal');
        }

        function saveBindCharacter() {
            if (!currentEditingPackId) return;
            
            const pack = appData.emojiLibrary.find(p => p.id === currentEditingPackId);
            if (!pack) return;

            const radios = document.querySelectorAll('input[name="bind-char"]');
            let selectedId = null;
            radios.forEach(r => {
                if (r.checked) selectedId = r.value;
            });

            pack.bindCharId = selectedId || null;
            saveAppData();
            
            closeModal('bind-character-modal');
            showToast('ÁªëÂÆöÂ∑≤‰øùÂ≠ò');
            renderEmojiContent(); // Âà∑Êñ∞ÊòæÁ§∫
        }

        function deleteEmojiPack() {
            if (!currentEditingPackId) return;
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ë°®ÊÉÖÂåÖÂêóÔºü')) {
                appData.emojiLibrary = appData.emojiLibrary.filter(p => p.id !== currentEditingPackId);
                saveAppData();
                closeModal('bind-character-modal');
                showToast('Ë°®ÊÉÖÂåÖÂ∑≤Âà†Èô§');
                renderEmojiContent();
            }
        }
        
    </script>
</body>
</html>
=======
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="‰ªøAppÂ∞èÊâãÊú∫">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#e8f8f5">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="manifest" href="manifest.json">
    <title>‰ªøÂæÆ‰ø°ÊâãÊú∫ÁïåÈù¢ - ËßíËâ≤ËÅäÂ§©Á≥ªÁªü</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        :root {
            --custom-font: 'PingFang SC', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        body {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            min-height: 100dvh;
            background: linear-gradient(160deg, #e8f8f5 0%, #d5f5e3 25%, #abebc6 50%, #d5f5e3 75%, #e8f8f5 100%);
            font-family: var(--custom-font);
            display: flex;
            justify-content: center;
        }

        .phone {
            width: 100%;
            max-width: 450px;
            height: 100vh;
            height: -webkit-fill-available;
            height: 100dvh;
            position: relative;
            display: flex;
            flex-direction: column;
            background: transparent;
            box-shadow: 0 0 50px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .phone-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 0;
        }

        .decoration {
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
            pointer-events: none;
            z-index: 1;
        }

        .deco1 { width: 120px; height: 120px; background: radial-gradient(circle, #fff 0%, transparent 70%); top: 60px; right: 10%; }
        .deco2 { width: 80px; height: 80px; background: radial-gradient(circle, #fff 0%, transparent 70%); top: 300px; left: 5%; }
        .deco3 { width: 60px; height: 60px; background: radial-gradient(circle, #fff 0%, transparent 70%); bottom: 150px; right: 10%; }

        .stars {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
        }

        .star {
            position: absolute;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            animation: twinkle 2s ease-in-out infinite;
        }

        .star:nth-child(1) { top: 15%; left: 10%; animation-delay: 0s; }
        .star:nth-child(2) { top: 25%; right: 15%; animation-delay: 0.5s; }
        .star:nth-child(3) { top: 55%; left: 8%; animation-delay: 1s; }
        .star:nth-child(4) { top: 70%; right: 12%; animation-delay: 1.5s; }

        @keyframes twinkle {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            z-index: 2;
            scrollbar-width: none;
        }

        .content-wrapper::-webkit-scrollbar { display: none; }

        .status-bar {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            padding-top: calc(15px + env(safe-area-inset-top, 0px));
            color: #5d8a66;
            font-size: 14px;
            font-weight: 500;
        }

        .time { font-size: 16px; letter-spacing: 1px; }
        .battery { display: flex; align-items: center; gap: 4px; }
        .battery-icon {
            width: 24px; height: 11px;
            border: 1.5px solid #5d8a66;
            border-radius: 3px;
            position: relative;
            display: flex; align-items: center; padding: 1px;
        }
        .battery-icon::after {
            content: ''; position: absolute; right: -4px;
            width: 2px; height: 5px; background: #5d8a66; border-radius: 0 2px 2px 0;
        }
        .battery-level {
            width: 85%; height: 100%;
            background: linear-gradient(90deg, #81c784, #4caf50);
            border-radius: 1px;
        }
        .battery-percent { font-size: 13px; }

        .avatar-section {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .avatar-frame {
            width: 85px; height: 85px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.9);
            overflow: hidden;
            background: linear-gradient(135deg, #fff 0%, #f0fff0 100%);
            box-shadow: 0 4px 20px rgba(129, 199, 132, 0.3), 0 0 0 5px rgba(255,255,255,0.3);
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .avatar-frame:hover {
            transform: scale(1.05);
        }
        
        .avatar-frame::before {
            content: '‚úø'; position: absolute; top: -8px; right: -5px;
            font-size: 16px; color: #f8bbd9; z-index: 10;
        }

        .avatar-frame img { width: 100%; height: 100%; object-fit: cover; }

        .input-section {
            flex-shrink: 0;
            padding: 0 45px;
            margin-bottom: 10px;
        }

        .text-input {
            width: 100%; padding: 12px 16px;
            border: none; border-radius: 20px;
            background: rgba(255,255,255,0.85);
            font-size: 14px; outline: none;
            box-shadow: 0 2px 12px rgba(129, 199, 132, 0.2), inset 0 1px 3px rgba(255,255,255,0.8);
            text-align: center; color: #5d8a66;
        }
        .text-input::placeholder { color: #a5d6a7; font-size: 13px; }

        .apps-container {
            flex-shrink: 0;
            position: relative;
            width: 360px;
            height: 380px;
            margin: 10px auto 0;
        }

        .app-icon {
            position: absolute;
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .app-icon:hover { transform: scale(1.15) translateY(-3px); }
        .app-icon:active { transform: scale(0.95); }

        .icon-img {
            width: 58px; height: 58px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.75);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(129, 199, 132, 0.2), 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden; transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .app-icon:hover .icon-img {
            box-shadow: 0 8px 24px rgba(129, 199, 132, 0.35), 0 2px 8px rgba(0,0,0,0.08);
        }

        /* ÁÆÄÁ¨îÁîªSVGÂõæÊ†áÊ†∑Âºè */
        .icon-img svg {
            width: 36px;
            height: 36px;
        }

        .icon-img img {
            width: 36px;
            height: 36px;
            object-fit: contain;
        }

        .app-name {
            margin-top: 6px; font-size: 11px; color: #5d8a66;
            text-align: center; max-width: 65px; font-weight: 500; letter-spacing: 0.3px;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }

        .app-icon:nth-child(1) { left: 105px; top: 20px; }
        .app-icon:nth-child(2) { right: 105px; top: 20px; }
        .app-icon:nth-child(3) { left: 55px; top: 80px; }
        .app-icon:nth-child(4) { right: 55px; top: 80px; }
        .app-icon:nth-child(5) { left: 90px; top: 155px; }
        .app-icon:nth-child(6) { right: 90px; top: 155px; }
        .app-icon:nth-child(7) { left: 50%; transform: translateX(-50%); top: 230px; }
        .app-icon:nth-child(7):hover { transform: translateX(-50%) scale(1.15) translateY(-3px); }

        .bottom-area {
            margin-top: auto;
            flex-shrink: 0;
            width: 100%;
            padding-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .bottom-apps {
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            width: 100%;
            padding: 10px 20px;
        }

        .bottom-app {
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bottom-app:hover { transform: scale(1.15) translateY(-3px); }
        .bottom-app:active { transform: scale(0.95); }
        
        .bottom-app .icon-img {
            width: 58px; height: 58px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.75);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(129, 199, 132, 0.2), 0 1px 3px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .bottom-app:hover .icon-img {
            box-shadow: 0 8px 24px rgba(129, 199, 132, 0.35), 0 2px 8px rgba(0,0,0,0.08);
        }

        .bottom-app .app-name {
            margin-top: 6px; font-size: 11px; color: #5d8a66;
            text-align: center; font-weight: 500; letter-spacing: 0.3px;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }

        .bottom-decoration {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: rgba(129, 199, 132, 0.4);
        }
        .dot.active {
            width: 18px; border-radius: 9px;
            background: linear-gradient(90deg, #81c784, #66bb6a);
        }

        .bottom-bar {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 5px;
            background: rgba(93, 138, 102, 0.3);
            border-radius: 3px;
            z-index: 10;
        }

        /* ================= ÈÄöÁî®Ê®°ÊÄÅÊ°ÜÊ†∑Âºè ================= */
        .modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: flex-end;
            backdrop-filter: blur(3px);
        }

        .modal.full-screen {
            align-items: stretch;
        }

        .modal-content {
            background: #fff;
            width: 100%;
            height: 85%;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }

        .modal-content.full-height {
            height: 100%;
            border-radius: 0;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .modal-header h2 {
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn {
            font-size: 20px;
            color: #5d8a66;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .back-btn:hover {
            transform: translateX(-3px);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-btn {
            font-size: 22px;
            color: #5d8a66;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .header-btn:hover {
            transform: scale(1.1);
        }

        .close-btn {
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 5px;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .setting-section {
            margin-bottom: 25px;
            background: #f9fcf9;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e8f5e9;
        }

        .setting-section h3 {
            font-size: 14px;
            color: #5d8a66;
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 8px;
            background: #fff;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: #81c784;
            outline: none;
        }

        .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 8px;
            background: #fff;
            transition: border-color 0.3s;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .form-textarea:focus {
            border-color: #81c784;
            outline: none;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary {
            background: #81c784;
            color: white;
        }
        .btn-primary:hover { background: #66bb6a; }

        .btn-secondary {
            background: #e0e0e0;
            color: #555;
        }
        .btn-secondary:hover { background: #d5d5d5; }

        .btn-danger {
            background: #ef5350;
            color: white;
        }
        .btn-danger:hover { background: #e53935; }

        .form-select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
        }

        .switch-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .switch-row span {
            font-size: 13px;
            color: #555;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #81c784;
        }

        input:checked + .slider:before {
            transform: translateX(18px);
        }

        .modal-footer {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            text-align: center;
            flex-shrink: 0;
        }

        .save-all-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #81c784, #4caf50);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }
        .save-all-btn:active {
            transform: scale(0.98);
        }

        .hidden-area {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }

        .preset-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .preset-tag {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            border: 1px solid #c8e6c9;
        }
        .preset-tag:hover {
            background: #c8e6c9;
        }

        /* ================= ËßíËâ≤ÂàóË°®Ê†∑Âºè ================= */
        .character-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .character-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9fcf9;
            border-radius: 12px;
            border: 1px solid #e8f5e9;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .character-item:hover {
            background: #e8f5e9;
            transform: translateX(5px);
        }

        .character-item.long-press {
            background: #ffebee;
            border-color: #ffcdd2;
            transform: scale(0.98);
        }

        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 12px;
            border: 2px solid #81c784;
            flex-shrink: 0;
        }

        .character-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-info {
            flex: 1;
            min-width: 0;
        }

        .character-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .character-desc {
            font-size: 12px;
            color: #888;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .character-delete {
            padding: 8px;
            color: #ef5350;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .character-delete:hover {
            opacity: 1;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #aaa;
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
            text-align: center;
            line-height: 1.6;
        }

        /* ================= ‰∏ñÁïå‰π¶ÂàóË°®Ê†∑Âºè ================= */
        .worldbook-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9fcf9;
            border-radius: 12px;
            border: 1px solid #e8f5e9;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .worldbook-item:hover {
            background: #e8f5e9;
        }

        .worldbook-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #81c784, #4caf50);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
            font-size: 20px;
        }

        .worldbook-info {
            flex: 1;
        }

        .worldbook-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .worldbook-entries {
            font-size: 11px;
            color: #888;
        }

        /* ================= ËÅäÂ§©ÁïåÈù¢Ê†∑Âºè ================= */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #f5f5f5;
            position: relative;
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px;
            padding-top: calc(15px + env(safe-area-inset-top, 0px));
            background: #fff;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            z-index: 10;
        }

        .chat-header .back-btn {
            margin-right: 10px;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 10px;
        }

        .chat-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .chat-header-status {
            font-size: 12px;
            color: #888;
        }

        .chat-header-settings {
            padding: 10px;
            font-size: 20px;
            color: #5d8a66;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chat-header-settings:hover {
            transform: rotate(45deg);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            display: flex;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.ai {
            align-self: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            margin: 0 8px;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #81c784, #66bb6a);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.ai .message-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message-time {
            font-size: 10px;
            color: #aaa;
            margin-top: 4px;
            padding: 0 5px;
        }

        .message.user .message-time {
            text-align: right;
        }

        /* ËØ≠Èü≥Ê∂àÊÅØÊ†∑Âºè */
        .voice-bubble {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 18px;
            background: white;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
            min-width: 100px;
            transition: background 0.2s;
        }

        .voice-bubble:hover {
            background: #f5f5f5;
        }

        .voice-bubble.playing {
            background: #e8f5e9;
        }

        .voice-icon {
            font-size: 18px;
            animation: none;
        }

        .voice-bubble.playing .voice-icon {
            animation: voiceWave 1s infinite;
        }

        @keyframes voiceWave {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .voice-duration {
            font-size: 12px;
            color: #888;
        }

        .voice-wave {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 20px;
        }

        .voice-wave span {
            width: 3px;
            background: #81c784;
            border-radius: 2px;
            animation: wave 0.5s ease-in-out infinite;
        }

        .voice-wave span:nth-child(1) { height: 8px; animation-delay: 0s; }
        .voice-wave span:nth-child(2) { height: 14px; animation-delay: 0.1s; }
        .voice-wave span:nth-child(3) { height: 10px; animation-delay: 0.2s; }
        .voice-wave span:nth-child(4) { height: 16px; animation-delay: 0.3s; }
        .voice-wave span:nth-child(5) { height: 12px; animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.5); }
        }

        .chat-input-area {
            display: flex;
            align-items: flex-end;
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
            background: #fff;
            border-top: 1px solid #eee;
            gap: 10px;
            flex-shrink: 0;
            z-index: 10;
            transition: transform 0.3s ease;
        }

        .chat-input {
            flex: 1;
            min-height: 36px;
            max-height: 100px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 18px;
            font-size: 14px;
            resize: none;
            outline: none;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #81c784;
        }

        .chat-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .chat-btn.star-btn {
            background: linear-gradient(135deg, #ffd54f, #ffb300);
            color: white;
            font-size: 18px;
        }

        .chat-btn.star-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 179, 0, 0.4);
        }

        .chat-btn.star-btn.loading {
            animation: pulse 1s infinite;
            pointer-events: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.95); }
        }

        .chat-btn.send-btn {
            background: linear-gradient(135deg, #81c784, #4caf50);
            color: white;
            font-size: 16px;
        }

        .chat-btn.send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        /* ================= ËßíËâ≤ÁºñËæëÊ†∑Âºè ================= */
        .avatar-upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #81c784;
            margin-bottom: 10px;
            cursor: pointer;
            position: relative;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-preview:hover::after {
            content: 'üì∑';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .inline-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .inline-input .form-input {
            flex: 1;
            margin-bottom: 0;
        }

        .inline-input span {
            font-size: 13px;
            color: #555;
            white-space: nowrap;
        }

        .tokens-display {
            background: #e8f5e9;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }

        .tokens-display .label {
            font-size: 12px;
            color: #666;
        }

        .tokens-display .value {
            font-size: 20px;
            font-weight: bold;
            color: #4caf50;
        }

        /* ================= ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• ================= */
        .hidden-input {
            display: none;
        }

        /* ================= ÊªöÂä®Êù°ÁæéÂåñ ================= */
        .modal-body::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .modal-body::-webkit-scrollbar-track,
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-body::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 2px;
        }

        /* ================= ‰∏ñÁïå‰π¶Êù°ÁõÆÁºñËæë ================= */
        .entry-item {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .entry-keywords {
            font-size: 12px;
            color: #81c784;
            font-weight: 600;
        }

        .entry-content {
            font-size: 13px;
            color: #555;
            line-height: 1.5;
        }

        .entry-actions {
            display: flex;
            gap: 8px;
        }

        .entry-btn {
            padding: 4px 8px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .entry-btn.edit {
            background: #e3f2fd;
            color: #1976d2;
        }

        .entry-btn.delete {
            background: #ffebee;
            color: #d32f2f;
        }

        /* Âä†ËΩΩÊèêÁ§∫ */
        .loading-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 9999;
            display: none;
        }

        .loading-toast.show {
            display: block;
        }

        /* ÊâìÂ≠óÊåáÁ§∫Âô® */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #ccc;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* PWAÂÆâË£ÖÊèêÁ§∫ */
        .pwa-install-prompt {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 9999;
            max-width: 90%;
            text-align: center;
        }

        .pwa-install-prompt.show {
            display: block;
            animation: slideUpPrompt 0.3s ease-out;
        }

        @keyframes slideUpPrompt {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .pwa-install-prompt p {
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }

        .pwa-install-prompt .btn-row {
            justify-content: center;
        }

        /* Ê∏©Â∫¶ÊªëÂùóÊ†∑Âºè */
        .temperature-slider {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .temperature-slider input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #81c784, #ffb300, #ef5350);
            border-radius: 3px;
            outline: none;
        }

        .temperature-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid #81c784;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .temperature-value {
            min-width: 40px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #5d8a66;
        }

        /* Âà†Èô§Á°ÆËÆ§ÂºπÁ™ó */
        .delete-confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        .delete-confirm-overlay.show {
            display: flex;
        }

        .delete-confirm-box {
            background: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            max-width: 280px;
            animation: popIn 0.2s ease-out;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .delete-confirm-box h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
        }

        .delete-confirm-box p {
            font-size: 13px;
            color: #666;
            margin-bottom: 20px;
        }

        .delete-confirm-box .btn-row {
            justify-content: center;
        }

        /* ================= Â§ñËßÇËÆæÁΩÆÂõæÊ†áÁºñËæëÊ†∑Âºè ================= */
        .icon-edit-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .icon-edit-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .icon-edit-item:hover {
            transform: scale(1.05);
        }

        .icon-edit-preview {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
            border: 2px dashed #ccc;
            overflow: hidden;
            position: relative;
        }

        .icon-edit-preview:hover {
            border-color: #81c784;
        }

        .icon-edit-preview svg,
        .icon-edit-preview img {
            width: 30px;
            height: 30px;
        }

        .icon-edit-preview::after {
            content: '‚úèÔ∏è';
            position: absolute;
            bottom: -2px;
            right: -2px;
            font-size: 10px;
            background: white;
            border-radius: 50%;
            padding: 2px;
        }

        .icon-edit-name {
            font-size: 10px;
            color: #666;
            text-align: center;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bg-preview-box {
            width: 100%;
            height: 120px;
            border-radius: 12px;
            background: linear-gradient(160deg, #e8f8f5 0%, #d5f5e3 25%, #abebc6 50%, #d5f5e3 75%, #e8f8f5 100%);
            background-size: cover;
            background-position: center;
            border: 2px dashed #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .bg-preview-box:hover {
            border-color: #81c784;
        }

        .bg-preview-box span {
            background: rgba(255,255,255,0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: #5d8a66;
        }

        .main-avatar-edit {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #81c784;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            margin: 0 auto 10px;
        }

        .main-avatar-edit img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .main-avatar-edit:hover::after {
            content: 'üì∑';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* ÂõæÊ†áÁºñËæëÂºπÁ™ó */
        .icon-edit-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 300;
            width: 90%;
            max-width: 300px;
            display: none;
        }

        .icon-edit-popup.show {
            display: block;
            animation: popIn 0.2s ease-out;
        }

        .icon-edit-popup h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .icon-edit-popup .current-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            border-radius: 14px;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .icon-edit-popup .current-icon svg,
        .icon-edit-popup .current-icon img {
            width: 40px;
            height: 40px;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 250;
            display: none;
        }

        .popup-overlay.show {
            display: block;
        }

        /* ================= Ë°®ÊÉÖÈù¢ÊùøÊ†∑Âºè ================= */
        .emoji-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: #fff;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 110;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ‰øÆÂ§çÔºöËßíËâ≤ÁºñËæëÊ®°ÊÄÅÊ°ÜÂ±ÇÁ∫ßÈ´ò‰∫éËÅäÂ§©Á™óÂè£ */
        #character-edit-modal {
            z-index: 120;
        }

        /* Èù¢ÊùøÈÅÆÁΩ©Â±Ç */
        .panel-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 105;
            display: none;
        }
        .panel-overlay.show {
            display: block;
        }

        /* ================= ÂäüËÉΩÈù¢ÊùøÊ†∑Âºè ================= */
        .function-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 280px;
            background: #f5f5f5;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 110;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
            padding: 30px 20px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .function-panel.show {
            transform: translateY(0);
        }

        .function-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .function-icon {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: #555;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .function-item:active .function-icon {
            transform: scale(0.95);
            background: #e8f5e9;
        }

        .function-name {
            font-size: 12px;
            color: #666;
        }

        /* Á∫¢ÂåÖÊ†∑Âºè */
        .red-packet-bubble {
            background: #fa9d3b !important;
            color: white !important;
            padding: 0 !important;
            width: 220px;
            overflow: hidden;
            cursor: pointer;
            border-radius: 8px !important;
        }

        .rp-content {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rp-icon {
            width: 36px;
            height: 36px;
            background: #fcd69f;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fa9d3b;
            font-size: 20px;
            font-weight: bold;
        }

        .rp-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .rp-desc { font-size: 15px; font-weight: 500; }
        .rp-status { font-size: 11px; opacity: 0.8; }

        .rp-footer {
            background: white;
            padding: 5px 15px;
            font-size: 10px;
            color: #999;
        }

        /* Êñá‰ª∂Ê∂àÊÅØÊ†∑Âºè */
        .file-bubble {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white !important;
            padding: 10px !important;
            border-radius: 8px !important;
            min-width: 200px;
            border: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            color: #333 !important;
        }
        .file-bubble:hover {
            background: #f9f9f9 !important;
        }
        .file-icon { font-size: 32px; }
        .file-info { flex: 1; overflow: hidden; display: flex; flex-direction: column; align-items: flex-start; }
        .file-name { font-size: 14px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; width: 100%; text-align: left; }
        .file-size { font-size: 12px; color: #999; }

        .emoji-panel.show {
            transform: translateY(0);
        }

        .emoji-header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .emoji-tabs {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .emoji-tab {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            white-space: nowrap;
        }

        .emoji-tab.active {
            background: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
        }

        .emoji-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            align-content: start;
        }

        .emoji-item {
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .emoji-item:hover {
            background: #f5f5f5;
        }

        .emoji-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* ================= Ê∂àÊÅØÈïøÊåâËèúÂçï ================= */
        .message-menu {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 5px;
            display: flex;
            gap: 10px;
            z-index: 100;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s;
        }

        .message-menu-item {
            color: white;
            font-size: 12px;
            padding: 5px 10px;
            cursor: pointer;
            white-space: nowrap;
        }

        .message-menu-item:active {
            opacity: 0.7;
        }

        /* ================= Â§öÈÄâÊ°ÜÊ†∑Âºè ================= */
        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            background: #fff;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-item:hover {
            background: #f5f5f5;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #81c784;
        }

        .checkbox-label {
            font-size: 13px;
            color: #333;
            flex: 1;
        }

        /* ÂõæÁâáÊ∂àÊÅØÊ†∑Âºè */
        .chat-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
            display: block;
        }
        
        /* ËßÜÈ¢ëÈÄöËØùÊ®°ÊÄÅÊ°Ü */
        .video-call-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, #2c3e50 0%, #000000 100%);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 60px 20px;
            color: white;
        }
        .video-call-modal.show { display: flex; }
        .vc-avatar { width: 120px; height: 120px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); margin-bottom: 20px; object-fit: cover; }
        .vc-name { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .vc-status { font-size: 16px; opacity: 0.8; }
        .vc-actions { display: flex; gap: 40px; margin-bottom: 40px; }
        .vc-btn { width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; }
        .vc-btn.hangup { background: #ff3b30; color: white; }
        .vc-btn.answer { background: #4cd964; color: white; }
        .vc-btn:active { transform: scale(0.95); }
        
        /* ÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü */
        .image-preview-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2100;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .image-preview-modal.show { display: flex; }
        .image-preview-modal img { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body>
    <div class="phone">
        <!-- Ëá™ÂÆö‰πâËÉåÊôØ -->
        <div class="phone-bg" id="phone-bg"></div>

        <!-- Ë£ÖÈ•∞ÂÖÉÁ¥† -->
        <div class="decoration deco1"></div>
        <div class="decoration deco2"></div>
        <div class="decoration deco3"></div>
        
        <div class="stars">
            <span class="star">‚ú¶</span>
            <span class="star">‚úß</span>
            <span class="star">‚ú¶</span>
            <span class="star">‚úß</span>
        </div>

        <!-- ‰∏ªÁïåÈù¢ÂÜÖÂÆπ -->
        <div class="content-wrapper" id="main-screen">
            <div class="status-bar">
                <div class="time" id="current-time">09:41</div>
                <div class="battery">
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                    <span class="battery-percent">85%</span>
                </div>
            </div>

            <div class="avatar-section">
                <div class="avatar-frame" onclick="openAppearanceSettings()">
                    <img id="main-avatar" src="https://api.dicebear.com/7.x/lorelei/png?seed=cute&backgroundColor=d1fae5" alt="Â§¥ÂÉè">
                </div>
            </div>

            <div class="input-section">
                <input type="text" class="text-input" placeholder="‚úé ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑËØù...">
            </div>

            <div class="apps-container">
                <!-- ËßíËâ≤ - ÂèØÁà±Â∞èËÑëË¢ã -->
                <div class="app-icon" id="character-icon">
                    <div class="icon-img" id="icon-character">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="45" r="28" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <circle cx="40" cy="40" r="4" fill="#5d8a66"/>
                            <circle cx="60" cy="40" r="4" fill="#5d8a66"/>
                            <path d="M40 55 Q50 65 60 55" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/>
                            <path d="M30 25 Q35 15 45 20" stroke="#5d8a66" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                            <path d="M70 25 Q65 15 55 20" stroke="#5d8a66" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                            <circle cx="38" cy="38" r="1.5" fill="white"/>
                            <circle cx="58" cy="38" r="1.5" fill="white"/>
                            <ellipse cx="32" cy="50" rx="4" ry="3" fill="#ffcdd2" opacity="0.6"/>
                            <ellipse cx="68" cy="50" rx="4" ry="3" fill="#ffcdd2" opacity="0.6"/>
                        </svg>
                    </div>
                    <span class="app-name">ËßíËâ≤</span>
                </div>

                <!-- ‰∏ñÁïå‰π¶ - ÊâìÂºÄÁöÑ‰π¶Êú¨ -->
                <div class="app-icon" id="worldbook-icon">
                    <div class="icon-img" id="icon-worldbook">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M50 25 L50 80" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M50 25 Q30 20 15 30 L15 75 Q30 68 50 75" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/>
                            <path d="M50 25 Q70 20 85 30 L85 75 Q70 68 50 75" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/>
                            <path d="M22 40 L42 38" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M22 50 L42 48" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M22 60 L38 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M58 38 L78 40" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M58 48 L78 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M62 58 L78 60" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="50" cy="20" r="5" fill="#ffeb3b" stroke="#5d8a66" stroke-width="1.5"/>
                        </svg>
                    </div>
                    <span class="app-name">‰∏ñÁïå‰π¶</span>
                </div>

                <!-- Ê∑òÂÆù - Ë¥≠Áâ©ËΩ¶ -->
                <div class="app-icon">
                    <div class="icon-img" id="icon-taobao">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 30 L30 30 L40 65 L75 65 L82 40 L35 40" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="45" cy="78" r="6" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <circle cx="68" cy="78" r="6" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <path d="M45 50 L45 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M55 48 L55 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M65 50 L65 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M25 25 Q20 20 25 15" stroke="#ffb74d" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span class="app-name">Ê∑òÂÆù</span>
                </div>

                <!-- APIËÆæÁΩÆ - Ê≠™Ê≠™Êâ≠Êâ≠ÁöÑAPIÂ≠ó -->
                <div class="app-icon" id="api-settings-icon">
                    <div class="icon-img" id="icon-api">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <text x="12" y="58" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(-8 20 50)">A</text>
                            <text x="35" y="62" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(5 45 55)">P</text>
                            <text x="58" y="55" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(-3 65 50)">I</text>
                            <path d="M75 35 Q80 30 85 35 Q90 40 85 45 Q80 50 75 45 Q70 40 75 35" stroke="#ffb74d" stroke-width="2" fill="#fff59d"/><circle cx="20" cy="30" r="4" fill="#81c784"/><circle cx="80" cy="65" r="3" fill="#81c784"/><path d="M25 70 L35 75" stroke="#5d8a66" stroke-width="1.5" stroke-linecap="round"/><path d="M30 73 L32 68" stroke="#5d8a66" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span class="app-name">APIËÆæÁΩÆ</span>
                </div>

                <!-- Â§ñËßÇËÆæÁΩÆ - Ë∞ÉËâ≤Êùø -->
                <div class="app-icon" id="appearance-icon">
                    <div class="icon-img" id="icon-appearance">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="50" cy="50" rx="35" ry="32" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <circle cx="35" cy="38" r="7" fill="#ff8a80"/>
                            <circle cx="55" cy="32" r="6" fill="#ffcc80"/>
                            <circle cx="70" cy="45" r="6" fill="#a5d6a7"/>
                            <circle cx="65" cy="62" r="5" fill="#90caf9"/>
                            <circle cx="40" cy="60" r="8" fill="white" stroke="#5d8a66" stroke-width="2"/>
                            <path d="M75 75 L90 90" stroke="#5d8a66" stroke-width="4" stroke-linecap="round"/>
                            <path d="M88 82 L92 88 L86 92" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="app-name">Â§ñËßÇËÆæÁΩÆ</span>
                </div>

                <!-- ÁúãÁúã‰Ω† - ÁúºÁùõ -->
                <div class="app-icon">
                    <div class="icon-img" id="icon-look">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="50" cy="50" rx="35" ry="22" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <circle cx="50" cy="50" r="15" stroke="#5d8a66" stroke-width="2.5" fill="none"/>
                            <circle cx="50" cy="50" r="8" fill="#5d8a66"/>
                            <circle cx="46" cy="46" r="3" fill="white"/>
                            <path d="M20 35 Q15 30 20 25" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M80 35 Q85 30 80 25" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M15 50 L20 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            <path d="M80 50 L85 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span class="app-name">ÁúãÁúã‰Ω†</span>
                </div>

                <!-- ‰ªäÂ§©ÂÅö‰ªÄ‰πà - Êó•ÂéÜ -->
                <div class="app-icon">
                    <div class="icon-img" id="icon-calendar">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="18" y="25" width="64" height="55" rx="8" stroke="#5d8a66" stroke-width="3" fill="none"/>
                            <path d="M18 42 L82 42" stroke="#5d8a66" stroke-width="2"/>
                            <path d="M35 18 L35 32" stroke="#5d8a66" stroke-width="3" stroke-linecap="round"/>
                            <path d="M65 18 L65 32" stroke="#5d8a66" stroke-width="3" stroke-linecap="round"/>
                            <text x="50" y="68" font-family="Comic Sans MS, cursive" font-size="24" fill="#5d8a66" text-anchor="middle">?</text>
                            <circle cx="72" cy="28" r="5" fill="#ff8a80"/>
                        </svg>
                    </div>
                    <span class="app-name">‰ªäÂ§©ÂÅö‰ªÄ‰πà</span>
                </div>
            </div>

            <div class="bottom-area">
                <div class="bottom-apps">
                    <!-- Êü•ÊâãÊú∫ - ÊâãÊú∫ -->
                    <div class="bottom-app">
                        <div class="icon-img" id="icon-phone">
                            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="28" y="15" width="44" height="70" rx="8" stroke="#5d8a66" stroke-width="3" fill="none"/>
                                <path d="M28 25 L72 25" stroke="#5d8a66" stroke-width="2"/>
                                <path d="M28 72 L72 72" stroke="#5d8a66" stroke-width="2"/>
                                <circle cx="50" cy="80" r="4" stroke="#5d8a66" stroke-width="2" fill="none"/>
                                <path d="M42 20 L58 20" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                                <path d="M38 45 L48 55 L62 38" stroke="#81c784" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span class="app-name">Êü•ÊâãÊú∫</span>
                    </div>

                    <!-- Âõ¥ËÑñ - ÂØπËØùÊ°Ü -->
                    <div class="bottom-app">
                        <div class="icon-img" id="icon-weibo">
                            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 30 Q20 20 30 20 L70 20 Q80 20 80 30 L80 55 Q80 65 70 65 L35 65 L22 78 L25 65 L30 65 Q20 65 20 55 Z" stroke="#5d8a66" stroke-width="3" fill="none"/>
                                <circle cx="38" cy="42" r="4" fill="#5d8a66"/>
                                <circle cx="52" cy="42" r="4" fill="#5d8a66"/>
                                <circle cx="66" cy="42" r="4" fill="#5d8a66"/>
                            </svg>
                        </div>
                        <span class="app-name">Âõ¥ËÑñ</span>
                    </div>

                    <!-- BO4 - ‰øùÁïôÂéüÊ†∑Âºè -->
                    <div class="bottom-app">
                        <div class="icon-img" id="icon-bo4">
                            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <text x="50" y="62" font-family="Georgia, serif" font-size="28" fill="#990000" text-anchor="middle" font-weight="bold">BO4</text>
                                <circle cx="20" cy="25" r="4" fill="#ffb74d"/>
                                <circle cx="80" cy="75" r="3" fill="#ffb74d"/>
                            </svg>
                        </div>
                        <span class="app-name">BO4</span>
                    </div>

                    <!-- Â§ßÂâßÂú∫ - Èù¢ÂÖ∑ -->
                    <div class="bottom-app">
                        <div class="icon-img" id="icon-theater">
                            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <ellipse cx="35" cy="45" rx="22" ry="28" stroke="#5d8a66" stroke-width="2.5" fill="none"/>
                                <ellipse cx="65" cy="45" rx="22" ry="28" stroke="#5d8a66" stroke-width="2.5" fill="none"/>
                                <circle cx="28" cy="38" r="4" fill="#5d8a66"/>
                                <circle cx="42" cy="38" r="4" fill="#5d8a66"/>
                                <path d="M25 55 Q35 65 45 55" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round"/>
                                <circle cx="58" cy="38" r="4" fill="#5d8a66"/>
                                <circle cx="72" cy="38" r="4" fill="#5d8a66"/>
                                <path d="M55 55 Q65 48 75 55" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round"/>
                                <path d="M35 75 Q50 85 65 75" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <span class="app-name">Â§ßÂâßÂú∫</span>
                    </div>
                </div>

                <div class="bottom-decoration">
                    <div class="dot"></div>
                    <div class="dot active"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>
        
        <div class="bottom-bar"></div>

        <!-- Âä†ËΩΩÊèêÁ§∫ -->
        <div id="loading-toast" class="loading-toast">Â§ÑÁêÜ‰∏≠...</div>

        <!-- Âà†Èô§Á°ÆËÆ§ÂºπÁ™ó -->
        <div id="delete-confirm-overlay" class="delete-confirm-overlay">
            <div class="delete-confirm-box">
                <h3>üóëÔ∏è Âà†Èô§ËßíËâ≤</h3>
                <p id="delete-confirm-text">Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËßíËâ≤ÂêóÔºüËÅäÂ§©ËÆ∞ÂΩï‰πü‰ºö‰∏ÄÂπ∂Âà†Èô§„ÄÇ</p>
                <div class="btn-row">
                    <button class="btn btn-danger" id="confirm-delete-btn">Âà†Èô§</button>
                    <button class="btn btn-secondary" onclick="hideDeleteConfirm()">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>

        <!-- PWAÂÆâË£ÖÊèêÁ§∫ -->
        <div id="pwa-install-prompt" class="pwa-install-prompt">
            <p>üì± Â∞ÜÊ≠§Â∫îÁî®Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπïÔºåËé∑ÂæóÊõ¥Â•Ω‰ΩìÈ™åÔºÅ</p>
            <div class="btn-row">
                <button class="btn btn-primary" id="pwa-install-btn">Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπï</button>
                <button class="btn btn-secondary" onclick="dismissPWAPrompt()">Á®çÂêéÂÜçËØ¥</button>
            </div>
        </div>

        <!-- ÂõæÊ†áÁºñËæëÂºπÁ™óÈÅÆÁΩ© -->
        <div id="popup-overlay" class="popup-overlay" onclick="closeIconEditPopup()"></div>

        <!-- ÂõæÊ†áÁºñËæëÂºπÁ™ó -->
        <div id="icon-edit-popup" class="icon-edit-popup">
            <h3 id="icon-edit-title">ÁºñËæëÂõæÊ†á</h3>
            <div class="current-icon" id="icon-edit-preview"></div>
            <div class="form-group">
                <label class="form-label">ÂõæÊ†áURL</label>
                <input type="text" id="icon-url-input" class="form-input" placeholder="ËæìÂÖ•ÂõæÁâáURL">
            </div>
            <div class="btn-row" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="document.getElementById('icon-file-input').click()">Êú¨Âú∞‰∏ä‰º†</button>
                <button class="btn btn-danger" onclick="resetIconToDefault()">ÊÅ¢Â§çÈªòËÆ§</button>
            </div>
            <div class="btn-row" style="margin-top: 15px;">
                <button class="btn btn-primary" style="flex:1" onclick="saveIconEdit()">Á°ÆÂÆö</button>
                <button class="btn btn-secondary" style="flex:1" onclick="closeIconEditPopup()">ÂèñÊ∂à</button>
            </div>
        </div>

        <!-- ================= ËßíËâ≤ÂàóË°®Ê®°ÊÄÅÊ°Ü ================= -->
        <div id="character-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeModal('character-modal')">‚Üê</span>
                        <h2>ËßíËâ≤ÂàóË°®</h2>
                    </div>
                    <div class="header-right">
                        <span class="header-btn" onclick="createNewCharacter()">Ôºã</span>
                        <span class="header-btn" onclick="document.getElementById('character-import-input').click()">üì§</span>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="character-list" class="character-list">
                        <!-- ËßíËâ≤ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= ËßíËâ≤ÁºñËæë/ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="character-edit-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeCharacterEdit()">‚Üê</span>
                        <h2 id="character-edit-title">ËßíËâ≤ËÆæÁΩÆ</h2>
                    </div>
                    <div class="header-right">
                        <span class="header-btn" onclick="deleteCurrentCharacter()" style="color: #ef5350;">üóë</span>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- ËßíËâ≤Â§¥ÂÉè -->
                    <div class="avatar-upload-section">
                        <div class="avatar-preview" onclick="document.getElementById('char-avatar-input').click()">
                            <img id="char-avatar-preview" src="https://api.dicebear.com/7.x/lorelei/png?seed=default" alt="ËßíËâ≤Â§¥ÂÉè">
                        </div>
                        <span style="font-size: 12px; color: #888;">ÁÇπÂáªÊõ¥Êç¢Â§¥ÂÉè</span>
                    </div>

                    <!-- ËßíËâ≤‰ø°ÊÅØ -->
                    <div class="setting-section">
                        <h3>üë§ ËßíËâ≤‰ø°ÊÅØ</h3>
                        <div class="form-group">
                            <label class="form-label">ËßíËâ≤Â§áÊ≥®ÔºàÂèåÊñπÂèØËßÅÔºâ</label>
                            <input type="text" id="char-nickname" class="form-input" placeholder="ËßíËâ≤ÁöÑÂ§áÊ≥®ÂêçÁß∞">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ËßíËâ≤Êú¨ÂêçÔºàAIËØªÂèñÔºâ</label>
                            <input type="text" id="char-name" class="form-input" placeholder="ËßíËâ≤ÁöÑÁúüÂÆûÂêçÂ≠ó">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ËßíËâ≤‰∫∫ËÆæ</label>
                            <textarea id="char-persona" class="form-textarea" rows="5" placeholder="ÊèèËø∞ËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅËÉåÊôØ„ÄÅËØ¥ËØùÊñπÂºèÁ≠â..." oninput="updateTokensEstimate()"></textarea>
                        </div>
                    </div>

                    <!-- Áî®Êà∑‰ø°ÊÅØ -->
                    <div class="setting-section">
                        <h3>üôã Áî®Êà∑‰ø°ÊÅØ</h3>
                        <div class="avatar-upload-section">
                            <div class="avatar-preview" style="width: 60px; height: 60px;" onclick="document.getElementById('user-avatar-input').click()">
                                <img id="user-avatar-preview" src="https://api.dicebear.com/7.x/lorelei/png?seed=user" alt="Áî®Êà∑Â§¥ÂÉè">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Áî®Êà∑Â§áÊ≥®ÔºàAIÂèØËßÅÔºåAIÂèØÊîπÂÜôÔºâ</label>
                            <input type="text" id="user-nickname" class="form-input" placeholder="AIÁúãÂà∞ÁöÑ‰Ω†ÁöÑÂ§áÊ≥®">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Áî®Êà∑Êú¨ÂêçÔºàAIËØªÂèñÔºâ</label>
                            <input type="text" id="user-name" class="form-input" placeholder="‰Ω†ÁöÑÂêçÂ≠ó">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Áî®Êà∑‰∫∫ËÆæ</label>
                            <textarea id="user-persona" class="form-textarea" rows="3" placeholder="ÊèèËø∞‰Ω†Ëá™Â∑±..." oninput="updateTokensEstimate()"></textarea>
                        </div>
                    </div>

                    <!-- ÂÖ≥ËÅî‰∏ñÁïå‰π¶ -->
                    <div class="setting-section">
                        <h3>üìö ÂÖ≥ËÅî‰∏ñÁïå‰π¶ (Â§öÈÄâ)</h3>
                        <div id="char-worldbook-list" class="checkbox-list">
                            <!-- Âä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>

                    <!-- È´òÁ∫ßËÆæÂÆö -->
                    <div class="setting-section">
                        <h3>‚öôÔ∏è È´òÁ∫ßËÆæÂÆö</h3>
                        <div class="form-group">
                            <label class="form-label">Â∫ïÂ±ÇÊèêÁ§∫ËØç (ËøΩÂä†Âà∞ System Prompt Êú´Â∞æ)</label>
                            <textarea id="char-post-history-instructions" class="form-textarea" rows="3" placeholder="‰æãÂ¶ÇÔºöËØ∑ÂßãÁªà‰øùÊåÅÈ´òÂÜ∑ËØ≠Ê∞î..."></textarea>
                        </div>
                    </div>

                    <!-- Token‰º∞ÁÆó -->
                    <div class="tokens-display">
                        <div class="label">È¢Ñ‰º∞‰∏ä‰∏ãÊñáÊÄªTokens</div>
                        <div class="value" id="tokens-estimate">0</div>
                    </div>

                    <!-- ËÆ∞ÂøÜËÆæÁΩÆ -->
                    <div class="setting-section">
                        <h3>üß† ËÆ∞ÂøÜËÆæÁΩÆ</h3>
                        <div class="form-group">
                            <label class="form-label">ËßíËâ≤ËÆ∞ÂøÜÔºàAIÊØèÊ¨°Âõ∫ÂÆöËØªÂèñÁöÑËÅäÂ§©ËÆ∞ÂΩïÊù°Êï∞Ôºâ</label>
                            <input type="number" id="memory-count" class="form-input" placeholder="‰æãÂ¶Ç: 200" value="50">
                        </div>
                        
                        <div class="switch-row">
                            <span>ÊòØÂê¶Ëá™Âä®ÊÄªÁªì</span>
                            <label class="switch">
                                <input type="checkbox" id="auto-summary-switch" onchange="toggleArea('summary-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="summary-settings" class="hidden-area">
                            <div class="form-group">
                                <label class="form-label">ÊØèÈöîÂ§öÂ∞ëÊù°ËÅäÂ§©ËÆ∞ÂΩïËøõË°åÊÄªÁªì</label>
                                <input type="number" id="summary-interval" class="form-input" placeholder="‰æãÂ¶Ç: 100" value="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÊÄªÁªìÊèêÁ§∫ËØç</label>
                                <textarea id="summary-prompt" class="form-textarea" rows="2">‰ª•ËßíËâ≤Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÂèôËø∞Êàë‰ª¨ËÅäÂ§©‰∏≠ÊèêÂà∞ÁöÑ‰∫ãÊÉÖÔºå100Â≠óÂÜÖ</textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÊâãÂä®ÊÄªÁªìËåÉÂõ¥</label>
                                <div class="inline-input">
                                    <input type="number" id="summary-start" class="form-input" placeholder="ÂºÄÂßã" style="width: 80px;">
                                    <span>Âà∞</span>
                                    <input type="number" id="summary-end" class="form-input" placeholder="ÁªìÊùü" style="width: 80px;">
                                    <button class="btn btn-primary" onclick="manualSummary()">ÊÄªÁªì</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Êó∂Èó¥‰∏éÂ§©Ê∞î -->
                    <div class="setting-section">
                        <h3>üåç ÁéØÂ¢ÉÊÑüÁü•</h3>
                        <div class="switch-row">
                            <span>ÊÑüÁü•ÁúüÂÆûÊó∂Èó¥</span>
                            <label class="switch">
                                <input type="checkbox" id="time-aware-switch" onchange="toggleArea('time-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="time-settings" class="hidden-area">
                            <div class="form-group">
                                <label class="form-label">Êó∂Âå∫ÈÄâÊã©</label>
                                <select id="timezone-select" class="form-select" style="width: 100%;">
                                    <option value="Asia/Shanghai">‰∏≠ÂõΩÊ†áÂáÜÊó∂Èó¥ (UTC+8)</option>
                                    <option value="Asia/Tokyo">Êó•Êú¨Ê†áÂáÜÊó∂Èó¥ (UTC+9)</option>
                                    <option value="America/New_York">ÁæéÂõΩ‰∏úÈÉ®Êó∂Èó¥ (UTC-5)</option>
                                    <option value="America/Los_Angeles">ÁæéÂõΩË•øÈÉ®Êó∂Èó¥ (UTC-8)</option>
                                    <option value="Europe/London">Ëã±ÂõΩÊó∂Èó¥ (UTC+0)</option>
                                    <option value="Europe/Paris">‰∏≠Ê¨ßÊó∂Èó¥ (UTC+1)</option>
                                </select>
                            </div>
                        </div>

                        <div class="switch-row">
                            <span>ÊÑüÁü•Â§©Ê∞î</span>
                            <label class="switch">
                                <input type="checkbox" id="weather-aware-switch" onchange="toggleArea('weather-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="weather-settings" class="hidden-area">
                            <div class="form-group">
                                <label class="form-label">ÂΩìÂâçÂ§©Ê∞î</label>
                                <input type="text" id="weather-input" class="form-input" placeholder="‰æãÂ¶Ç: Êô¥Â§©/‰∏ãÈõ®/‰∏ãÈõ™">
                            </div>
                        </div>
                    </div>

                    <!-- Á∫ø‰∏ãÊ®°Âºè -->
                    <div class="setting-section">
                        <h3>üìù Á∫ø‰∏ãÊ®°Âºè</h3>
                        <div class="switch-row">
                            <span>ÂêØÁî®Á∫ø‰∏ãÊ®°ÂºèÔºàÈïøÊñáËæìÂá∫Ôºâ</span>
                            <label class="switch">
                                <input type="checkbox" id="offline-mode-switch" onchange="toggleArea('offline-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="offline-settings" class="hidden-area">
                            <div class="form-group">
                                <label class="form-label">ÈïøÊñáÂ≠óÊï∞</label>
                                <input type="number" id="offline-length" class="form-input" placeholder="‰æãÂ¶Ç: 2000" value="1000">
                            </div>
                        </div>
                    </div>

                    <!-- Â§ñËßÇËÆæÁΩÆ -->
                    <div class="setting-section">
                        <h3>üé® Â§ñËßÇËÆæÁΩÆ</h3>
                        <div class="form-group">
                            <label class="form-label">Â≠ó‰ΩìÂ§ßÂ∞è</label>
                            <div class="inline-input">
                                <input type="range" id="font-size-range" class="range-input" min="12" max="20" value="14" style="flex:1" oninput="document.getElementById('font-size-value').textContent = this.value + 'px'">
                                <span id="font-size-value" style="width: 40px; text-align: right;">14px</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ËÅäÂ§©ËÉåÊôØÔºàURLÊàñÊú¨Âú∞‰∏ä‰º†Ôºâ</label>
                            <div class="btn-row">
                                <input type="text" id="chat-bg-url" class="form-input" placeholder="ËæìÂÖ•ÂõæÁâáURL" style="flex: 1; margin-bottom: 0;">
                                <button class="btn btn-secondary" onclick="document.getElementById('chat-bg-input').click()">Êú¨Âú∞</button>
                            </div>
                        </div>
                    </div>

                    <!-- ÂØºÂÖ•ÂØºÂá∫ -->
                    <div class="setting-section">
                        <h3>üíæ ËÅäÂ§©ËÆ∞ÂΩï</h3>
                        <div class="btn-row">
                            <button class="btn btn-primary" onclick="exportChatHistory()">ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('chat-import-input').click()">ÂØºÂÖ•ËÅäÂ§©ËÆ∞ÂΩï</button>
                        </div>
                        <div class="btn-row" style="margin-top: 10px;">
                            <button class="btn btn-danger" onclick="clearChatHistory()">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveCharacter()">‰øùÂ≠òËßíËâ≤ËÆæÁΩÆ</button>
                </div>
            </div>
        </div>

        <!-- ================= ËÅäÂ§©ÁïåÈù¢Ê®°ÊÄÅÊ°Ü ================= -->
        <div id="chat-modal" class="modal full-screen">
            <div class="modal-content full-height" style="padding: 0; background: #f5f5f5;">
                <div class="chat-container" id="chat-container">
                    <div class="chat-header">
                        <span class="back-btn" onclick="closeChat()">‚Üê</span>
                        <div class="chat-header-avatar">
                            <img id="chat-char-avatar" src="https://api.dicebear.com/7.x/lorelei/png?seed=default" alt="ËßíËâ≤">
                        </div>
                        <div class="chat-header-info">
                            <div class="chat-header-name" id="chat-char-name">ËßíËâ≤Âêç</div>
                            <div class="chat-header-status" id="chat-status">Âú®Á∫ø</div>
                        </div>
                        <span class="chat-header-settings" onclick="openCharacterSettings()">‚öôÔ∏è</span>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <!-- Ê∂àÊÅØÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                    <div class="chat-input-area" id="chat-input-area">
                        <button class="chat-btn" onclick="toggleFunctionPanel()" style="margin-right: 5px;">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                        <textarea class="chat-input" id="chat-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1" oninput="autoResize(this)"></textarea>
                        <button class="chat-btn star-btn" id="ai-reply-btn" onclick="triggerAIReply()" title="ËÆ©AIÂõûÂ§ç">‚ú¶</button>
                        <button class="chat-btn" id="retry-btn" onclick="retryLastMessage()" title="ÈáçËØï" style="display: none; background: #ffb74d; color: white; font-size: 14px;">‚Üª</button>
                        <button class="chat-btn send-btn" onclick="sendMessage()" title="ÂèëÈÄÅÊ∂àÊÅØ">‚û§</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= ‰∏ñÁïå‰π¶ÂàóË°®Ê®°ÊÄÅÊ°Ü ================= -->
        <div id="worldbook-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeModal('worldbook-modal')">‚Üê</span>
                        <h2>‰∏ñÁïå‰π¶</h2>
                    </div>
                    <div class="header-right">
                        <span class="header-btn" onclick="createNewWorldbook()">Ôºã</span>
                        <span class="header-btn" onclick="document.getElementById('worldbook-import-input').click()">üì§</span>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="worldbook-list">
                        <!-- ‰∏ñÁïå‰π¶ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= ‰∏ñÁïå‰π¶ÁºñËæëÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="worldbook-edit-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeWorldbookEdit()">‚Üê</span>
                        <h2 id="worldbook-edit-title">ÁºñËæë‰∏ñÁïå‰π¶</h2>
                    </div>
                    <div class="header-right">
                        <span class="header-btn" onclick="addWorldbookEntry()">Ôºã</span>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">‰∏ñÁïå‰π¶ÂêçÁß∞</label>
                        <input type="text" id="worldbook-name" class="form-input" placeholder="‰∏ñÁïå‰π¶ÂêçÁß∞">
                    </div>
                    <h3 style="font-size: 14px; color: #5d8a66; margin: 15px 0 10px;">üìñ Êù°ÁõÆÂàóË°®</h3>
                    <div id="worldbook-entries">
                        <!-- Êù°ÁõÆÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveWorldbook()">‰øùÂ≠ò‰∏ñÁïå‰π¶</button>
                </div>
            </div>
        </div>

        <!-- ================= ‰∏ñÁïå‰π¶Êù°ÁõÆÁºñËæëÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="entry-edit-modal" class="modal">
            <div class="modal-content" style="height: 60%;">
                <div class="modal-header">
                    <h2>ÁºñËæëÊù°ÁõÆ</h2>
                    <span class="close-btn" onclick="closeModal('entry-edit-modal')">√ó</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">ÂÖ≥ÈîÆËØçÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºâ</label>
                        <input type="text" id="entry-keywords" class="form-input" placeholder="‰æãÂ¶Ç: È≠îÊ≥ï,ÂííËØ≠,Ê≥ïÊúØ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÂÜÖÂÆπ</label>
                        <textarea id="entry-content" class="form-textarea" rows="6" placeholder="ÂΩìËß¶ÂèëÂÖ≥ÈîÆËØçÊó∂ÔºåAIÂ∞ÜËØªÂèñËøôÊÆµÂÜÖÂÆπ..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveEntry()">‰øùÂ≠òÊù°ÁõÆ</button>
                </div>
            </div>
        </div>

        <!-- ================= API ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="api-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>API ÈÖçÁΩÆ</h2>
                    <span class="close-btn" onclick="closeModal('api-modal')">√ó</span>
                </div>
                <div class="modal-body">
                    <div class="setting-section">
                        <h3>ü§ñ ‰∏ªAPI (ËßíËâ≤ÂØπËØù)</h3>
                        <input type="text" id="main-api-url" class="form-input" placeholder="APIÂú∞ÂùÄ (‰æãÂ¶Ç https://api.openai.com)">
                        <input type="password" id="main-api-key" class="form-input" placeholder="API ÂØÜÈí• (sk-...)">
                        <div class="btn-row">
                            <button class="btn btn-primary" onclick="fetchModels('main')">ÊãâÂèñÊ®°Âûã</button>
                            <select id="main-model-select" class="form-select">
                                <option value="">ËØ∑ÂÖàÊãâÂèñÊ®°Âûã</option>
                            </select>
                        </div>
                        
                        <!-- Ê®°ÂûãÊ∏©Â∫¶Ë∞ÉËäÇ -->
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label">üå°Ô∏è Ê®°ÂûãÊ∏©Â∫¶ (Temperature)</label>
                            <div class="temperature-slider">
                                <input type="range" id="main-temperature" min="0" max="2" step="0.1" value="0.8" oninput="document.getElementById('temp-value').textContent = this.value">
                                <span class="temperature-value" id="temp-value">0.8</span>
                            </div>
                            <div style="font-size: 11px; color: #888; margin-top: 5px;">
                                ËæÉ‰Ωé = Êõ¥Á≤æÁ°ÆÁ®≥ÂÆö | ËæÉÈ´ò = Êõ¥ÊúâÂàõÊÑèÈöèÊú∫
                            </div>
                        </div>
                        
                        <div class="btn-row" style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="savePreset()">‰øùÂ≠òÈ¢ÑËÆæ</button>
                        </div>
                        <div id="preset-list" class="preset-list"></div>
                    </div>

                    <div class="setting-section">
                        <h3>üìù ÂâØAPI (ËÅäÂ§©ÊÄªÁªì)</h3>
                        <input type="text" id="sub-api-url" class="form-input" placeholder="ÂâØAPIÂú∞ÂùÄÔºàÂèØÈÄâÔºå‰∏çÂ°´ÂàôÁî®‰∏ªAPIÔºâ">
                        <input type="password" id="sub-api-key" class="form-input" placeholder="API ÂØÜÈí•">
                        <div class="btn-row">
                            <button class="btn btn-primary" onclick="fetchModels('sub')">ÊãâÂèñÊ®°Âûã</button>
                            <select id="sub-model-select" class="form-select">
                                <option value="">ËØ∑ÂÖàÊãâÂèñÊ®°Âûã</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-section">
                        <div class="switch-row">
                            <h3 style="margin: 0;">üé® ÂºÄÂêØAIÁîüÂõæ</h3>
                            <label class="switch">
                                <input type="checkbox" id="img-gen-switch">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="setting-section">
                        <div class="switch-row">
                            <h3 style="margin: 0;">üé§ Minimax ËØ≠Èü≥</h3>
                            <label class="switch">
                                <input type="checkbox" id="voice-switch" onchange="toggleArea('voice-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="voice-settings" class="hidden-area">
                            <input type="text" id="voice-group-id" class="form-input" placeholder="Group ID">
                            <input type="password" id="voice-api-key" class="form-input" placeholder="API ÂØÜÈí•">
                            <div class="btn-row">
                                <button class="btn btn-primary" onclick="fetchMinimaxVoiceModels()">ÊãâÂèñËØ≠Èü≥Ê®°Âûã</button>
                                <select id="voice-model-select" class="form-select">
                                    <option value="">ËØ∑ÂÖàÊãâÂèñÊ®°Âûã</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-top: 8px;">
                                <label class="form-label">Voice ID (ÂèØÈÄâÔºåÁî®‰∫éÊåáÂÆöÈü≥Ëâ≤)</label>
                                <input type="text" id="voice-id-input" class="form-input" placeholder="Voice ID">
                            </div>
                            <div class="form-group" style="margin-top: 8px;">
                                <label class="form-label">ËØ≠Èü≥Ê∂àÊÅØÊ¶ÇÁéá (0-100%)</label>
                                <div class="inline-input">
                                    <input type="range" id="voice-probability" min="0" max="100" value="30" style="flex:1" oninput="document.getElementById('voice-prob-value').textContent = this.value + '%'">
                                    <span id="voice-prob-value" style="width: 50px; text-align: right;">30%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="setting-section">
                        <div class="switch-row">
                            <h3 style="margin: 0;">üí¨ AI‰∏ªÂä®ÂèëÊ∂àÊÅØ</h3>
                            <label class="switch">
                                <input type="checkbox" id="active-msg-switch" onchange="toggleArea('active-msg-settings', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="active-msg-settings" class="hidden-area">
                            <div class="inline-input">
                                <span>ÂìçÂ∫îÊó∂Èó¥(Áßí):</span>
                                <input type="number" id="active-msg-time" class="form-input" style="width: 80px; margin: 0;" value="60">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveAPISettings()">‰øùÂ≠òAPIÈÖçÁΩÆ</button>
                </div>
            </div>
        </div>

        <!-- ================= Â§ñËßÇËÆæÁΩÆÊ®°ÊÄÅÊ°Ü ================= -->
        <div id="appearance-modal" class="modal full-screen">
            <div class="modal-content full-height">
                <div class="modal-header">
                    <div class="header-left">
                        <span class="back-btn" onclick="closeModal('appearance-modal')">‚Üê</span>
                        <h2>Â§ñËßÇËÆæÁΩÆ</h2>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- ÂÖ®Â±ÄÂ≠ó‰Ωì -->
                    <div class="setting-section">
                        <h3>Aa ÂÖ®Â±ÄÂ≠ó‰Ωì</h3>
                        <div class="form-group">
                            <label class="form-label">Â≠ó‰ΩìÂêçÁß∞ (Á≥ªÁªüÂ≠ó‰ΩìÊàñÂ∑≤ÂÆâË£ÖÂ≠ó‰Ωì)</label>
                            <input type="text" id="custom-font-input" class="form-input" placeholder="‰æãÂ¶Ç: KaiTi, SimHei, 'Courier New'" onchange="applyCustomFont(this.value)">
                        </div>
                    </div>

                    <!-- ‰∏ªÂ±èÂπïÂ§¥ÂÉè -->
                    <div class="setting-section">
                        <h3>üñºÔ∏è ‰∏ªÂ±èÂπïÂ§¥ÂÉè</h3>
                        <div class="main-avatar-edit" onclick="document.getElementById('main-avatar-input').click()">
                            <img id="main-avatar-preview" src="https://api.dicebear.com/7.x/lorelei/png?seed=cute&backgroundColor=d1fae5" alt="‰∏ªÂ§¥ÂÉè">
                        </div>
                        <div class="form-group">
                            <input type="text" id="main-avatar-url" class="form-input" placeholder="ËæìÂÖ•Â§¥ÂÉèURL" onchange="previewMainAvatar()">
                        </div>
                        <div class="btn-row" style="justify-content: center;">
                            <button class="btn btn-secondary" onclick="document.getElementById('main-avatar-input').click()">Êú¨Âú∞‰∏ä‰º†</button>
                        </div>
                    </div>

                    <!-- ‰∏ªÂ±èÂπïËÉåÊôØ -->
                    <div class="setting-section">
                        <h3>üåÑ ‰∏ªÂ±èÂπïËÉåÊôØ</h3>
                        <div class="bg-preview-box" id="bg-preview-box" onclick="document.getElementById('main-bg-input').click()">
                            <span>ÁÇπÂáªÊõ¥Êç¢ËÉåÊôØ</span>
                        </div>
                        <div class="form-group">
                            <input type="text" id="main-bg-url" class="form-input" placeholder="ËæìÂÖ•ËÉåÊôØÂõæURL" onchange="previewMainBg()">
                        </div>
                        <div class="btn-row">
                            <button class="btn btn-secondary" onclick="document.getElementById('main-bg-input').click()">Êú¨Âú∞‰∏ä‰º†</button>
                            <button class="btn btn-danger" onclick="resetMainBg()">ÊÅ¢Â§çÈªòËÆ§</button>
                        </div>
                    </div>

                    <!-- Â∫îÁî®ÂõæÊ†á -->
                    <div class="setting-section">
                        <h3>üì± Â∫îÁî®ÂõæÊ†á (ÁÇπÂáªÁºñËæë)</h3>
                        <div class="icon-edit-grid" id="icon-edit-grid">
                            <!-- ÂõæÊ†áÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveAppearanceSettings()">‰øùÂ≠òÂ§ñËßÇËÆæÁΩÆ</button>
                </div>
            </div>
        </div>

        <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• -->
        <input type="file" id="character-import-input" class="hidden-input" accept=".json,.png" onchange="importCharacter(event)">
        <input type="file" id="worldbook-import-input" class="hidden-input" accept=".json,.txt,.docx" onchange="importWorldbook(event)">
        <input type="file" id="char-avatar-input" class="hidden-input" accept="image/*" onchange="uploadAvatar(event, 'char')">
        <input type="file" id="user-avatar-input" class="hidden-input" accept="image/*" onchange="uploadAvatar(event, 'user')">
        <input type="file" id="chat-bg-input" class="hidden-input" accept="image/*" onchange="uploadChatBg(event)">
        <input type="file" id="chat-import-input" class="hidden-input" accept=".json" onchange="importChatHistory(event)">
        <input type="file" id="main-avatar-input" class="hidden-input" accept="image/*" onchange="uploadMainAvatar(event)">
        <input type="file" id="main-bg-input" class="hidden-input" accept="image/*" onchange="uploadMainBg(event)">
        <input type="file" id="icon-file-input" class="hidden-input" accept="image/*" onchange="uploadIconImage(event)">
        
        <!-- ÈöêËóèÁöÑÈü≥È¢ëÊí≠ÊîæÂô® -->
        <audio id="voice-player" style="display:none;"></audio>

        <!-- Èù¢ÊùøÈÅÆÁΩ©Â±Ç -->
        <div id="panel-overlay" class="panel-overlay" onclick="closeAllPanels()"></div>

        <!-- ÂäüËÉΩÈù¢Êùø -->
        <div id="function-panel" class="function-panel">
            <div class="function-item" onclick="openEmojiPanelFromFunc()">
                <div class="function-icon">üòä</div>
                <div class="function-name">Ë°®ÊÉÖ</div>
            </div>
            <div class="function-item" onclick="document.getElementById('image-upload-input').click()">
                <div class="function-icon">üñºÔ∏è</div>
                <div class="function-name">Áõ∏ÂÜå</div>
            </div>
            <div class="function-item" onclick="startVoiceInput()">
                <div class="function-icon">üé§</div>
                <div class="function-name">ËØ≠Èü≥</div>
            </div>
            <div class="function-item" onclick="openRedPacketModal()">
                <div class="function-icon">üßß</div>
                <div class="function-name">Á∫¢ÂåÖ</div>
            </div>
            <div class="function-item" onclick="startVideoCall()">
                <div class="function-icon">üìπ</div>
                <div class="function-name">ËßÜÈ¢ëÈÄöËØù</div>
            </div>
        </div>

        <!-- Ë°®ÊÉÖÈù¢Êùø -->
        <div id="emoji-panel" class="emoji-panel">
            <div class="emoji-header">
                <div class="header-left" style="display: flex; align-items: center; gap: 10px; overflow: hidden;">
                    <span class="back-btn" onclick="closeEmojiPanel()" style="font-size: 20px; padding: 5px 10px; cursor: pointer; color: #5d8a66;">‚Üê</span>
                    <div class="emoji-tabs" id="emoji-tabs">
                        <div class="emoji-tab active" onclick="switchEmojiTab('emoji')">Emoji</div>
                        <div class="emoji-tab" onclick="switchEmojiTab('custom')">Ë°®ÊÉÖÂåÖ</div>
                        <div class="emoji-tab" onclick="document.getElementById('emoji-import-input').click()">+ ÂØºÂÖ•</div>
                    </div>
                </div>
            </div>
            <div class="emoji-content" id="emoji-content">
                <!-- Ë°®ÊÉÖÂÜÖÂÆπÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>

        <!-- Ë°®ÊÉÖÂåÖÂØºÂÖ•ÂºπÁ™ó -->
        <div id="emoji-import-modal" class="modal">
            <div class="modal-content" style="height: auto;">
                <div class="modal-header">
                    <h2>ÂØºÂÖ•Ë°®ÊÉÖÂåÖ</h2>
                    <span class="close-btn" onclick="closeModal('emoji-import-modal')">√ó</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Ë°®ÊÉÖÂåÖÂêçÁß∞</label>
                        <input type="text" id="emoji-pack-name" class="form-input" placeholder="‰æãÂ¶Ç: ÂñµÂñµË°®ÊÉÖ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÈÄâÊã©ÂõæÁâá (ÊîØÊåÅÂ§öÈÄâ)</label>
                        <div class="btn-row">
                            <button class="btn btn-secondary" onclick="document.getElementById('emoji-files-input').click()">ÈÄâÊã©ÂõæÁâá...</button>
                            <span id="emoji-files-count" style="font-size: 12px; color: #666; align-self: center;">Êú™ÈÄâÊã©</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Êàñ‰ªéÊñáÊ°£ÂØºÂÖ• (txt/docx)</label>
                        <div class="btn-row">
                            <button class="btn btn-secondary" onclick="document.getElementById('emoji-doc-input').click()">ÈÄâÊã©ÊñáÊ°£...</button>
                            <span style="font-size: 11px; color: #999; align-self: center;">Ëá™Âä®ÊèêÂèñÈìæÊé•</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveEmojiPack()">ÂØºÂÖ•</button>
                </div>
            </div>
        </div>

        <!-- ÁªëÂÆöËßíËâ≤ÂºπÁ™ó -->
        <div id="bind-character-modal" class="modal">
            <div class="modal-content" style="height: 60%;">
                <div class="modal-header">
                    <h2>ÁªëÂÆöËßíËâ≤</h2>
                    <span class="close-btn" onclick="closeModal('bind-character-modal')">√ó</span>
                </div>
                <div class="modal-body">
                    <p style="font-size: 13px; color: #666; margin-bottom: 10px;">ÈÄâÊã©ÂèØ‰ª•‰ΩøÁî®Ê≠§Ë°®ÊÉÖÂåÖÁöÑËßíËâ≤ÔºàAIÂ∞ÜÊ†πÊçÆË°®ÊÉÖÂåÖÂêçÁß∞Ëá™Âä®ÂèëÈÄÅÔºâÔºö</p>
                    <div id="bind-char-list" class="checkbox-list">
                        <!-- Âä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" onclick="saveBindCharacter()">‰øùÂ≠òÁªëÂÆö</button>
                </div>
            </div>
        </div>

        <!-- Á∫¢ÂåÖÂºπÁ™ó -->
        <div id="red-packet-modal" class="modal">
            <div class="modal-content" style="height: auto;">
                <div class="modal-header">
                    <h2>ÂèëÁ∫¢ÂåÖ</h2>
                    <span class="close-btn" onclick="closeModal('red-packet-modal')">√ó</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">ÈáëÈ¢ù</label>
                        <input type="number" id="rp-amount" class="form-input" placeholder="0.00" style="font-size: 24px; font-weight: bold; text-align: center;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Â§áÊ≥®</label>
                        <input type="text" id="rp-memo" class="form-input" placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©" value="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="save-all-btn" style="background: #fa9d3b;" onclick="sendRedPacket()">Â°ûÈí±ËøõÁ∫¢ÂåÖ</button>
                </div>
            </div>
        </div>

        <input type="file" id="emoji-import-input" class="hidden-input" accept=".json" onchange="importEmojiConfig(event)">
        <input type="file" id="emoji-files-input" class="hidden-input" accept="image/*" multiple onchange="handleEmojiFilesSelect(event)">
        <input type="file" id="emoji-doc-input" class="hidden-input" accept=".txt,.docx" onchange="handleEmojiDocSelect(event)">
        <input type="file" id="image-upload-input" class="hidden-input" accept="image/*" onchange="handleImageUpload(event)">
        <input type="file" id="file-upload-input" class="hidden-input" accept=".txt,.docx,.pdf" onchange="handleFileUpload(event)">
        
        <!-- ËßÜÈ¢ëÈÄöËØùÊ®°ÊÄÅÊ°Ü -->
        <div id="video-call-modal" class="video-call-modal">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <img id="vc-avatar" class="vc-avatar" src="" alt="Avatar">
                <div id="vc-name" class="vc-name">ËßíËâ≤Âêç</div>
                <div id="vc-status" class="vc-status">Ê≠£Âú®Á≠âÂæÖÂØπÊñπÊé•ÂèóÈÇÄËØ∑...</div>
            </div>
            <div class="vc-actions">
                <div class="vc-btn hangup" onclick="endVideoCall()">üìû</div>
            </div>
        </div>

        <!-- ÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
        <div id="image-preview-modal" class="image-preview-modal" onclick="this.classList.remove('show')">
            <img id="preview-image" src="" alt="Preview">
        </div>
    </div>

    <script>
        // ================= ÈªòËÆ§ÂõæÊ†áSVG =================
        const defaultIcons = {
            'character': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="45" r="28" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="40" cy="40" r="4" fill="#5d8a66"/><circle cx="60" cy="40" r="4" fill="#5d8a66"/><path d="M40 55 Q50 65 60 55" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M30 25 Q35 15 45 20" stroke="#5d8a66" stroke-width="2.5" fill="none" stroke-linecap="round"/><path d="M70 25 Q65 15 55 20" stroke="#5d8a66" stroke-width="2.5" fill="none" stroke-linecap="round"/><circle cx="38" cy="38" r="1.5" fill="white"/><circle cx="58" cy="38" r="1.5" fill="white"/><ellipse cx="32" cy="50" rx="4" ry="3" fill="#ffcdd2" opacity="0.6"/><ellipse cx="68" cy="50" rx="4" ry="3" fill="#ffcdd2" opacity="0.6"/></svg>`,
            'worldbook': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M50 25 L50 80" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M50 25 Q30 20 15 30 L15 75 Q30 68 50 75" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M50 25 Q70 20 85 30 L85 75 Q70 68 50 75" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M22 40 L42 38" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M22 50 L42 48" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M22 60 L38 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M58 38 L78 40" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M58 48 L78 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M62 58 L78 60" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><circle cx="50" cy="20" r="5" fill="#ffeb3b" stroke="#5d8a66" stroke-width="1.5"/></svg>`,
            'taobao': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 30 L30 30 L40 65 L75 65 L82 40 L35 40" stroke="#5d8a66" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/><circle cx="45" cy="78" r="6" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="68" cy="78" r="6" stroke="#5d8a66" stroke-width="3" fill="none"/><path d="M45 50 L45 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M55 48 L55 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M65 50 L65 58" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M25 25 Q20 20 25 15" stroke="#ffb74d" stroke-width="2" stroke-linecap="round"/></svg>`,
            'api': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><text x="12" y="58" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(-8 20 50)">A</text><text x="35" y="62" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(5 45 55)">P</text><text x="58" y="55" font-family="Comic Sans MS, cursive" font-size="22" fill="#5d8a66" transform="rotate(-3 65 50)">I</text><path d="M75 35 Q80 30 85 35 Q90 40 85 45 Q80 50 75 45 Q70 40 75 35" stroke="#ffb74d" stroke-width="2" fill="#fff59d"/><circle cx="20" cy="30" r="4" fill="#81c784"/><circle cx="80" cy="65" r="3" fill="#81c784"/><path d="M25 70 L35 75" stroke="#5d8a66" stroke-width="1.5" stroke-linecap="round"/><path d="M30 73 L32 68" stroke="#5d8a66" stroke-width="1.5" stroke-linecap="round"/></svg>`,
            'appearance': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="50" rx="35" ry="32" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="35" cy="38" r="7" fill="#ff8a80"/><circle cx="55" cy="32" r="6" fill="#ffcc80"/><circle cx="70" cy="45" r="6" fill="#a5d6a7"/><circle cx="65" cy="62" r="5" fill="#90caf9"/><circle cx="40" cy="60" r="8" fill="white" stroke="#5d8a66" stroke-width="2"/><path d="M75 75 L90 90" stroke="#5d8a66" stroke-width="4" stroke-linecap="round"/><path d="M88 82 L92 88 L86 92" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            'look': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="50" rx="35" ry="22" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="50" cy="50" r="15" stroke="#5d8a66" stroke-width="2.5" fill="none"/><circle cx="50" cy="50" r="8" fill="#5d8a66"/><circle cx="46" cy="46" r="3" fill="white"/><path d="M20 35 Q15 30 20 25" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M80 35 Q85 30 80 25" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M15 50 L20 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M80 50 L85 50" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/></svg>`,
            'calendar': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="18" y="25" width="64" height="55" rx="8" stroke="#5d8a66" stroke-width="3" fill="none"/><path d="M18 42 L82 42" stroke="#5d8a66" stroke-width="2"/><path d="M35 18 L35 32" stroke="#5d8a66" stroke-width="3" stroke-linecap="round"/><path d="M65 18 L65 32" stroke="#5d8a66" stroke-width="3" stroke-linecap="round"/><text x="50" y="68" font-family="Comic Sans MS, cursive" font-size="24" fill="#5d8a66" text-anchor="middle">?</text><circle cx="72" cy="28" r="5" fill="#ff8a80"/></svg>`,
            'phone': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="28" y="15" width="44" height="70" rx="8" stroke="#5d8a66" stroke-width="3" fill="none"/><path d="M28 25 L72 25" stroke="#5d8a66" stroke-width="2"/><path d="M28 72 L72 72" stroke="#5d8a66" stroke-width="2"/><circle cx="50" cy="80" r="4" stroke="#5d8a66" stroke-width="2" fill="none"/><path d="M42 20 L58 20" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/><path d="M38 45 L48 55 L62 38" stroke="#81c784" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            'weibo': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 30 Q20 20 30 20 L70 20 Q80 20 80 30 L80 55 Q80 65 70 65 L35 65 L22 78 L25 65 L30 65 Q20 65 20 55 Z" stroke="#5d8a66" stroke-width="3" fill="none"/><circle cx="38" cy="42" r="4" fill="#5d8a66"/><circle cx="52" cy="42" r="4" fill="#5d8a66"/><circle cx="66" cy="42" r="4" fill="#5d8a66"/></svg>`,
            'bo4': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><text x="50" y="62" font-family="Georgia, serif" font-size="28" fill="#990000" text-anchor="middle" font-weight="bold">BO4</text><circle cx="20" cy="25" r="4" fill="#ffb74d"/><circle cx="80" cy="75" r="3" fill="#ffb74d"/></svg>`,
            'theater': `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="35" cy="45" rx="22" ry="28" stroke="#5d8a66" stroke-width="2.5" fill="none"/><ellipse cx="65" cy="45" rx="22" ry="28" stroke="#5d8a66" stroke-width="2.5" fill="none"/><circle cx="28" cy="38" r="4" fill="#5d8a66"/><circle cx="42" cy="38" r="4" fill="#5d8a66"/><path d="M25 55 Q35 65 45 55" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round"/><circle cx="58" cy="38" r="4" fill="#5d8a66"/><circle cx="72" cy="38" r="4" fill="#5d8a66"/><path d="M55 55 Q65 48 75 55" stroke="#5d8a66" stroke-width="2" fill="none" stroke-linecap="round"/><path d="M35 75 Q50 85 65 75" stroke="#5d8a66" stroke-width="2" stroke-linecap="round"/></svg>`
        };

        const iconNames = {
            'character': 'ËßíËâ≤',
            'worldbook': '‰∏ñÁïå‰π¶',
            'taobao': 'Ê∑òÂÆù',
            'api': 'APIËÆæÁΩÆ',
            'appearance': 'Â§ñËßÇËÆæÁΩÆ',
            'look': 'ÁúãÁúã‰Ω†',
            'calendar': '‰ªäÂ§©ÂÅö‰ªÄ‰πà',
            'phone': 'Êü•ÊâãÊú∫',
            'weibo': 'Âõ¥ËÑñ',
            'bo4': 'BO4',
            'theater': 'Â§ßÂâßÂú∫'
        };

        // ================= ÂÖ®Â±ÄÊï∞ÊçÆÂ≠òÂÇ® =================
        let isCreatingNewCharacter = false;
        let tempNewCharacter = null;

        let appData = {
            characters: [],
            worldbooks: [],
            currentCharacterId: null,
            currentWorldbookId: null,
            currentEntryIndex: null,
            apiSettings: {
                main: { url: '', key: '', model: '', temperature: 0.8 },
                sub: { url: '', key: '', model: '' },
                imgGen: false,
                voice: { enabled: false, groupId: '', key: '', voiceId: '', model: '', probability: 30 },
                activeMsg: { enabled: false, time: 60 }
            },
            presets: [],
            appearance: {
                mainAvatar: '',
                mainBg: '',
                icons: {}
            },
            emojiLibrary: []
        };

        // PWAÁõ∏ÂÖ≥
        let deferredPrompt = null;
        
        // ÈïøÊåâÂà†Èô§Áõ∏ÂÖ≥
        let longPressTimer = null;
        let longPressCharId = null;
        let isLongPress = false;

        // Ê∂àÊÅØÈïøÊåâÁõ∏ÂÖ≥
        let messageLongPressTimer = null;
        let isMessageLongPress = false;

        // ÂΩìÂâçÁºñËæëÁöÑÂõæÊ†á
        let currentEditingIcon = null;

        // Âä†ËΩΩÊï∞ÊçÆ
        function loadAppData() {
            const saved = localStorage.getItem('chat_app_data');
            if (saved) {
                try {
                    appData = JSON.parse(saved);
                    // Á°Æ‰øùÂ≠óÊÆµÂ≠òÂú®
                    if (!appData.apiSettings.main.temperature) appData.apiSettings.main.temperature = 0.8;
                    if (!appData.apiSettings.voice) appData.apiSettings.voice = { enabled: false, probability: 30 };
                    if (!appData.appearance) appData.appearance = { mainAvatar: '', mainBg: '', icons: {} };
                    if (!appData.emojiLibrary) appData.emojiLibrary = [];
                    
                    // Á°Æ‰øùÂõæÊ†áÈÖçÁΩÆÂ≠òÂú®
                    if (!appData.appearance.icons) appData.appearance.icons = {};
                } catch (e) {
                    console.error('Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•', e);
                }
            }
            applyAppearance();
        }

        function saveAppData() {
            localStorage.setItem('chat_app_data', JSON.stringify(appData));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function showToast(msg) {
            const toast = document.getElementById('loading-toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function formatTime(date) {
            return new Date(date).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        // ================= Â§ñËßÇ‰∏éÂàùÂßãÂåñ =================
        function applyAppearance() {
            // Â∫îÁî®ÂÖ®Â±ÄÂ≠ó‰Ωì
            const font = localStorage.getItem('custom_font');
            if (font) {
                document.documentElement.style.setProperty('--custom-font', font);
                const input = document.getElementById('custom-font-input');
                if (input) input.value = font;
            }

            // Â∫îÁî®‰∏ªÂ±èÂπïËÉåÊôØ
            if (appData.appearance.mainBg) {
                document.getElementById('phone-bg').style.backgroundImage = `url(${appData.appearance.mainBg})`;
            }

            // Â∫îÁî®‰∏ªÂ±èÂπïÂ§¥ÂÉè
            if (appData.appearance.mainAvatar) {
                document.getElementById('main-avatar').src = appData.appearance.mainAvatar;
            }

            // Â∫îÁî®Ëá™ÂÆö‰πâÂõæÊ†á
            if (appData.appearance.icons) {
                Object.keys(appData.appearance.icons).forEach(key => {
                    const iconData = appData.appearance.icons[key];
                    const iconEl = document.getElementById(`icon-${key}`);
                    if (iconEl && iconData) {
                        if (iconData.type === 'image') {
                            iconEl.innerHTML = `<img src="${iconData.content}" style="width:100%;height:100%;object-fit:cover;border-radius:14px;">`;
                        }
                    }
                });
            }
        }

        function applyCustomFont(fontName) {
            if (!fontName) return;
            document.documentElement.style.setProperty('--custom-font', fontName);
            localStorage.setItem('custom_font', fontName);
        }

        // ================= Ê®°ÊÄÅÊ°ÜÁÆ°ÁêÜ =================
        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function toggleArea(id, show) {
            document.getElementById(id).style.display = show ? 'block' : 'none';
        }

        // ================= ËßíËâ≤ÁÆ°ÁêÜ =================
        function openCharacterList() {
            renderCharacterList();
            openModal('character-modal');
        }

        function renderCharacterList() {
            const list = document.getElementById('character-list');
            list.innerHTML = '';
            
            if (appData.characters.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <div class="empty-state-text">ËøòÊ≤°ÊúâËßíËâ≤<br>ÁÇπÂáªÂè≥‰∏äËßí + ÂàõÂª∫‰∏Ä‰∏™Âêß</div>
                    </div>
                `;
                return;
            }

            appData.characters.forEach(char => {
                const item = document.createElement('div');
                item.className = 'character-item';
                item.innerHTML = `
                    <div class="character-avatar">
                        <img src="${char.avatar || 'https://api.dicebear.com/7.x/lorelei/png?seed=' + char.id}" alt="${char.name}">
                    </div>
                    <div class="character-info">
                        <div class="character-name">${char.nickname || char.name}</div>
                        <div class="character-desc">${char.persona.substring(0, 30)}...</div>
                    </div>
                `;
                item.onclick = () => openChat(char.id);
                
                // ÈïøÊåâÂà†Èô§
                let pressTimer;
                item.addEventListener('touchstart', () => {
                    pressTimer = setTimeout(() => showDeleteConfirm(char.id), 800);
                });
                item.addEventListener('touchend', () => clearTimeout(pressTimer));
                
                list.appendChild(item);
            });
        }

        function createNewCharacter() {
            isCreatingNewCharacter = true;
            tempNewCharacter = {
                id: generateId(),
                name: '',
                nickname: '',
                persona: '',
                avatar: '',
                userSettings: { name: 'Áî®Êà∑', nickname: '‰Ω†', persona: '', avatar: '' },
                worldbooks: [],
                chatHistory: [],
                settings: { memoryCount: 50, temperature: 0.8 }
            };
            
            // Â°´ÂÖÖË°®Âçï
            document.getElementById('character-edit-title').textContent = 'ÂàõÂª∫Êñ∞ËßíËâ≤';
            document.getElementById('char-name').value = '';
            document.getElementById('char-nickname').value = '';
            document.getElementById('char-persona').value = '';
            document.getElementById('char-avatar-preview').src = 'https://api.dicebear.com/7.x/lorelei/png?seed=new';
            
            document.getElementById('user-name').value = '';
            document.getElementById('user-nickname').value = '';
            document.getElementById('user-persona').value = '';
            document.getElementById('user-avatar-preview').src = 'https://api.dicebear.com/7.x/lorelei/png?seed=user';
            
            renderWorldbookCheckboxList([]);
            
            openModal('character-edit-modal');
        }

        function openCharacterSettings() {
            if (!appData.currentCharacterId) return;
            isCreatingNewCharacter = false;
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;

            document.getElementById('character-edit-title').textContent = 'ËßíËâ≤ËÆæÁΩÆ';
            document.getElementById('char-name').value = char.name || '';
            document.getElementById('char-nickname').value = char.nickname || '';
            document.getElementById('char-persona').value = char.persona || '';
            document.getElementById('char-avatar-preview').src = char.avatar || `https://api.dicebear.com/7.x/lorelei/png?seed=${char.id}`;
            
            document.getElementById('user-name').value = char.userSettings?.name || '';
            document.getElementById('user-nickname').value = char.userSettings?.nickname || '';
            document.getElementById('user-persona').value = char.userSettings?.persona || '';
            document.getElementById('user-avatar-preview').src = char.userSettings?.avatar || `https://api.dicebear.com/7.x/lorelei/png?seed=user${char.id}`;
            
            renderWorldbookCheckboxList(char.worldbooks || []);
            
            openModal('character-edit-modal');
        }

        function saveCharacter() {
            const charData = isCreatingNewCharacter ? tempNewCharacter : appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!charData) return;

            charData.name = document.getElementById('char-name').value;
            charData.nickname = document.getElementById('char-nickname').value;
            charData.persona = document.getElementById('char-persona').value;
            charData.avatar = document.getElementById('char-avatar-preview').src;
            
            if (!charData.userSettings) charData.userSettings = {};
            charData.userSettings.name = document.getElementById('user-name').value;
            charData.userSettings.nickname = document.getElementById('user-nickname').value;
            charData.userSettings.persona = document.getElementById('user-persona').value;
            charData.userSettings.avatar = document.getElementById('user-avatar-preview').src;
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑ‰∏ñÁïå‰π¶
            const checkboxes = document.querySelectorAll('#char-worldbook-list input[type="checkbox"]');
            charData.worldbooks = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);

            if (isCreatingNewCharacter) {
                appData.characters.push(charData);
                isCreatingNewCharacter = false;
            }
            
            saveAppData();
            closeModal('character-edit-modal');
            renderCharacterList();
            
            if (appData.currentCharacterId === charData.id) {
                updateChatHeader(charData);
            }
            
            showToast('ËßíËâ≤Â∑≤‰øùÂ≠ò');
        }

        function renderWorldbookCheckboxList(selectedIds) {
            const list = document.getElementById('char-worldbook-list');
            list.innerHTML = '';
            appData.worldbooks.forEach(wb => {
                const item = document.createElement('label');
                item.className = 'checkbox-item';
                item.innerHTML = `
                    <input type="checkbox" value="${wb.id}" ${selectedIds.includes(wb.id) ? 'checked' : ''}>
                    <span class="checkbox-label">${wb.name}</span>
                `;
                list.appendChild(item);
            });
        }

        function showDeleteConfirm(charId) {
            longPressCharId = charId;
            document.getElementById('delete-confirm-overlay').classList.add('show');
        }

        function hideDeleteConfirm() {
            document.getElementById('delete-confirm-overlay').classList.remove('show');
            longPressCharId = null;
        }

        document.getElementById('confirm-delete-btn').onclick = function() {
            if (longPressCharId) {
                appData.characters = appData.characters.filter(c => c.id !== longPressCharId);
                saveAppData();
                renderCharacterList();
                hideDeleteConfirm();
                
                if (appData.currentCharacterId === longPressCharId) {
                    closeChat();
                }
            } else if (appData.currentCharacterId) {
                // ‰ªéÁºñËæëÁïåÈù¢Âà†Èô§
                appData.characters = appData.characters.filter(c => c.id !== appData.currentCharacterId);
                saveAppData();
                closeModal('character-edit-modal');
                closeChat();
                renderCharacterList();
            }
        };

        function deleteCurrentCharacter() {
            if (isCreatingNewCharacter) {
                closeModal('character-edit-modal');
                return;
            }
            showDeleteConfirm(null); // null Ë°®Á§∫Âà†Èô§ÂΩìÂâçÁºñËæëÁöÑËßíËâ≤
        }

        function closeCharacterEdit() {
            closeModal('character-edit-modal');
        }

        // ================= ËÅäÂ§©ÂäüËÉΩ =================
        function openChat(charId) {
            appData.currentCharacterId = charId;
            const char = appData.characters.find(c => c.id === charId);
            if (!char) return;

            updateChatHeader(char);
            renderMessages();
            openModal('chat-modal');
            closeModal('character-modal'); // ÂÖ≥Èó≠ÂàóË°®
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            setTimeout(scrollToBottom, 100);
        }

        function updateChatHeader(char) {
            document.getElementById('chat-char-name').textContent = char.nickname || char.name;
            document.getElementById('chat-char-avatar').src = char.avatar || `https://api.dicebear.com/7.x/lorelei/png?seed=${char.id}`;
        }

        function closeChat() {
            appData.currentCharacterId = null;
            closeModal('chat-modal');
        }

        function renderMessages() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;
            
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';
            
            char.chatHistory.forEach(msg => {
                appendMessageToDOM(msg);
            });
        }

        function appendMessageToDOM(msg) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message ${msg.role === 'user' ? 'user' : 'ai'}`;
            
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            const avatarSrc = msg.role === 'user' 
                ? (char.userSettings?.avatar || 'https://api.dicebear.com/7.x/lorelei/png?seed=user')
                : (char.avatar || `https://api.dicebear.com/7.x/lorelei/png?seed=${char.id}`);

            let contentHtml = '';
            
            // Â§ÑÁêÜÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
            if (msg.content.includes('[img]')) {
                const url = msg.content.match(/\[img\](.*?)\[\/img\]/)[1];
                contentHtml = `<img src="${url}" class="chat-image" onclick="previewImage('${url}')">`;
            } else if (msg.content.includes('[file]')) {
                // Êñá‰ª∂Ê†ºÂºè: [file]Êñá‰ª∂Âêç|Â§ßÂ∞è[/file]
                const match = msg.content.match(/\[file\](.*?)\|(.*?)\[\/file\]/);
                if (match) {
                    const fileName = match[1];
                    const fileSize = match[2];
                    contentHtml = `
                        <div class="file-bubble" style="display: flex; align-items: center; gap: 10px; background: white; padding: 10px; border-radius: 8px; min-width: 200px; border: 1px solid #eee; cursor: pointer;">
                            <div style="font-size: 32px;">üìÑ</div>
                            <div style="flex: 1; overflow: hidden;">
                                <div style="font-size: 14px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500;">${fileName}</div>
                                <div style="font-size: 12px; color: #999;">${fileSize}</div>
                            </div>
                        </div>
                    `;
                } else {
                    contentHtml = msg.content;
                }
            } else if (msg.content.includes('[redpacket]')) {
                // Á∫¢ÂåÖÊ†ºÂºè: [redpacket]ÈáëÈ¢ù|Â§áÊ≥®[/redpacket]
                const match = msg.content.match(/\[redpacket\](.*?)\|(.*?)\[\/redpacket\]/);
                if (match) {
                    contentHtml = `
                        <div class="red-packet-bubble">
                            <div class="rp-content">
                                <div class="rp-icon">üßß</div>
                                <div class="rp-text">
                                    <div class="rp-desc">${match[2]}</div>
                                    <div class="rp-status">Êü•ÁúãÁ∫¢ÂåÖ</div>
                                </div>
                            </div>
                            <div class="rp-footer">ÂæÆ‰ø°Á∫¢ÂåÖ</div>
                        </div>
                    `;
                }
            } else {
                contentHtml = msg.content.replace(/\n/g, '<br>');
            }

            div.innerHTML = `
                <div class="message-avatar">
                    <img src="${avatarSrc}">
                </div>
                <div class="message-content">
                    <div class="message-bubble">${contentHtml}</div>
                    <div class="message-time">${formatTime(msg.timestamp || Date.now())}</div>
                </div>
            `;
            
            container.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;

            const msg = {
                role: 'user',
                content: text,
                timestamp: Date.now()
            };

            char.chatHistory.push(msg);
            saveAppData();
            appendMessageToDOM(msg);
            input.value = '';
            input.style.height = 'auto';
            
            // Ëß¶ÂèëAIÂõûÂ§ç
            triggerAIReply();
        }

        function triggerAIReply() {
            const btn = document.getElementById('ai-reply-btn');
            btn.classList.add('loading');
            
            callAI().then(response => {
                btn.classList.remove('loading');
                if (response) {
                    handleAIResponse(response);
                }
            }).catch(err => {
                btn.classList.remove('loading');
                showToast('AIËØ∑Ê±ÇÂ§±Ë¥•: ' + err.message);
            });
        }

        function retryLastMessage() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char || char.chatHistory.length === 0) return;

            const lastMsg = char.chatHistory[char.chatHistory.length - 1];
            
            // Â¶ÇÊûúÊúÄÂêé‰∏ÄÊù°ÊòØ AI ÂõûÂ§çÔºåÂà†Èô§ÂÆÉÂπ∂ÈáçËØï
            if (lastMsg.role === 'assistant') {
                char.chatHistory.pop();
                saveAppData();
                renderMessages();
                triggerAIReply();
            } else if (lastMsg.role === 'user') {
                // Â¶ÇÊûúÊúÄÂêé‰∏ÄÊù°ÊòØÁî®Êà∑Ê∂àÊÅØÔºåÁõ¥Êé•Ëß¶Âèë AI ÂõûÂ§ç
                triggerAIReply();
            }
        }

        function handleAIResponse(responseText) {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            
            // Â§ÑÁêÜÂ§öÊ∂àÊÅØÂàÜÈöîÁ¨¶ |||
            const parts = responseText.split('|||').filter(p => p.trim());
            
            let delay = 0;
            parts.forEach((part, index) => {
                setTimeout(() => {
                    const msg = {
                        role: 'assistant',
                        content: part.trim(),
                        timestamp: Date.now()
                    };
                    char.chatHistory.push(msg);
                    saveAppData();
                    appendMessageToDOM(msg);
                }, delay);
                delay += 1500; // ÊØèÊù°Ê∂àÊÅØÈó¥Èöî1.5Áßí
            });
        }

        async function fetchChatCompletion(messages, settings) {
            const apiKey = settings.key;
            const apiUrl = settings.url || 'https://api.openai.com/v1/chat/completions';
            const model = settings.model || 'gpt-3.5-turbo';
            
            if (!apiKey) {
                throw new Error('ËØ∑ÂÖàÈÖçÁΩÆAPI Key');
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: messages,
                    temperature: parseFloat(settings.temperature || 0.8)
                })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || 'ËØ∑Ê±ÇÂ§±Ë¥•');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function callAI() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            const messages = buildPromptMessages(char);
            return await fetchChatCompletion(messages, appData.apiSettings.main);
        }

        function buildPromptMessages(char) {
            // ÊûÑÂª∫ System Prompt
            let systemPrompt = `‰Ω†Ê≠£Âú®ÊâÆÊºî‰∏Ä‰∏™ËßíËâ≤„ÄÇ
ËßíËâ≤ÂêçÔºö${char.name}
ÊòµÁß∞Ôºö${char.nickname}
‰∫∫ËÆæÔºö${char.persona}

Áî®Êà∑Ôºö${char.userSettings?.name || 'Áî®Êà∑'}
Áî®Êà∑ÊòµÁß∞Ôºö${char.userSettings?.nickname || '‰Ω†'}
Áî®Êà∑‰∫∫ËÆæÔºö${char.userSettings?.persona || ''}

ÂΩìÂâçÊó∂Èó¥Ôºö${new Date().toLocaleString()}

ËØ∑‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãËßÑÂàôÔºö
1. ÂßãÁªà‰øùÊåÅËßíËâ≤ËØ≠Ê∞îÔºå‰∏çË¶ÅË∑≥Âá∫ËßíËâ≤„ÄÇ
2. ÂõûÂ§çË¶ÅÁÆÄÁü≠Ëá™ÁÑ∂ÔºåÂÉèÂæÆ‰ø°ËÅäÂ§©‰∏ÄÊ†∑„ÄÇ
3. Â¶ÇÊûúÈúÄË¶ÅÂèëÈÄÅÂ§öÊù°Ê∂àÊÅØÔºåËØ∑Âú®Ê∂àÊÅØ‰πãÈó¥‰ΩøÁî® "|||" ÂàÜÈöî„ÄÇ
4. Â¶ÇÊûúÁî®Êà∑ÂèëÈÄÅÂõæÁâáÔºåËØ∑Ê†πÊçÆÂõæÁâáÂÜÖÂÆπËøõË°åÂõûÂ∫î„ÄÇ
`;

            // ÂÖ≥ËÅî‰∏ñÁïå‰π¶
            if (char.worldbooks && char.worldbooks.length > 0) {
                const wbContent = char.worldbooks.map(wbId => {
                    const wb = appData.worldbooks.find(w => w.id === wbId);
                    if (!wb) return '';
                    // ÁÆÄÂçïÁöÑÂÖ≥ÈîÆËØçÂåπÈÖçÈÄªËæëÔºàËøôÈáåÁÆÄÂåñ‰∏∫ÂÖ®ÈÉ®Âä†ËΩΩÔºåÂÆûÈôÖÂ∫îÊåâÈúÄÔºâ
                    return wb.entries.map(e => `${e.keywords}: ${e.content}`).join('\n');
                }).join('\n');
                if (wbContent) {
                    systemPrompt += `\n‰∏ñÁïåËßÇËÆæÂÆöÔºö\n${wbContent}`;
                }
            }

            if (char.postHistoryInstructions) {
                systemPrompt += `\n${char.postHistoryInstructions}`;
            }

            const messages = [
                { role: 'system', content: systemPrompt }
            ];

            // Ê∑ªÂä†ÂéÜÂè≤ËÆ∞ÂΩï
            const historyLimit = char.settings?.memoryCount || 50;
            const recentHistory = char.chatHistory.slice(-historyLimit);
            
            recentHistory.forEach(msg => {
                let content = msg.content;
                
                // Â§ÑÁêÜÂõæÁâáÊ∂àÊÅØÊ†ºÂºèËΩ¨Êç¢
                if (content.includes('[img]')) {
                    const imgUrl = content.match(/\[img\](.*?)\[\/img\]/)[1];
                    messages.push({
                        role: msg.role,
                        content: [
                            { type: "text", text: "ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá" },
                            { type: "image_url", image_url: { url: imgUrl } }
                        ]
                    });
                } else {
                    messages.push({ role: msg.role, content: content });
                }
            });

            return messages;
        }

        // ================= ËæÖÂä©ÂäüËÉΩ =================
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                const input = document.getElementById('chat-input');
                // ÊèíÂÖ•ÂõæÁâáÊ†áÁ≠æ
                input.value += `[img]${base64}[/img]`;
                sendMessage();
            };
            reader.readAsDataURL(file);
            event.target.value = ''; // ÈáçÁΩÆ
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const input = document.getElementById('chat-input');
            
            // ÁÆÄÂçïÁöÑÊñá‰ª∂Â§ÑÁêÜÔºöÂ¶ÇÊûúÊòØÊñáÊú¨Êñá‰ª∂ÔºåËØªÂèñÂÜÖÂÆπ
            if (file.type === 'text/plain') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    input.value += e.target.result;
                    autoResize(input);
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.docx')) {
                // ‰ΩøÁî® mammoth ËØªÂèñ docx
                const reader = new FileReader();
                reader.onload = function(e) {
                    mammoth.extractRawText({arrayBuffer: e.target.result})
                        .then(function(result){
                            input.value += result.value;
                            autoResize(input);
                        })
                        .catch(function(err){
                            showToast('ÊñáÊ°£ËØªÂèñÂ§±Ë¥•');
                        });
                };
                reader.readAsArrayBuffer(file);
            } else {
                // ÂÖ∂‰ªñÊñá‰ª∂ÔºåÂèëÈÄÅÊñá‰ª∂Ê∂àÊÅØÊ†áËÆ∞
                // Ê†ºÂºè: [file]Êñá‰ª∂Âêç|Â§ßÂ∞è[/file]
                const size = (file.size / 1024).toFixed(1) + 'KB';
                input.value += `[file]${file.name}|${size}[/file]`;
                sendMessage();
            }
            
            event.target.value = '';
        }

        function previewImage(url) {
            const modal = document.getElementById('image-preview-modal');
            const img = document.getElementById('preview-image');
            img.src = url;
            modal.classList.add('show');
        }

        // ================= ËßÜÈ¢ëÈÄöËØù =================
        function startVideoCall() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;
            
            document.getElementById('vc-avatar').src = char.avatar || `https://api.dicebear.com/7.x/lorelei/png?seed=${char.id}`;
            document.getElementById('vc-name').textContent = char.nickname || char.name;
            document.getElementById('video-call-modal').classList.add('show');
            
            // Ê®°ÊãüÂØπÊñπÊé•Âê¨
            setTimeout(() => {
                document.getElementById('vc-status').textContent = 'ÈÄöËØù‰∏≠ 00:00';
                // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ËÆ°Êó∂Âô®ÈÄªËæë
            }, 3000);
        }

        function endVideoCall() {
            document.getElementById('video-call-modal').classList.remove('show');
            document.getElementById('vc-status').textContent = 'Ê≠£Âú®Á≠âÂæÖÂØπÊñπÊé•ÂèóÈÇÄËØ∑...';
        }

        // ================= Á∫¢ÂåÖÂäüËÉΩ =================
        function openRedPacketModal() {
            openModal('red-packet-modal');
            toggleFunctionPanel(); // ÂÖ≥Èó≠ÂäüËÉΩÈù¢Êùø
        }

        function sendRedPacket() {
            const amount = document.getElementById('rp-amount').value;
            const memo = document.getElementById('rp-memo').value || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©';
            
            if (!amount) {
                showToast('ËØ∑ËæìÂÖ•ÈáëÈ¢ù');
                return;
            }
            
            const input = document.getElementById('chat-input');
            input.value = `[redpacket]${amount}|${memo}[/redpacket]`;
            sendMessage();
            closeModal('red-packet-modal');
        }

        // ================= ÂäüËÉΩÈù¢Êùø =================
        function closeAllPanels() {
            document.getElementById('function-panel').classList.remove('show');
            document.getElementById('emoji-panel').classList.remove('show');
            document.getElementById('panel-overlay').classList.remove('show');
        }

        function toggleFunctionPanel() {
            const panel = document.getElementById('function-panel');
            const overlay = document.getElementById('panel-overlay');
            const isShown = panel.classList.contains('show');
            
            if (isShown) {
                panel.classList.remove('show');
                overlay.classList.remove('show');
            } else {
                panel.classList.add('show');
                overlay.classList.add('show');
                // Á°Æ‰øùË°®ÊÉÖÈù¢ÊùøÂÖ≥Èó≠
                document.getElementById('emoji-panel').classList.remove('show');
            }
        }

        function openEmojiPanelFromFunc() {
            // ÂÖ≥Èó≠ÂäüËÉΩÈù¢ÊùøÔºå‰øùÊåÅÈÅÆÁΩ©Â±ÇÊòæÁ§∫
            document.getElementById('function-panel').classList.remove('show');
            // Á°Æ‰øùÈÅÆÁΩ©Â±ÇÊòæÁ§∫
            document.getElementById('panel-overlay').classList.add('show');
            
            setTimeout(() => {
                document.getElementById('emoji-panel').classList.add('show');
            }, 100);
        }

        function toggleEmojiPanel() {
            const panel = document.getElementById('emoji-panel');
            const overlay = document.getElementById('panel-overlay');
            panel.classList.toggle('show');
            
            if (panel.classList.contains('show')) {
                overlay.classList.add('show');
                switchEmojiTab('emoji'); // ÈªòËÆ§ÊâìÂºÄ Emoji Ê†áÁ≠æ
            } else {
                overlay.classList.remove('show');
            }
        }

        function closeEmojiPanel() {
            document.getElementById('emoji-panel').classList.remove('show');
            document.getElementById('panel-overlay').classList.remove('show');
            document.getElementById('chat-input').focus(); // ËøîÂõûÁÑ¶ÁÇπÁªôËæìÂÖ•Ê°Ü
        }

        let currentEmojiTab = 'emoji';

        function switchEmojiTab(tab) {
            currentEmojiTab = tab;
            document.querySelectorAll('.emoji-tab').forEach(el => el.classList.remove('active'));
            // ÊâæÂà∞ÂØπÂ∫îÁöÑ tab ÂÖÉÁ¥†Âπ∂Ê∑ªÂä† active Á±ª
            const tabs = document.querySelectorAll('.emoji-tab');
            if (tab === 'emoji') tabs[0].classList.add('active');
            else if (tab === 'custom') tabs[1].classList.add('active');
            
            renderEmojiContent();
        }

        function renderEmojiContent() {
            const container = document.getElementById('emoji-content');
            container.innerHTML = '';

            if (currentEmojiTab === 'emoji') {
                // Â∏∏Áî® Emoji ÂàóË°®
                const emojis = ['üòÄ','üòÅ','üòÇ','ü§£','üòÉ','üòÑ','üòÖ','üòÜ','üòâ','üòä','üòã','üòé','üòç','üòò','ü•∞','üòó','üòô','üòö','üôÇ','ü§ó','ü§©','ü§î','ü§®','üòê','üòë','üò∂','üôÑ','üòè','üò£','üò•','üòÆ','ü§ê','üòØ','üò™','üò´','üò¥','üòå','üòõ','üòú','üòù','ü§§','üòí','üòì','üòî','üòï','üôÉ','ü§ë','üò≤','‚òπÔ∏è','üôÅ','üòñ','üòû','üòü','üò§','üò¢','üò≠','üò¶','üòß','üò®','üò©','ü§Ø','üò¨','üò∞','üò±','ü•µ','ü•∂','üò≥','ü§™','üòµ','üò°','üò†','ü§¨','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','üòá','ü§†','ü§°','ü•≥','ü•¥','ü•∫','ü§•','ü§´','ü§≠','üßê','ü§ì','üòà','üëø','üëπ','üë∫','üíÄ','üëª','üëΩ','ü§ñ','üí©','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ'];
                
                emojis.forEach(emoji => {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = emoji;
                    item.onclick = () => insertEmoji(emoji);
                    container.appendChild(item);
                });
            } else if (currentEmojiTab === 'custom') {
                // Ê∏≤ÊüìËá™ÂÆö‰πâË°®ÊÉÖÂåÖ
                if (appData.emojiLibrary && appData.emojiLibrary.length > 0) {
                    appData.emojiLibrary.forEach(pack => {
                        // Ê£ÄÊü•ÊòØÂê¶ÁªëÂÆö‰∫ÜÂΩìÂâçËßíËâ≤
                        // Â¶ÇÊûúÁªëÂÆö‰∫ÜËßíËâ≤ÔºåÂè™ÊúâËØ•ËßíËâ≤ËÉΩÁúãÂà∞ÔºõÊ≤°ÁªëÂÆöÂàôÊâÄÊúâËßíËâ≤ÂèØËßÅ
                        // ‰ΩÜÂú®ÁÆ°ÁêÜÊ®°Âºè‰∏ãÔºàËøôÈáåÊ≤°Êúâ‰∏ìÈó®ÁöÑÁÆ°ÁêÜÊ®°ÂºèÔºåÊâÄ‰ª•Êàë‰ª¨ÂÖÅËÆ∏ÁúãÂà∞ÊâÄÊúâÔºå‰ΩÜÂú®ÁÇπÂáªÊó∂ÊèêÁ§∫ÔºüÊàñËÄÖÂè™ÊòæÁ§∫ÂèØËßÅÁöÑÔºâ
                        // ‰∏∫‰∫ÜÊñπ‰æøÁÆ°ÁêÜÔºåÊàë‰ª¨ÊòæÁ§∫ÊâÄÊúâÂèØËßÅÁöÑ„ÄÇ
                        const isVisible = !pack.bindCharId || pack.bindCharId === appData.currentCharacterId;
                        if (!isVisible) return;

                        // ÁªÑÊ†áÈ¢òÊ†è
                        const groupHeader = document.createElement('div');
                        groupHeader.style.gridColumn = '1 / -1';
                        groupHeader.style.display = 'flex';
                        groupHeader.style.justifyContent = 'space-between';
                        groupHeader.style.alignItems = 'center';
                        groupHeader.style.padding = '5px 0';
                        groupHeader.style.marginTop = '10px';
                        groupHeader.style.borderBottom = '1px dashed #eee';
                        
                        groupHeader.innerHTML = `
                            <span style="font-size:12px;color:#666;font-weight:bold;">${pack.name}</span>
                            <span style="font-size:16px;cursor:pointer;padding:0 5px;" onclick="openBindCharacterModal('${pack.id}')" title="ËÆæÁΩÆ">‚öôÔ∏è</span>
                        `;
                        container.appendChild(groupHeader);

                        pack.emojis.forEach(url => {
                            const item = document.createElement('div');
                            item.className = 'emoji-item';
                            item.innerHTML = `<img src="${url}">`;
                            item.onclick = () => sendEmojiImage(url);
                            container.appendChild(item);
                        });
                    });
                } else {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">ÊöÇÊó†Ë°®ÊÉÖÂåÖÔºåÁÇπÂáªÂè≥‰∏äËßíÂØºÂÖ•</div>';
                }
            }
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('chat-input');
            input.value += emoji;
            // ‰∏çËá™Âä®ÂèëÈÄÅÔºå‰πü‰∏çÂÖ≥Èó≠Èù¢Êùø
        }

        function sendEmojiImage(url) {
            const input = document.getElementById('chat-input');
            // ÂèëÈÄÅÂõæÁâáÊ∂àÊÅØ
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;

            const msg = {
                role: 'user',
                content: `[img]${url}[/img]`,
                timestamp: Date.now()
            };

            char.chatHistory.push(msg);
            saveAppData();
            appendMessageToDOM(msg);
            
            // Ëß¶ÂèëAIÂõûÂ§ç
            triggerAIReply();
            
            // ÂèëÈÄÅÂêé‰∏çÂÖ≥Èó≠Èù¢ÊùøÔºåÁ¨¶ÂêàÁî®Êà∑Ë¶ÅÊ±Ç
        }

        // ================= API ËÆæÁΩÆ =================
        function openAPISettings() {
            document.getElementById('main-api-url').value = appData.apiSettings.main.url;
            document.getElementById('main-api-key').value = appData.apiSettings.main.key;
            document.getElementById('main-temperature').value = appData.apiSettings.main.temperature || 0.8;
            document.getElementById('temp-value').textContent = appData.apiSettings.main.temperature || 0.8;
            openModal('api-modal');
        }

        function saveAPISettings() {
            appData.apiSettings.main.url = document.getElementById('main-api-url').value;
            appData.apiSettings.main.key = document.getElementById('main-api-key').value;
            appData.apiSettings.main.temperature = document.getElementById('main-temperature').value;
            saveAppData();
            closeModal('api-modal');
            showToast('APIËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }

        // ================= Â§ñËßÇËÆæÁΩÆ =================
        function openAppearanceSettings() {
            document.getElementById('custom-font-input').value = localStorage.getItem('custom_font') || '';
            document.getElementById('main-avatar-url').value = appData.appearance.mainAvatar || '';
            document.getElementById('main-bg-url').value = appData.appearance.mainBg || '';
            
            renderIconEditGrid();
            openModal('appearance-modal');
        }

        function saveAppearanceSettings() {
            appData.appearance.mainAvatar = document.getElementById('main-avatar-url').value;
            appData.appearance.mainBg = document.getElementById('main-bg-url').value;
            saveAppData();
            applyAppearance();
            closeModal('appearance-modal');
            showToast('Â§ñËßÇËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }

        function renderIconEditGrid() {
            const grid = document.getElementById('icon-edit-grid');
            grid.innerHTML = '';
            
            Object.keys(iconNames).forEach(key => {
                const item = document.createElement('div');
                item.className = 'icon-edit-item';
                
                let iconContent = defaultIcons[key];
                if (appData.appearance.icons && appData.appearance.icons[key]) {
                    if (appData.appearance.icons[key].type === 'image') {
                        iconContent = `<img src="${appData.appearance.icons[key].content}">`;
                    }
                }

                item.innerHTML = `
                    <div class="icon-edit-preview">${iconContent}</div>
                    <div class="icon-edit-name">${iconNames[key]}</div>
                `;
                item.onclick = () => openIconEdit(key);
                grid.appendChild(item);
            });
        }

        function openIconEdit(key) {
            currentEditingIcon = key;
            document.getElementById('icon-edit-title').textContent = `ÁºñËæë ${iconNames[key]} ÂõæÊ†á`;
            
            const preview = document.getElementById('icon-edit-preview');
            let iconContent = defaultIcons[key];
            if (appData.appearance.icons && appData.appearance.icons[key]) {
                if (appData.appearance.icons[key].type === 'image') {
                    iconContent = `<img src="${appData.appearance.icons[key].content}">`;
                }
            }
            preview.innerHTML = iconContent;
            
            document.getElementById('popup-overlay').classList.add('show');
            document.getElementById('icon-edit-popup').classList.add('show');
        }

        function closeIconEditPopup() {
            document.getElementById('popup-overlay').classList.remove('show');
            document.getElementById('icon-edit-popup').classList.remove('show');
            currentEditingIcon = null;
        }

        function uploadIconImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('icon-url-input').value = e.target.result;
                document.getElementById('icon-edit-preview').innerHTML = `<img src="${e.target.result}">`;
            };
            reader.readAsDataURL(file);
        }

        function saveIconEdit() {
            if (!currentEditingIcon) return;
            const url = document.getElementById('icon-url-input').value;
            if (url) {
                if (!appData.appearance.icons) appData.appearance.icons = {};
                appData.appearance.icons[currentEditingIcon] = { type: 'image', content: url };
                saveAppData();
                renderIconEditGrid();
                closeIconEditPopup();
            }
        }

        function resetIconToDefault() {
            if (!currentEditingIcon) return;
            if (appData.appearance.icons && appData.appearance.icons[currentEditingIcon]) {
                delete appData.appearance.icons[currentEditingIcon];
                saveAppData();
                renderIconEditGrid();
                closeIconEditPopup();
            }
        }

        // ================= ÂàùÂßãÂåñ =================
        window.onload = function() {
            loadAppData();
            
            // ÁªëÂÆö‰∏ªÂ±èÂπïÂõæÊ†áÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('character-icon').onclick = openCharacterList;
            document.getElementById('worldbook-icon').onclick = () => { renderWorldbookList(); openModal('worldbook-modal'); };
            document.getElementById('api-settings-icon').onclick = openAPISettings;
            document.getElementById('appearance-icon').onclick = openAppearanceSettings;
            
            // Êõ¥Êñ∞Êó∂Èó¥
            setInterval(() => {
                document.getElementById('current-time').textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            }, 1000);

            // PWA ÂÆâË£ÖÊèêÁ§∫
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('pwa-install-prompt').classList.add('show');
            });

            document.getElementById('pwa-install-btn').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        deferredPrompt = null;
                    }
                    document.getElementById('pwa-install-prompt').classList.remove('show');
                }
            });
        };

        function dismissPWAPrompt() {
            document.getElementById('pwa-install-prompt').classList.remove('show');
        }
        
        // ================= API Áõ∏ÂÖ≥ =================
        async function fetchModels(type) {
            const urlInput = type === 'main' ? 'main-api-url' : 'sub-api-url';
            const keyInput = type === 'main' ? 'main-api-key' : 'sub-api-key';
            const selectId = type === 'main' ? 'main-model-select' : 'sub-model-select';
            
            const urlVal = document.getElementById(urlInput).value;
            if (!urlVal) {
                showToast('ËØ∑ËæìÂÖ•APIÂú∞ÂùÄ');
                return;
            }
            // ÁÆÄÂçïÁöÑÂ§ÑÁêÜÔºåÂéªÊéâÊú´Â∞æÁöÑ /chat/completions Êç¢Êàê /models
            const url = urlVal.replace(/\/chat\/completions\/?$/, '') + '/models';
            const key = document.getElementById(keyInput).value;
            const select = document.getElementById(selectId);
            
            select.innerHTML = '<option>Âä†ËΩΩ‰∏≠...</option>';
            
            try {
                const headers = {};
                if (key) headers['Authorization'] = `Bearer ${key}`;
                
                const response = await fetch(url, { headers });
                if (!response.ok) throw new Error('ËØ∑Ê±ÇÂ§±Ë¥•');
                
                const data = await response.json();
                select.innerHTML = '';
                
                const models = data.data || data; // ÂÖºÂÆπ‰∏çÂêåÊ†ºÂºè
                if (Array.isArray(models)) {
                    models.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.id;
                        option.textContent = m.id;
                        select.appendChild(option);
                    });
                    
                    // ÊÅ¢Â§ç‰πãÂâçÁöÑÈÄâÊã©
                    const savedModel = type === 'main' ? appData.apiSettings.main.model : appData.apiSettings.sub.model;
                    if (savedModel) {
                        // Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®
                        let exists = false;
                        for(let i=0; i<select.options.length; i++) {
                            if(select.options[i].value === savedModel) exists = true;
                        }
                        if(!exists) {
                            const opt = document.createElement('option');
                            opt.value = savedModel;
                            opt.textContent = savedModel;
                            select.appendChild(opt);
                        }
                        select.value = savedModel;
                    }
                    
                    // ÁªëÂÆö change ‰∫ã‰ª∂
                    select.onchange = function() {
                        if (type === 'main') appData.apiSettings.main.model = this.value;
                        else appData.apiSettings.sub.model = this.value;
                    };
                } else {
                    throw new Error('Ê†ºÂºèÊó†Ê≥ïËØÜÂà´');
                }
                showToast('Ê®°ÂûãÊãâÂèñÊàêÂäü');
            } catch (e) {
                console.error(e);
                select.innerHTML = '<option value="">ÊãâÂèñÂ§±Ë¥•</option>';
                showToast('ÊãâÂèñÂ§±Ë¥•: ' + e.message);
            }
        }

        function fetchMinimaxVoiceModels() {
            // Ê®°ÊãüÊãâÂèñÔºåÂõ†‰∏∫ Minimax API ÊØîËæÉÂ§çÊùÇÔºåËøôÈáåÂÖàÊèê‰æõÂá†‰∏™È¢ÑËÆæ
            const select = document.getElementById('voice-model-select');
            select.innerHTML = '';
            const models = [
                { id: 'speech-01', name: 'Speech-01' },
                { id: 'speech-02', name: 'Speech-02' },
                { id: 'abab5.5-chat', name: 'abab5.5-chat' }
            ];
            models.forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = m.name;
                select.appendChild(option);
            });
            showToast('ËØ≠Èü≥Ê®°ÂûãÂàóË°®Â∑≤Êõ¥Êñ∞');
        }

        function savePreset() {
            const name = prompt('ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞Ôºö');
            if (!name) return;
            
            const preset = {
                name: name,
                url: document.getElementById('main-api-url').value,
                key: document.getElementById('main-api-key').value,
                model: document.getElementById('main-model-select').value
            };
            
            appData.presets.push(preset);
            saveAppData();
            renderPresets();
            showToast('È¢ÑËÆæÂ∑≤‰øùÂ≠ò');
        }

        function renderPresets() {
            const list = document.getElementById('preset-list');
            list.innerHTML = '';
            appData.presets.forEach((p, index) => {
                const tag = document.createElement('span');
                tag.className = 'preset-tag';
                tag.textContent = p.name;
                tag.onclick = () => loadPreset(index);
                
                // ÈïøÊåâÂà†Èô§
                let timer;
                tag.addEventListener('touchstart', () => {
                    timer = setTimeout(() => {
                        if(confirm(`Âà†Èô§È¢ÑËÆæ "${p.name}"?`)) {
                            appData.presets.splice(index, 1);
                            saveAppData();
                            renderPresets();
                        }
                    }, 800);
                });
                tag.addEventListener('touchend', () => clearTimeout(timer));
                
                list.appendChild(tag);
            });
        }

        function loadPreset(index) {
            const p = appData.presets[index];
            if (!p) return;
            document.getElementById('main-api-url').value = p.url;
            document.getElementById('main-api-key').value = p.key;
            
            const select = document.getElementById('main-model-select');
            // ÁÆÄÂçïÁöÑÊ∑ªÂä†ÈÄâÈ°π
            const opt = document.createElement('option');
            opt.value = p.model;
            opt.textContent = p.model;
            select.innerHTML = ''; // Ê∏ÖÁ©∫
            select.appendChild(opt);
            select.value = p.model;
            
            appData.apiSettings.main.url = p.url;
            appData.apiSettings.main.key = p.key;
            appData.apiSettings.main.model = p.model;
            
            showToast(`Â∑≤Âä†ËΩΩÈ¢ÑËÆæ: ${p.name}`);
        }

        // ================= Êï∞ÊçÆÁÆ°ÁêÜ =================
        function importCharacter(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const charData = JSON.parse(e.target.result);
                    // ÁÆÄÂçïÁöÑÊ†ºÂºèÊ£ÄÊü•
                    if (!charData.name) throw new Error('Êó†ÊïàÁöÑËßíËâ≤Êñá‰ª∂');
                    
                    charData.id = generateId(); // ÈáçÊñ∞ÁîüÊàêIDÈÅøÂÖçÂÜ≤Á™Å
                    appData.characters.push(charData);
                    saveAppData();
                    renderCharacterList();
                    showToast('ËßíËâ≤ÂØºÂÖ•ÊàêÂäü');
                } catch (err) {
                    showToast('ÂØºÂÖ•Â§±Ë¥•: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportChatHistory() {
            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char) return;
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(char.chatHistory));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `${char.name}_chat_history.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importChatHistory(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const history = JSON.parse(e.target.result);
                    if (!Array.isArray(history)) throw new Error('Êó†ÊïàÁöÑËÅäÂ§©ËÆ∞ÂΩï');
                    
                    const char = appData.characters.find(c => c.id === appData.currentCharacterId);
                    if (char) {
                        if (confirm('Ë¶ÅË¶ÜÁõñÁé∞ÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºüÁÇπÂáª"ÂèñÊ∂à"ÂàôËøΩÂä†Âà∞Êú´Â∞æ„ÄÇ')) {
                            char.chatHistory = history;
                        } else {
                            char.chatHistory = char.chatHistory.concat(history);
                        }
                        saveAppData();
                        renderMessages();
                        showToast('ËÅäÂ§©ËÆ∞ÂΩïÂØºÂÖ•ÊàêÂäü');
                    }
                } catch (err) {
                    showToast('ÂØºÂÖ•Â§±Ë¥•: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function clearChatHistory() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂΩìÂâçËßíËâ≤ÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                const char = appData.characters.find(c => c.id === appData.currentCharacterId);
                if (char) {
                    char.chatHistory = [];
                    saveAppData();
                    renderMessages();
                    showToast('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
                }
            }
        }

        // ================= Êñá‰ª∂‰∏ä‰º† =================
        function uploadAvatar(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const result = e.target.result;
                if (type === 'char') {
                    document.getElementById('char-avatar-preview').src = result;
                } else {
                    document.getElementById('user-avatar-preview').src = result;
                }
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function uploadChatBg(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('chat-bg-url').value = e.target.result;
                // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†È¢ÑËßàÈÄªËæë
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function uploadMainAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('main-avatar-url').value = e.target.result;
                previewMainAvatar();
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function uploadMainBg(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('main-bg-url').value = e.target.result;
                previewMainBg();
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function previewMainAvatar() {
            const url = document.getElementById('main-avatar-url').value;
            if (url) document.getElementById('main-avatar-preview').src = url;
        }

        function previewMainBg() {
            const url = document.getElementById('main-bg-url').value;
            if (url) {
                document.getElementById('bg-preview-box').style.backgroundImage = `url(${url})`;
                document.getElementById('bg-preview-box').innerHTML = '';
            }
        }

        function resetMainBg() {
            document.getElementById('main-bg-url').value = '';
            document.getElementById('bg-preview-box').style.backgroundImage = '';
            document.getElementById('bg-preview-box').innerHTML = '<span>ÁÇπÂáªÊõ¥Êç¢ËÉåÊôØ</span>';
        }

        // ================= ÂÖ∂‰ªñËæÖÂä© =================
        function updateTokensEstimate() {
            const persona = document.getElementById('char-persona').value || '';
            const userPersona = document.getElementById('user-persona').value || '';
            const history = document.getElementById('char-post-history-instructions').value || '';
            // Á≤óÁï•‰º∞ÁÆóÔºöÊ±âÂ≠ó2tokenÔºåËã±Êñá1tokenÔºåËøôÈáåÁÆÄÂåñ‰∏∫ÈïøÂ∫¶/2
            const total = persona.length + userPersona.length + history.length;
            document.getElementById('tokens-estimate').textContent = Math.ceil(total);
        }

        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËæìÂÖ•');
                return;
            }
            
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            showToast('ËØ∑ËØ¥ËØù...');
            
            recognition.onresult = function(event) {
                const text = event.results[0][0].transcript;
                const input = document.getElementById('chat-input');
                input.value += text;
                autoResize(input);
            };
            
            recognition.onerror = function(event) {
                showToast('ËØ≠Èü≥ËØÜÂà´ÈîôËØØ: ' + event.error);
            };
            
            recognition.start();
        }

        async function manualSummary() {
            const startInput = document.getElementById('summary-start');
            const endInput = document.getElementById('summary-end');
            const start = parseInt(startInput.value);
            const end = parseInt(endInput.value);
            
            if (isNaN(start) || isNaN(end) || start > end) {
                showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑËåÉÂõ¥');
                return;
            }

            const char = appData.characters.find(c => c.id === appData.currentCharacterId);
            if (!char || !char.chatHistory.length) {
                showToast('Ê≤°ÊúâËÅäÂ§©ËÆ∞ÂΩï');
                return;
            }

            // Á¥¢Âºï‰ªé1ÂºÄÂßã
            const history = char.chatHistory.slice(Math.max(0, start - 1), end);
            
            if (history.length === 0) {
                showToast('ËåÉÂõ¥ÂÜÖÊ≤°ÊúâÊ∂àÊÅØ');
                return;
            }

            showToast('Ê≠£Âú®ÊÄªÁªì...');
            
            const summaryPrompt = document.getElementById('summary-prompt').value || '‰ª•ËßíËâ≤Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÂèôËø∞Êàë‰ª¨ËÅäÂ§©‰∏≠ÊèêÂà∞ÁöÑ‰∫ãÊÉÖÔºå100Â≠óÂÜÖ';
            
            const contentToSummarize = history.map(msg => {
                const roleName = msg.role === 'user' ? (char.userSettings?.name || 'Áî®Êà∑') : (char.name || 'ËßíËâ≤');
                return `${roleName}: ${msg.content}`;
            }).join('\n');

            const messages = [
                { role: 'system', content: '‰Ω†ÊòØ‰∏Ä‰∏™Âä©ÊâãÔºåË¥üË¥£ÊÄªÁªìËÅäÂ§©ËÆ∞ÂΩï„ÄÇ' },
                { role: 'user', content: `ËØ∑Ê†πÊçÆ‰ª•‰∏ãËÅäÂ§©ËÆ∞ÂΩïËøõË°åÊÄªÁªì„ÄÇ\nË¶ÅÊ±ÇÔºö${summaryPrompt}\n\nËÅäÂ§©ËÆ∞ÂΩïÔºö\n${contentToSummarize}` }
            ];

            try {
                // ‰ºòÂÖà‰ΩøÁî®ÂâØAPIÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®‰∏ªAPI
                const settings = appData.apiSettings.sub.key ? appData.apiSettings.sub : appData.apiSettings.main;
                const summary = await fetchChatCompletion(messages, settings);
                
                // ÊòæÁ§∫ÁªìÊûú
                const result = prompt('ÊÄªÁªìÂÆåÊàêÔºåËØ∑Â§çÂà∂Ôºö', summary);
                if (result !== null) {
                    if (confirm('ÊòØÂê¶Â∞ÜÊ≠§ÊÄªÁªìËøΩÂä†Âà∞ËßíËâ≤‰∫∫ËÆæÊú´Â∞æÔºü')) {
                        document.getElementById('char-persona').value += '\n\n[ËÆ∞ÂøÜÊÄªÁªì]\n' + summary;
                        updateTokensEstimate();
                        showToast('Â∑≤ËøΩÂä†Âà∞‰∫∫ËÆæ');
                    }
                }
            } catch (e) {
                showToast('ÊÄªÁªìÂ§±Ë¥•: ' + e.message);
                console.error(e);
            }
        }

        // ================= ‰∏ñÁïå‰π¶ÈÄªËæë =================
        function renderWorldbookList() {
            const list = document.getElementById('worldbook-list');
            list.innerHTML = '';
            
            if (appData.worldbooks.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-text">ÊöÇÊó†‰∏ñÁïå‰π¶</div></div>';
                return;
            }

            appData.worldbooks.forEach(wb => {
                const item = document.createElement('div');
                item.className = 'worldbook-item';
                item.innerHTML = `
                    <div class="worldbook-icon">üìñ</div>
                    <div class="worldbook-info">
                        <div class="worldbook-name">${wb.name}</div>
                        <div class="worldbook-entries">${wb.entries.length} ‰∏™Êù°ÁõÆ</div>
                    </div>
                `;
                item.onclick = () => openWorldbookEdit(wb.id);
                list.appendChild(item);
            });
        }

        function createNewWorldbook() {
            const name = prompt('ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÂêçÁß∞Ôºö');
            if (!name) return;
            
            const newWb = {
                id: generateId(),
                name: name,
                entries: []
            };
            
            appData.worldbooks.push(newWb);
            saveAppData();
            renderWorldbookList();
        }

        let currentEditingWorldbookId = null;

        function openWorldbookEdit(id) {
            currentEditingWorldbookId = id;
            const wb = appData.worldbooks.find(w => w.id === id);
            if (!wb) return;
            
            document.getElementById('worldbook-edit-title').textContent = 'ÁºñËæë ' + wb.name;
            document.getElementById('worldbook-name').value = wb.name;
            renderWorldbookEntries();
            
            closeModal('worldbook-modal');
            openModal('worldbook-edit-modal');
        }
        
        function closeWorldbookEdit() {
            closeModal('worldbook-edit-modal');
            openModal('worldbook-modal');
        }

        function renderWorldbookEntries() {
            const wb = appData.worldbooks.find(w => w.id === currentEditingWorldbookId);
            if (!wb) return;
            
            const container = document.getElementById('worldbook-entries');
            container.innerHTML = '';
            
            wb.entries.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = 'entry-item';
                div.innerHTML = `
                    <div class="entry-header">
                        <div class="entry-keywords">${entry.keywords}</div>
                        <div class="entry-actions">
                            <button class="entry-btn edit" onclick="editEntry(${index})">ÁºñËæë</button>
                            <button class="entry-btn delete" onclick="deleteEntry(${index})">Âà†Èô§</button>
                        </div>
                    </div>
                    <div class="entry-content">${entry.content}</div>
                `;
                container.appendChild(div);
            });
        }

        function saveWorldbook() {
            const wb = appData.worldbooks.find(w => w.id === currentEditingWorldbookId);
            if (!wb) return;
            
            wb.name = document.getElementById('worldbook-name').value;
            saveAppData();
            showToast('‰∏ñÁïå‰π¶Â∑≤‰øùÂ≠ò');
            closeWorldbookEdit();
            renderWorldbookList();
        }

        let currentEditingEntryIndex = -1;

        function addWorldbookEntry() {
            currentEditingEntryIndex = -1;
            document.getElementById('entry-keywords').value = '';
            document.getElementById('entry-content').value = '';
            openModal('entry-edit-modal');
        }

        function editEntry(index) {
            const wb = appData.worldbooks.find(w => w.id === currentEditingWorldbookId);
            if (!wb) return;
            
            currentEditingEntryIndex = index;
            const entry = wb.entries[index];
            document.getElementById('entry-keywords').value = entry.keywords;
            document.getElementById('entry-content').value = entry.content;
            openModal('entry-edit-modal');
        }

        function deleteEntry(index) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ê≠§Êù°ÁõÆÔºü')) return;
            const wb = appData.worldbooks.find(w => w.id === currentEditingWorldbookId);
            if (wb) {
                wb.entries.splice(index, 1);
                saveAppData();
                renderWorldbookEntries();
            }
        }

        function saveEntry() {
            const wb = appData.worldbooks.find(w => w.id === currentEditingWorldbookId);
            if (!wb) return;
            
            const keywords = document.getElementById('entry-keywords').value;
            const content = document.getElementById('entry-content').value;
            
            if (!keywords || !content) {
                showToast('ËØ∑Â°´ÂÜôÂÆåÊï¥');
                return;
            }
            
            const entry = { keywords, content };
            
            if (currentEditingEntryIndex === -1) {
                wb.entries.push(entry);
            } else {
                wb.entries[currentEditingEntryIndex] = entry;
            }
            
            saveAppData();
            renderWorldbookEntries();
            closeModal('entry-edit-modal');
        }
        
        function importWorldbook(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const wbData = JSON.parse(e.target.result);
                    if (!wbData.name || !Array.isArray(wbData.entries)) throw new Error('Ê†ºÂºèÈîôËØØ');
                    
                    wbData.id = generateId();
                    appData.worldbooks.push(wbData);
                    saveAppData();
                    renderWorldbookList();
                    showToast('‰∏ñÁïå‰π¶ÂØºÂÖ•ÊàêÂäü');
                } catch (err) {
                    showToast('ÂØºÂÖ•Â§±Ë¥•: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ================= Ë°®ÊÉÖÂåÖÈÄªËæë =================
        let tempEmojiPack = { name: '', emojis: [] };

        function handleEmojiFilesSelect(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            document.getElementById('emoji-files-count').textContent = `Â∑≤ÈÄâÊã© ${files.length} Âº†ÂõæÁâá`;
            
            // ÂºÇÊ≠•ËØªÂèñÊâÄÊúâÂõæÁâá
            tempEmojiPack.emojis = [];
            let loaded = 0;
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempEmojiPack.emojis.push(e.target.result);
                    loaded++;
                    if (loaded === files.length) {
                        showToast('ÂõæÁâáËØªÂèñÂÆåÊàê');
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function handleEmojiDocSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const processText = (text) => {
                // ÊèêÂèñÊâÄÊúâ http/https ÈìæÊé•
                const urls = text.match(/https?:\/\/[^\s"']+/g);
                if (urls && urls.length > 0) {
                    // ËøáÊª§ÂõæÁâáÈìæÊé• (ÁÆÄÂçïÂà§Êñ≠)
                    const imgUrls = urls.filter(url => /\.(jpg|jpeg|png|gif|webp)$/i.test(url) || url.includes('images'));
                    
                    if (imgUrls.length > 0) {
                        tempEmojiPack.emojis = tempEmojiPack.emojis.concat(imgUrls);
                        document.getElementById('emoji-files-count').textContent = `Â∑≤ÊèêÂèñ ${tempEmojiPack.emojis.length} Âº†ÂõæÁâá`;
                        showToast(`Â∑≤ÊèêÂèñ ${imgUrls.length} ‰∏™ÈìæÊé•`);
                    } else {
                        showToast('Êú™ÊâæÂà∞ÂõæÁâáÈìæÊé•');
                    }
                } else {
                    showToast('Êú™ÊâæÂà∞ÈìæÊé•');
                }
            };

            if (file.name.endsWith('.txt')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processText(e.target.result);
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.docx')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    mammoth.extractRawText({arrayBuffer: e.target.result})
                        .then(function(result){
                            processText(result.value);
                        })
                        .catch(function(err){
                            console.error(err);
                            showToast('ÊñáÊ°£ËØªÂèñÂ§±Ë¥•');
                        });
                };
                reader.readAsArrayBuffer(file);
            } else {
                showToast('‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè');
            }
            event.target.value = '';
        }

        function saveEmojiPack() {
            const name = document.getElementById('emoji-pack-name').value;
            if (!name) {
                showToast('ËØ∑ËæìÂÖ•Ë°®ÊÉÖÂåÖÂêçÁß∞');
                return;
            }
            if (tempEmojiPack.emojis.length === 0) {
                showToast('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÂº†ÂõæÁâá');
                return;
            }
            
            const newPack = {
                id: generateId(),
                name: name,
                emojis: tempEmojiPack.emojis,
                bindCharId: null
            };
            
            appData.emojiLibrary.push(newPack);
            saveAppData();
            showToast('Ë°®ÊÉÖÂåÖÂØºÂÖ•ÊàêÂäü');
            closeModal('emoji-import-modal');
            
            // ÈáçÁΩÆ
            tempEmojiPack = { name: '', emojis: [] };
            document.getElementById('emoji-pack-name').value = '';
            document.getElementById('emoji-files-count').textContent = 'Êú™ÈÄâÊã©';
        }

        function importEmojiConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const pack = JSON.parse(e.target.result);
                    if (!pack.emojis) throw new Error('Ê†ºÂºèÈîôËØØ');
                    
                    pack.id = generateId();
                    appData.emojiLibrary.push(pack);
                    saveAppData();
                    showToast('Ë°®ÊÉÖÂåÖÈÖçÁΩÆÂØºÂÖ•ÊàêÂäü');
                } catch (err) {
                    showToast('ÂØºÂÖ•Â§±Ë¥•');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        let currentEditingPackId = null;

        function openBindCharacterModal(packId) {
            currentEditingPackId = packId;
            const pack = appData.emojiLibrary.find(p => p.id === packId);
            if (!pack) return;

            const list = document.getElementById('bind-char-list');
            list.innerHTML = '';

            // Ê∑ªÂä†"‰∏çÁªëÂÆöÔºàÊâÄÊúâËßíËâ≤ÂèØËßÅÔºâ"ÈÄâÈ°π
            const noBindItem = document.createElement('label');
            noBindItem.className = 'checkbox-item';
            noBindItem.innerHTML = `
                <input type="radio" name="bind-char" value="" ${!pack.bindCharId ? 'checked' : ''}>
                <span class="checkbox-label">‰∏çÁªëÂÆöÔºàÊâÄÊúâËßíËâ≤ÂèØËßÅÔºâ</span>
            `;
            list.appendChild(noBindItem);

            appData.characters.forEach(char => {
                const item = document.createElement('label');
                item.className = 'checkbox-item';
                item.innerHTML = `
                    <input type="radio" name="bind-char" value="${char.id}" ${pack.bindCharId === char.id ? 'checked' : ''}>
                    <span class="checkbox-label">${char.nickname || char.name}</span>
                `;
                list.appendChild(item);
            });

            // Ê∑ªÂä†Âà†Èô§ÊåâÈíÆ
            const footer = document.querySelector('#bind-character-modal .modal-footer');
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâÂà†Èô§ÊåâÈíÆÔºåÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†
            let delBtn = document.getElementById('delete-pack-btn');
            if (!delBtn) {
                delBtn = document.createElement('button');
                delBtn.id = 'delete-pack-btn';
                delBtn.className = 'btn btn-danger';
                delBtn.style.width = '100%';
                delBtn.style.marginTop = '10px';
                delBtn.textContent = 'Âà†Èô§Ê≠§Ë°®ÊÉÖÂåÖ';
                delBtn.onclick = deleteEmojiPack;
                footer.appendChild(delBtn);
            }

            openModal('bind-character-modal');
        }

        function saveBindCharacter() {
            if (!currentEditingPackId) return;
            
            const pack = appData.emojiLibrary.find(p => p.id === currentEditingPackId);
            if (!pack) return;

            const radios = document.querySelectorAll('input[name="bind-char"]');
            let selectedId = null;
            radios.forEach(r => {
                if (r.checked) selectedId = r.value;
            });

            pack.bindCharId = selectedId || null;
            saveAppData();
            
            closeModal('bind-character-modal');
            showToast('ÁªëÂÆöÂ∑≤‰øùÂ≠ò');
            renderEmojiContent(); // Âà∑Êñ∞ÊòæÁ§∫
        }

        function deleteEmojiPack() {
            if (!currentEditingPackId) return;
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ë°®ÊÉÖÂåÖÂêóÔºü')) {
                appData.emojiLibrary = appData.emojiLibrary.filter(p => p.id !== currentEditingPackId);
                saveAppData();
                closeModal('bind-character-modal');
                showToast('Ë°®ÊÉÖÂåÖÂ∑≤Âà†Èô§');
                renderEmojiContent();
            }
        }
        
    </script>
</body>
</html>
>>>>>>> ac8e4b986cfe087b06488523277cfcde6322feb4
